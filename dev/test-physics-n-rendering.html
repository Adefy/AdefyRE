<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AdefyRE Physics + Rendering Test</title>

  <script type="text/javascript" src="./components/underscore/underscore.js"></script>
  <script type="text/javascript" src="./components/async/lib/async.js"></script>
  <script type="text/javascript" src="./components/zepto/zepto.min.js"></script>
  <script type="text/javascript" src="./components/chipmunk/cp.min.js"></script>
  <script type="text/javascript" src="./js/EWGL_math.js"></script>
  <script type="text/javascript" src="./js/inkyEWGL.js"></script>
  <script type="text/javascript" src="./js/reutil.js"></script>
  <script type="text/javascript" src="./are.js"></script>
  <script type="text/javascript" src="./js/are_test_helper.js"></script>

  <link type="text/css" rel="stylesheet" href="./css/main.css"/>
</head>

<body>
  <header>
    <div id="header-decorator"></div>
    <ul>
      <li>
        Mode: <span id="RendererMode"></span>
      </li>
      <li>
        Actor Count: <span id="ActorCount"></span>
      </li>
    </ul>
  </header>

  <script>

    var manifest = [{
      "name": "metalGrate",
      "path": "images/metalGrate.jpg"
    },{
      "name": "roundThing",
      "path": "images/roundThing.jpg"
    }];

    var width = window.innerWidth;
    var height = window.innerHeight - 30;

    //ARERenderer.force_pos0_0 = false
    //ARERenderer.setRendererMode(ARERenderer.RENDERER_MODE_NULL);
    //ARERenderer.setRendererMode(ARERenderer.RENDERER_MODE_CANVAS);
    ARERenderer.setRendererMode(ARERenderer.RENDERER_MODE_WGL);

    window.engine = window.AdefyRE.Engine().initialize(width, height, function() {
      window.AdefyRE.Engine().wglFlipTextureY = true;
      window.AdefyRE.Engine().loadManifest(JSON.stringify(manifest), function() {

        //window.engine.setClearColor(255, 255, 255);
        window.AdefyRE.Engine().setClearColor(0, 128, 128);

        var ground = window.ground = new ARERectangleActor(width, height * 0.05);
        ground.setPosition({ x: width / 2, y: height - ground.getHeight() / 2 })
        //ground.setPosition({ x: width / 2, y: ground.getHeight() / 2 })
          .setTexture("metalGrate")
          .setTextureRepeat(20, 0.5)
          .createPhysicsBody(0, 0.7, 0.6);

        new ARECircleActor(128)
          .setTexture("roundThing")
          .setPosition({ x: width / 2, y: height / 2 })
          .createPhysicsBody(100, 0.8, 0.7);

        var createBall = function() {
          var x = Math.random() * width;
          var y = -(Math.random() * 500);
          //var y = window.AdefyRE.Engine().getHeight() + (Math.random() * 500);

          var mass = Math.random() * 100;
          var friction = Math.random();
          var elasticity = Math.random() * 1.2;

          var ball = new ARECircleActor(Math.round(Math.random() * 32) + 5)
            .setPosition({ x: x, y: y })
            .setTexture("roundThing")
            .setStrokeColor(0, 0, 0)
            .setStrokeWidth(4)
            .createPhysicsBody(mass, friction, elasticity);
        };

        var scheduleBallTimeout = function() {
          setTimeout(function() {
            createBall();
            refreshActorCount();
            //if(ARERenderer.actors.length < 600)
              scheduleBallTimeout();
          }, Math.random() * 50);
        };

        // Throw out the old balls ~_~
        // For people like IceDragon, who has a shitty computer
        var ballGCTimeout = function() {
          setTimeout(function() {
            var to_remove = [];
            for (var i = 0; i < ARERenderer.actors.length; i++) {
              actor = ARERenderer.actors[i];
              if (actor.getPosition().y < -height)
                to_remove.push(actor);
            };
            for (var i = 0; i < to_remove.length; i++) {
              ARERenderer.removeActor(to_remove[i]);
            };
            ballGCTimeout();
          }, 5000);
        };

        scheduleBallTimeout();
        ballGCTimeout();

        refreshRendererMode();

      });
    });

  </script>
</body>
</html>
