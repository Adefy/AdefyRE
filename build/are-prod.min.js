/* Copyright Â© 2013 Spectrum IT Solutions Gmbh - All Rights Reserved */
var ARE,AREActorInterface,AREAnimationInterface,AREBezAnimation,ARECircleActor,AREColor3,AREEngineInterface,AREInterface,ARELog,AREPolygonActor,AREPsyxAnimation,ARERawActor,ARERectangleActor,ARERenderer,AREShader,ARETriangleActor,AREUtilParam,AREVector2,AREVertAnimation,PhysicsManager,nextHighestPowerOfTwo,precision,precision_declaration,varying_precision,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};AREUtilParam=function(){function a(){}return a.required=function(a,b,c){var d,e,f,g;if(null===a&&c!==!0&&(a=void 0),void 0===a)throw new Error("Required argument missing!");if(b instanceof Array&&b.length>0){for(d=!1,f=0,g=b.length;g>f;f++)if(e=b[f],a===e){d=!0;break}if(!d)throw new Error("Required argument is not of a valid value!")}return a},a}(),void 0===window.param&&(window.param=AREUtilParam),ARERawActor=function(){function a(a,b,c){this._renderer=a,param.required(a),param.required(b),this._initializeValues(),this._id=this._renderer.getNextId(),this._renderer.addActor(this),this._renderer.getGL()&&(this._indiceBuffer=this._renderer.getGL().createBuffer()),this._ownIndiceBuffer=this._indiceBuffer,this._hasOwnIndiceBuffer=!0,this._hostActorId=null,this._vertexData=null,this._vertStride=4*Float32Array.BYTES_PER_ELEMENT,this._uvOffset=2*Float32Array.BYTES_PER_ELEMENT,this.updateVertices(b,c),this.setColor(new AREColor3(255,255,255)),this.clearTexture()}return a.defaultFriction=.3,a.defaultMass=10,a.defaultElasticity=.2,a.prototype._initializeValues=function(){if(this._renderer.isWGLRendererActive()&&!(this._gl=this._renderer.getGL()))throw new Error("GL context is required for actor initialization!");return this._color=null,this._strokeColor=null,this._strokeWidth=1,this._colArray=null,this._opacity=1,this._needsDelete=!1,this._visible=!0,this.layer=0,this._physicsLayer=-1,this._id=-1,this._position={x:0,y:0},this._rotation=0,this._bounds={w:0,h:0},this._initializeModelMatrix(),this._updateModelMatrix(),this._physics=!1,this._friction=null,this._mass=null,this._elasticity=null,this._vertices=[],this._psyxVertices=[],this._texVerts=[],this._origTexVerts=[],this._vertBuffer=null,this._vertBufferFloats=null,this._sh_handles={},this._renderMode=ARERenderer.GL_MODE_TRIANGLE_FAN,this._renderStyle=ARERenderer.RENDER_STYLE_FILL,this._texture=null,this._clipRect=[0,0,1,1],this._attachedTexture=null,this.attachedTextureAnchor={clipRect:[0,0,1,1],x:0,y:0,width:0,height:0,angle:0}},a.prototype.getRenderer=function(){return this._renderer},a.prototype.flagForDelete=function(){return this._needsDelete=!0},a.prototype.flaggedForDeletion=function(){return this._needsDelete},a.prototype.destroy=function(){return this.flagForDelete()},a.prototype.rendererActorDelete=function(){var a,b,c,d;for(this.destroyPhysicsBody(),b=_.filter(this._renderer._actors,function(a){return!a.hasOwnIndiceBuffer()}),c=0,d=b.length;d>c;c++)a=b[c],a.getHostId()===this._id&&a.clearHostIndiceBuffer();return this._renderer.getGL().deleteBuffer(this._ownIndiceBuffer)},a.prototype.getIndiceBuffer=function(){return this._ownIndiceBuffer},a.prototype.getUsedIndiceBuffer=function(){return this._ownIndiceBuffer},a.prototype.setHostIndiceBuffer=function(a,b){return this._indiceBuffer=a,this._hostActorId=b,this._hasOwnIndiceBuffer=!1,this._renderer.requestVBORefresh()},a.prototype.getHostId=function(){return this._hostActorId},a.prototype.clearHostIndiceBuffer=function(){return this._indiceBuffer=this._ownIndiceBuffer,this._hasOwnIndiceBuffer=!0,this._hostActorId=null,this._renderer.requestVBORefresh()},a.prototype.hasOwnIndiceBuffer=function(){return this._hasOwnIndiceBuffer},a.prototype.getMaterial=function(){return this._material},a.prototype.getLayer=function(){return this.layer},a.prototype.setLayer=function(a){return this.layer=a,param.required(a),this._renderer.removeActor(this,!0),this._renderer.addActor(this,a)},a.prototype.hasTexture=function(){return!!this._texture},a.prototype.setTexture=function(a){if(param.required(a),!this._renderer.hasTexture(a))throw new Error("No such texture loaded: "+a);return this._texture=this._renderer.getTexture(a),this.setShader(this._renderer.getTextureShader()),this._material=ARERenderer.MATERIAL_TEXTURE,this},a.prototype.clearTexture=function(){return this._texture=void 0,this._texRepeatX=1,this._texRepeatY=1,this._renderer.getDefaultShader()&&this.setShader(this._renderer.getDefaultShader()),this._material=ARERenderer.MATERIAL_FLAT,this},a.prototype.getTexture=function(){return this._texture},a.prototype.getTextureRepeat=function(){return{x:this._texRepeatX,y:this._texRepeatY}},a.prototype.setShader=function(a){if(this._renderer.isWGLRendererActive()){if(param.required(a),!a.getProgram())throw new Error("Shader has to be built before it can be used!");return a.getHandles()||a.generateHandles(),this._sh_handles=a.getHandles()}},a.prototype.hasPhysics=function(){return this._physics},a.prototype.createPhysicsBody=function(b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q;if(this._mass=b,this._friction=c,this._elasticity=d,!this._physics&&null!==this._mass&&void 0!==this._mass){for(e=!!e,this._friction||(this._friction=a.defaultFriction),this._elasticity||(this._elasticity=a.defaultElasticity),this._mass<0&&(this._mass=0),this._friction&&(this._friction=0),this._elasticity<0&&(this._elasticity=0),m=[],l=0,j=null,j=this._psyxVertices.length>6?this._psyxVertices:this._vertices,i=p=0,q=j.length-1;q>p;i=p+=2)m.push(j[i]),m.push(j[i+1]),0===this._mass&&(n=m[m.length-2],o=m[m.length-1],f=this._rotation,m[m.length-2]=n*Math.cos(f)-o*Math.sin(f),m[m.length-1]=n*Math.sin(f)+o*Math.cos(f));return g=null,k={id:this._id,type:"Polygon",vertices:m,"static":!1,position:this._position,friction:this._friction,elasticity:this._elasticity,layer:this._physicsLayer},0===this._mass?(k["static"]=!0,k.position=this._position):(g={id:this._id,position:this._position,angle:this._rotation,mass:this._mass,momentV:{x:0,y:0},vertices:m},k.position={x:0,y:0}),this._physics=!0,window.AREPhysicsManager.sendMessage({},"physics.enable"),g&&(h=e?"physics.body.refresh":"physics.body.create",window.AREPhysicsManager.sendMessage({def:g,id:this._id},h)),k&&(h=e?"physics.shape.refresh":"physics.shape.create",window.AREPhysicsManager.sendMessage({def:k,id:this._id},h)),this}},a.prototype.destroyPhysicsBody=function(){return this._physics?(window.AREPhysicsManager.sendMessage({id:this._id},"physics.shape.remove"),0!==this._mass&&window.AREPhysicsManager.sendMessage({id:this._id},"physics.body.remove"),this._physics=!1,this):void 0},a.prototype.enablePhysics=function(){return this.hasPhysics()||this.createPhysicsBody(),this},a.prototype.disablePhysics=function(){return this.hasPhysics()&&this.destroyPhysicsBody,this},a.prototype.refreshPhysics=function(){return this.hasPhysics()?this.createPhysicsBody(this._mass,this._friction,this._elasticity,!0):void 0},a.prototype.getMass=function(){return this._mass},a.prototype.getElasticity=function(){return this._elasticity},a.prototype.getFriction=function(){return this._friction},a.prototype.setMass=function(a){return this._mass=a,this.refreshPhysics(),this},a.prototype.setElasticity=function(a){return this._elasticity=a,this.refreshPhysics(),this},a.prototype.setFriction=function(a){return this._friction=a,this.refreshPhysics(),this},a.prototype.getMass=function(){return this._mass},a.prototype.getElasticity=function(){return this._elasticity},a.prototype.getFriction=function(){return this._friction},a.prototype.setMass=function(a){return this._mass=a,this.refreshPhysics(),this},a.prototype.setElasticity=function(a){return this._elasticity=a,this.refreshPhysics(),this},a.prototype.setFriction=function(a){return this._friction=a,this.refreshPhysics(),this},a.prototype.getPhysicsLayer=function(){return this._physicsLayer.toString(2).length-1},a.prototype.setPhysicsLayer=function(a){return this._physicsLayer=1<<param.required(a,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]),window.AREPhysicsManager.sendMessage({id:this._id,layer:this._physicsLayer},"physics.shape.set.layer")},a.prototype.updateVertices=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;if(i=a||this._vertices,h=b||this._texVerts,i.length<6)throw new Error("At least 3 vertices make up an actor");if(h!==this._texVerts)if(i!==this._vertices){if(i.length!==h.length)throw new Error("Vert and UV count must match!")}else if(this._vertices.length!==h.length)throw new Error("Vert and UV count must match!");for(this._vertices=i,this._texVerts=h,this._origTexVerts=h,this._vertexData=[],c=j=0,l=this._vertices.length/2;l>=0?l>j:j>l;c=l>=0?++j:--j)this._vertexData.push(this._vertices[2*c]),this._vertexData.push(this._vertices[2*c+1]),this._vertexData.push(this._texVerts[2*c]),this._vertexData.push(this._texVerts[2*c+1]);for(this._vertCount=this._vertexData.length/4,d=0,e=0,f=0,g=0,c=k=1,m=this._vertices.length/2;m>=1?m>=k:k>=m;c=m>=1?++k:--k)d>this._vertices[2*c]&&(d=this._vertices[2*c]),f<this._vertices[2*c]&&(f=this._vertices[2*c]),e>this._vertices[2*c+1]&&(e=this._vertices[2*c+1]),g<this._vertices[2*c+1]&&(g=this._vertices[2*c+1]);return this._bounds={w:f-d,h:g-e},this._onSizeChange&&this._onSizeChange(this._bounds),this._renderer.requestVBORefresh()},a.prototype.updateIndices=function(a){var b;return b=new Uint16Array(a),this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._indiceBuffer),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,b,this._gl.STATIC_DRAW)},a.prototype.getRawVertexData=function(){return this._vertexData},a.prototype.setTextureRepeat=function(a,b){var c,d,e,f;for(a||(a=1),b||(b=1),d=[],c=e=0,f=this._origTexVerts.length;f>e;c=e+=2)d.push(this._origTexVerts[c]/this._texRepeatX*a),d.push(this._origTexVerts[c+1]/this._texRepeatY*b);return this._texRepeatX=a,this._texRepeatY=b,this.updateVertices(this._vertices,d),this},a.prototype.setPhysicsVertices=function(a){return this._psyxVertices=param.required(a),this.refreshPhysics()},a.prototype.attachTexture=function(a,b,c,d,e,f){if(param.required(a),param.required(b),param.required(c),this.attachedTextureAnchor.width=b,this.attachedTextureAnchor.height=c,this.attachedTextureAnchor.x=d||0,this.attachedTextureAnchor.y=e||0,this.attachedTextureAnchor.angle=f||0,!this._renderer.hasTexture(a))throw new Error("No such texture loaded: "+a);return this._attachedTexture&&this.removeAttachment(),this._attachedTexture=new ARERectangleActor(b,c),this._attachedTexture.setTexture(a),this._attachedTexture},a.prototype.removeAttachment=function(){return this._attachedTexture?(this._attachedTexture.destroy(),!0):!1},a.prototype.setAttachmentVisibility=function(a){return param.required(a),this._attachedTexture?(this._attachedTexture._visible=a,!0):!1},a.prototype.hasAttachment=function(){return null!==this._attachedTexture},a.prototype.getAttachment=function(){return this._attachedTexture},a.prototype.updateAttachment=function(){var a,b,c;return this.hasAttachment()&&this.getAttachment()._visible?(b=this.getPosition(),c=this.getRotation(),b.x+=this.attachedTextureAnchor.x,b.y+=this.attachedTextureAnchor.y,c+=this.attachedTextureAnchor.angle,a=this.getAttachment(),a.setPosition(b),a.setRotation(c),a):this},a.prototype.wglBindTexture=function(a){return this._renderer._currentTexture=this._texture.texture,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this._texture.texture),a.uniform1i(this._sh_handles.uSampler,0),this},a.prototype._updateModelMatrix=function(){var a,b,c,d;return c=this._position,b=this._renderer.getCameraPosition(),d=Math.sin(this._rotation),a=Math.cos(this._rotation),this._modelM[0]=a,this._modelM[1]=d,this._modelM[4]=-d,this._modelM[5]=a,this._modelM[12]=c.x-b.x,this._modelM[13]=c.y-b.y},a.prototype._initializeModelMatrix=function(){return this._modelM=[16],this._modelM[2]=0,this._modelM[3]=0,this._modelM[6]=0,this._modelM[7]=0,this._modelM[8]=0,this._modelM[9]=0,this._modelM[10]=1,this._modelM[11]=0,this._modelM[14]=1,this._modelM[15]=1},a.prototype.wglDraw=function(a,b){var c;if(this._visible){switch(this._updateModelMatrix(),b&&(c=this._sh_handles,this._sh_handles=b.getHandles()),a.uniformMatrix4fv(this._sh_handles.uModelView,!1,this._modelM),a.uniform4f(this._sh_handles.uColor,this._colArray[0],this._colArray[1],this._colArray[2],1),this._sh_handles.uClipRect&&a.uniform4fv(this._sh_handles.uClipRect,this._clipRect),a.uniform1f(this._sh_handles.uOpacity,this._opacity),a.enableVertexAttribArray(this._sh_handles.aPosition),a.vertexAttribPointer(this._sh_handles.aPosition,2,a.FLOAT,!1,this._vertStride,0),void 0!==this._sh_handles.aTexCoord&&(a.enableVertexAttribArray(this._sh_handles.aTexCoord),a.vertexAttribPointer(this._sh_handles.aTexCoord,2,a.FLOAT,!1,this._vertStride,this._uvOffset)),this._renderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE&&this._renderer._currentTexture!==this._texture.texture&&this.wglBindTexture(a),this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._indiceBuffer),this._renderMode){case ARERenderer.GL_MODE_LINE_LOOP:a.drawElements(a.LINE_LOOP,this._vertCount,a.UNSIGNED_SHORT,0);break;case ARERenderer.GL_MODE_TRIANGLE_FAN:a.drawElements(a.TRIANGLE_FAN,this._vertCount,a.UNSIGNED_SHORT,0);break;case ARERenderer.GL_MODE_TRIANGLE_STRIP:a.drawElements(a.TRIANGLE_STRIP,this._vertCount,a.UNSIGNED_SHORT,0);break;default:throw new Error("Invalid render mode! "+this._renderMode)}return b&&(this._sh_handles=c),this}},a.prototype.cvSetupStyle=function(a){var b,c,d,e;return a.lineWidth=null!==this._strokeWidth?this._strokeWidth:1,this._strokeColor?(e=Number(this._strokeColor._r).toFixed(0),d=Number(this._strokeColor._g).toFixed(0),c=Number(this._strokeColor._b).toFixed(0),b=Number(this._opacity).toFixed(4),a.strokeStyle="rgba("+e+","+d+","+c+","+b+")"):a.strokeStyle="#FFF",this._renderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE||(this._color?(e=Number(this._color._r).toFixed(0),d=Number(this._color._g).toFixed(0),c=Number(this._color._b).toFixed(0),b=Number(this._opacity).toFixed(4),a.fillStyle="rgba("+e+","+d+","+c+","+b+")"):a.fillStyle="#FFF"),this},a.prototype.cvDraw=function(a){var b,c,d;if(this._visible){for(this._updateModelMatrix(),a.translate(this._modelM[12],a.canvas.clientHeight-this._modelM[13]),a.beginPath(),a.rotate(this._rotation),a.moveTo(this._vertices[0],this._vertices[1]),b=c=1,d=this._vertices.length/2;d>=1?d>=c:c>=d;b=d>=1?++c:--c)a.lineTo(this._vertices[2*b],this._vertices[2*b+1]);switch(a.closePath(),this.cvSetupStyle(a),a.scale(1,-1),this._renderMode){case ARERenderer.GL_MODE_LINE_LOOP:a.stroke();break;case ARERenderer.GL_MODE_TRIANGLE_STRIP:case ARERenderer.GL_MODE_TRIANGLE_FAN:(this._renderStyle&ARERenderer.RENDER_STYLE_STROKE)>0&&a.stroke(),(this._renderStyle&ARERenderer.RENDER_STYLE_FILL)>0&&(this._renderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE?(a.clip(),a.drawImage(this._texture.texture,-this._bounds.w/2,-this._bounds.h/2,this._bounds.w,this._bounds.h)):a.fill());break;default:throw new Error("Invalid render mode! "+this._renderMode)}return this}},a.prototype.nullDraw=function(){return this._visible?this:void 0},a.prototype.setRenderMode=function(a){return this._renderMode=a,this},a.prototype.setRenderStyle=function(a){return this._renderStyle=a,this},a.prototype.setOpacity=function(a){return this._opacity=a,this},a.prototype.setOnOrientationChange=function(a){return this._onOrientationChange=a},a.prototype.setOnSizeChange=function(a){return this._onSizeChange=a},a.prototype.setPosition=function(a){return this._position=param.required(a),this.hasPhysics()&&window.AREPhysicsManager.sendMessage({id:this._id,position:a},"physics.body.set.position"),this._onOrientationChange&&this._onOrientationChange({position:this._position}),this},a.prototype.setRotation=function(a,b){return param.required(a),b=!!b,b||(a=.0174532925*Number(a)),this._rotation!==a?(this._rotation=a,this.hasPhysics()&&(this._mass>0?window.AREPhysicsManager.sendMessage({id:this._id,rotation:this._rotation},"physics.body.set.rotation"):this.refreshPhysics()),this._onOrientationChange&&this._onOrientationChange({rotation:this._rotation}),this):void 0},a.prototype.setStrokeWidth=function(a){return this._strokeWidth=Number(a),this},a.prototype.setColor_ext=function(a,b,c,d){return param.required(b),b instanceof AREColor3?(a.setR(b.getR()),a.setG(b.getG()),a.setB(b.getB())):(void 0!==b.g&&void 0!==b.b?(c=b.g,d=b.b,b=b.r):(param.required(c),param.required(d)),a.setR(Number(b)),a.setG(Number(c)),a.setB(Number(d))),this},a.prototype.setColor=function(a,b,c){return param.required(a),this._color||(this._color=new AREColor3),this.setColor_ext(this._color,a,b,c),this._colArray=[this._color.getR(!0),this._color.getG(!0),this._color.getB(!0)],this},a.prototype.setStrokeColor=function(a,b,c){return param.required(a),this._strokeColor||(this._strokeColor=new AREColor3),this.setColor_ext(this._strokeColor,a,b,c),this._strokeColorArray=[this._strokeColor.getR(!0),this._strokeColor.getG(!0),this._strokeColor.getB(!0)],this},a.prototype.setVisible=function(a){return this._visible=a,this},a.prototype.getOpacity=function(){return this._opacity},a.prototype.getPosition=function(){return this._position},a.prototype.getBounds=function(){return this._bounds},a.prototype.getRotation=function(a){return a?this._rotation:57.2957795*this._rotation},a.prototype.getVertices=function(){return this._vertices},a.prototype.getId=function(){return this._id},a.prototype.getColor=function(){return new AREColor3(this._color)},a.prototype.getVisible=function(){return this._visible},a.updateCount=0,a.lastTime=Date.now(),a.prototype.receiveMessage=function(a,b){var c;if(-1!==b.indexOf("actor.")&&a.id&&a.id===this._id)switch(c=b.split("."),c[1]){case"update":if(this._position=a.position,this._rotation=a.rotation,this._onOrientationChange)return this._onOrientationChange({position:this._position,rotation:this._rotation})}},a}(),ARERectangleActor=function(a){function b(a,c,d){var e,f;if(this.width=c,this.height=d,param.required(c),param.required(d),0>=c)throw new Error("Invalid width: "+c);if(0>=d)throw new Error("Invalid height: "+d);f=this.generateVertices(),e=this.generateUVs(),b.__super__.constructor.call(this,a,f,e)}return __extends(b,a),b.prototype.generateVertices=function(){var a,b;return b=this.width/2,a=this.height/2,[-b,-a,-b,a,b,a,b,-a,-b,-a]},b.prototype.generateUVs=function(){return[0,1,0,0,1,0,1,1,0,1]},b.prototype.getWidth=function(){return this.width},b.prototype.getHeight=function(){return this.height},b.prototype.setWidth=function(a){return this.width=a,this.updateVertices(this.generateVertices())},b.prototype.setHeight=function(a){return this.height=a,this.updateVertices(this.generateVertices())},b}(ARERawActor),AREPolygonActor=function(a){function b(a,c,d){var e,f,g;if(this.radius=c,this.segments=d,param.required(c),this.radius instanceof Array)this._verts=this.radius,this.radius=null,f=this.generateUVs(this._verts),b.__super__.constructor.call(this,a,this._verts,f),this.setPhysicsVertices(this._verts);else{if(param.required(d),0>=c)throw new Error("Invalid radius: "+c);if(2>=d)throw new ERror("Invalid segment count: "+d);g=this.generateVertices(),e=this.generateVertices({mode:"physics"}),f=this.generateUVs(g),b.__super__.constructor.call(this,a,g,f),this.setPhysicsVertices(e)}this.setRenderMode(ARERenderer.GL_MODE_TRIANGLE_FAN),this.validateCacheEntry()}return __extends(b,a),b._INDICE_BUFFER_CACHE={},b._VERTEX_CACHE={},b._UV_CACHE={},b.prototype.generateVertices=function(a){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(a||(a={}),c=""+this.radius+"."+this.segments+"."+a.mode,d=b._VERTEX_CACHE[c])return d;for(l=this.radius,m=0,h=6.2831852/this.segments,g=Math.tan(h),f=Math.cos(h),k=[],e=n=0,p=this.segments;p>=0?p>n:n>p;e=p>=0?++n:--n)k[2*e]=l,k[2*e+1]=m,i=-m,j=l,l+=i*g,m+=j*g,l*=f,m*=f;for(k.push(k[0]),k.push(k[1]),r=[],e=o=0,q=k.length;q>o;e=o+=2)r.push(k[k.length-2-e]),r.push(k[k.length-1-e]);return k=r,"physics"!==a.mode&&(k.push(0),k.push(0)),b._VERTEX_CACHE[c]=k,k},b.prototype.generateUVs=function(a){var c,d,e,f,g,h;if(param.required(a),c=""+this.radius+"."+this.segments,d=b._UV_CACHE[c])return d;for(e=[],g=0,h=a.length;h>g;g++)f=a[g],e.push(f/this.radius/2+.5);return b._UV_CACHE[c]=e,e},b.prototype.fullVertRefresh=function(){var a,b,c;return c=this.generateVertices(),a=this.generateVertices({mode:"physics"}),b=this.generateUVs(c),this.updateVertices(c,b),this.setPhysicsVertices(a)},b.prototype.validateCacheEntry=function(){var a,c;return a=""+this.radius+"."+this.segments,b._INDICE_BUFFER_CACHE[a]?(c=b._INDICE_BUFFER_CACHE[a],this.setHostIndiceBuffer(c.getIndiceBuffer(),c.getId())):(b._INDICE_BUFFER_CACHE[a]=this,this.clearHostIndiceBuffer())},b.prototype.destroy=function(){var a;return a=""+this.radius+"."+this.segments,b._INDICE_BUFFER_CACHE[a]===this&&(b._INDICE_BUFFER_CACHE[a]=null),b.__super__.destroy.call(this)},b.prototype.getRadius=function(){return this.radius},b.prototype.getSegments=function(){return this.segments},b.prototype.setRadius=function(a){if(this.radius=a,0>=a)throw new Error("Invalid radius: "+a);return this.fullVertRefresh(),this.validateCacheEntry()},b.prototype.setSegments=function(a){if(this.segments=a,2>=a)throw new ERror("Invalid segment count: "+a);return this.fullVertRefresh(),this.validateCacheEntry()},b}(ARERawActor),ARECircleActor=function(a){function b(a,c){this.radius=c,b.__super__.constructor.call(this,a,c,32),delete this.setSegments,delete this.getSegments}return __extends(b,a),b}(AREPolygonActor),ARETriangleActor=function(a){function b(a,c,d){var e,f;if(this.base=c,this.height=d,param.required(c),param.required(d),0>=c)throw new Error("Invalid base: "+c);if(0>=d)throw new Error("Invalid height: "+d);f=this.generateVertices(),e=this.generateUVs(),b.__super__.constructor.call(this,a,f,e)}return __extends(b,a),b.prototype.generateVertices=function(){var a,b;return a=this.base/2,b=this.height/2,[-a,-b,0,b,a,-b,-a,-b]},b.prototype.generateUVs=function(){return[0,1,0,0,1,0,1,1]},b.prototype.getBase=function(){return this.base},b.prototype.getHeight=function(){return this.height},b.prototype.setBase=function(a){return this.base=a,this.updateVertices(this.generateVertices())},b.prototype.setHeight=function(a){return this.height=a,this.updateVertices(this.generateVertices())},b}(ARERawActor),AREColor3=function(){function a(b,c,d){b||(b=0),c||(c=0),d||(d=0),b instanceof a?(this._r=b.getR(),this._g=b.getG(),this._b=b.getB()):(this.setR(b),this.setG(c),this.setB(d))}return a.prototype.getR=function(a){return a!==!0?this._r:this._r/255},a.prototype.getG=function(a){return a!==!0?this._g:this._g/255},a.prototype.getB=function(a){return a!==!0?this._b:this._b/255},a.prototype.setR=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._r=a},a.prototype.setG=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._g=a},a.prototype.setB=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._b=a},a.prototype.toString=function(){return"("+this._r+", "+this._g+", "+this._b+")"},a}(),AREShader=function(){function a(a,b,c,d){var e;if(this._vertSrc=a,this._fragSrc=b,this._gl=c,param.required(this._vertSrc),param.required(this._fragSrc),param.required(this._gl),d=!!d,this.errors=[],this._prog=null,this._vertShader=null,this._fragShader=null,this._handles=null,d===!0&&(e=this.build(this._gl),e===!1))throw new Error("Failed to build shader! "+JSON.stringify(this.errors))}return a.prototype.build=function(a){var b;if(this._gl=a,param.required(this._gl),b=this._gl,this.errors=[],void 0===b||null===b)throw new Error("Need a valid gl object to build a shader!");return this._vertShader=b.createShader(b.VERTEX_SHADER),this._fragShader=b.createShader(b.FRAGMENT_SHADER),b.shaderSource(this._vertShader,this._vertSrc),b.shaderSource(this._fragShader,this._fragSrc),b.compileShader(this._vertShader),b.compileShader(this._fragShader),b.getShaderParameter(this._vertShader,b.COMPILE_STATUS)||this.errors.push(b.getShaderInfoLog(this._vertShader)),b.getShaderParameter(this._fragShader,b.COMPILE_STATUS)||this.errors.push(b.getShaderInfoLog(this._fragShader)),this._prog=b.createProgram(),b.attachShader(this._prog,this._vertShader),b.attachShader(this._prog,this._fragShader),b.linkProgram(this._prog),b.getProgramParameter(this._prog,b.LINK_STATUS)||this.errors.push("Failed to link!"),this.errors.length>0?!1:!0},a.prototype.generateHandles=function(){var a,b,c,d,e,f,g,h,i;if(null===this._prog)return AREEngine.getLog().error("Build program before generating handles"),!1;if(null!==this._handles)return AREEngine.getLog().warn("Refusing to re-generate handles!"),!1;for(this._handles={},h=function(a,b,c){var d,e;if(a=a.split(" "),d=a[a.length-1].replace(";",""),1===b){if(e={n:d,h:c._gl.getUniformLocation(c._prog,d)},"object"!=typeof e.h)throw new Error("Failed to get handle for uniform "+d+" ["+e.h+"]");return e}if(2===b)return e={n:d,h:c._gl.getAttribLocation(c._prog,d)};throw new Error("Type not 1 or 2, WTF, internal error")},i=[this._vertSrc,this._fragSrc],d=0,f=i.length;f>d;d++)for(c=i[d],c=c.split(";"),e=0,g=c.length;g>e&&(b=c[e],-1===b.indexOf("main()"));e++)-1!==b.indexOf("attribute")?(a=h(b,2,this),this._handles[a.n]=a.h):-1!==b.indexOf("uniform")&&(a=h(b,1,this),this._handles[a.n]=a.h);return!0},a.prototype.getHandles=function(){return this._handles},a.prototype.getProgram=function(){return this._prog},a}(),AREVector2=function(){function a(){this.x||(this.x=0),this.y||(this.y=0)}return a.prototype.random=function(b){var c,d,e,f;return b||(b={}),c=!!b.bipolar,d=b.seed||65535*Math.random(),e=Math.random()*this.x,f=Math.random()*this.y,c&&(Math.random()<.5&&(e=-e),Math.random()<.5&&(f=-f)),new a(e,f)},a.prototype.add=function(b){return new a(this.x+b.x,this.y+b.y)},a.prototype.sub=function(b){return new a(this.x-b.x,this.y-b.y)},a.prototype.mul=function(b){return new a(this.x*b.x,this.y*b.y)},a.prototype.div=function(b){return new a(this.x/b.x,this.y/b.y)},a.prototype.floor=function(){return new a(Math.floor(this.x),Math.floor(this.y))},a.prototype.ceil=function(){return new a(Math.ceil(this.x),Math.ceil(this.y))},a.zero=function(){return new a(0,0)},a}(),AREShader.shaders={},AREShader.shaders.wire={},AREShader.shaders.solid={},AREShader.shaders.texture={},precision="mediump",varying_precision="mediump",precision_declaration="precision "+precision+" float;",AREShader.shaders.wire.vertex=""+precision_declaration+"\n\nattribute vec2 aPosition;\n\nuniform mat4 uProjection;\nuniform mat4 uModelView;\n\nvoid main() {\n  gl_Position = uProjection * uModelView * vec4(aPosition, 1, 1);\n}",AREShader.shaders.wire.fragment=""+precision_declaration+"\n\nuniform vec4 uColor;\nuniform float uOpacity;\n\nvoid main() {\n  vec4 frag = uColor;\n  frag.a *= uOpacity;\n  gl_FragColor = frag;\n}",AREShader.shaders.solid.vertex=AREShader.shaders.wire.vertex,AREShader.shaders.solid.fragment=""+precision_declaration+"\n\nuniform vec4 uColor;\nuniform float uOpacity;\n\nvoid main() {\n  vec4 frag = uColor;\n  frag.a *= uOpacity;\n  gl_FragColor = frag;\n}",AREShader.shaders.texture.vertex=""+precision_declaration+"\n\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nuniform mat4 uProjection;\nuniform mat4 uModelView;\n\nvarying "+varying_precision+" vec2 vTexCoord;\n\nvoid main() {\n  gl_Position = uProjection * uModelView * vec4(aPosition, 1, 1);\n  vTexCoord = aTexCoord;\n}",AREShader.shaders.texture.fragment=""+precision_declaration+"\n\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform float uOpacity;\nuniform vec4 uClipRect;\n\nvarying "+varying_precision+" vec2 vTexCoord;\n\nvoid main() {\n  vec4 baseColor = texture2D(uSampler,\n                             uClipRect.xy +\n                             vTexCoord * uClipRect.zw);\n  // baseColor *= uColor;\n  baseColor.a *= uOpacity;\n\n  gl_FragColor = baseColor;\n}",ARERenderer=function(){function a(b){var c,d,e;if(this._width=param.required(b.width),this._height=param.required(b.height),c=b.canvasId||"",d=b.renderMode||a.RENDER_MODE_WGL,b.premultipliedAlpha||(b.premultipliedAlpha=!0),b.antialias||(b.antialias=!0),b.alpha||(b.alpha=!0),b.depth||(b.depth=!0),b.stencil||(b.stencil=!1),this._alwaysClearScreen=!!b.preserveDrawingBuffer,this._nextID=0,this._defaultShader=null,this._canvas=null,this._ctx=null,this._gl=null,this._actors=[],this._actor_hash={},this._textures=[],this._currentMaterial="none",this._activeRendererMode=null,this._cameraPosition={x:0,y:0},this._zoomFactor=1,this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderSelectionRect=null,this._pickRenderCB=null,this._clearColor=new AREColor3(255,255,255),e=function(a){return function(b,c){var d;return a._canvas=document.createElement("canvas"),a._canvas.width=a._width,a._canvas.height=a._height,a._canvas.id=c,d=document.querySelector(b),d||(d=document.getElementById(b)),d.appendChild(a._canvas),ARELog.info("Creating canvas #"+c+" ["+a._width+"x"+a._height+"] <"+b+">")}}(this),c?(this._canvas=document.getElementById(c),this._canvas?"canvas"===this._canvas.nodeName.toLowerCase()?(this._canvas.width=this._width,this._canvas.height=this._height):e(c,"are_canvas"):e("body",c)):e("body","are_anvas"),!this._canvas)throw new Error("Failed to create or find suitable canvas!");switch(d){case a.RENDER_MODE_NULL:this._initializeNullRendering();break;case a.RENDER_MODE_CANVAS:this._initializeCanvasRendering();break;case a.RENDER_MODE_WGL:this._initializeWebGLRendering(b)||(ARELog.info("Falling back on regular canvas renderer"),this._initializeCanvasRendering());break;default:throw new Error("Invalid Renderer "+rendererMode)}ARELog.info("Using the "+this._activeRendererMode+" renderer mode"),this.setClearColor(255,255,255),this.switchMaterial(a.MATERIAL_FLAT)}return a.RENDER_MODE_NULL=0,a.RENDER_MODE_CANVAS=1,a.RENDER_MODE_WGL=2,a.GL_MODE_LINE_LOOP=0,a.GL_MODE_TRIANGLE_FAN=1,a.GL_MODE_TRIANGLE_STRIP=2,a.RENDER_STYLE_STROKE=1,a.RENDER_STYLE_FILL=2,a.RENDER_STYLE_FILL_AND_STROKE=3,a.MATERIAL_NONE="none",a.MATERIAL_FLAT="flat",a.MATERIAL_TEXTURE="texture",a.prototype._initializeWebGLRendering=function(b){var c,d,e,f,g,h,i;return this._gl=this._canvas.getContext("webgl",b),this._gl||(ARELog.warn("Continuing with experimental webgl support"),this._gl=this._canvas.getContext("experimental-webgl",b)),this._gl?(ARELog.info("Obtained WebGL context"),this._gl.enable(this._gl.DEPTH_TEST),this._gl.enable(this._gl.BLEND),this._gl.depthFunc(this._gl.LEQUAL),this._gl.blendFunc(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),e=this._clearColor.getR(!0),d=this._clearColor.getG(!0),c=this._clearColor.getB(!0),this._gl.clearColor(e,d,c,1),f=AREShader.shaders,i=f.wire,g=f.solid,h=f.texture,this._defaultShader=new AREShader(g.vertex,g.fragment,this._gl,!0),this._defaultShader.generateHandles(),this._wireShader=new AREShader(i.vertex,i.fragment,this._gl,!0),this._wireShader.generateHandles(),this._texShader=new AREShader(h.vertex,h.fragment,this._gl,!0),this._texShader.generateHandles(),ARELog.info("Initialized shaders"),this._activeRendererMode=a.RENDER_MODE_WGL,this.render=this._wglRender,this._pendingVBORefresh=!1,this._vertexDataBuffer=this._gl.createBuffer(),this.requestVBORefresh(),ARELog.info("WebgL renderer initialized"),!0):(ARELog.warn("Failed to obtain WebGL context"),!1)},a.prototype._initializeCanvasRendering=function(){return this._ctx=this._canvas.getContext("2d"),this._activeRendererMode=a.RENDER_MODE_CANVAS,this.render=this._cvRender,ARELog.info("Canvas renderer initialized"),!0},a.prototype._initializeNullRendering=function(){return this._ctx=this._canvas.getContext("2d"),this._activeRendererMode=a.RENDER_MODE_NULL,this.render=this._nullRender,ARELog.info("Null renderer initialized"),!0},a.prototype.render=function(){},a.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;for(i=_.remove(this._actors,function(a){return a.flaggedForDeletion()}),n=0,r=i.length;r>n;n++)b=i[n],b.rendererActorDelete();if(this._pendingVBORefresh&&this.isWGLRendererActive()){for(h=0,k=[],g=[],l=0,u=this._actors,o=0,s=u.length;s>o;o++)e=u[o],e.hasOwnIndiceBuffer()&&(l+=e.getRawVertexData().length);
for(a=new Float32Array(l),v=this._actors,p=0,t=v.length;t>p;p++)if(e=v[p],e.hasOwnIndiceBuffer()){for(m=e.getRawVertexData(),k=[],j=q=0,w=m.length/4;w>=0?w>q:q>w;j=w>=0?++q:--q)f=h+j,k.push(f),c=4*f,d=4*j,a[c]=m[d],a[c+1]=m[d+1],a[c+2]=m[d+2],a[c+3]=m[d+3];h+=m.length/4,e.updateIndices(k)}return this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vertexDataBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,a,this._gl.STATIC_DRAW),this._pendingVBORefresh=!1}},a.prototype.requestVBORefresh=function(){return this._pendingVBORefresh=!0},a.prototype.getDefaultShader=function(){return this._defaultShader},a.prototype.getWireShader=function(){return this._wireShader},a.prototype.getTextureShader=function(){return this._texShader},a.prototype.getCanvas=function(){return this._canvas},a.prototype.getContext=function(){return this._ctx},a.prototype.getWidth=function(){return this._width},a.prototype.getHeight=function(){return this._height},a.prototype.setCameraPosition=function(a){this._cameraPosition=a},a.prototype.getCameraPosition=function(){return{x:this._cameraPosition.x,y:this._cameraPosition.y}},a.prototype.setCameraZoom=function(a){var b;return this._zoomFactor=a,(b=this.getShaderForMaterial(this._currentMaterial))?this.refreshViewport(b):void 0},a.prototype.getCameraZoom=function(){return this._zoomFactor},a.prototype.getClearColor=function(){return this._clearColor},a.prototype.setClearColor=function(b,c,d){var e;return this._clearColor||(this._clearColor=new AREColor3),b instanceof AREColor3?this._clearColor=b:(this._clearColor.setR(b||0),this._clearColor.setG(c||0),this._clearColor.setB(d||0)),this._activeRendererMode===a.RENDER_MODE_WGL&&(e=this._clearColor.getR(!0),c=this._clearColor.getG(!0),d=this._clearColor.getB(!0),this._gl&&this._gl.clearColor(e,c,d,1)),this},a.prototype.requestPickingRenderWGL=function(a,b){return param.required(a),param.required(b),this._pickRenderRequested?ARELog.warn("Pick render already requested! No request queue"):(this._pickRenderBuff=a,this._pickRenderSelectionRect=null,this._pickRenderCB=b,this._pickRenderRequested=!0,this)},a.prototype.requestPickingRenderCanvas=function(a,b){return param.required(a),param.required(b),this._pickRenderRequested?ARELog.warn("Pick render already requested! No request queue"):(this._pickRenderBuff=null,this._pickRenderSelectionRect=a,this._pickRenderCB=b,this._pickRenderRequested=!0,this)},a.prototype._wglRender=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(h=this._gl,this._pickRenderRequested&&h.bindFramebuffer(h.FRAMEBUFFER,this._pickRenderBuff),this._alwaysClearScreen&&h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT),d=this._actors.length,e=this._actors.length,this._pickRenderRequested){for(;e--;)b=this._actors[d-e-1],b._visible&&(c=b._id,p={r:b._color._r,g:b._color._g,b:b._color._b},q=b._opacity,n=c-255*Math.floor(c/255),o=Math.floor(c/255),this.switchMaterial(a.MATERIAL_FLAT),b.setColor(n,o,248),b.setOpacity(1),b.wglDraw(h,this._defaultShader),b.setColor(p.r,p.g,p.b),b.setOpacity(q));this._pickRenderCB(),this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderCB=null,h.bindFramebuffer(h.FRAMEBUFFER,null),this.render()}else for(m=window.innerWidth*this._zoomFactor*.5,l=window.innerHeight*this._zoomFactor*.5,i=j=k=f=!0,g=this._cameraPosition;e--;)b=this._actors[d-e-1],b._visible&&(i=b._position.x-g.x+b._bounds.w/2<-m,j=b._position.x-g.x-b._bounds.w/2>m,k=b._position.y-g.y+b._bounds.h/2<-l,f=b._position.y-g.y-b._bounds.h/2>l,f||k||i||j||(b._attachedTexture&&(b=b.updateAttachment()),b._material!==this._currentMaterial&&this.switchMaterial(b._material),b.wglDraw(h)));return this},a.prototype._cvRender=function(){var b,c,d,e,f,g,h,i,j,k,l;if(this._ctx){for(c=this._ctx,this._clearColor?(c.fillStyle="rgb"+this._clearColor,c.fillRect(0,0,this._width,this._height)):c.clearRect(0,0,this._width,this._height),c.save(),c.translate(0,this._height),c.scale(1,-1),j=this._actors,f=0,i=j.length;i>f;f++)b=j[f],c.save(),this._pickRenderRequested?(k=b._color,k={r:k._r,g:k._g,b:k._b},l=b._opacity,g=b.getId()-255*Math.floor(b.getId()/255),h=Math.floor(b.getId()/255),this.switchMaterial(a.MATERIAL_FLAT),b.setColor(g,h,248),b.setOpacity(1),b.cvDraw(c),b.setColor(k.r,k.g,k.b),b.setOpacity(l)):(b=b.updateAttachment(),(d=b.getMaterial())!==this._currentMaterial&&this.switchMaterial(d),b.cvDraw(c)),c.restore();return c.restore(),this._pickRenderRequested&&(e=this._pickRenderSelectionRect,this._pickRenderCB(c.getImageData(e.x,e.y,e.width,e.height)),this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderSelectionRect=null,this._pickRenderCB=null,this.render()),this}},a.prototype._nullRender=function(){var a,b,c,d,e;if(this._ctx){for(b=this._ctx,this._clearColor?(b.fillStyle="rgb"+this._clearColor,b.fillRect(0,0,this._canvas.width,this._canvas.height)):b.clearRect(0,0,this._canvas.width,this._canvas.height),e=this._actors,c=0,d=e.length;d>c;c++)a=e[c],a=a.updateAttachment(),a.nullDraw(b);return this}},a.prototype.clearScreen=function(){switch(this._activeRendererMode){case a.RENDER_MODE_CANVAS:this._clearColor?(this._ctx.fillStyle="rgb"+this._clearColor,this._ctx.fillRect(0,0,this._width,this._height)):this._ctx.clearRect(0,0,this._width,this._height);break;case a.RENDER_MODE_WGL:this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT)}return this},a.prototype.getActiveRendererMode=function(){return this._activeRendererMode},a.prototype.isNullRendererActive=function(){return this._activeRendererMode===a.RENDER_MODE_NULL},a.prototype.isCanvasRendererActive=function(){return this._activeRendererMode===a.RENDER_MODE_CANVAS},a.prototype.isWGLRendererActive=function(){return this._activeRendererMode===a.RENDER_MODE_WGL},a.prototype.getNextId=function(){return this._nextID++},a.prototype.getGL=function(){return this._gl},a.prototype.addActor=function(a,b){var c;return param.required(a),a.layer=b||a.layer,c=_.sortedIndex(this._actors,a,"layer"),this._actors.splice(c,0,a),this._actor_hash[a.getId()]=a,a},a.prototype.removeActor=function(a){var b;return param.required(a),a instanceof ARERawActor&&(a=a.getId()),b=_.remove(this._actors,function(b){return b.getId()===a})[0],!!b},a.prototype.makeOrthoMatrix=function(a,b,c,d,e,f){return new Float32Array([2/(b-a),0,0,0,0,2/(d-c),0,0,0,0,-2/(f-e),0,-(b+a)/(b-a),-(d+c)/(d-c),-(f+e)/(f-e),1])},a.prototype.refreshViewport=function(a){var b,c,d,e;return e=this._width*this._zoomFactor,c=this._height*this._zoomFactor,d=this.makeOrthoMatrix(-e/2,e/2,c/2,-c/2,-10,10),b=a.getHandles(),this._gl.uniformMatrix4fv(b.uProjection,!1,d)},a.prototype.getShaderForMaterial=function(b){switch(b){case a.MATERIAL_FLAT:return this._defaultShader;case a.MATERIAL_TEXTURE:return this._texShader;default:return null}},a.prototype.switchMaterial=function(a){var b;if(param.required(a),a===this._currentMaterial)return!1;if(this.isWGLRendererActive()){if(!(b=this.getShaderForMaterial(a)))throw new Error("Unknown material "+a);this._gl.useProgram(b.getProgram()),this.refreshViewport(b)}return this._currentMaterial=a,this},a.prototype.hasTexture=function(a){return!!_.find(this._textures,function(b){return b.name===a})},a.prototype.getTexture=function(a){return param.required(a),_.find(this._textures,function(b){return b.name===a})},a.prototype.getTextureSize=function(a){var b;return param.required(a),(b=this.getTexture(a))?{w:b.width*b.scaleX,h:b.height*b.scaleY}:null},a.prototype.addTexture=function(a){return param.required(a),param.required(a.name),param.required(a.texture),this._textures.push(a),this},a}(),PhysicsManager=function(){function a(a,b,c){var d;this._renderer=a,param.required(a),param.required(b),this._backlog=[],d=[{raw:"cp = exports = {};"},{url:b.chipmunk},{url:b.physics_worker}],async.map(d,function(a,b){var c;return a.raw?b(null,a.raw):(c=new XMLHttpRequest,c.open("GET",a.url,!0),c.onerror=function(a){return b("Connection error: "+a,null)},c.onload=function(){return c.status>=200&&c.status<400?b(null,c.responseText):b("Request returned "+c.status,null)},c.send())},function(a){return function(b,d){return a._initFromSources(d),a._emptyBacklog(),c?c():void 0}}(this))}return a.prototype._initFromSources=function(a){var b;if(!this._worker)return b=new Blob([a.join("\n\n")],{type:"text/javascript"}),this._worker=new Worker((URL||window.webkitURL).createObjectURL(b)),this._worker.postMessage(""),this._connectWorkerListener()},a.prototype._emptyBacklog=function(){var a,b,c,d,e;if(this._worker){for(d=this._backlog,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.sendMessage(a.message,a.command));return e}},a.prototype.sendMessage=function(a,b){return this._worker?this._worker.postMessage({message:a,command:b}):this._backlog.push({message:a,command:b})},a.prototype._connectWorkerListener=function(){var a,b,c,d,e,f;return a=0,b=1,c=2,e={},f={},d={},this._worker.onmessage=function(g){return function(h){var i,j;if(e=h.data,e.length){for(i=e.length,j=[];i--;)f=e[i],d=g._renderer._actor_hash[f[a]],d._position=f[b],d._rotation=f[c],j.push(d._updateModelMatrix());return j}}}(this)},a}(),ARELog=function(){function a(){}return a.tags=["","[Error]> ","[Warning]> ","[Debug]> ","[Info]> "],a.level=4,a.w=function(b,c){var d;return d=a,b>d.level||0===b||0===d.level?void 0:1===b&&void 0!==console.error?console.error?console.error(""+d.tags[b]+c):console.log(""+d.tags[b]+c):2===b&&void 0!==console.warn?console.warn?console.warn(""+d.tags[b]+c):console.log(""+d.tags[b]+c):3===b&&void 0!==console.debug?console.debug?console.debug(""+d.tags[b]+c):console.log(""+d.tags[b]+c):4===b&&void 0!==console.info?console.info?console.info(""+d.tags[b]+c):console.log(""+d.tags[b]+c):console.log(b>4&&void 0!==d.tags[b]?""+d.tags[b]+c:c)},a.error=function(a){return this.w(1,a)},a.warn=function(a){return this.w(2,a)},a.debug=function(a){return this.w(3,a)},a.info=function(a){return this.w(4,a)},a}(),AREBezAnimation=function(){function a(a,b,c){this.actor=a,c=!!c,this.options=param.required(b),this._duration=param.required(b.duration),param.required(b.endVal),this._property=param.required(b.property),b.controlPoints=b.controlPoints||[],this._fps=b.fps||30,param.required(c?b.startVal:this.actor),this._animated=!1,this.bezOpt={},b.controlPoints.length>0?(this.bezOpt.degree=b.controlPoints.length,this.bezOpt.degree>0&&(param.required(b.controlPoints[0].x),param.required(b.controlPoints[0].y),2===this.bezOpt.degree&&(param.required(b.controlPoints[1].x),param.required(b.controlPoints[1].y))),this.bezOpt.ctrl=b.controlPoints):this.bezOpt.degree=0,this.bezOpt.endPos=param.required(b.endVal),this.tIncr=1/(this._duration*(this._fps/1e3)),c?this.bezOpt.startPos=b.startVal:("rotation"===this._property&&(this.bezOpt.startPos=this.actor.getRotation()),"position"===this._property[0]&&("x"===this._property[1]?this.bezOpt.startPos=this.actor.getPosition().x:"y"===this._property[1]&&(this.bezOpt.startPos=this.actor.getPosition().y)),"color"===this._property[0]&&("r"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getR():"g"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getG():"b"===this._property[1]&&(this.bezOpt.startPos=this.actor.getColor().getB())))}return a.prototype._update=function(a,b){var c,d,e,f,g,h;if(param.required(a),b||(b=!0),a>1||0>a)throw new Error("t out of bounds! "+a);if(0===this.bezOpt.degree)c=this.bezOpt.startPos+(this.bezOpt.endPos-this.bezOpt.startPos)*a;else if(1===this.bezOpt.degree)d=1-a,e=d*d,g=a*a,c=e*this.bezOpt.startPos+2*d*a*this.bezOpt.ctrl[0].y+g*this.bezOpt.endPos;else{if(2!==this.bezOpt.degree)throw new Error("Invalid degree, can't evaluate ("+this.bezOpt.degree+")");d=1-a,e=d*d,f=e*d,g=a*a,h=g*a,c=f*this.bezOpt.startPos+3*e*a*this.bezOpt.ctrl[0].y+3*d*g*this.bezOpt.ctrl[1].y+h*this.bezOpt.endPos}return b&&(this._applyValue(c),void 0!==this.options.cbStep&&this.options.cbStep(c)),c},a.prototype.preCalculate=function(){var a,b;for(b=0,a={stepTime:this._duration*this.tIncr},a.values=[];1>=b;){if(b+=this.tIncr,b>1&&b<1+this.tIncr)b=1;else if(b>1)break;a.values.push(this._update(b,!1))}return a},a.prototype._applyValue=function(a){var b,c,d,e;if("rotation"===this._property&&this.actor.setRotation(a),"position"===this._property[0]&&("x"===this._property[1]?(b=new cp.v(a,this.actor.getPosition().y),this.actor.setPosition(b)):"y"===this._property[1]&&(b=new cp.v(this.actor.getPosition().x,a),this.actor.setPosition(b))),"color"===this._property[0]){if("r"===this._property[1])return e=a,d=this.actor.getColor().getG(),c=this.actor.getColor().getB(),this.actor.setColor(e,d,c);if("g"===this._property[1])return e=this.actor.getColor().getR(),d=a,c=this.actor.getColor().getB(),this.actor.setColor(e,d,c);if("b"===this._property[1])return e=this.actor.getColor().getR(),d=this.actor.getColor().getG(),c=a,this.actor.setColor(e,d,c)}},a.prototype.animate=function(){var a;if(!this._animated)return this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),a=-this.tIncr,this._intervalID=setInterval(function(b){return function(){if(a+=b.tIncr,a>1){if(clearInterval(b._intervalID),void 0!==b.options.cbEnd)return b.options.cbEnd()}else if(b._update(a),void 0!==b.options.cbStep)return b.options.cbStep()}}(this),1e3/this._fps)},a}(),AREVertAnimation=function(){function a(a,b){return this.actor=a,this.options=b,param.required(this.actor),param.required(this.options),param.required(this.options.delays),param.required(this.options.deltas),this.options.delays.length!==this.options.deltas.length?(ARELog.warn("Vert animation delay count != delta set count! Bailing."),void(this._animated=!0)):void(this._animated=!1)}return a.prototype._setTimeout=function(a,b,c,d){return param.required(a),param.required(b),setTimeout(function(b){return function(){return b._applyDeltas(a,c),d&&void 0!==b.options.cbEnd?b.options.cbEnd():void 0}}(this),b)},a.prototype._applyDeltas=function(a,b){var c,d,e,f,g,h,i;for(param.required(a),void 0!==this.options.cbStep&&this.options.cbStep(b),d=this.actor.getVertices(),f=-1!==a.join("_").indexOf("...")?!0:!1,e=h=0,i=a.length;i>=0?i>h:h>i;e=i>=0?++h:--h){if(c=a[e],e>=d.length){if(f)break;g=void 0}else g=d[e];if("number"==typeof c)g=c;else{if("string"!=typeof c)return void ARELog.warn("Unknown delta type, can't apply deltas! "+c+" "+typeof c);if(void 0===g)return void ARELog.warn("Vertex does not exist, yet delta is relative!");if("|"===c.charAt(0))break;if("-"===c.charAt(0))g-=Number(c.slice(1));else if("+"===c.charAt(0))g+=Number(c.slice(1));else if("..."===c)e=0;else if("."!==c.charAt(0))return void ARELog.warn("Unknown delta action, "+c+", can't apply deltas.")}if(e>d.length)return void ARELog.warn("Vertex gap, can't push new vert! "+g+":"+c+":"+e);e===d.length?d.push(g):d[e]=g}return this.actor.updateVertices(d)},a.prototype.animate=function(){var a,b,c,d,e,f;if(!this._animated){for(this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),f=[],a=d=0,e=this.options.deltas.length;e>=0?e>d:d>e;a=e>=0?++d:--d)c=null,void 0!==this.options.udata&&(this.options.udata instanceof Array?a<this.options.udata.length&&(c=this.options.udata[a]):c=this.options.udata),b=a===this.options.deltas.length-1?!0:!1,f.push(this._setTimeout(this.options.deltas[a],this.options.delays[a],c,b));return f}},a}(),AREPsyxAnimation=function(){function a(a,b){this.actor=a,this.options=b,param.required(this.actor),param.required(this.options.mass),param.required(this.options.friction),param.required(this.options.elasticity),param.required(this.options.timeout),this._animated=!1}return a.prototype.animate=function(){return this._animated?void 0:(this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),setTimeout(function(a){return function(){return a.actor.createPhysicsBody(a.options.mass,a.options.friction,a.options.elasticity),void 0!==a.options.cbEnd?a.options.cbEnd():void 0}}(this),this.options.timeout))},a}(),AREActorInterface=function(){function a(){}return a.prototype.setEngine=function(a){return this._renderer=a.getRenderer()},a.prototype._findActor=function(a){var b,c,d,e;for(param.required(a),e=this._renderer._actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a)return b;return null},a.prototype.create2DRawPolygon=function(a){return new ARERawActor(this._renderer,a).getId()},a.prototype.create2DPolygon=function(a,b){return"string"==typeof a?this.createRawActor(a):new AREPolygonActor(this._renderer,a,b).getId()},a.prototype.create2DRectangle=function(a,b){return new ARERectangleActor(this._renderer,a,b).getId()},a.prototype.create2DCircle=function(a){return new ARECircleActor(this._renderer,a).getId()},a.prototype.getLayer=function(a){var b;return(b=this._findActor(a))?b.getLayer():null},a.prototype.getPhysicsLayer=function(a){var b;return(b=this._findActor(a))?b.getPhysicsLayer():null},a.prototype.getRectangleWidth=function(a){var b;return(b=this._findActor(a))&&b instanceof ARERectangleActor?b.getWidth():null},a.prototype.getRectangleHeight=function(a){var b;return(b=this._findActor(a))&&b instanceof ARERectangleActor?b.getHeight():null},a.prototype.getOpacity=function(a){var b;return(b=this._findActor(a))?b.getOpacity():null},a.prototype.isVisible=function(a){var b;return(b=this._findActor(a))?b.getVisible():null},a.prototype.getPosition=function(a){var b;return(b=this._findActor(a))?b.getPosition():null},a.prototype.getRotation=function(a,b){var c;return(c=this._findActor(a))?c.getRotation(!!b):null},a.prototype.getColor=function(a){var b,c;return(b=this._findActor(a))?(c=b.getColor(),{r:c.getR(),g:c.getG(),b:c.getB()}):null},a.prototype.getTexture=function(a){var b;return(b=this._findActor(a))?b.getTexture().name:null},a.prototype.getTextureRepeat=function(a){var b;return(b=this._findActor(a))?b.getTextureRepeat():null},a.prototype.setRectangleHeight=function(a,b){var c;return(c=this._findActor(a))&&c instanceof ARERectangleActor?(c.setHeight(b),!0):!1},a.prototype.setRectangleWidth=function(a,b){var c;return(c=this._findActor(a))&&c instanceof ARERectangleActor?(c.setWidth(b),!0):!1},a.prototype.setPolygonSegments=function(a,b){var c;return(c=this._findActor(a))&&c instanceof AREPolygonActor?(c.setSegments(b),!0):!1},a.prototype.setPolygonRadius=function(a,b){var c;return(c=this._findActor(a))&&c instanceof AREPolygonActor?(c.setRadius(b),!0):!1},a.prototype.getPolygonRadius=function(a){var b;return(b=this._findActor(a))&&b instanceof AREPolygonActor?b.getRadius():null},a.prototype.getPolygonSegments=function(a){var b;return(b=this._findActor(a))&&b instanceof AREPolygonActor?b.getSegments():null},a.prototype.attachTexture=function(a,b,c,d,e,f,g){var h;return e||(e=0),f||(f=0),g||(g=0),(h=this._findActor(a))?(h.attachTexture(b,c,d,e,f,g),!0):!1},a.prototype.setLayer=function(a,b){var c;return(c=this._findActor(a))?(c.setLayer(b),!0):!1},a.prototype.setPhysicsLayer=function(a,b){var c;return(c=this._findActor(a))?(c.setPhysicsLayer(b),!0):!1},a.prototype.removeAttachment=function(a){var b;return(b=this._findActor(a))?(b.removeAttachment(),!0):!1},a.prototype.setAttachmentVisiblity=function(a,b){var c;return(c=this._findActor(a))?c.setAttachmentVisibility(b):!1},a.prototype.setVertices=function(a,b){var c;return(c=this._findActor(a))?(c.updateVertices(JSON.parse(b)),!0):!1},a.prototype.getVertices=function(a){var b;return(b=this._findActor(a))?b.getVertices():null},a.prototype.destroyActor=function(a){var b;return(b=this._findActor(a))?(b.destroy(),!0):!1},a.prototype.setPhysicsVertices=function(a,b){var c;return(c=this._findActor(a))?(c.setPhysicsVertices(b),!0):!1},a.prototype.setRenderMode=function(a,b){var c;return(c=this._findActor(a))?(c.setRenderMode(b),!0):!1},a.prototype.setOpacity=function(a,b){var c;return isNaN(b)?!1:(b=Number(b),b>1&&(b=1),0>b&&(b=0),(c=this._findActor(a))?(c.setOpacity(b),!0):!1)},a.prototype.setVisible=function(a,b){var c;return(c=this._findActor(a))?(c.setVisible(b),!0):!1},a.prototype.setPosition=function(a,b){var c;return(c=this._findActor(a))?(c.setPosition(b),!0):!1},a.prototype.setRotation=function(a,b,c){var d;return(d=this._findActor(a))?(d.setRotation(b,!!c),!0):!1},a.prototype.setColor=function(a,b){var c;return(c=this._findActor(a))?(c.setColor(b),!0):!1},a.prototype.setTexture=function(a,b){var c;return(c=this._findActor(a))?(c.setTexture(b),!0):!1},a.prototype.setTextureRepeat=function(a,b){var c;return(c=this._findActor(a))?(c.setTextureRepeat(b.x,b.y),!0):!1},a.prototype.createPhysicsBody=function(a,b,c,d){var e;return(e=this._findActor(a))?(e.createPhysicsBody(b,c,d),!0):!1},a.prototype.destroyPhysicsBody=function(a){var b;return(b=this._findActor(a))?(b.destroyPhysicsBody(),!0):!1},a.prototype.enable2DMode=function(){return!1},a.prototype.disable2DMode=function(){return!1},a.prototype.is2DModeEnabled=function(){return!1},a.prototype.create3DActor=function(){return!1},a.prototype.beginActorBatch=function(){return!1},a.prototype.endActorBatch=function(){return!1},a.prototype.set2DRotation=function(){return!1},a.prototype.rotateInto2DPlane=function(){return!1},a.prototype.clearTexture=function(){return!1},a.prototype.set2DVertices=function(){return!1},a.prototype.setTextureCoords=function(){return!1},a.prototype.getTextureCoords=function(){return null},a.prototype.get2DRotation=function(){return null},a.prototype.getAABB=function(){return null},a.prototype.destroy=function(){return!1},a.prototype.setAttachment=function(){return!1},a.prototype.setAttachmentOffset=function(){return!1},a.prototype.setAttachmentRotation=function(){return!1},a.prototype.getAttachmentID=function(){return null},a.prototype.getAttachmentVisibility=function(){return null},a.prototype.getAttachmentOffset=function(){return null},a.prototype.getAttachmentRotation=function(){return null},a}(),nextHighestPowerOfTwo=function(a){var b;for(--a,b=1;32>b;)a|=a>>b,b<<=1;return a+1},AREEngineInterface=function(){function a(a){this._masterInterface=a}return a.prototype.initialize=function(a,b,c,d,e){return param.required(c),d||(d=4),e||(e=""),this._engine?(ARELog.warn("Re-initialize attempt, ignoring and passing through"),c(this._engine)):(this.wglFlipTextureY=!0,this._engine=new ARE(a,b,function(a){return function(){return c(a._engine)}}(this),d,e),this._masterInterface.setEngine(this._engine),this._renderer=this._engine.getRenderer(),this._engine.startRendering(),this._engine)},a.prototype.getRendererMode=function(){return this._renderer.getActiveRendererMode()},a.prototype.setClearColor=function(a){return this._renderer?this._renderer.setClearColor(a.r,a.g,a.b):void 0},a.prototype.getClearColor=function(){var a;if(this._renderer)return a=this._renderer.getClearColor(),{r:a.getR(),g:a.getG(),b:a.getB()}},a.prototype.setLogLevel=function(a){return a=Number(a),isNaN(a)?ARELog.warn("Log level is NaN"):(a=Math.round(a),0>a&&(a=0),a>4&&(a=4),ARELog.level=a)},a.prototype.getLogLevel=function(){return ARELog.level},a.prototype.setCameraPosition=function(a){var b;return b=this._renderer.getCameraPosition(),void 0!==a.x&&(b.x=a.x),void 0!==a.y&&(b.y=a.y),this._renderer.setCameraPosition(b)},a.prototype.getCameraPosition=function(){return this._renderer.getCameraPosition()},a.prototype.getWidth=function(){return this._renderer?this._renderer.getWidth():-1},a.prototype.getHeight=function(){return this._renderer?this._renderer.getHeight():-1},a.prototype.setBenchmark=function(a){return this._engine?(this._engine.benchmark=a,window.AREMessages.broadcast({value:a},"physics.benchmark.set")):void 0},a.prototype.getNRAIDVersion=function(){return"1.0.0,freestanding"},a.prototype.getMetaData=function(){return this._metaData},a.prototype.loadManifest=function(a,b){if(param.required(a.version),a.version.split(",")[0]>this.getNRAIDVersion().split(",")[0])throw new Error("Unsupported NRAID version");return this._metaData=a.meta,a.textures?async.each(a.textures,function(a){return function(b,c){return a.loadTexture(b,function(){return c()},a.wglFlipTextureY)}}(this),b):b()},a.prototype.loadTexture=function(a,b,c){var d,e,f;if(param.required(a.name),param.required(a.file),"boolean"!=typeof c&&(c=this.wglFlipTextureY),a.atlas)throw new Error("This version of ARE does not support atlas loading!");return e=new Image,e.crossOrigin="anonymous",d=this._renderer.getGL(),f=null,this._renderer.isWGLRendererActive()?(f=d.createTexture(),e.onload=function(g){return function(){var h,i,j,k,l,m;return ARELog.info("Loading GL tex: "+a.name+", "+a.file),k=1,l=1,m=0!==(e.width&e.width-1),j=0!==(e.height&e.height-1),(m||j)&&(h=document.createElement("canvas"),h.width=nextHighestPowerOfTwo(e.width),h.height=nextHighestPowerOfTwo(e.height),k=e.width/h.width,l=e.height/h.height,i=h.getContext("2d"),i.drawImage(e,0,0,h.width,h.height),e=h),d.bindTexture(d.TEXTURE_2D,f),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,c),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,e),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.bindTexture(d.TEXTURE_2D,null),g._renderer.addTexture({name:a.name,texture:f,width:e.width,height:e.height,scaleX:k,scaleY:l}),b?b():void 0}}(this)):e.onload=function(c){return function(){return ARELog.info("Loading canvas tex: "+a.name+", "+a.file),c._renderer.addTexture({name:a.name,texture:e,width:e.width,height:e.height}),b?b():void 0}}(this),e.src=a.file},a.prototype.getTextureSize=function(a){return this._renderer.getTextureSize(a)},a}(),AREAnimationInterface=function(){function a(){}return a._animationMap={position:AREBezAnimation,color:AREBezAnimation,rotation:AREBezAnimation,mass:AREPsyxAnimation,friction:AREPsyxAnimation,elasticity:AREPsyxAnimation,physics:AREPsyxAnimation,vertices:AREVertAnimation},a.prototype.setEngine=function(a){return this._renderer=a.getRenderer()},a.prototype.canAnimate=function(b){return!!a._animationMap[b]},a.prototype.getAnimationName=function(b){if(!a._animationMap[b])return!1;switch(a._animationMap[b]){case AREBezAnimation:return"bezier";case AREPsyxAnimation:return"psyx";case AREVertAnimation:return"vert";default:return!1}},a.prototype.animate=function(b,c,d){var e,f,g,h,i,j,k;for(c=JSON.parse(param.required(c)),d=JSON.parse(param.required(d)),d.start||(d.start=0),f=null,j=this._renderer._actors,h=0,i=j.length;i>h;h++)if(e=j[h],e.getId()===b){f=e;break}if(null===f)throw new Error("Actor not found, can't animate! "+actorId);return g=c[0],void 0===d.property&&(d.property=c),k=function(b,c,d){return a._animationMap[b]===AREBezAnimation?new AREBezAnimation(c,d).animate():a._animationMap[b]===AREPsyxAnimation?new AREPsyxAnimation(c,d).animate():a._animationMap[b]===AREVertAnimation?new AREVertAnimation(c,d).animate():ARELog.warn("Unrecognized property: "+b)},d.start>0?setTimeout(function(){return k(g,f,d)},d.start):k(g,f,d)},a.prototype.preCalculateBez=function(a){var b;return a=JSON.parse(param.required(a)),a.controlPoints||(a.controlPoints=0),a.fps||(a.fps=30),b=new AREBezAnimation(null,a,!0).preCalculate(),JSON.stringify(b)},a}(),AREInterface=function(){function a(){this._Actors=new AREActorInterface(this),this._Engine=new AREEngineInterface(this),this._Animations=new AREAnimationInterface(this)}return a.prototype.Actors=function(){return this._Actors},a.prototype.Engine=function(){return this._Engine},a.prototype.Animations=function(){return this._Animations},a.prototype.setEngine=function(a){return this._Actors.setEngine(a),this._Animations.setEngine(a)},a}(),ARE=function(){function a(b,c,d,e,f){return param.required(b),param.required(c),param.required(d),ARELog.level=e||4,f||(f=""),this._renderIntervalId=null,this.benchmark=!1,this.setFPS(60),null===window._||void 0===window._?ARELog.error("Underscore.js is not present!"):(this._renderer=new ARERenderer({canvasId:f,width:b,height:c}),this._physics=new PhysicsManager(this._renderer,a.config.deps.physics,function(a){return function(){return a._currentlyRendering=!1,a.startRendering(),d(a)}}(this)),void(window.AREPhysicsManager=this._physics))}return a.config={deps:{physics:{chipmunk:"/components/chipmunk/cp.js",physics_worker:"/lib/physics/worker.js"}}},a.Version={MAJOR:1,MINOR:5,PATCH:0,BUILD:null,STRING:"1.5.0"},a.prototype.getRenderer=function(){return this._renderer},a.prototype.setFPS=function(a){return this._framerate=1/a,this},a.prototype.startRendering=function(){var a,b;if(!this._currentlyRendering)return this._currentlyRendering=!0,ARELog.info("Starting render loop"),b=this._renderer,a=function(){return b.update(),b.render(),window.requestAnimationFrame(a)},window.requestAnimationFrame(a)},a.prototype.isRendering=function(){return this._currentlyRendering},a.prototype.setClearColor=function(a,b,c){return a||(a=0),b||(b=0),c||(c=0),this._renderer instanceof ARERenderer&&this._renderer.setClearColor(a,b,c),this},a.prototype.getClearColor=function(){return this._renderer instanceof ARERenderer?this._renderer.getClearColor():null},a.prototype.getWidth=function(){return this._renderer.getWidth()},a.prototype.getHeight=function(){return this._renderer.getHeight()},a.prototype.requestPickingRenderWGL=function(a,b){return this._renderer.isWGLRendererActive()?this._renderer.requestPickingRenderWGL(a,b):ARELog.warn("WebGL renderer available for WebGL pick!")},a.prototype.requestPickingRenderCanvas=function(a,b){return this._renderer.isCanvasRendererActive()?this._renderer.requestPickingRenderCanvas(a,b):ARELog.warn("Canvas renderer available for canvas pick!")},a}(),window.AdefyGLI=window.AdefyRE=new AREInterface;