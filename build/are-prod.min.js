/* Copyright Â© 2013 Spectrum IT Solutions Gmbh - All Rights Reserved */
var AREActorInterface,AREAnimationInterface,AREBezAnimation,ARECircleActor,AREColor3,AREEngine,AREEngineInterface,AREInterface,ARELog,AREPolygonActor,AREPsyxAnimation,ARERawActor,ARERectangleActor,ARERenderer,AREShader,ARETriangleActor,AREUtilParam,AREVector2,AREVersion,AREVertAnimation,BazarShop,CBazar,Koon,KoonFlock,KoonNetworkMember,PhysicsManager,nextHighestPowerOfTwo,precision,precision_declaration,varying_precision,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};KoonNetworkMember=function(){function a(b){this._name=b||"GenericKoonNetworkMember",this._uuid=a.generateUUID(),this._subscribers=[]}return a.prototype._generateReceiver=function(a){return function(){return function(b,c){return a.receiveMessage(b,c)}}(this)},a.prototype.subscribe=function(a,b){return this._subscribers.push({namespace:b||"",receiver:this._generateReceiver(a)})},a.prototype.broadcast=function(a,b){var c,d;if(b=b||"",!this.hasSent(a)){for(a=this.tagAsSent(a),c=this._subscribers.length,d=[];c--;)d.push(this._subscribers[c].receiver(a,b));return d}},a.prototype.getId=function(){return this._uuid},a.prototype.getName=function(){return this._name},a.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b;return b=16*Math.random()|0,"x"===a?b.toString(16):(3&b|8).toString(16)})},a.prototype.tagAsSent=function(a){return a._senders?a._senders.push(this._name):a._senders=[this._name],a},a.prototype.hasSent=function(a){var b,c,d,e;if(a&&a._senders)for(e=a._senders,c=0,d=e.length;d>c;c++)if(b=e[c],b===this._name)return!0;return!1},a}(),Koon=function(a){function b(a){b.__super__.constructor.call(this,a||"GenericKoon")}return __extends(b,a),b.prototype.receiveMessage=function(a,b){return console.log("<"+a._sender+"> --> <"+this.getName()+">  ["+b+"] "+JSON.stringify(a))},b.prototype.broadcast=function(a,c){return"object"==typeof a?(a._sender=this._name,b.__super__.broadcast.call(this,a,c)):void 0},b}(KoonNetworkMember),KoonFlock=function(a){function b(a){b.__super__.constructor.call(this,a||"GenericKoonFlock")}return __extends(b,a),b.prototype.registerKoon=function(a,b){return this.subscribe(a,b),a.subscribe(this)},b.prototype.receiveMessage=function(a,b){return this.broadcast(a,b)},b.prototype._generateReceiver=function(a){return function(b,c){return a.hasSent(b)?void 0:a.receiveMessage(b,c)}},b}(KoonNetworkMember),CBazar=function(a){function b(){b.__super__.constructor.call(this,"Bazar")}return __extends(b,a),b}(KoonFlock),BazarShop=function(a){function b(a,c){b.__super__.constructor.call(this,a),async.map(c,function(a,b){return a.raw?b(null,a.raw):$.ajax({url:a.url,mimeType:"text",success:function(a){return b(null,a)}})},function(a){return function(b,c){return a._initFromSources(c),a._registerWithBazar()}}(this))}return __extends(b,a),b.prototype._initFromSources=function(a){var b;if(!this._worker)return b=new Blob([a.join("\n\n")],{type:"text/javascript"}),this._worker=new Worker((URL||window.webkitURL).createObjectURL(b)),this._connectWorkerListener(),this._worker.postMessage("")},b.prototype._connectWorkerListener=function(){return this._worker.onmessage=function(a){return function(b){var c,d,e,f,g;if(b.data instanceof Array){for(f=b.data,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(a.broadcast(c.message,c.namespace));return g}return a.broadcast(b.data.message,b.data.namespace)}}(this)},b.prototype._registerWithBazar=function(){return window.Bazar.registerKoon(this)},b.prototype.receiveMessage=function(a,b){return this._worker?this._worker.postMessage({message:a,namespace:b}):void 0},b}(Koon),window.Bazar||(window.Bazar=new CBazar),AREUtilParam=function(){function a(){}return a.required=function(a,b,c){var d,e,f,g;if(null===a&&c!==!0&&(a=void 0),void 0===a)throw new Error("Required argument missing!");if(b instanceof Array&&b.length>0){for(d=!1,f=0,g=b.length;g>f;f++)if(e=b[f],a===e){d=!0;break}if(!d)throw new Error("Required argument is not of a valid value!")}return a},a.optional=function(a,b,c,d){var e,f,g,h;if(null===a&&d!==!0&&(a=void 0),void 0===a&&(a=b),c instanceof Array&&c.length>0){for(e=!1,g=0,h=c.length;h>g;g++)if(f=c[g],a===f){e=!0;break}if(!e)throw new Error("Required argument is not of a valid value!")}return a},a}(),void 0===window.param&&(window.param=AREUtilParam),ARERawActor=function(a){function b(a,c){param.required(a),c=param.optional(c,null),this._initializeValues(),this._registerWithRenderer(),this.updateVertices(a,c),this.setColor(new AREColor3(255,255,255)),this.clearTexture(),b.__super__.constructor.call(this,"Actor_"+this._id),window.AREMessages.registerKoon(this,/^actor\..*/)}return __extends(b,a),b.defaultFriction=.3,b.defaultMass=10,b.defaultElasticity=.2,b.prototype._registerWithRenderer=function(){return this._id=ARERenderer.getNextId(),ARERenderer.addActor(this)},b.prototype._initializeValues=function(){if(ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL&&(this._gl=ARERenderer._gl,void 0===this._gl||null===this._gl))throw new Error("GL context is required for actor initialization!");return this._color=null,this._strokeColor=null,this._strokeWidth=1,this._colArray=null,this._opacity=1,this.lit=!1,this._visible=!0,this.layer=0,this._physicsLayer=-1,this._id=-1,this._position={x:0,y:0},this._rotation=0,this._initializeModelMatrix(),this._updateModelMatrix(),this._size=new AREVector2(0,0),this._friction=null,this._mass=null,this._elasticity=null,this._vertices=[],this._psyxVertices=[],this._texVerts=[],this._origTexVerts=[],this._vertBuffer=null,this._vertBufferFloats=null,this._sh_handles={},this._renderMode=ARERenderer.RENDER_MODE_TRIANGLE_FAN,this._renderStyle=ARERenderer.RENDER_STYLE_FILL,this._texture=null,this._clipRect=[0,0,1,1],this._attachedTexture=null,this.attachedTextureAnchor={clipRect:[0,0,1,1],x:0,y:0,width:0,height:0,angle:0}},b.prototype.destroy=function(){return this.destroyPhysicsBody(),null},b.prototype.getMaterial=function(){return this._material},b.prototype.getLayer=function(){return this.layer},b.prototype.setLayer=function(a){return this.layer=param.required(a),ARERenderer.removeActor(this,!0),ARERenderer.addActor(this)},b.prototype.setTexture=function(a){if(param.required(a),!ARERenderer.hasTexture(a))throw new Error("No such texture loaded: "+a);return this._texture=ARERenderer.getTexture(a),this.setShader(ARERenderer.getMe().getTextureShader()),this._material=ARERenderer.MATERIAL_TEXTURE,this},b.prototype.clearTexture=function(){return this._texture=void 0,this._texRepeatX=1,this._texRepeatY=1,this.setShader(ARERenderer.getMe().getDefaultShader()),this._material=ARERenderer.MATERIAL_FLAT,this},b.prototype.getTexture=function(){return this._texture},b.prototype.getTextureRepeat=function(){return{x:this._texRepeatX,y:this._texRepeatY}},b.prototype.setShader=function(a){if(ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL){if(param.required(a),null===a.getProgram())throw new Error("Shader has to be built before it can be used!");return null===a.getHandles()&&a.generateHandles(),this._sh_handles=a.getHandles()}},b.prototype.hasPhysics=function(){return null!==this._shape||null!==this._body},b.prototype.createPhysicsBody=function(a,c,d){var e,f,g,h,i,j,k,l,m,n,o;if(this._mass=a,this._friction=c,this._elasticity=d,null!==this._mass&&void 0!==this._mass){for(this._friction||(this._friction=b.defaultFriction),this._elasticity||(this._elasticity=b.defaultElasticity),this._mass<0&&(this._mass=0),this._friction<0&&(this._friction=0),this._elasticity<0&&(this._elasticity=0),k=[],j=0,h=null,h=this._psyxVertices.length>6?this._psyxVertices:this._vertices,g=n=0,o=h.length-1;o>n;g=n+=2)k.push(h[g]),k.push(h[g+1]),0===this._mass&&(l=k[k.length-2],m=k[k.length-1],e=this._rotation,k[k.length-2]=l*Math.cos(e)-m*Math.sin(e),k[k.length-1]=l*Math.sin(e)+m*Math.cos(e));return f=null,i={id:this._id,type:"Polygon",vertices:k,"static":!1,position:this._position,friction:this._friction,elasticity:this._elasticity,layer:this._physicsLayer},0===this._mass?(i["static"]=!0,i.position=this._position):(f={id:this._id,position:this._position,angle:this._rotation,mass:this._mass,momentV:{x:0,y:0},vertices:k},i.position={x:0,y:0}),this.broadcast({},"physics.enable"),f&&this.broadcast({def:f},"physics.body.create"),i&&this.broadcast({def:i},"physics.shape.create"),this}},b.prototype.destroyPhysicsBody=function(){return this.broadcast({id:this._id},"physics.shape.remove"),this.broadcast({id:this._id},"physics.body.remove")},b.prototype.enablePhysics=function(){return this.hasPhysics()||this.createPhysicsBody(),this},b.prototype.disablePhysics=function(){return this.hasPhysics()&&this.destroyPhysicsBody,this},b.prototype.refreshPhysics=function(){return this.hasPhysics()?(this.destroyPhysicsBody(),this.createPhysicsBody(this._mass,this._friction,this._elasticity)):void 0},b.prototype.getMass=function(){return this._mass},b.prototype.getElasticity=function(){return this._elasticity},b.prototype.getFriction=function(){return this._friction},b.prototype.setMass=function(a){return this._mass=a,this.refreshPhysics(),this},b.prototype.setElasticity=function(a){return this._elasticity=a,this.refreshPhysics(),this},b.prototype.setFriction=function(a){return this._friction=a,this.refreshPhysics(),this},b.prototype.getPhysicsLayer=function(){return this._physicsLayer.toString(2).length-1},b.prototype.setPhysicsLayer=function(a){return this._physicsLayer=1<<param.required(a,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]),this.broadcast({id:this._id,layer:this._physicsLayer},"physics.shape.set.layer")},b.prototype.updateVertices=function(a,b){var c,d;if(d=param.optional(a,this._vertices),c=param.optional(b,this._texVerts),d.length<6)throw new Error("At least 3 vertices make up an actor");if(c!==this._texVerts)if(d!==this._vertices){if(d.length!==c.length)throw new Error("Vert and UV count must match!")}else if(this._vertices.length!==c.length)throw new Error("Vert and UV count must match!");return d!==this._vertices&&this.updateVertBuffer(d),c!==this._texVerts?this.updateUVBuffer(c):void 0},b.prototype.updateVertBuffer=function(a){var b,c,d,e,f,g,h;for(this._vertices=a,this._vertBufferFloats=new Float32Array(this._vertices),ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL&&(this._vertBuffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vertBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,this._vertBufferFloats,this._gl.STATIC_DRAW),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null)),c=0,d=0,e=0,f=0,b=g=1,h=this._vertices.length/2;h>=1?h>=g:g>=h;b=h>=1?++g:--g)this._vertices[2*b]<c&&(c=this._vertices[2*b]),e<this._vertices[2*b]&&(e=this._vertices[2*b]),this._vertices[2*b+1]<d&&(d=this._vertices[2*b+1]),f<this._vertices[2*b+1]&&(f=this._vertices[2*b+1]);return this._size.x=e-c,this._size.y=f-d},b.prototype.updateUVBuffer=function(a){return this._texVerts=a,ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL?(this._origTexVerts=this._texVerts,this._texVBufferFloats=new Float32Array(this._texVerts),this._texBuffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._texBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,this._texVBufferFloats,this._gl.STATIC_DRAW),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null)):void 0},b.prototype.setTextureRepeat=function(a,b){var c,d,e,f;for(a=param.optional(a,1),b=param.optional(b,1),d=[],c=e=0,f=this._origTexVerts.length;f>e;c=e+=2)d.push(this._origTexVerts[c]/this._texRepeatX*a),d.push(this._origTexVerts[c+1]/this._texRepeatY*b);return this._texRepeatX=a,this._texRepeatY=b,this.updateUVBuffer(d),this},b.prototype.setPhysicsVertices=function(a){return this._psyxVertices=param.required(a),this.destroyPhysicsBody(),this.createPhysicsBody(this._mass,this._friction,this._elasticity)},b.prototype.attachTexture=function(a,b,c,d,e,f){if(param.required(a),param.required(b),param.required(c),this.attachedTextureAnchor.width=b,this.attachedTextureAnchor.height=c,this.attachedTextureAnchor.x=param.optional(d,0),this.attachedTextureAnchor.y=param.optional(e,0),this.attachedTextureAnchor.angle=param.optional(f,0),!ARERenderer.hasTexture(a))throw new Error("No such texture loaded: "+a);return this._attachedTexture&&this.removeAttachment(),this._attachedTexture=new ARERectangleActor(b,c),this._attachedTexture.setTexture(a),this._attachedTexture},b.prototype.removeAttachment=function(){return this._attachedTexture?(ARERenderer.removeActor(this._attachedTexture),this._attachedTexture=null,!0):!1},b.prototype.setAttachmentVisibility=function(a){return param.required(a),null===this._attachedTexture?!1:(this._attachedTexture._visible=a,!0)},b.prototype.hasAttachment=function(){return null!==this._attachedTexture},b.prototype.getAttachment=function(){return this._attachedTexture},b.prototype.updateAttachment=function(){var a,b,c;return this.hasAttachment()&&this.getAttachment()._visible?(b=this.getPosition(),c=this.getRotation(),b.x+=this.attachedTextureAnchor.x,b.y+=this.attachedTextureAnchor.y,c+=this.attachedTextureAnchor.angle,a=this.getAttachment(),a.setPosition(b),a.setRotation(c),a):this},b.prototype.wglBindTexture=function(a){return ARERenderer._currentTexture=this._texture.texture,a.bindBuffer(a.ARRAY_BUFFER,this._texBuffer),a.vertexAttribPointer(this._sh_handles.aTexCoord,2,a.FLOAT,!1,0,0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this._texture.texture),a.uniform1i(this._sh_handles.uSampler,0),this},b.prototype._updateModelMatrix=function(){var a,b,c,d,e;return d=ARERenderer,c=this._position,b=ARERenderer.camPos,e=Math.sin(-this._rotation),a=Math.cos(-this._rotation),this._modelM[0]=a,this._modelM[1]=e,this._modelM[4]=-e,this._modelM[5]=a,this._modelM[12]=c.x-b.x,this._modelM[13]=d.force_pos0_0?d.getHeight()-c.y+b.y:c.y-b.y},b.prototype._initializeModelMatrix=function(){return this._modelM=[16],this._modelM[2]=0,this._modelM[3]=0,this._modelM[6]=0,this._modelM[7]=0,this._modelM[8]=0,this._modelM[9]=0,this._modelM[10]=1,this._modelM[11]=0,this._modelM[14]=1,this._modelM[15]=1},b.prototype.wglDraw=function(a,b){var c;if(this._visible){switch(b&&(c=this._sh_handles,this._sh_handles=b.getHandles()),a.bindBuffer(a.ARRAY_BUFFER,this._vertBuffer),a.vertexAttribPointer(this._sh_handles.aPosition,2,a.FLOAT,!1,0,0),a.uniformMatrix4fv(this._sh_handles.uModelView,!1,this._modelM),a.uniform4f(this._sh_handles.uColor,this._colArray[0],this._colArray[1],this._colArray[2],1),this._sh_handles.uClipRect&&a.uniform4fv(this._sh_handles.uClipRect,this._clipRect),a.uniform1f(this._sh_handles.uOpacity,this._opacity),ARERenderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE&&ARERenderer._currentTexture!==this._texture.texture&&this.wglBindTexture(a),this._renderMode){case ARERenderer.RENDER_MODE_LINE_LOOP:a.drawArrays(a.LINE_LOOP,0,this._vertices.length/2);break;case ARERenderer.RENDER_MODE_TRIANGLE_FAN:a.drawArrays(a.TRIANGLE_FAN,0,this._vertices.length/2);break;case ARERenderer.RENDER_MODE_TRIANGLE_STRIP:a.drawArrays(a.TRIANGLE_STRIP,0,this._vertices.length/2);break;default:throw new Error("Invalid render mode! "+this._renderMode)}return b&&(this._sh_handles=c),this}},b.prototype.cvSetupStyle=function(a){var b,c,d,e;return a.lineWidth=null!==this._strokeWidth?this._strokeWidth:1,this._strokeColor?(e=Number(this._strokeColor._r).toFixed(0),d=Number(this._strokeColor._g).toFixed(0),c=Number(this._strokeColor._b).toFixed(0),b=Number(this._opacity).toFixed(4),a.strokeStyle="rgba("+e+","+d+","+c+","+b+")"):a.strokeStyle="#FFF",ARERenderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE||(this._color?(e=Number(this._color._r).toFixed(0),d=Number(this._color._g).toFixed(0),c=Number(this._color._b).toFixed(0),b=Number(this._opacity).toFixed(4),a.fillStyle="rgba("+e+","+d+","+c+","+b+")"):a.fillStyle="#FFF"),this},b.prototype.cvDraw=function(a){var b,c,d;if(this._visible){for(a.translate(this._modelM[12],this._modelM[13]),a.beginPath(),a.rotate(this._rotation),a.moveTo(this._vertices[0],this._vertices[1]),b=c=1,d=this._vertices.length/2;d>=1?d>=c:c>=d;b=d>=1?++c:--c)a.lineTo(this._vertices[2*b],this._vertices[2*b+1]);switch(a.closePath(),this.cvSetupStyle(a),ARERenderer.force_pos0_0||a.scale(1,-1),this._renderMode){case ARERenderer.RENDER_MODE_LINE_LOOP:a.stroke();break;case ARERenderer.RENDER_MODE_TRIANGLE_STRIP:case ARERenderer.RENDER_MODE_TRIANGLE_FAN:(this._renderStyle&ARERenderer.RENDER_STYLE_STROKE)>0&&a.stroke(),(this._renderStyle&ARERenderer.RENDER_STYLE_FILL)>0&&(ARERenderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE?(a.clip(),a.drawImage(this._texture.texture,-this._size.x/2,-this._size.y/2,this._size.x,this._size.y)):a.fill());break;default:throw new Error("Invalid render mode! "+this._renderMode)}return this}},b.prototype.nullDraw=function(){return this._visible?this:void 0},b.prototype.setRenderMode=function(a){return this._renderMode=param.required(a,ARERenderer.renderModes),this},b.prototype.setRenderStyle=function(a){return this._renderStyle=param.required(a,ARERenderer.renderStyles),this},b.prototype.setOpacity=function(a){return this._opacity=a,param.required(this._opacity),this},b.prototype.setPosition=function(a){return this._position=param.required(a),this._updateModelMatrix(),this.broadcast({id:this._id,position:a},"physics.body.set.position"),this},b.prototype.setRotation=function(a,b){return param.required(a),b=param.optional(b,!1),b||(a=.0174532925*Number(a)),this._rotation=a,this._updateModelMatrix(),this._mass>0?this.broadcast({id:this._id,rotation:this._rotation},"physics.body.set.rotation"):(this.destroyPhysicsBody(),this.createPhysicsBody(this._mass,this._friction,this._elasticity)),this},b.prototype.setStrokeWidth=function(a){return this._strokeWidth=Number(a),this},b.prototype.setColor_ext=function(a,b,c,d){return param.required(b),b instanceof AREColor3?(a.setR(b.getR()),a.setG(b.getG()),a.setB(b.getB())):(param.required(c),param.required(d),a.setR(Number(b)),a.setG(Number(c)),a.setB(Number(d))),this},b.prototype.setColor=function(a,b,c){return param.required(a),this._color||(this._color=new AREColor3),this.setColor_ext(this._color,a,b,c),this._colArray=[this._color.getR(!0),this._color.getG(!0),this._color.getB(!0)],this},b.prototype.setStrokeColor=function(a,b,c){return param.required(a),this._strokeColor||(this._strokeColor=new AREColor3),this.setColor_ext(this._strokeColor,a,b,c),this._strokeColorArray=[this._strokeColor.getR(!0),this._strokeColor.getG(!0),this._strokeColor.getB(!0)],this},b.prototype.setVisible=function(a){return this._visible=a,this},b.prototype.getOpacity=function(){return this._opacity},b.prototype.getPosition=function(){return this._position},b.prototype.getRotation=function(a){return a=param.optional(a,!1),a===!1?57.2957795*this._rotation:this._rotation},b.prototype.getVertices=function(){return this._vertices},b.prototype.getId=function(){return this._id},b.prototype.getColor=function(){return new AREColor3(this._color)},b.prototype.getVisible=function(){return this._visible},b.updateCount=0,b.lastTime=Date.now(),b.prototype.receiveMessage=function(a,b){var c;if(-1!==b.indexOf("actor.")&&a.id&&a.id===this._id)switch(c=b.split("."),c[1]){case"update":return this._position=a.position,this._rotation=a.rotation,this._updateModelMatrix()}},b}(Koon),ARERectangleActor=function(a){function b(a,c){var d,e;if(this.width=a,this.height=c,param.required(a),param.required(c),0>=a)throw new Error("Invalid width: "+a);if(0>=c)throw new Error("Invalid height: "+c);e=this.generateVertices(),d=this.generateUVs(),b.__super__.constructor.call(this,e,d)}return __extends(b,a),b.prototype.generateVertices=function(){var a,b;return b=this.width/2,a=this.height/2,[-b,-a,-b,a,b,a,b,-a,-b,-a]},b.prototype.generateUVs=function(){return[0,1,0,0,1,0,1,1,0,1]},b.prototype.getWidth=function(){return this.width},b.prototype.getHeight=function(){return this.height},b.prototype.setWidth=function(a){return this.width=a,this.updateVertBuffer(this.generateVertices())},b.prototype.setHeight=function(a){return this.height=a,this.updateVertBuffer(this.generateVertices())},b}(ARERawActor),AREPolygonActor=function(a){function b(a,c){var d,e,f;if(this.radius=a,this.segments=c,param.required(a),this.radius instanceof Array)this._verts=this.radius,this.radius=null,e=this.generateUVs(this._verts),b.__super__.constructor.call(this,this._verts,e),this.setPhysicsVertices(this._verts);else{if(param.required(c),0>=a)throw new Error("Invalid radius: "+a);if(2>=c)throw new ERror("Invalid segment count: "+c);f=this.generateVertices(),d=this.generateVertices({mode:"physics"}),e=this.generateUVs(f),b.__super__.constructor.call(this,f,e),this.setPhysicsVertices(d)}this.setRenderMode(ARERenderer.RENDER_MODE_TRIANGLE_FAN)}return __extends(b,a),b.prototype.generateVertices=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(a=param.optional(a,{}),i=this.radius,j=0,e=6.2831852/this.segments,d=Math.tan(e),c=Math.cos(e),h=[],b=k=0,m=this.segments;m>=0?m>k:k>m;b=m>=0?++k:--k)h[2*b]=i,h[2*b+1]=j,f=-j,g=i,i+=f*d,j+=g*d,i*=c,j*=c;for(h.push(h[0]),h.push(h[1]),o=[],b=l=0,n=h.length;n>l;b=l+=2)o.push(h[h.length-2-b]),o.push(h[h.length-1-b]);return h=o,"physics"!==a.mode&&(h.push(0),h.push(0)),h},b.prototype.generateUVs=function(a){var b,c,d,e;for(param.required(a),b=[],d=0,e=a.length;e>d;d++)c=a[d],b.push(c/this.radius/2+.5);return b},b.prototype.fullVertRefresh=function(){var a,b,c;return c=this.generateVertices(),a=this.generateVertices({mode:"physics"}),b=this.generateUVs(c),this.updateVertices(c,b),this.setPhysicsVertices(a)},b.prototype.getRadius=function(){return this.radius},b.prototype.getSegments=function(){return this.segments},b.prototype.setRadius=function(a){if(this.radius=a,0>=a)throw new Error("Invalid radius: "+a);return this.fullVertRefresh()},b.prototype.setSegments=function(a){if(this.segments=a,2>=a)throw new ERror("Invalid segment count: "+a);return this.fullVertRefresh()},b}(ARERawActor),ARECircleActor=function(a){function b(a){this.radius=a,b.__super__.constructor.call(this,a,32),delete this.setSegments,delete this.getSegments}return __extends(b,a),b}(AREPolygonActor),ARETriangleActor=function(a){function b(a,c){var d,e;if(this.base=a,this.height=c,param.required(a),param.required(c),0>=a)throw new Error("Invalid base: "+a);if(0>=c)throw new Error("Invalid height: "+c);e=this.generateVertices(),d=this.generateUVs(),b.__super__.constructor.call(this,e,d)}return __extends(b,a),b.prototype.generateVertices=function(){var a,b;return a=this.base/2,b=this.height/2,[-a,-b,0,b,a,-b,-a,-b]},b.prototype.generateUVs=function(){return[0,1,0,0,1,0,1,1]},b.prototype.getBase=function(){return this.base},b.prototype.getHeight=function(){return this.height},b.prototype.setBase=function(a){return this.base=a,this.updateVertBuffer(this.generateVertices())},b.prototype.setHeight=function(a){return this.height=a,this.updateVertBuffer(this.generateVertices())},b}(ARERawActor),AREColor3=function(){function a(b,c,d){b=param.optional(b,0),c=param.optional(c,0),d=param.optional(d,0),b instanceof a?(this._r=b.getR(),this._g=b.getG(),this._b=b.getB()):(this.setR(b),this.setG(c),this.setB(d))}return a.prototype.getR=function(a){return a!==!0?this._r:this._r/255},a.prototype.getG=function(a){return a!==!0?this._g:this._g/255},a.prototype.getB=function(a){return a!==!0?this._b:this._b/255},a.prototype.setR=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._r=a},a.prototype.setG=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._g=a},a.prototype.setB=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._b=a},a.prototype.toString=function(){return"("+this._r+", "+this._g+", "+this._b+")"},a}(),AREShader=function(){function a(a,b,c,d){var e;if(this._vertSrc=a,this._fragSrc=b,this._gl=c,param.required(this._vertSrc),param.required(this._fragSrc),param.required(this._gl),d=param.optional(d,!1),this.errors=[],this._prog=null,this._vertShader=null,this._fragShader=null,this._handles=null,d===!0&&(e=this.build(this._gl),e===!1))throw new Error("Failed to build shader! "+JSON.stringify(this.errors))}return a.prototype.build=function(a){var b;if(this._gl=a,param.required(this._gl),b=this._gl,this.errors=[],void 0===b||null===b)throw new Error("Need a valid gl object to build a shader!");return this._vertShader=b.createShader(b.VERTEX_SHADER),this._fragShader=b.createShader(b.FRAGMENT_SHADER),b.shaderSource(this._vertShader,this._vertSrc),b.shaderSource(this._fragShader,this._fragSrc),b.compileShader(this._vertShader),b.compileShader(this._fragShader),b.getShaderParameter(this._vertShader,b.COMPILE_STATUS)||this.errors.push(b.getShaderInfoLog(this._vertShader)),b.getShaderParameter(this._fragShader,b.COMPILE_STATUS)||this.errors.push(b.getShaderInfoLog(this._fragShader)),this._prog=b.createProgram(),b.attachShader(this._prog,this._vertShader),b.attachShader(this._prog,this._fragShader),b.linkProgram(this._prog),b.getProgramParameter(this._prog,b.LINK_STATUS)||this.errors.push("Failed to link!"),this.errors.length>0?!1:!0},a.prototype.generateHandles=function(){var a,b,c,d,e,f,g,h,i;if(null===this._prog)return AREEngine.getLog().error("Build program before generating handles"),!1;if(null!==this._handles)return AREEngine.getLog().warn("Refusing to re-generate handles!"),!1;for(this._handles={},h=function(a,b,c){var d,e;if(a=a.split(" "),d=a[a.length-1].replace(";",""),1===b){if(e={n:d,h:c._gl.getUniformLocation(c._prog,d)},"object"!=typeof e.h)throw new Error("Failed to get handle for uniform "+d+" ["+e.h+"]");return e}if(2===b)return e={n:d,h:c._gl.getAttribLocation(c._prog,d)};throw new Error("Type not 1 or 2, WTF, internal error")},i=[this._vertSrc,this._fragSrc],d=0,f=i.length;f>d;d++)for(c=i[d],c=c.split(";"),e=0,g=c.length;g>e&&(b=c[e],-1===b.indexOf("main()"));e++)-1!==b.indexOf("attribute")?(a=h(b,2,this),this._handles[a.n]=a.h):-1!==b.indexOf("uniform")&&(a=h(b,1,this),this._handles[a.n]=a.h);return!0},a.prototype.getHandles=function(){return this._handles},a.prototype.getProgram=function(){return this._prog},a}(),AREVector2=function(){function a(a,b){this.x=param.optional(a,0),this.y=param.optional(b,0)}return a.prototype.random=function(b){var c,d,e,f;return b=param.optional(b,{}),c=param.optional(b.bipolar,!1),d=param.optional(b.seed,65535*Math.random()),e=Math.random()*this.x,f=Math.random()*this.y,c&&(Math.random()<.5&&(e=-e),Math.random()<.5&&(f=-f)),new a(e,f)},a.prototype.add=function(b){return new a(this.x+b.x,this.y+b.y)},a.prototype.sub=function(b){return new a(this.x-b.x,this.y-b.y)},a.prototype.mul=function(b){return new a(this.x*b.x,this.y*b.y)},a.prototype.div=function(b){return new a(this.x/b.x,this.y/b.y)},a.prototype.floor=function(){return new a(Math.floor(this.x),Math.floor(this.y))},a.prototype.ceil=function(){return new a(Math.ceil(this.x),Math.ceil(this.y))},a.zero=function(){return new a(0,0)},a}(),AREShader.shaders={},AREShader.shaders.wire={},AREShader.shaders.solid={},AREShader.shaders.texture={},precision="mediump",varying_precision="mediump",precision_declaration="precision "+precision+" float;",AREShader.shaders.wire.vertex=""+precision_declaration+"\n\nattribute vec2 aPosition;\n\nuniform mat4 uProjection;\nuniform mat4 uModelView;\n\nvoid main() {\n  gl_Position = uProjection * uModelView * vec4(aPosition, 1, 1);\n}",AREShader.shaders.wire.fragment=""+precision_declaration+"\n\nuniform vec4 uColor;\nuniform float uOpacity;\n\nvoid main() {\n  vec4 frag = uColor;\n  frag.a *= uOpacity;\n  gl_FragColor = frag;\n}",AREShader.shaders.solid.vertex=AREShader.shaders.wire.vertex,AREShader.shaders.solid.fragment=""+precision_declaration+"\n\nuniform vec4 uColor;\nuniform float uOpacity;\n\nvoid main() {\n  vec4 frag = uColor;\n  frag.a *= uOpacity;\n  gl_FragColor = frag;\n}",AREShader.shaders.texture.vertex=""+precision_declaration+"\n\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\n/* attribute vec2 aUVScale; */\n\nuniform mat4 uProjection;\nuniform mat4 uModelView;\n\nvarying "+varying_precision+" vec2 vTexCoord;\n/* varying "+varying_precision+" vec2 vUVScale; */\n\nvoid main() {\n  gl_Position = uProjection * uModelView * vec4(aPosition, 1, 1);\n  vTexCoord = aTexCoord;\n  /* vUVScale = aUVScale; */\n}",AREShader.shaders.texture.fragment=""+precision_declaration+"\n\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform float uOpacity;\n/* uniform "+varying_precision+" vec2 uUVScale; */\nuniform vec4 uClipRect;\n\nvarying "+varying_precision+" vec2 vTexCoord;\n/* varying "+varying_precision+" vec2 vUVScale; */\n\nvoid main() {\n  vec4 baseColor = texture2D(uSampler,\n                             uClipRect.xy +\n                             vTexCoord * uClipRect.zw);\n                             //vTexCoord * uClipRect.zw * uUVScale);\n  baseColor *= uColor;\n\n  if(baseColor.rgb == vec3(1.0, 0.0, 1.0))\n    discard;\n\n  baseColor.a *= uOpacity;\n  gl_FragColor = baseColor;\n}",ARERenderer=function(){function a(b,c,d){var e;if(this._width=c,this._height=d,b=param.optional(b,""),this._defaultShader=null,this._canvas=null,this._ctx=null,this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderSelectionRect=null,this._pickRenderCB=null,this.initError=void 0,0===b.length&&(b=void 0),null!==a.me)throw new Error("Only one instance of ARERenderer can be created!");if(a.me=this,this._width=param.optional(this._width,800),this._height=param.optional(this._height,600),this._width<=1||this._height<=1)throw new Error("Canvas must be at least 2x2 in size");if(e=function(b,c,d,e){var f;return f=a.me._canvas=document.createElement("canvas"),f.width=d,f.height=e,f.id="are_canvas","body"===b?document.getElementsByTagName(b)[0].appendChild(f):document.getElementById(b).appendChild(f)},void 0===b||null===b?(e("body","are_canvas",this._width,this._height),ARELog.info("Creating canvas #are_canvas ["+this._width+"x"+this._height+"]"),this._canvas=document.getElementById("are_canvas")):(this._canvas=document.getElementById(b),null===this._canvas?(e("body",b,this._width,this._height),ARELog.info("Creating canvas #"+b+" ["+this._width+"x"+this._height+"]"),this._canvas=document.getElementById(b)):"canvas"===this._canvas.nodeName.toLowerCase()?(ARELog.warn("Canvas exists, ignoring supplied dimensions"),this._width=this._canvas.width,this._height=this._canvas.height,ARELog.info("Using canvas #"+b+" ["+this._width+"x"+this._height+"]")):(e(b,"are_canvas",this._width,this._height),ARELog.info("Creating canvas #are_canvas ["+this._width+"x"+this._height+"]"))),null===this._canvas)return ARELog.error("Canvas does not exist!");switch(a.rendererMode){case a.RENDERER_MODE_NULL:this.initializeNullContext();break;case a.RENDERER_MODE_CANVAS:this.initializeCanvasContext();break;case a.RENDERER_MODE_WGL:this.initializeWGLContext(this._canvas)||(ARELog.info("Falling back on regular canvas renderer"),this.initializeCanvasContext());break;default:ARELog.error("Invalid Renderer "+a.rendererMode)}ARELog.info("Using the "+a.activeRendererMode+" renderer mode"),this.setClearColor(0,0,0),this.switchMaterial(a.MATERIAL_FLAT)}return a._nextID=0,a._gl=null,a.actors=[],a.actor_hash={},a.textures=[],a.me=null,a.camPos={x:0,y:0},a.RENDERER_MODE_NULL=0,a.RENDERER_MODE_CANVAS=1,a.RENDERER_MODE_WGL=2,a.rendererModes=[0,1,2],a.rendererMode=a.RENDERER_MODE_WGL,a.setRendererMode=function(a){return this.rendererMode=param.optional(a,null,this.rendererModes)},a.activeRendererMode=null,a.RENDER_MODE_LINE_LOOP=0,a.RENDER_MODE_TRIANGLE_FAN=1,a.RENDER_MODE_TRIANGLE_STRIP=2,a.renderModes=[0,1,2],a.RENDER_STYLE_STROKE=1,a.RENDER_STYLE_FILL=2,a.RENDER_STYLE_FILL_AND_STROKE=3,a.renderStyles=[0,1,2,3],a.MATERIAL_NONE="none",a.MATERIAL_FLAT="flat",a.MATERIAL_TEXTURE="texture",a._currentMaterial="none",a.force_pos0_0=!0,a.alwaysClearScreen=!1,a.prototype.initializeWGLContext=function(b){var c,d,e,f,g,h;return d={preserveDrawingBuffer:a.alwaysClearScreen,antialias:!0,alpha:!0,premultipliedAlpha:!0,depth:!0,stencil:!1},c=b.getContext("webgl",d),null===c&&(ARELog.warn("Continuing with experimental webgl support"),c=b.getContext("experimental-webgl")),null!==c?(a._gl=c,ARELog.info("Created WebGL context"),c.enable(c.DEPTH_TEST),c.enable(c.BLEND),c.depthFunc(c.LEQUAL),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),ARELog.info("Renderer initialized"),e=AREShader.shaders,h=e.wire,f=e.solid,g=e.texture,this._defaultShader=new AREShader(f.vertex,f.fragment,c,!0),this._defaultShader.generateHandles(),this._wireShader=new AREShader(h.vertex,h.fragment,c,!0),this._wireShader.generateHandles(),this._texShader=new AREShader(g.vertex,g.fragment,c,!0),this._texShader.generateHandles(),ARELog.info("Initialized shaders"),ARELog.info("ARE WGL initialized"),a.activeRendererMode=a.RENDERER_MODE_WGL,this.activeRenderMethod=this.wglRender,!0):void 0
},a.prototype.initializeCanvasContext=function(){return this._ctx=this._canvas.getContext("2d"),ARELog.info("ARE CTX initialized"),a.activeRendererMode=a.RENDERER_MODE_CANVAS,this.activeRenderMethod=this.cvRender,!0},a.prototype.initializeNullContext=function(){return this._ctx=this._canvas.getContext("2d"),ARELog.info("ARE Null initialized"),a.activeRendererMode=a.RENDERER_MODE_NULL,this.activeRenderMethod=this.nullRender,!0},a.prototype.activeRenderMethod=function(){},a.getMe=function(){return a.me},a.prototype.getDefaultShader=function(){return this._defaultShader},a.prototype.getWireShader=function(){return this._wireShader},a.prototype.getTextureShader=function(){return this._texShader},a.prototype.getCanvas=function(){return this._canvas},a.prototype.getContext=function(){return this._ctx},a.getGL=function(){return a._gl},a.prototype.getWidth=function(){return this._width},a.getWidth=function(){return this.me&&this.me.getWidth()||-1},a.prototype.getHeight=function(){return this._height},a.getHeight=function(){return this.me&&this.me.getHeight()||-1},a.prototype.getClearColor=function(){return this._clearColor},a.prototype.setClearColor=function(b,c,d){return void 0===this._clearColor&&(this._clearColor=new AREColor3),b instanceof AREColor3?this._clearColor=b:(this._clearColor.setR(b||0),this._clearColor.setG(c||0),this._clearColor.setB(d||0)),a.activeRendererMode===a.RENDERER_MODE_WGL?(b=this._clearColor.getR(!0),c=this._clearColor.getG(!0),d=this._clearColor.getB(!0),null!==a._gl&&void 0!==a._gl?a._gl.clearColor(b,c,d,1):ARELog.error("Can't set clear color, ARERenderer._gl not valid!")):void 0},a.prototype.requestPickingRenderWGL=function(a,b){return param.required(a),param.required(b),this._pickRenderRequested?void ARELog.warn("Pick render already requested! No request queue"):(this._pickRenderBuff=a,this._pickRenderSelectionRect=null,this._pickRenderCB=b,this._pickRenderRequested=!0)},a.prototype.requestPickingRenderCanvas=function(a,b){return param.required(a),param.required(b),this._pickRenderRequested?void ARELog.warn("Pick render already requested! No request queue"):(this._pickRenderBuff=null,this._pickRenderSelectionRect=a,this._pickRenderCB=b,this._pickRenderRequested=!0)},a.prototype.wglRender=function(){var b,c,d,e,f,g,h,i,j;if(e=a._gl,this._pickRenderRequested&&e.bindFramebuffer(e.FRAMEBUFFER,this._pickRenderBuff),a.alwaysClearScreen&&e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),d=a.actors.length,this._pickRenderRequested){for(;d--;)b=a.actors[d],c=b._id,i=b._color,j=b._opacity,f=c-255*Math.floor(c/255),g=Math.floor(c/255),this.switchMaterial(a.MATERIAL_FLAT),b.setColor(f,g,248),b.setOpacity(1),b.wglDraw(e,this._defaultShader),b.setColor(i),b.setOpacity(j);return this._pickRenderCB(),this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderCB=null,e.bindFramebuffer(e.FRAMEBUFFER,null),this.render()}for(h=[];d--;)b=a.actors[d],b._attachedTexture&&(b=b.updateAttachment()),b._material!==a._currentMaterial&&this.switchMaterial(b._material),h.push(b.wglDraw(e));return h},a.prototype.cvRender=function(){var b,c,d,e,f,g,h,i,j,k,l;if(c=this._ctx,void 0!==c&&null!==c){for(this._clearColor?(c.fillStyle="rgb"+this._clearColor,c.fillRect(0,0,this._width,this._height)):c.clearRect(0,0,this._width,this._height),c.save(),c.translate(0,this._height),c.scale(1,-1),j=a.actors,f=0,i=j.length;i>f;f++)b=j[f],c.save(),this._pickRenderRequested?(k=b.getColor(),l=b.getOpacity(),g=b.getId()-255*Math.floor(b.getId()/255),h=Math.floor(b.getId()/255),this.switchMaterial(a.MATERIAL_FLAT),b.setColor(g,h,248),b.setOpacity(1),b.cvDraw(c),b.setColor(k),b.setOpacity(l)):(b=b.updateAttachment(),(d=b.getMaterial())!==a._currentMaterial&&this.switchMaterial(d),b.cvDraw(c)),c.restore();return c.restore(),this._pickRenderRequested?(e=this._pickRenderSelectionRect,this._pickRenderCB(c.getImageData(e.x,e.y,e.width,e.height)),this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderSelectionRect=null,this._pickRenderCB=null,this.render()):void 0}},a.prototype.nullRender=function(){var b,c,d,e,f,g;if(c=this._ctx,void 0!==c&&null!==c){for(this._clearColor?(c.fillStyle="rgb"+this._clearColor,c.fillRect(0,0,this._canvas.width,this._canvas.height)):c.clearRect(0,0,this._canvas.width,this._canvas.height),f=a.actors,g=[],d=0,e=f.length;e>d;d++)b=f[d],b=b.updateAttachment(),g.push(b.nullDraw(c));return g}},a.prototype.clearScreen=function(){var b,c;switch(a.activeRendererMode){case a.RENDERER_MODE_CANVAS:return b=this._ctx,this._clearColor?(b.fillStyle="rgb"+this._clearColor,b.fillRect(0,0,this._width,this._height)):b.clearRect(0,0,this._width,this._height);case a.RENDERER_MODE_WGL:return c=a._gl,c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT)}},a.prototype.getActiveRendererMode=function(){return a.activeRendererMode},a.prototype.isNullRendererActive=function(){return this.getActiveRendererMode()===a.RENDERER_MODE_NULL},a.prototype.isCanvasRendererActive=function(){return this.getActiveRendererMode()===a.RENDERER_MODE_CANVAS},a.prototype.isWGLRendererActive=function(){return this.getActiveRendererMode()===a.RENDERER_MODE_WGL},a.getNextId=function(){return a._nextID++},a.addActor=function(b,c){var d;return param.required(b),c=param.optional(c,b.layer),b.layer!==c&&(b.layer=c),d=_.sortedIndex(a.actors,b,"layer"),a.actors.splice(d,0,b),a.actor_hash[b.getId()]=b,b},a.removeActor=function(b,c){var d,e,f,g,h,i;for(param.required(b),c=param.optional(c,!1),e=b,e instanceof ARERawActor&&(e=e.getId()),i=a.actors,f=g=0,h=i.length;h>g;f=++g)if(d=i[f],d.getId()===e)return a.actors.splice(f,1),c||b.destroy(),!0;return!1},a.prototype.switchMaterial=function(b){var c,d,e;if(param.required(b),b===a._currentMaterial)return!1;if(this.isWGLRendererActive())switch(e=Matrix4.makeOrtho(0,this._width,0,this._height,-10,10).flatten(),e[15]=1,c=a._gl,b){case a.MATERIAL_FLAT:c.useProgram(this._defaultShader.getProgram()),d=this._defaultShader.getHandles(),c.uniformMatrix4fv(d.uProjection,!1,e),c.enableVertexAttribArray(d.aPosition);break;case a.MATERIAL_TEXTURE:c.useProgram(this._texShader.getProgram()),d=this._texShader.getHandles(),c.uniformMatrix4fv(d.uProjection,!1,e),c.enableVertexAttribArray(d.aPosition),c.enableVertexAttribArray(d.aTexCoord);break;default:throw new Error("Unknown material "+b)}return a._currentMaterial=b,ARELog.info("ARERenderer Switched material "+a._currentMaterial)},a.hasTexture=function(b){var c,d,e,f;for(f=a.textures,d=0,e=f.length;e>d;d++)if(c=f[d],c.name===b)return!0;return!1},a.getTexture=function(b){var c,d,e,f;for(param.required(b),f=a.textures,d=0,e=f.length;e>d;d++)if(c=f[d],c.name===b)return c;return null},a.getTextureSize=function(a){var b;return param.required(a),(b=this.getTexture(a))?{w:b.width*b.scaleX,h:b.height*b.scaleY}:null},a.addTexture=function(b){return param.required(b.name),param.required(b.texture),a.textures.push(b)},a}(),PhysicsManager=function(a){function b(){b.__super__.constructor.call(this,"PhysicsManager",[{raw:"cp = exports = {};"},{url:"/components/chipmunk/cp.js"},{url:"/lib/koon/koon.js"},{url:"/lib/physics/worker.js"}])}return __extends(b,a),b.prototype._connectWorkerListener=function(){var a,b,c,d,e,f;return a=0,b=1,c=2,e={},f={},d={},this._worker.onmessage=function(g){return function(h){var i,j;if(e=h.data,e.length){for(i=e.length,j=[];i--;)f=e[i],d=ARERenderer.actor_hash[f[a]],d._position=f[b],d._rotation=f[c],j.push(d._updateModelMatrix());return j}return g.broadcast(h.data.message,h.data.namespace)}}(this)},b}(BazarShop),ARELog=function(){function a(){}return a.tags=["","[Error]> ","[Warning]> ","[Debug]> ","[Info]> "],a.level=4,a.w=function(b,c){var d;return d=a,b>d.level||0===b||0===d.level?void 0:1===b&&void 0!==console.error?console.error?console.error(""+d.tags[b]+c):console.log(""+d.tags[b]+c):2===b&&void 0!==console.warn?console.warn?console.warn(""+d.tags[b]+c):console.log(""+d.tags[b]+c):3===b&&void 0!==console.debug?console.debug?console.debug(""+d.tags[b]+c):console.log(""+d.tags[b]+c):4===b&&void 0!==console.info?console.info?console.info(""+d.tags[b]+c):console.log(""+d.tags[b]+c):console.log(b>4&&void 0!==d.tags[b]?""+d.tags[b]+c:c)},a.error=function(a){return this.w(1,a)},a.warn=function(a){return this.w(2,a)},a.debug=function(a){return this.w(3,a)},a.info=function(a){return this.w(4,a)},a}(),AREBezAnimation=function(){function a(a,b,c){this.actor=a,c=param.optional(c,!1),this.options=param.required(b),this._duration=param.required(b.duration),param.required(b.endVal),this._property=param.required(b.property),b.controlPoints=param.optional(b.controlPoints,[]),this._fps=param.optional(b.fps,30),c?(param.optional(this.actor),param.required(b.startVal)):param.required(this.actor),this._animated=!1,this.bezOpt={},b.controlPoints.length>0?(this.bezOpt.degree=b.controlPoints.length,this.bezOpt.degree>0&&(param.required(b.controlPoints[0].x),param.required(b.controlPoints[0].y),2===this.bezOpt.degree&&(param.required(b.controlPoints[1].x),param.required(b.controlPoints[1].y))),this.bezOpt.ctrl=b.controlPoints):this.bezOpt.degree=0,this.bezOpt.endPos=param.required(b.endVal),this.tIncr=1/(this._duration*(this._fps/1e3)),c?this.bezOpt.startPos=b.startVal:("rotation"===this._property&&(this.bezOpt.startPos=this.actor.getRotation()),"position"===this._property[0]&&("x"===this._property[1]?this.bezOpt.startPos=this.actor.getPosition().x:"y"===this._property[1]&&(this.bezOpt.startPos=this.actor.getPosition().y)),"color"===this._property[0]&&("r"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getR():"g"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getG():"b"===this._property[1]&&(this.bezOpt.startPos=this.actor.getColor().getB())))}return a.prototype._update=function(a,b){var c,d,e,f,g,h;if(param.required(a),b=param.optional(b,!0),a>1||0>a)throw new Error("t out of bounds! "+a);if(0===this.bezOpt.degree)c=this.bezOpt.startPos+(this.bezOpt.endPos-this.bezOpt.startPos)*a;else if(1===this.bezOpt.degree)d=1-a,e=d*d,g=a*a,c=e*this.bezOpt.startPos+2*d*a*this.bezOpt.ctrl[0].y+g*this.bezOpt.endPos;else{if(2!==this.bezOpt.degree)throw new Error("Invalid degree, can't evaluate ("+this.bezOpt.degree+")");d=1-a,e=d*d,f=e*d,g=a*a,h=g*a,c=f*this.bezOpt.startPos+3*e*a*this.bezOpt.ctrl[0].y+3*d*g*this.bezOpt.ctrl[1].y+h*this.bezOpt.endPos}return b&&(this._applyValue(c),void 0!==this.options.cbStep&&this.options.cbStep(c)),c},a.prototype.preCalculate=function(){var a,b;for(b=0,a={stepTime:this._duration*this.tIncr},a.values=[];1>=b;){if(b+=this.tIncr,b>1&&b<1+this.tIncr)b=1;else if(b>1)break;a.values.push(this._update(b,!1))}return a},a.prototype._applyValue=function(a){var b,c,d,e;if("rotation"===this._property&&this.actor.setRotation(a),"position"===this._property[0]&&("x"===this._property[1]?(b=new cp.v(a,this.actor.getPosition().y),this.actor.setPosition(b)):"y"===this._property[1]&&(b=new cp.v(this.actor.getPosition().x,a),this.actor.setPosition(b))),"color"===this._property[0]){if("r"===this._property[1])return e=a,d=this.actor.getColor().getG(),c=this.actor.getColor().getB(),this.actor.setColor(e,d,c);if("g"===this._property[1])return e=this.actor.getColor().getR(),d=a,c=this.actor.getColor().getB(),this.actor.setColor(e,d,c);if("b"===this._property[1])return e=this.actor.getColor().getR(),d=this.actor.getColor().getG(),c=a,this.actor.setColor(e,d,c)}},a.prototype.animate=function(){var a;if(!this._animated)return this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),a=-this.tIncr,this._intervalID=setInterval(function(b){return function(){if(a+=b.tIncr,a>1){if(clearInterval(b._intervalID),void 0!==b.options.cbEnd)return b.options.cbEnd()}else if(b._update(a),void 0!==b.options.cbStep)return b.options.cbStep()}}(this),1e3/this._fps)},a}(),AREVertAnimation=function(){function a(a,b){return this.actor=a,this.options=b,param.required(this.actor),param.required(this.options),param.required(this.options.delays),param.required(this.options.deltas),this.options.delays.length!==this.options.deltas.length?(ARELog.warn("Vert animation delay count != delta set count! Bailing."),void(this._animated=!0)):void(this._animated=!1)}return a.prototype._setTimeout=function(a,b,c,d){return param.required(a),param.required(b),c=param.optional(c,null),setTimeout(function(b){return function(){return b._applyDeltas(a,c),d&&void 0!==b.options.cbEnd?b.options.cbEnd():void 0}}(this),b)},a.prototype._applyDeltas=function(a,b){var c,d,e,f,g,h,i;for(param.required(a),void 0!==this.options.cbStep&&this.options.cbStep(b),d=this.actor.getVertices(),f=-1!==a.join("_").indexOf("...")?!0:!1,e=h=0,i=a.length;i>=0?i>h:h>i;e=i>=0?++h:--h){if(c=a[e],e>=d.length){if(f)break;g=void 0}else g=d[e];if("number"==typeof c)g=c;else{if("string"!=typeof c)return void ARELog.warn("Unknown delta type, can't apply deltas! "+c+" "+typeof c);if(void 0===g)return void ARELog.warn("Vertex does not exist, yet delta is relative!");if("|"===c.charAt(0))break;if("-"===c.charAt(0))g-=Number(c.slice(1));else if("+"===c.charAt(0))g+=Number(c.slice(1));else if("..."===c)e=0;else if("."!==c.charAt(0))return void ARELog.warn("Unknown delta action, "+c+", can't apply deltas.")}if(e>d.length)return void ARELog.warn("Vertex gap, can't push new vert! "+g+":"+c+":"+e);e===d.length?d.push(g):d[e]=g}return this.actor.updateVertices(d)},a.prototype.animate=function(){var a,b,c,d,e,f;if(!this._animated){for(this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),f=[],a=d=0,e=this.options.deltas.length;e>=0?e>d:d>e;a=e>=0?++d:--d)c=null,void 0!==this.options.udata&&(this.options.udata instanceof Array?a<this.options.udata.length&&(c=this.options.udata[a]):c=this.options.udata),b=a===this.options.deltas.length-1?!0:!1,f.push(this._setTimeout(this.options.deltas[a],this.options.delays[a],c,b));return f}},a}(),AREPsyxAnimation=function(){function a(a,b){this.actor=a,this.options=b,param.required(this.actor),param.required(this.options.mass),param.required(this.options.friction),param.required(this.options.elasticity),param.required(this.options.timeout),this._animated=!1}return a.prototype.animate=function(){return this._animated?void 0:(this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),setTimeout(function(a){return function(){return a.actor.createPhysicsBody(a.options.mass,a.options.friction,a.options.elasticity),void 0!==a.options.cbEnd?a.options.cbEnd():void 0}}(this),this.options.timeout))},a}(),AREActorInterface=function(){function a(){}return a.prototype._findActor=function(a){var b,c,d,e;for(param.required(a),e=ARERenderer.actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a)return b;return null},a.prototype.createRawActor=function(a){return param.required(a),new ARERawActor(JSON.parse(a)).getId()},a.prototype.createPolygonActor=function(a,b){return param.required(a),"string"==typeof a?this.createRawActor(a):(param.required(b),new AREPolygonActor(a,b).getId())},a.prototype.createRectangleActor=function(a,b){return param.required(a),param.required(b),new ARERectangleActor(a,b).getId()},a.prototype.createCircleActor=function(a){return param.required(a),new ARECircleActor(a).getId()},a.prototype.getActorLayer=function(a){var b;return(b=this._findActor(a))?b.getLayer():null},a.prototype.getActorPhysicsLayer=function(a){var b;return(b=this._findActor(a))?b.getPhysicsLayer():null},a.prototype.getRectangleActorWidth=function(a){var b,c,d,e;for(e=ARERenderer.actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a&&b instanceof ARERectangleActor)return b.getWidth();return null},a.prototype.getRectangleActorHeight=function(a){var b,c,d,e;for(e=ARERenderer.actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a&&b instanceof ARERectangleActor)return b.getHeight();return null},a.prototype.getCircleActorRadius=function(a){var b,c,d,e;for(e=ARERenderer.actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a&&b instanceof AREPolygonActor)return b.getRadius();return null},a.prototype.getActorOpacity=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?b.getOpacity():null},a.prototype.getActorVisible=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?b.getVisible():null},a.prototype.getActorPosition=function(a){var b,c;return param.required(a),null!==(b=this._findActor(a))?(c=b.getPosition(),JSON.stringify({x:c.x,y:c.y})):null},a.prototype.getActorRotation=function(a,b){var c;return param.required(a),b=param.optional(b,!1),null!==(c=this._findActor(a))?c.getRotation(b):1e-6},a.prototype.getActorColor=function(a){var b,c;return param.required(a),null!==(b=this._findActor(a))?(c=b.getColor(),JSON.stringify({r:c.getR(),g:c.getG(),b:c.getB()})):null},a.prototype.getActorTexture=function(a){var b,c;return null!==(b=this._findActor(a))?(c=b.getTexture(),c.name):null},a.prototype.getActorTextureRepeat=function(a){var b,c;return null!==(b=this._findActor(a))?(c=b.getTextureRepeat(),JSON.stringify(c)):null},a.prototype.setRectangleActorHeight=function(a,b){var c,d,e,f;for(f=ARERenderer.actors,d=0,e=f.length;e>d;d++)if(c=f[d],c.getId()===a&&c instanceof ARERectangleActor)return c.setHeight(b),!0;return!1},a.prototype.setRectangleActorWidth=function(a,b){var c,d,e,f;for(f=ARERenderer.actors,d=0,e=f.length;e>d;d++)if(c=f[d],c.getId()===a&&c instanceof ARERectangleActor)return c.setWidth(b),!0;return!1},a.prototype.setCircleActorRadius=function(a,b){var c,d,e,f;for(f=ARERenderer.actors,d=0,e=f.length;e>d;d++)if(c=f[d],c.getId()===a&&c instanceof AREPolygonActor)return c.setRadius(b),!0;return!1},a.prototype.attachTexture=function(a,b,c,d,e,f,g){var h;return param.required(g),param.required(a),param.required(b),param.required(c),d=param.optional(d,0),e=param.optional(e,0),f=param.optional(f,0),null!==(h=this._findActor(g))?(h.attachTexture(a,b,c,d,e,f),!0):!1},a.prototype.setActorLayer=function(a,b){var c;return param.required(b),param.required(a),null!==(c=this._findActor(b))?(c.setLayer(a),!0):!1},a.prototype.setActorPhysicsLayer=function(a,b){var c;return param.required(b),param.required(a),null!==(c=this._findActor(b))?(c.setPhysicsLayer(a),!0):!1},a.prototype.removeAttachment=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?(b.removeAttachment(),!0):!1},a.prototype.setAttachmentVisiblity=function(a,b){var c;return param.required(a),null!==(c=this._findActor(b))?c.setAttachmentVisibility(a):!1},a.prototype.updateVertices=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.updateVertices(JSON.parse(a)),!0):!1},a.prototype.getVertices=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?JSON.stringify(b.getVertices()):null},a.prototype.destroyActor=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?(b.destroyPhysicsBody(),ARERenderer.removeActor(b),!0):!1},a.prototype.setPhysicsVertices=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.setPhysicsVertices(JSON.parse(a)),!0):!1},a.prototype.setRenderMode=function(a,b){var c;return a=param.required(a,ARERenderer.renderModes),param.required(b),null!==(c=this._findActor(b))?(c.setRenderMode(a),!0):!1},a.prototype.setActorOpacity=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.setOpacity(a),!0):!1},a.prototype.setActorVisible=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.setVisible(a),!0):!1},a.prototype.setActorPosition=function(a,b,c){var d;return param.required(a),param.required(b),param.required(c),null!==(d=this._findActor(c))?(d.setPosition(new cp.v(a,b)),!0):!1},a.prototype.setActorRotation=function(a,b,c){var d;return param.required(a),param.required(b),c=param.optional(c,!1),null!==(d=this._findActor(b))?(d.setRotation(a,c),!0):!1},a.prototype.setActorColor=function(a,b,c,d){var e;return param.required(a),param.required(b),param.required(c),param.required(d),null!==(e=this._findActor(d))?(e.setColor(new AREColor3(a,b,c)),!0):!1},a.prototype.setActorTexture=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.setTexture(a),!0):!1},a.prototype.setActorTextureRepeat=function(a,b,c){var d;return param.required(a),param.required(c),b=param.optional(b,1),null!==(d=this._findActor(c))?(d.setTextureRepeat(a,b),!0):!1},a.prototype.enableActorPhysics=function(a,b,c,d){var e;return param.required(d),param.required(a),param.required(b),param.required(c),null!==(e=this._findActor(d))?(e.createPhysicsBody(a,b,c),!0):!1},a.prototype.destroyPhysicsBody=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?(b.destroyPhysicsBody(),!0):!1},a}(),nextHighestPowerOfTwo=function(a){var b;for(--a,b=1;32>b;)a|=a>>b,b<<=1;return a+1},AREEngineInterface=function(){function a(){}return a.prototype.initialize=function(a,b,c,d,e){return param.required(c),param.required(a),param.required(b),d=param.optional(d,4),e=param.optional(e,""),ARERenderer.actors=[],ARERenderer.textures=[],ARERenderer._gl=null,ARERenderer.me=null,ARERenderer._currentMaterial="none",ARERenderer.camPos={x:0,y:0},this.wglFlipTextureY=!1,new AREEngine(a,b,function(a){return function(b){return a._engine=b,b.startRendering(),c(b)}}(this),d,e)},a.prototype.getRendererMode=function(){return ARERenderer.rendererMode},a.prototype.setRendererMode=function(a){return ARERenderer.setRendererMode(a)},a.prototype.setClearColor=function(a,b,c){return param.required(a),param.required(b),param.required(c),void 0!==this._engine?ARERenderer.me.setClearColor(a,b,c):void 0},a.prototype.getClearColor=function(){var a;return void 0===this._engine?null:(a=ARERenderer.me.getClearColor(),JSON.stringify({r:a.getR(),g:a.getG(),b:a.getB()}))},a.prototype.setLogLevel=function(a){return param.required(a,[0,1,2,3,4]),ARELog.level=a},a.prototype.setCameraPosition=function(a,b){return ARERenderer.camPos.x=param.optional(a,ARERenderer.camPos.x),ARERenderer.camPos.y=param.optional(b,ARERenderer.camPos.y)},a.prototype.getCameraPosition=function(){return JSON.stringify(ARERenderer.camPos)},a.prototype.getWidth=function(){return null===this._engine||void 0===this._engine?-1:this._engine.getWidth()},a.prototype.getHeight=function(){return null===this._engine||void 0===this._engine?-1:this._engine.getHeight()},a.prototype.setBenchmark=function(a){return this._engine.benchmark=a,window.AREMessages.broadcast({value:a},"physics.benchmark.set")},a.prototype.loadManifest=function(a,b){var c,d,e,f,g,h,i;if(param.required(a),e=JSON.parse(a),void 0!==e.textures&&(e=e.textures),_.isEmpty(e))return b();for(c=0,d=this.wglFlipTextureY,i=[],g=0,h=e.length;h>g;g++){if(f=e[g],void 0!==f.compression&&"none"!==f.compression)throw console.error(f.compression),new Error("Only un-compressed textures are supported!");if(void 0!==f.type&&"image"!==f.type)throw console.error(f.type),new Error("Only image textures are supported!");i.push(this.loadTexture(f.name,f.path,d,function(){return c++,c===e.length?b():void 0}))}return i},a.prototype.loadTexture=function(a,b,c,d){var e,f,g;return c=param.optional(c,this.wglFlipTextureY),ARELog.info("Loading texture: "+a+", "+b),f=new Image,f.crossOrigin="anonymous",e=ARERenderer._gl,g=null,ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL?(ARELog.info("Loading Gl Texture"),g=e.createTexture(),f.onload=function(){var b,h,i,j,k,l;return j=1,k=1,l=0!==(f.width&f.width-1),i=0!==(f.height&f.height-1),(l||i)&&(b=document.createElement("canvas"),b.width=nextHighestPowerOfTwo(f.width),b.height=nextHighestPowerOfTwo(f.height),j=f.width/b.width,k=f.height/b.height,h=b.getContext("2d"),h.drawImage(f,0,0,b.width,b.height),f=b),e.bindTexture(e.TEXTURE_2D,g),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,c),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,f),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,null),ARERenderer.addTexture({name:a,texture:g,width:f.width,height:f.height,scaleX:j,scaleY:k}),d?d():void 0}):(ARELog.info("Loading Canvas Image"),f.onload=function(){return ARERenderer.addTexture({name:a,texture:f,width:f.width,height:f.height}),d?d():void 0}),f.src=b},a.prototype.getTextureSize=function(a){return ARERenderer.getTextureSize(a)},a.prototype.setRemindMeButton=function(){},a}(),AREAnimationInterface=function(){function a(){}return a._animationMap={position:AREBezAnimation,color:AREBezAnimation,rotation:AREBezAnimation,mass:AREPsyxAnimation,friction:AREPsyxAnimation,elasticity:AREPsyxAnimation,physics:AREPsyxAnimation,vertices:AREVertAnimation},a.prototype.canAnimate=function(b){return void 0===a._animationMap[b]?!1:!0},a.prototype.getAnimationName=function(b){var c;return void 0===a._animationMap[b]?!1:(c=a._animationMap[b],c===AREBezAnimation?"bezier":c===AREPsyxAnimation?"psyx":c===AREVertAnimation?"vert":void 0)},a.prototype.animate=function(b,c,d){var e,f,g,h,i,j,k;for(param.required(b),c=JSON.parse(param.required(c)),d=JSON.parse(param.required(d)),d.start=param.optional(d.start,0),f=null,j=ARERenderer.actors,h=0,i=j.length;i>h;h++)if(e=j[h],e.getId()===b){f=e;break}if(null===f)throw new Error("Actor not found, can't animate! "+actorId);return g=c[0],void 0===d.property&&(d.property=c),k=function(b,c,d){return a._animationMap[b]===AREBezAnimation?new AREBezAnimation(c,d).animate():a._animationMap[b]===AREPsyxAnimation?new AREPsyxAnimation(c,d).animate():a._animationMap[b]===AREVertAnimation?new AREVertAnimation(c,d).animate():ARELog.warn("Unrecognized property: "+b)},d.start>0?setTimeout(function(){return k(g,f,d)},d.start):k(g,f,d)},a.prototype.preCalculateBez=function(a){var b;return a=JSON.parse(param.required(a)),param.required(a.startVal),param.required(a.endVal),param.required(a.duration),a.controlPoints=param.required(a.controlPoints,[]),a.fps=param.required(a.fps,30),b=new AREBezAnimation(null,a,!0).preCalculate(),JSON.stringify(b)},a}(),AREInterface=function(){function a(){this._Actors=new AREActorInterface,this._Engine=new AREEngineInterface,this._Animations=new AREAnimationInterface}return a.prototype.Actors=function(){return this._Actors},a.prototype.Engine=function(){return this._Engine},a.prototype.Animations=function(){return this._Animations},a}(),AREEngine=function(){function a(a,b,c,d,e){return param.required(a),param.required(b),param.required(c),ARELog.level=param.optional(d,4),e=param.optional(e,""),this._renderIntervalId=null,this.benchmark=!1,this.setFPS(60),null===window._||void 0===window._?ARELog.error("Underscore.js is not present!"):(window.AREMessages=new KoonFlock("AREMessages"),window.AREMessages.registerKoon(window.Bazar),this._physics=new PhysicsManager,this._renderer=new ARERenderer(e,a,b),this._currentlyRendering=!1,this.startRendering(),void c(this))}return a.prototype.setFPS=function(a){return this._framerate=1/a,this},a.prototype.startRendering=function(){var a,b;if(!this._currentlyRendering)return this._currentlyRendering=!0,ARELog.info("Starting render loop"),b=this._renderer,a=function(){return b.activeRenderMethod(),window.requestAnimationFrame(a)},window.requestAnimationFrame(a)},a.prototype.setClearColor=function(a,b,c){return a=param.optional(a,0),b=param.optional(b,0),c=param.optional(c,0),this._renderer instanceof ARERenderer&&this._renderer.setClearColor(a,b,c),this},a.prototype.getClearColor=function(){return this._renderer instanceof ARERenderer?this._renderer.getClearColor():null},a.prototype.getWidth=function(){return null===this._renderer||void 0===this._renderer?-1:this._renderer.getWidth()},a.prototype.getHeight=function(){return null===this._renderer||void 0===this._renderer?-1:this._renderer.getHeight()},a.prototype.requestPickingRenderWGL=function(a,b){return null===this._renderer||void 0===this._renderer?ARELog.warn("Can't request a pick render, renderer not instantiated!"):this._renderer.isWGLRendererActive()?this._renderer.requestPickingRenderWGL(a,b):ARELog.warn("Can't request a WGL pick render, not using WGL renderer")},a.prototype.requestPickingRenderCanvas=function(a,b){return null===this._renderer||void 0===this._renderer?ARELog.warn("Can't request a pick render, renderer not instantiated!"):this._renderer.isCanvasRendererActive()?this._renderer.requestPickingRenderCanvas(a,b):ARELog.warn("Can't request a canvas pick render, not using canvas renderer")},a.prototype.getGL=function(){return null===ARERenderer._gl&&ARELog.warn("Render not instantiated!"),ARERenderer._gl},a.prototype.getActiveRendererMode=function(){return ARERenderer.activeRendererMode},a}(),window.AdefyGLI=window.AdefyRE=new AREInterface,AREVersion={MAJOR:1,MINOR:1,PATCH:1,BUILD:null,STRING:"1.1.1"};