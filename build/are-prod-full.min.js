/* Copyright Â© 2013 Spectrum IT Solutions Gmbh - All Rights Reserved */
(function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=Function.prototype,g=d.push,h=d.slice,i=d.concat,j=e.toString,k=e.hasOwnProperty,l=d.forEach,m=d.map,n=d.reduce,o=d.reduceRight,p=d.filter,q=d.every,r=d.some,s=d.indexOf,t=d.lastIndexOf,u=Array.isArray,v=Object.keys,w=f.bind,x=function(a){return a instanceof x?a:this instanceof x?void(this._wrapped=a):new x(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):a._=x,x.VERSION="1.6.0";var y=x.each=x.forEach=function(a,b,d){if(null==a)return a;if(l&&a.forEach===l)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;f>e;e++)if(b.call(d,a[e],e,a)===c)return}else for(var g=x.keys(a),e=0,f=g.length;f>e;e++)if(b.call(d,a[g[e]],g[e],a)===c)return;return a};x.map=x.collect=function(a,b,c){var d=[];return null==a?d:m&&a.map===m?a.map(b,c):(y(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d)};var z="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),n&&a.reduce===n)return d&&(b=x.bind(b,d)),e?a.reduce(b,c):a.reduce(b);if(y(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)}),!e)throw new TypeError(z);return c},x.reduceRight=x.foldr=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),o&&a.reduceRight===o)return d&&(b=x.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=a.length;if(f!==+f){var g=x.keys(a);f=g.length}if(y(a,function(h,i,j){i=g?g[--f]:--f,e?c=b.call(d,c,a[i],i,j):(c=a[i],e=!0)}),!e)throw new TypeError(z);return c},x.find=x.detect=function(a,b,c){var d;return A(a,function(a,e,f){return b.call(c,a,e,f)?(d=a,!0):void 0}),d},x.filter=x.select=function(a,b,c){var d=[];return null==a?d:p&&a.filter===p?a.filter(b,c):(y(a,function(a,e,f){b.call(c,a,e,f)&&d.push(a)}),d)},x.reject=function(a,b,c){return x.filter(a,function(a,d,e){return!b.call(c,a,d,e)},c)},x.every=x.all=function(a,b,d){b||(b=x.identity);var e=!0;return null==a?e:q&&a.every===q?a.every(b,d):(y(a,function(a,f,g){return(e=e&&b.call(d,a,f,g))?void 0:c}),!!e)};var A=x.some=x.any=function(a,b,d){b||(b=x.identity);var e=!1;return null==a?e:r&&a.some===r?a.some(b,d):(y(a,function(a,f,g){return e||(e=b.call(d,a,f,g))?c:void 0}),!!e)};x.contains=x.include=function(a,b){return null==a?!1:s&&a.indexOf===s?-1!=a.indexOf(b):A(a,function(a){return a===b})},x.invoke=function(a,b){var c=h.call(arguments,2),d=x.isFunction(b);return x.map(a,function(a){return(d?b:a[b]).apply(a,c)})},x.pluck=function(a,b){return x.map(a,x.property(b))},x.where=function(a,b){return x.filter(a,x.matches(b))},x.findWhere=function(a,b){return x.find(a,x.matches(b))},x.max=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.max.apply(Math,a);var d=-1/0,e=-1/0;return y(a,function(a,f,g){var h=b?b.call(c,a,f,g):a;h>e&&(d=a,e=h)}),d},x.min=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.min.apply(Math,a);var d=1/0,e=1/0;return y(a,function(a,f,g){var h=b?b.call(c,a,f,g):a;e>h&&(d=a,e=h)}),d},x.shuffle=function(a){var b,c=0,d=[];return y(a,function(a){b=x.random(c++),d[c-1]=d[b],d[b]=a}),d},x.sample=function(a,b,c){return null==b||c?(a.length!==+a.length&&(a=x.values(a)),a[x.random(a.length-1)]):x.shuffle(a).slice(0,Math.max(0,b))};var B=function(a){return null==a?x.identity:x.isFunction(a)?a:x.property(a)};x.sortBy=function(a,b,c){return b=B(b),x.pluck(x.map(a,function(a,d,e){return{value:a,index:d,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index-b.index}),"value")};var C=function(a){return function(b,c,d){var e={};return c=B(c),y(b,function(f,g){var h=c.call(d,f,g,b);a(e,h,f)}),e}};x.groupBy=C(function(a,b,c){x.has(a,b)?a[b].push(c):a[b]=[c]}),x.indexBy=C(function(a,b,c){a[b]=c}),x.countBy=C(function(a,b){x.has(a,b)?a[b]++:a[b]=1}),x.sortedIndex=function(a,b,c,d){c=B(c);for(var e=c.call(d,b),f=0,g=a.length;g>f;){var h=f+g>>>1;c.call(d,a[h])<e?f=h+1:g=h}return f},x.toArray=function(a){return a?x.isArray(a)?h.call(a):a.length===+a.length?x.map(a,x.identity):x.values(a):[]},x.size=function(a){return null==a?0:a.length===+a.length?a.length:x.keys(a).length},x.first=x.head=x.take=function(a,b,c){return null==a?void 0:null==b||c?a[0]:0>b?[]:h.call(a,0,b)},x.initial=function(a,b,c){return h.call(a,0,a.length-(null==b||c?1:b))},x.last=function(a,b,c){return null==a?void 0:null==b||c?a[a.length-1]:h.call(a,Math.max(a.length-b,0))},x.rest=x.tail=x.drop=function(a,b,c){return h.call(a,null==b||c?1:b)},x.compact=function(a){return x.filter(a,x.identity)};var D=function(a,b,c){return b&&x.every(a,x.isArray)?i.apply(c,a):(y(a,function(a){x.isArray(a)||x.isArguments(a)?b?g.apply(c,a):D(a,b,c):c.push(a)}),c)};x.flatten=function(a,b){return D(a,b,[])},x.without=function(a){return x.difference(a,h.call(arguments,1))},x.partition=function(a,b){var c=[],d=[];return y(a,function(a){(b(a)?c:d).push(a)}),[c,d]},x.uniq=x.unique=function(a,b,c,d){x.isFunction(b)&&(d=c,c=b,b=!1);var e=c?x.map(a,c,d):a,f=[],g=[];return y(e,function(c,d){(b?d&&g[g.length-1]===c:x.contains(g,c))||(g.push(c),f.push(a[d]))}),f},x.union=function(){return x.uniq(x.flatten(arguments,!0))},x.intersection=function(a){var b=h.call(arguments,1);return x.filter(x.uniq(a),function(a){return x.every(b,function(b){return x.contains(b,a)})})},x.difference=function(a){var b=i.apply(d,h.call(arguments,1));return x.filter(a,function(a){return!x.contains(b,a)})},x.zip=function(){for(var a=x.max(x.pluck(arguments,"length").concat(0)),b=new Array(a),c=0;a>c;c++)b[c]=x.pluck(arguments,""+c);return b},x.object=function(a,b){if(null==a)return{};for(var c={},d=0,e=a.length;e>d;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},x.indexOf=function(a,b,c){if(null==a)return-1;var d=0,e=a.length;if(c){if("number"!=typeof c)return d=x.sortedIndex(a,b),a[d]===b?d:-1;d=0>c?Math.max(0,e+c):c}if(s&&a.indexOf===s)return a.indexOf(b,c);for(;e>d;d++)if(a[d]===b)return d;return-1},x.lastIndexOf=function(a,b,c){if(null==a)return-1;var d=null!=c;if(t&&a.lastIndexOf===t)return d?a.lastIndexOf(b,c):a.lastIndexOf(b);for(var e=d?c:a.length;e--;)if(a[e]===b)return e;return-1},x.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=new Array(d);d>e;)f[e++]=a,a+=c;return f};var E=function(){};x.bind=function(a,b){var c,d;if(w&&a.bind===w)return w.apply(a,h.call(arguments,1));if(!x.isFunction(a))throw new TypeError;return c=h.call(arguments,2),d=function(){if(!(this instanceof d))return a.apply(b,c.concat(h.call(arguments)));E.prototype=a.prototype;var e=new E;E.prototype=null;var f=a.apply(e,c.concat(h.call(arguments)));return Object(f)===f?f:e}},x.partial=function(a){var b=h.call(arguments,1);return function(){for(var c=0,d=b.slice(),e=0,f=d.length;f>e;e++)d[e]===x&&(d[e]=arguments[c++]);for(;c<arguments.length;)d.push(arguments[c++]);return a.apply(this,d)}},x.bindAll=function(a){var b=h.call(arguments,1);if(0===b.length)throw new Error("bindAll must be passed function names");return y(b,function(b){a[b]=x.bind(a[b],a)}),a},x.memoize=function(a,b){var c={};return b||(b=x.identity),function(){var d=b.apply(this,arguments);return x.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}},x.delay=function(a,b){var c=h.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},x.defer=function(a){return x.delay.apply(x,[a,1].concat(h.call(arguments,1)))},x.throttle=function(a,b,c){var d,e,f,g=null,h=0;c||(c={});var i=function(){h=c.leading===!1?0:x.now(),g=null,f=a.apply(d,e),d=e=null};return function(){var j=x.now();h||c.leading!==!1||(h=j);var k=b-(j-h);return d=this,e=arguments,0>=k?(clearTimeout(g),g=null,h=j,f=a.apply(d,e),d=e=null):g||c.trailing===!1||(g=setTimeout(i,k)),f}},x.debounce=function(a,b,c){var d,e,f,g,h,i=function(){var j=x.now()-g;b>j?d=setTimeout(i,b-j):(d=null,c||(h=a.apply(f,e),f=e=null))};return function(){f=this,e=arguments,g=x.now();var j=c&&!d;return d||(d=setTimeout(i,b)),j&&(h=a.apply(f,e),f=e=null),h}},x.once=function(a){var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}},x.wrap=function(a,b){return x.partial(b,a)},x.compose=function(){var a=arguments;return function(){for(var b=arguments,c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},x.after=function(a,b){return function(){return--a<1?b.apply(this,arguments):void 0}},x.keys=function(a){if(!x.isObject(a))return[];if(v)return v(a);var b=[];for(var c in a)x.has(a,c)&&b.push(c);return b},x.values=function(a){for(var b=x.keys(a),c=b.length,d=new Array(c),e=0;c>e;e++)d[e]=a[b[e]];return d},x.pairs=function(a){for(var b=x.keys(a),c=b.length,d=new Array(c),e=0;c>e;e++)d[e]=[b[e],a[b[e]]];return d},x.invert=function(a){for(var b={},c=x.keys(a),d=0,e=c.length;e>d;d++)b[a[c[d]]]=c[d];return b},x.functions=x.methods=function(a){var b=[];for(var c in a)x.isFunction(a[c])&&b.push(c);return b.sort()},x.extend=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a},x.pick=function(a){var b={},c=i.apply(d,h.call(arguments,1));return y(c,function(c){c in a&&(b[c]=a[c])}),b},x.omit=function(a){var b={},c=i.apply(d,h.call(arguments,1));for(var e in a)x.contains(c,e)||(b[e]=a[e]);return b},x.defaults=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)void 0===a[c]&&(a[c]=b[c])}),a},x.clone=function(a){return x.isObject(a)?x.isArray(a)?a.slice():x.extend({},a):a},x.tap=function(a,b){return b(a),a};var F=function(a,b,c,d){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof x&&(a=a._wrapped),b instanceof x&&(b=b._wrapped);var e=j.call(a);if(e!=j.call(b))return!1;switch(e){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var f=c.length;f--;)if(c[f]==a)return d[f]==b;var g=a.constructor,h=b.constructor;if(g!==h&&!(x.isFunction(g)&&g instanceof g&&x.isFunction(h)&&h instanceof h)&&"constructor"in a&&"constructor"in b)return!1;c.push(a),d.push(b);var i=0,k=!0;if("[object Array]"==e){if(i=a.length,k=i==b.length)for(;i--&&(k=F(a[i],b[i],c,d)););}else{for(var l in a)if(x.has(a,l)&&(i++,!(k=x.has(b,l)&&F(a[l],b[l],c,d))))break;if(k){for(l in b)if(x.has(b,l)&&!i--)break;k=!i}}return c.pop(),d.pop(),k};x.isEqual=function(a,b){return F(a,b,[],[])},x.isEmpty=function(a){if(null==a)return!0;if(x.isArray(a)||x.isString(a))return 0===a.length;for(var b in a)if(x.has(a,b))return!1;return!0},x.isElement=function(a){return!(!a||1!==a.nodeType)},x.isArray=u||function(a){return"[object Array]"==j.call(a)},x.isObject=function(a){return a===Object(a)},y(["Arguments","Function","String","Number","Date","RegExp"],function(a){x["is"+a]=function(b){return j.call(b)=="[object "+a+"]"}}),x.isArguments(arguments)||(x.isArguments=function(a){return!(!a||!x.has(a,"callee"))}),"function"!=typeof/./&&(x.isFunction=function(a){return"function"==typeof a}),x.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},x.isNaN=function(a){return x.isNumber(a)&&a!=+a},x.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"==j.call(a)},x.isNull=function(a){return null===a},x.isUndefined=function(a){return void 0===a},x.has=function(a,b){return k.call(a,b)},x.noConflict=function(){return a._=b,this},x.identity=function(a){return a},x.constant=function(a){return function(){return a}},x.property=function(a){return function(b){return b[a]}},x.matches=function(a){return function(b){if(b===a)return!0;for(var c in a)if(a[c]!==b[c])return!1;return!0}},x.times=function(a,b,c){for(var d=Array(Math.max(0,a)),e=0;a>e;e++)d[e]=b.call(c,e);return d},x.random=function(a,b){return null==b&&(b=a,a=0),a+Math.floor(Math.random()*(b-a+1))},x.now=Date.now||function(){return(new Date).getTime()};var G={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};G.unescape=x.invert(G.escape);var H={escape:new RegExp("["+x.keys(G.escape).join("")+"]","g"),unescape:new RegExp("("+x.keys(G.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(a){x[a]=function(b){return null==b?"":(""+b).replace(H[a],function(b){return G[a][b]})}}),x.result=function(a,b){if(null==a)return void 0;var c=a[b];return x.isFunction(c)?c.call(a):c},x.mixin=function(a){y(x.functions(a),function(b){var c=x[b]=a[b];x.prototype[b]=function(){var a=[this._wrapped];return g.apply(a,arguments),M.call(this,c.apply(x,a))}})};var I=0;x.uniqueId=function(a){var b=++I+"";return a?a+b:b},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var J=/(.)^/,K={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},L=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(a,b,c){var d;c=x.defaults({},c,x.templateSettings);var e=new RegExp([(c.escape||J).source,(c.interpolate||J).source,(c.evaluate||J).source].join("|")+"|$","g"),f=0,g="__p+='";a.replace(e,function(b,c,d,e,h){return g+=a.slice(f,h).replace(L,function(a){return"\\"+K[a]}),c&&(g+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'"),d&&(g+="'+\n((__t=("+d+"))==null?'':__t)+\n'"),e&&(g+="';\n"+e+"\n__p+='"),f=h+b.length,b}),g+="';\n",c.variable||(g="with(obj||{}){\n"+g+"}\n"),g="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+g+"return __p;\n";try{d=new Function(c.variable||"obj","_",g)}catch(h){throw h.source=g,h}if(b)return d(b,x);var i=function(a){return d.call(this,a,x)};return i.source="function("+(c.variable||"obj")+"){\n"+g+"}",i},x.chain=function(a){return x(a).chain()};var M=function(a){return this._chain?x(a).chain():a};x.mixin(x),y(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];x.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!=a&&"splice"!=a||0!==c.length||delete c[0],M.call(this,c)}}),y(["concat","join","slice"],function(a){var b=d[a];x.prototype[a]=function(){return M.call(this,b.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return x})}).call(this),function(){Object.create=Object.create||function(a){function b(){}return b.prototype=a,new b};var a;"undefined"==typeof exports?(a={},"object"==typeof window&&(window.cp=a)):a=exports;var b,c,d=function(a,b){if(!a)throw Error("Assertion failed: "+b)},e=function(a,b){!a&&console&&console.warn&&(console.warn("ASSERTION FAILED: "+b),console.trace&&console.trace())},f=function(a,b){return b>a?a:b},g=function(a,b){return a>b?a:b};"object"==typeof window&&window.navigator.userAgent.indexOf("Firefox")>-1?(b=Math.min,c=Math.max):(b=f,c=g);var h=function(a,b){return b>a?a+" "+b:b+" "+a},i=function(a,b){for(var c=0;a.length>c;c++)if(a[c]===b)return a[c]=a[a.length-1],void a.length--},j=function(a,b,c){var d=y(b,c),e=q(t(d,y(a,c))/H(d));return x(c,A(d,e))},k=function(a,b,c,d,e,f){var g=c-e,h=d-f,i=q(u(g,h,a-e,b-f)/I(g,h));return new r(e+g*i,f+h*i)};a.momentForCircle=function(a,b,c,d){return a*(.5*(b*b+c*c)+H(d))},a.areaForCircle=function(a,b){return Math.PI*Math.abs(a*a-b*b)},a.momentForSegment=function(a,b,c){var d=A(x(b,c),.5);return a*(O(c,b)/12+H(d))},a.areaForSegment=function(a,b,c){return c*(Math.PI*c+2*N(a,b))},a.momentForPoly=function(a,b,c){for(var d=0,e=0,f=b.length,g=0;f>g;g+=2){var h=b[g]+c.x,i=b[g+1]+c.y,j=b[(g+2)%f]+c.x,k=b[(g+3)%f]+c.y,l=C(j,k,h,i),m=u(h,i,h,i)+u(h,i,j,k)+u(j,k,j,k);d+=l*m,e+=l}return a*d/(6*e)},a.areaForPoly=function(a){for(var b=0,c=0,d=a.length;d>c;c+=2)b+=B(new r(a[c],a[c+1]),new r(a[(c+2)%d],a[(c+3)%d]));return-b/2},a.centroidForPoly=function(a){for(var b=0,c=new r(0,0),d=0,e=a.length;e>d;d+=2){var f=new r(a[d],a[d+1]),g=new r(a[(d+2)%e],a[(d+3)%e]),h=B(f,g);b+=h,c=x(c,A(x(f,g),h))}return A(c,1/(3*b))},a.recenterPoly=function(b){for(var c=a.centroidForPoly(b),d=0;b.length>d;d+=2)b[d]-=c.x,b[d+1]-=c.y},a.momentForBox=function(a,b,c){return a*(b*b+c*c)/12},a.momentForBox2=function(b,c){var d=c.r-c.l,e=c.t-c.b,f=A([c.l+c.r,c.b+c.t],.5);return a.momentForBox(b,d,e)+b*H(f)};var l=a.loopIndexes=function(a){var b,c,d,e,f=0,g=0;b=d=a[0],c=e=a[1];for(var h=a.length>>1,i=1;h>i;i++){var j=a[2*i],k=a[2*i+1];b>j||j==b&&c>k?(b=j,c=k,f=i):(j>d||j==d&&k>e)&&(d=j,e=k,g=i)}return[f,g]},m=function(a,b,c){var d=a[2*b];a[2*b]=a[2*c],a[2*c]=d,d=a[2*b+1],a[2*b+1]=a[2*c+1],a[2*c+1]=d},n=function(a,b,c,d,e,f){if(0===c)return 0;for(var g=0,h=b,i=y(e,d),j=f*v(i),k=b,l=b+c-1;l>=k;){var n=new r(a[2*k],a[2*k+1]),o=B(i,y(n,d));o>j?(o>g&&(g=o,h=k),k++):(m(a,k,l),l--)}return h!=b&&m(a,b,h),k-b},o=function(a,b,c,d,e,f,g,h){if(0>d)return 0;if(0==d)return b[2*h]=f.x,b[2*h+1]=f.y,1;var i=n(b,c,d,e,f,a),j=new r(b[2*c],b[2*c+1]),k=o(a,b,c+1,i-1,e,j,f,h),l=h+k++;b[2*l]=f.x,b[2*l+1]=f.y;var m=n(b,c+i,d-i,f,g,a),p=new r(b[2*(c+i)],b[2*(c+i)+1]);return k+o(a,b,c+i+1,m-1,f,p,g,h+k)};a.convexHull=function(a,b,c){if(b)for(var d=0;a.length>d;d++)b[d]=a[d];else b=a;var f=l(a),g=f[0],h=f[1];if(g==h)return b.length=2,b;m(b,0,g),m(b,1,0==h?g:h);var i=new r(b[0],b[1]),j=new r(b[2],b[3]),k=a.length>>1,n=o(c,b,2,k-2,i,j,i,1)+1;return b.length=2*n,e(ab(b),"Internal error: cpConvexHull() and cpPolyValidate() did not agree.Please report this error with as much info as you can."),b};var p=function(a,d,e){return b(c(a,d),e)},q=function(a){return c(0,b(a,1))},r=a.Vect=function(a,b){this.x=a,this.y=b};a.v=function(a,b){return new r(a,b)};var s=a.vzero=new r(0,0),t=a.v.dot=function(a,b){return a.x*b.x+a.y*b.y},u=function(a,b,c,d){return a*c+b*d},v=a.v.len=function(a){return Math.sqrt(t(a,a))},w=a.v.len2=function(a,b){return Math.sqrt(a*a+b*b)};a.v.eql=function(a,b){return a.x===b.x&&a.y===b.y};var x=a.v.add=function(a,b){return new r(a.x+b.x,a.y+b.y)};r.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this};var y=a.v.sub=function(a,b){return new r(a.x-b.x,a.y-b.y)};r.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this};var z=a.v.neg=function(a){return new r(-a.x,-a.y)};r.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var A=a.v.mult=function(a,b){return new r(a.x*b,a.y*b)};r.prototype.mult=function(a){return this.x*=a,this.y*=a,this};var B=a.v.cross=function(a,b){return a.x*b.y-a.y*b.x},C=function(a,b,c,d){return a*d-b*c},D=a.v.perp=function(a){return new r(-a.y,a.x)};a.v.pvrperp=function(a){return new r(a.y,-a.x)};var E=a.v.project=function(a,b){return A(b,t(a,b)/H(b))};r.prototype.project=function(a){return this.mult(t(this,a)/H(a)),this};var F=a.v.rotate=function(a,b){return new r(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)};r.prototype.rotate=function(a){return this.x=this.x*a.x-this.y*a.y,this.y=this.x*a.y+this.y*a.x,this};var G=a.v.unrotate=function(a,b){return new r(a.x*b.x+a.y*b.y,a.y*b.x-a.x*b.y)},H=a.v.lengthsq=function(a){return t(a,a)},I=a.v.lengthsq2=function(a,b){return a*a+b*b},J=a.v.lerp=function(a,b,c){return x(A(a,1-c),A(b,c))},K=a.v.normalize=function(a){return A(a,1/v(a))},L=a.v.normalize_safe=function(a){return 0===a.x&&0===a.y?s:K(a)},M=a.v.clamp=function(a,b){return t(a,a)>b*b?A(K(a),b):a};a.v.lerpconst=function(a,b,c){return x(a,M(y(b,a),c))};var N=a.v.dist=function(a,b){return v(y(a,b))},O=a.v.distsq=function(a,b){return H(y(a,b))};a.v.near=function(a,b,c){return c*c>O(a,b)};var P=a.v.slerp=function(a,b,c){var d=Math.acos(t(a,b));if(d){var e=1/Math.sin(d);return x(A(a,Math.sin((1-c)*d)*e),A(b,Math.sin(c*d)*e))}return a};a.v.slerpconst=function(a,c,d){var e=Math.acos(t(a,c));return P(a,c,b(d,e)/e)},a.v.forangle=function(a){return new r(Math.cos(a),Math.sin(a))},a.v.toangle=function(a){return Math.atan2(a.y,a.x)},a.v.str=function(a){return"("+a.x.toFixed(3)+", "+a.y.toFixed(3)+")"};var Q=0,R=a.BB=function(a,b,c,d){this.l=a,this.b=b,this.r=c,this.t=d,Q++};a.bb=function(a,b,c,d){return new R(a,b,c,d)};var S=function(a,b){return new R(a.x-b,a.y-b,a.x+b,a.y+b)},T=function(a,b,c,d,e){return d>=a.l&&a.r>=b&&e>=a.b&&a.t>=c},U=0;a.NO_GROUP=0;var V=a.ALL_LAYERS=-1;a.resetShapeIdCounter=function(){U=0};var W=a.Shape=function(a){this.body=a,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=U++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=s,this.collision_type=0,this.group=0,this.layers=V,this.space=null,this.collisionCode=this.collisionCode};W.prototype.setElasticity=function(a){this.e=a},W.prototype.setFriction=function(a){this.body.activate(),this.u=a},W.prototype.setLayers=function(a){this.body.activate(),this.layers=a},W.prototype.setSensor=function(a){this.body.activate(),this.sensor=a},W.prototype.setCollisionType=function(a){this.body.activate(),this.collision_type=a},W.prototype.getBody=function(){return this.body},W.prototype.active=function(){return this.body&&-1!==this.body.shapeList.indexOf(this)},W.prototype.setBody=function(a){d(!this.active(),"You cannot change the body on an active shape. You must remove the shape from the space before changing the body."),this.body=a},W.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},W.prototype.update=function(a,b){d(!isNaN(b.x),"Rotation is NaN"),d(!isNaN(a.x),"Position is NaN"),this.cacheData(a,b)},W.prototype.pointQuery=function(a){var b=this.nearestPointQuery(a);return 0>b.d?b:void 0},W.prototype.getBB=function(){return new R(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var X=function(a,b,c){this.shape=a,this.p=b,this.d=c},Y=function(a,b,c){this.shape=a,this.t=b,this.n=c};Y.prototype.hitPoint=function(a,b){return J(a,b,this.t)},Y.prototype.hitDist=function(a,b){return N(a,b)*this.t};var Z=a.CircleShape=function(a,b,c){this.c=this.tc=c,this.r=b,this.type="circle",W.call(this,a)};Z.prototype=Object.create(W.prototype),Z.prototype.cacheData=function(a,b){var c=this.tc=F(this.c,b).add(a),d=this.r;this.bb_l=c.x-d,this.bb_b=c.y-d,this.bb_r=c.x+d,this.bb_t=c.y+d},Z.prototype.nearestPointQuery=function(a){var b=a.x-this.tc.x,c=a.y-this.tc.y,d=w(b,c),e=this.r,f=new r(this.tc.x+b*e/d,this.tc.y+c*e/d);return new X(this,f,d-e)};var $=function(a,b,c,d,e){d=y(d,b),e=y(e,b);var f=t(d,d)-2*t(d,e)+t(e,e),g=-2*t(d,d)+2*t(d,e),h=t(d,d)-c*c,i=g*g-4*f*h;if(i>=0){var j=(-g-Math.sqrt(i))/(2*f);if(j>=0&&1>=j)return new Y(a,j,K(J(d,e,j)))}};Z.prototype.segmentQuery=function(a,b){return $(this,this.tc,this.r,a,b)};var _=a.SegmentShape=function(a,b,c,d){this.a=b,this.b=c,this.n=D(K(y(c,b))),this.ta=this.tb=this.tn=null,this.r=d,this.a_tangent=s,this.b_tangent=s,this.type="segment",W.call(this,a)};_.prototype=Object.create(W.prototype),_.prototype.cacheData=function(a,b){this.ta=x(a,F(this.a,b)),this.tb=x(a,F(this.b,b)),this.tn=F(this.n,b);var c,d,e,f;this.ta.x<this.tb.x?(c=this.ta.x,d=this.tb.x):(c=this.tb.x,d=this.ta.x),this.ta.y<this.tb.y?(e=this.ta.y,f=this.tb.y):(e=this.tb.y,f=this.ta.y);var g=this.r;this.bb_l=c-g,this.bb_b=e-g,this.bb_r=d+g,this.bb_t=f+g},_.prototype.nearestPointQuery=function(a){var b=j(a,this.ta,this.tb),c=a.x-b.x,d=a.y-b.y,e=w(c,d),f=this.r,g=e?x(b,A(new r(c,d),f/e)):b;return new X(this,g,e-f)},_.prototype.segmentQuery=function(a,b){var c=this.tn,d=t(y(this.ta,a),c),e=this.r,f=d>0?z(c):c,g=y(A(f,e),a),h=x(this.ta,g),i=x(this.tb,g),j=y(b,a);if(0>=B(j,h)*B(j,i)){var k=d+(d>0?-e:e),l=-k,m=t(j,c)-k;if(0>l*m)return new Y(this,l/(l-m),f)}else if(0!==e){var n=$(this,this.ta,this.r,a,b),o=$(this,this.tb,this.r,a,b);return n?o&&o.t<n.t?o:n:o}},_.prototype.setNeighbors=function(a,b){this.a_tangent=y(a,this.a),this.b_tangent=y(b,this.b)},_.prototype.setEndpoints=function(a,b){this.a=a,this.b=b,this.n=D(K(y(b,a)))};var ab=function(a){for(var b=a.length,c=0;b>c;c+=2){var d=a[c],e=a[c+1],f=a[(c+2)%b],g=a[(c+3)%b],h=a[(c+4)%b],i=a[(c+5)%b];if(C(f-d,g-e,h-f,i-g)>0)return!1}return!0},bb=a.PolyShape=function(a,b,c){this.setVerts(b,c),this.type="poly",W.call(this,a)};bb.prototype=Object.create(W.prototype);var cb=function(a,b){this.n=a,this.d=b};cb.prototype.compare=function(a){return t(this.n,a)-this.d},bb.prototype.setVerts=function(a,b){d(a.length>=4,"Polygons require some verts"),d("number"==typeof a[0],"Polygon verticies should be specified in a flattened list (eg [x1,y1,x2,y2,x3,y3,...])"),d(ab(a),"Polygon is concave or has a reversed winding. Consider using cpConvexHull()");var c=a.length,e=c>>1;this.verts=Array(c),this.tVerts=Array(c),this.planes=Array(e),this.tPlanes=Array(e);for(var f=0;c>f;f+=2){var g=a[f]+b.x,h=a[f+1]+b.y,i=a[(f+2)%c]+b.x,j=a[(f+3)%c]+b.y,k=K(D(new r(i-g,j-h)));this.verts[f]=g,this.verts[f+1]=h,this.planes[f>>1]=new cb(k,u(k.x,k.y,g,h)),this.tPlanes[f>>1]=new cb(new r(0,0),0)}},a.BoxShape=function(a,b,c){var d=b/2,e=c/2;return db(a,new R(-d,-e,d,e))};var db=a.BoxShape2=function(a,b){var c=[b.l,b.b,b.l,b.t,b.r,b.t,b.r,b.b];return new bb(a,c,s)};bb.prototype.transformVerts=function(a,d){for(var e=this.verts,f=this.tVerts,g=1/0,h=-1/0,i=1/0,j=-1/0,k=0;e.length>k;k+=2){var l=e[k],m=e[k+1],n=a.x+l*d.x-m*d.y,o=a.y+l*d.y+m*d.x;f[k]=n,f[k+1]=o,g=b(g,n),h=c(h,n),i=b(i,o),j=c(j,o)}this.bb_l=g,this.bb_b=i,this.bb_r=h,this.bb_t=j},bb.prototype.transformAxes=function(a,b){for(var c=this.planes,d=this.tPlanes,e=0;c.length>e;e++){var f=F(c[e].n,b);d[e].n=f,d[e].d=t(a,f)+c[e].d}},bb.prototype.cacheData=function(a,b){this.transformAxes(a,b),this.transformVerts(a,b)},bb.prototype.nearestPointQuery=function(a){for(var b=this.tPlanes,c=this.tVerts,d=c[c.length-2],e=c[c.length-1],f=1/0,g=s,h=!1,i=0;b.length>i;i++){b[i].compare(a)>0&&(h=!0);var j=c[2*i],l=c[2*i+1],m=k(a.x,a.y,d,e,j,l),n=N(a,m);f>n&&(f=n,g=m),d=j,e=l}return new X(this,g,h?f:-f)},bb.prototype.segmentQuery=function(a,b){for(var c=this.tPlanes,d=this.tVerts,e=c.length,f=2*e,g=0;e>g;g++){var h=c[g].n,i=t(a,h);if(!(c[g].d>i)){var j=t(b,h),k=(c[g].d-i)/(j-i);if(!(0>k||k>1)){var l=J(a,b,k),m=-B(h,l),n=-C(h.x,h.y,d[2*g],d[2*g+1]),o=-C(h.x,h.y,d[(2*g+2)%f],d[(2*g+3)%f]);if(m>=n&&o>=m)return new Y(this,k,h)}}}},bb.prototype.valueOnAxis=function(a,c){for(var d=this.tVerts,e=u(a.x,a.y,d[0],d[1]),f=2;d.length>f;f+=2)e=b(e,u(a.x,a.y,d[f],d[f+1]));return e-c},bb.prototype.containsVert=function(a,b){for(var c=this.tPlanes,d=0;c.length>d;d++){var e=c[d].n,f=u(e.x,e.y,a,b)-c[d].d;if(f>0)return!1}return!0},bb.prototype.containsVertPartial=function(a,b,c){for(var d=this.tPlanes,e=0;d.length>e;e++){var f=d[e].n;if(!(0>t(f,c))){var g=u(f.x,f.y,a,b)-d[e].d;if(g>0)return!1}}return!0},bb.prototype.getNumVerts=function(){return this.verts.length/2},bb.prototype.getVert=function(a){return new r(this.verts[2*a],this.verts[2*a+1])};var eb=a.Body=function(a,b){this.p=new r(0,0),this.vx=this.vy=0,this.f=new r(0,0),this.w=0,this.t=0,this.v_limit=1/0,this.w_limit=1/0,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(a),this.setMoment(b),this.rot=new r(0,0),this.setAngle(0)};if("undefined"!=typeof DEBUG&&DEBUG){var fb=function(a,b){d(a.x==a.x&&a.y==a.y,b)},gb=function(a,b){d(1/0!==Math.abs(a.x)&&1/0!==Math.abs(a.y),b)},hb=function(a,b){fb(a,b),gb(a,b)};eb.prototype.sanityCheck=function(){d(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),d(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),hb(this.p,"Body's position is invalid."),hb(this.f,"Body's force is invalid."),d(this.vx===this.vx&&1/0!==Math.abs(this.vx),"Body's velocity is invalid."),d(this.vy===this.vy&&1/0!==Math.abs(this.vy),"Body's velocity is invalid."),d(this.a===this.a&&1/0!==Math.abs(this.a),"Body's angle is invalid."),d(this.w===this.w&&1/0!==Math.abs(this.w),"Body's angular velocity is invalid."),d(this.t===this.t&&1/0!==Math.abs(this.t),"Body's torque is invalid."),hb(this.rot,"Body's rotation vector is invalid."),d(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),d(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else eb.prototype.sanityCheck=function(){};eb.prototype.getPos=function(){return this.p},eb.prototype.getVel=function(){return new r(this.vx,this.vy)},eb.prototype.getAngVel=function(){return this.w},eb.prototype.isSleeping=function(){return null!==this.nodeRoot},eb.prototype.isStatic=function(){return 1/0===this.nodeIdleTime},eb.prototype.isRogue=function(){return null===this.space},eb.prototype.setMass=function(a){d(a>0,"Mass must be positive and non-zero."),this.activate(),this.m=a,this.m_inv=1/a},eb.prototype.setMoment=function(a){d(a>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=a,this.i_inv=1/a},eb.prototype.addShape=function(a){this.shapeList.push(a)},eb.prototype.removeShape=function(a){i(this.shapeList,a)};var ib=function(a,b,c){return a===c?a.next(b):(a.a===b?a.next_a=ib(a.next_a,b,c):a.next_b=ib(a.next_b,b,c),a)};eb.prototype.removeConstraint=function(a){this.constraintList=ib(this.constraintList,this,a)},eb.prototype.setPos=function(b){this.activate(),this.sanityCheck(),b===s&&(b=a.v(0,0)),this.p=b},eb.prototype.setVel=function(a){this.activate(),this.vx=a.x,this.vy=a.y},eb.prototype.setAngVel=function(a){this.activate(),this.w=a},eb.prototype.setAngleInternal=function(a){d(!isNaN(a),"Internal Error: Attempting to set body's angle to NaN"),this.a=a,this.rot.x=Math.cos(a),this.rot.y=Math.sin(a)},eb.prototype.setAngle=function(a){this.activate(),this.sanityCheck(),this.setAngleInternal(a)},eb.prototype.velocity_func=function(a,b,c){var d=this.vx*b+(a.x+this.f.x*this.m_inv)*c,e=this.vy*b+(a.y+this.f.y*this.m_inv)*c,f=this.v_limit,g=d*d+e*e,h=g>f*f?f/Math.sqrt(g):1;this.vx=d*h,this.vy=e*h;var i=this.w_limit;this.w=p(this.w*b+this.t*this.i_inv*c,-i,i),this.sanityCheck()},eb.prototype.position_func=function(a){this.p.x+=(this.vx+this.v_biasx)*a,this.p.y+=(this.vy+this.v_biasy)*a,this.setAngleInternal(this.a+(this.w+this.w_bias)*a),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},eb.prototype.resetForces=function(){this.activate(),this.f=new r(0,0),this.t=0},eb.prototype.applyForce=function(a,b){this.activate(),this.f=x(this.f,a),this.t+=B(b,a)},eb.prototype.applyImpulse=function(a,b){this.activate(),kc(this,a.x,a.y,b)},eb.prototype.getVelAtPoint=function(a){return x(new r(this.vx,this.vy),A(D(a),this.w))},eb.prototype.getVelAtWorldPoint=function(a){return this.getVelAtPoint(y(a,this.p))},eb.prototype.getVelAtLocalPoint=function(a){return this.getVelAtPoint(F(a,this.rot))},eb.prototype.eachShape=function(a){for(var b=0,c=this.shapeList.length;c>b;b++)a(this.shapeList[b])},eb.prototype.eachConstraint=function(a){for(var b=this.constraintList;b;){var c=b.next(this);a(b),b=c}},eb.prototype.eachArbiter=function(a){for(var b=this.arbiterList;b;){var c=b.next(this);b.swappedColl=this===b.body_b,a(b),b=c}},eb.prototype.local2World=function(a){return x(this.p,F(a,this.rot))},eb.prototype.world2Local=function(a){return G(y(a,this.p),this.rot)},eb.prototype.kineticEnergy=function(){var a=this.vx*this.vx+this.vy*this.vy,b=this.w*this.w;return(a?a*this.m:0)+(b?b*this.i:0)};var jb=a.SpatialIndex=function(a){if(this.staticIndex=a,a){if(a.dynamicIndex)throw Error("This static index is already associated with a dynamic index.");a.dynamicIndex=this}};jb.prototype.collideStatic=function(a,b){if(a.count>0){var c=a.query;this.each(function(a){c(a,new R(a.bb_l,a.bb_b,a.bb_r,a.bb_t),b)})}};var kb=a.BBTree=function(a){jb.call(this,a),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.pooledNodes=null,this.pooledPairs=null,this.stamp=0};kb.prototype=Object.create(jb.prototype);var lb=0,mb=function(a,d,e){this.obj=null,this.bb_l=b(d.bb_l,e.bb_l),this.bb_b=b(d.bb_b,e.bb_b),this.bb_r=c(d.bb_r,e.bb_r),this.bb_t=c(d.bb_t,e.bb_t),this.parent=null,this.setA(d),this.setB(e)};kb.prototype.makeNode=function(a,b){var c=this.pooledNodes;return c?(this.pooledNodes=c.parent,c.constructor(this,a,b),c):(lb++,new mb(this,a,b))};var nb=0,ob=function(a,b){this.obj=b,a.getBB(b,this),this.parent=null,this.stamp=1,this.pairs=null,nb++
};kb.prototype.getBB=function(a,d){var e=this.velocityFunc;if(e){var f=.1,g=(a.bb_r-a.bb_l)*f,h=(a.bb_t-a.bb_b)*f,i=A(e(a),.1);d.bb_l=a.bb_l+b(-g,i.x),d.bb_b=a.bb_b+b(-h,i.y),d.bb_r=a.bb_r+c(g,i.x),d.bb_t=a.bb_t+c(h,i.y)}else d.bb_l=a.bb_l,d.bb_b=a.bb_b,d.bb_r=a.bb_r,d.bb_t=a.bb_t},kb.prototype.getStamp=function(){var a=this.dynamicIndex;return a&&a.stamp?a.stamp:this.stamp},kb.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var pb=0,qb=function(a,b,c,d){this.prevA=null,this.leafA=a,this.nextA=b,this.prevB=null,this.leafB=c,this.nextB=d};kb.prototype.makePair=function(a,b,c,d){var e=this.pooledPairs;return e?(this.pooledPairs=e.prevA,e.prevA=null,e.leafA=a,e.nextA=b,e.prevB=null,e.leafB=c,e.nextB=d,e):(pb++,new qb(a,b,c,d))},qb.prototype.recycle=function(a){this.prevA=a.pooledPairs,a.pooledPairs=this};var rb=function(a,b,c){c&&(c.leafA===b?c.prevA=a:c.prevB=a),a?a.leafA===b?a.nextA=c:a.nextB=c:b.pairs=c};ob.prototype.clearPairs=function(a){var b,c=this.pairs;for(this.pairs=null;c;)c.leafA===this?(b=c.nextA,rb(c.prevB,c.leafB,c.nextB)):(b=c.nextB,rb(c.prevA,c.leafA,c.nextA)),c.recycle(a),c=b};var sb=function(a,b,c){var d=a.pairs,e=b.pairs,f=c.makePair(a,d,b,e);a.pairs=b.pairs=f,d&&(d.leafA===a?d.prevA=f:d.prevB=f),e&&(e.leafA===b?e.prevA=f:e.prevB=f)};mb.prototype.recycle=function(a){this.parent=a.pooledNodes,a.pooledNodes=this},ob.prototype.recycle=function(){},mb.prototype.setA=function(a){this.A=a,a.parent=this},mb.prototype.setB=function(a){this.B=a,a.parent=this},ob.prototype.isLeaf=!0,mb.prototype.isLeaf=!1,mb.prototype.otherChild=function(a){return this.A==a?this.B:this.A},mb.prototype.replaceChild=function(a,d,f){e(a==this.A||a==this.B,"Node is not a child of parent."),this.A==a?(this.A.recycle(f),this.setA(d)):(this.B.recycle(f),this.setB(d));for(var g=this;g;g=g.parent){var h=g.A,i=g.B;g.bb_l=b(h.bb_l,i.bb_l),g.bb_b=b(h.bb_b,i.bb_b),g.bb_r=c(h.bb_r,i.bb_r),g.bb_t=c(h.bb_t,i.bb_t)}},mb.prototype.bbArea=ob.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var tb=function(a,d){return(c(a.bb_r,d.bb_r)-b(a.bb_l,d.bb_l))*(c(a.bb_t,d.bb_t)-b(a.bb_b,d.bb_b))},ub=function(a,b){return Math.abs(a.bb_l+a.bb_r-b.bb_l-b.bb_r)+Math.abs(a.bb_b+a.bb_t-b.bb_b-b.bb_t)},vb=function(a,d,e){if(null==a)return d;if(a.isLeaf)return e.makeNode(d,a);var f=a.B.bbArea()+tb(a.A,d),g=a.A.bbArea()+tb(a.B,d);return f===g&&(f=ub(a.A,d),g=ub(a.B,d)),f>g?a.setB(vb(a.B,d,e)):a.setA(vb(a.A,d,e)),a.bb_l=b(a.bb_l,d.bb_l),a.bb_b=b(a.bb_b,d.bb_b),a.bb_r=c(a.bb_r,d.bb_r),a.bb_t=c(a.bb_t,d.bb_t),a};mb.prototype.intersectsBB=ob.prototype.intersectsBB=function(a){return this.bb_l<=a.r&&a.l<=this.bb_r&&this.bb_b<=a.t&&a.b<=this.bb_t};var wb=function(a,b,c){a.intersectsBB(b)&&(a.isLeaf?c(a.obj):(wb(a.A,b,c),wb(a.B,b,c)))},xb=function(a,d,e){var f=1/(e.x-d.x),g=a.bb_l==d.x?-1/0:(a.bb_l-d.x)*f,h=a.bb_r==d.x?1/0:(a.bb_r-d.x)*f,i=b(g,h),j=c(g,h),k=1/(e.y-d.y),l=a.bb_b==d.y?-1/0:(a.bb_b-d.y)*k,m=a.bb_t==d.y?1/0:(a.bb_t-d.y)*k,n=b(l,m),o=c(l,m);if(j>=n&&o>=i){var p=c(i,n),q=b(j,o);if(q>=0&&1>=p)return c(p,0)}return 1/0},yb=function(a,c,d,e,f){if(a.isLeaf)return f(a.obj);var g=xb(a.A,c,d),h=xb(a.B,c,d);return h>g?(e>g&&(e=b(e,yb(a.A,c,d,e,f))),e>h&&(e=b(e,yb(a.B,c,d,e,f)))):(e>h&&(e=b(e,yb(a.B,c,d,e,f))),e>g&&(e=b(e,yb(a.A,c,d,e,f)))),e};kb.prototype.subtreeRecycle=function(a){a.isLeaf&&(this.subtreeRecycle(a.A),this.subtreeRecycle(a.B),a.recycle(this))};var zb=function(a,b,c){if(b==a)return null;var d=b.parent;if(d==a){var e=a.otherChild(b);return e.parent=a.parent,a.recycle(c),e}return d.parent.replaceChild(d,d.otherChild(b),c),a},Ab=function(a,b){return a.bb_l<=b.bb_r&&b.bb_l<=a.bb_r&&a.bb_b<=b.bb_t&&b.bb_b<=a.bb_t};ob.prototype.markLeafQuery=function(a,b,c,d){Ab(a,this)&&(b?sb(a,this,c):(this.stamp<a.stamp&&sb(this,a,c),d&&d(a.obj,this.obj)))},mb.prototype.markLeafQuery=function(a,b,c,d){Ab(a,this)&&(this.A.markLeafQuery(a,b,c,d),this.B.markLeafQuery(a,b,c,d))},ob.prototype.markSubtree=function(a,b,c){if(this.stamp==a.getStamp()){b&&b.markLeafQuery(this,!1,a,c);for(var d=this;d.parent;d=d.parent)d==d.parent.A?d.parent.B.markLeafQuery(this,!0,a,c):d.parent.A.markLeafQuery(this,!1,a,c)}else for(var e=this.pairs;e;)this===e.leafB?(c&&c(e.leafA.obj,this.obj),e=e.nextB):e=e.nextA},mb.prototype.markSubtree=function(a,b,c){this.A.markSubtree(a,b,c),this.B.markSubtree(a,b,c)},ob.prototype.containsObj=function(a){return this.bb_l<=a.bb_l&&this.bb_r>=a.bb_r&&this.bb_b<=a.bb_b&&this.bb_t>=a.bb_t},ob.prototype.update=function(a){var b=a.root,c=this.obj;return this.containsObj(c)?!1:(a.getBB(this.obj,this),b=zb(b,this,a),a.root=vb(b,this,a),this.clearPairs(a),this.stamp=a.getStamp(),!0)},ob.prototype.addPairs=function(a){var b=a.dynamicIndex;if(b){var c=b.root;c&&c.markLeafQuery(this,!0,b,null)}else{var d=a.staticIndex.root;this.markSubtree(a,d,null)}},kb.prototype.insert=function(a,b){var c=new ob(this,a);this.leaves[b]=c,this.root=vb(this.root,c,this),this.count++,c.stamp=this.getStamp(),c.addPairs(this),this.incrementStamp()},kb.prototype.remove=function(a,b){var c=this.leaves[b];delete this.leaves[b],this.root=zb(this.root,c,this),this.count--,c.clearPairs(this),c.recycle(this)},kb.prototype.contains=function(a,b){return null!=this.leaves[b]};var Bb=function(){};kb.prototype.reindexQuery=function(a){if(this.root){var b,c=this.leaves;for(b in c)c[b].update(this);var d=this.staticIndex,e=d&&d.root;this.root.markSubtree(this,e,a),d&&!e&&this.collideStatic(this,d,a),this.incrementStamp()}},kb.prototype.reindex=function(){this.reindexQuery(Bb)},kb.prototype.reindexObject=function(a,b){var c=this.leaves[b];c&&(c.update(this)&&c.addPairs(this),this.incrementStamp())},kb.prototype.pointQuery=function(a,b){this.query(new R(a.x,a.y,a.x,a.y),b)},kb.prototype.segmentQuery=function(a,b,c,d){this.root&&yb(this.root,a,b,c,d)},kb.prototype.query=function(a,b){this.root&&wb(this.root,a,b)},kb.prototype.count=function(){return this.count},kb.prototype.each=function(a){var b;for(b in this.leaves)a(this.leaves[b].obj)};var Cb=function(a,d,e,f,g){return(c(a.bb_r,f)-b(a.bb_l,d))*(c(a.bb_t,g)-b(a.bb_b,e))},Db=function(a,d,e,f){if(1==f)return d[e];if(2==f)return a.makeNode(d[e],d[e+1]);for(var g=d[e],h=g.bb_l,i=g.bb_b,j=g.bb_r,k=g.bb_t,l=e+f,m=e+1;l>m;m++)g=d[m],h=b(h,g.bb_l),i=b(i,g.bb_b),j=c(j,g.bb_r),k=c(k,g.bb_t);var n=j-h>k-i,o=Array(2*f);if(n)for(var m=e;l>m;m++)o[2*m+0]=d[m].bb_l,o[2*m+1]=d[m].bb_r;else for(var m=e;l>m;m++)o[2*m+0]=d[m].bb_b,o[2*m+1]=d[m].bb_t;o.sort(function(a,b){return a-b});var p=.5*(o[f-1]+o[f]),q=h,r=i,s=j,t=k,u=h,v=i,w=j,x=k;n?s=u=p:t=v=p;for(var y=l,z=e;y>z;){var g=d[z];Cb(g,u,v,w,x)<Cb(g,q,r,s,t)?(y--,d[z]=d[y],d[y]=g):z++}if(y==f){for(var g=null,m=e;l>m;m++)g=vb(g,d[m],a);return g}return NodeNew(a,Db(a,d,e,y-e),Db(a,d,y,l-y))};kb.prototype.optimize=function(){var a=Array(this.count),b=0;for(var c in this.leaves)a[b++]=this.nodes[c];tree.subtreeRecycle(root),this.root=Db(tree,a,a.length)};var Eb=function(a,b){!a.isLeaf&&10>=b&&(Eb(a.A,b+1),Eb(a.B,b+1));for(var c="",d=0;b>d;d++)c+=" ";console.log(c+a.bb_b+" "+a.bb_t)};kb.prototype.log=function(){this.root&&Eb(this.root,0)};var Fb=a.CollisionHandler=function(){this.a=this.b=0};Fb.prototype.begin=function(){return!0},Fb.prototype.preSolve=function(){return!0},Fb.prototype.postSolve=function(){},Fb.prototype.separate=function(){};var Gb=function(a,b){this.e=0,this.u=0,this.surface_vr=s,this.a=a,this.body_a=a.body,this.b=b,this.body_b=b.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};Gb.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},Gb.prototype.totalImpulse=function(){for(var a=this.contacts,b=new r(0,0),c=0,d=a.length;d>c;c++){var e=a[c];b.add(A(e.n,e.jnAcc))}return this.swappedColl?b:b.neg()},Gb.prototype.totalImpulseWithFriction=function(){for(var a=this.contacts,b=new r(0,0),c=0,d=a.length;d>c;c++){var e=a[c];b.add(new r(e.jnAcc,e.jtAcc).rotate(e.n))}return this.swappedColl?b:b.neg()},Gb.prototype.totalKE=function(){for(var a=(1-this.e)/(1+this.e),b=0,c=this.contacts,d=0,e=c.length;e>d;d++){var f=c[d],g=f.jnAcc,h=f.jtAcc;b+=a*g*g/f.nMass+h*h/f.tMass}return b},Gb.prototype.ignore=function(){this.state="ignore"},Gb.prototype.getA=function(){return this.swappedColl?this.b:this.a},Gb.prototype.getB=function(){return this.swappedColl?this.a:this.b},Gb.prototype.isFirstContact=function(){return"first coll"===this.state};var Hb=function(a,b,c){this.point=a,this.normal=b,this.dist=c};Gb.prototype.getContactPointSet=function(){var a,b=Array(this.contacts.length);for(a=0;b.length>a;a++)b[a]=new Hb(this.contacts[a].p,this.contacts[a].n,this.contacts[a].dist);return b},Gb.prototype.getNormal=function(a){var b=this.contacts[a].n;return this.swappedColl?z(b):b},Gb.prototype.getPoint=function(a){return this.contacts[a].p},Gb.prototype.getDepth=function(a){return this.contacts[a].dist};var Ib=function(a,b,c,d){c?c.body_a===b?c.thread_a_next=d:c.thread_b_next=d:b.arbiterList=d,d&&(d.body_a===b?d.thread_a_prev=c:d.thread_b_prev=c)};Gb.prototype.unthread=function(){Ib(this,this.body_a,this.thread_a_prev,this.thread_a_next),Ib(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},Gb.prototype.update=function(a,b,c,d){if(this.contacts)for(var e=0;this.contacts.length>e;e++)for(var f=this.contacts[e],g=0;a.length>g;g++){var h=a[g];h.hash===f.hash&&(h.jnAcc=f.jnAcc,h.jtAcc=f.jtAcc)}this.contacts=a,this.handler=b,this.swappedColl=c.collision_type!==b.a,this.e=c.e*d.e,this.u=c.u*d.u,this.surface_vr=y(c.surface_v,d.surface_v),this.a=c,this.body_a=c.body,this.b=d,this.body_b=d.body,"cached"==this.state&&(this.state="first coll")},Gb.prototype.preStep=function(a,c,d){for(var e=this.body_a,f=this.body_b,g=0;this.contacts.length>g;g++){var h=this.contacts[g];h.r1=y(h.p,e.p),h.r2=y(h.p,f.p),h.nMass=1/oc(e,f,h.r1,h.r2,h.n),h.tMass=1/oc(e,f,h.r1,h.r2,D(h.n)),h.bias=-d*b(0,h.dist+c)/a,h.jBias=0,h.bounce=jc(e,f,h.r1,h.r2,h.n)*this.e}},Gb.prototype.applyCachedImpulse=function(a){if(!this.isFirstContact())for(var b=this.body_a,c=this.body_b,d=0;this.contacts.length>d;d++){var e=this.contacts[d],f=e.n.x,g=e.n.y,h=f*e.jnAcc-g*e.jtAcc,i=f*e.jtAcc+g*e.jnAcc;lc(b,c,e.r1,e.r2,h*a,i*a)}};var Jb=0,Kb=0;Gb.prototype.applyImpulse=function(){Jb++;for(var a=this.body_a,b=this.body_b,d=this.surface_vr,e=this.u,f=0;this.contacts.length>f;f++){Kb++;var g=this.contacts[f],h=g.nMass,i=g.n,j=g.r1,k=g.r2,l=b.vx-k.y*b.w-(a.vx-j.y*a.w),m=b.vy+k.x*b.w-(a.vy+j.x*a.w),n=i.x*(b.v_biasx-k.y*b.w_bias-a.v_biasx+j.y*a.w_bias)+i.y*(k.x*b.w_bias+b.v_biasy-j.x*a.w_bias-a.v_biasy),o=u(l,m,i.x,i.y),q=u(l+d.x,m+d.y,-i.y,i.x),r=(g.bias-n)*h,s=g.jBias;g.jBias=c(s+r,0);var t=-(g.bounce+o)*h,v=g.jnAcc;g.jnAcc=c(v+t,0);var w=e*g.jnAcc,x=-q*g.tMass,y=g.jtAcc;g.jtAcc=p(y+x,-w,w);var z=i.x*(g.jBias-s),A=i.y*(g.jBias-s);mc(a,-z,-A,j),mc(b,z,A,k);var B=g.jnAcc-v,C=g.jtAcc-y;lc(a,b,j,k,i.x*B-i.y*C,i.x*C+i.y*B)}},Gb.prototype.callSeparate=function(a){var b=a.lookupHandler(this.a.collision_type,this.b.collision_type);b.separate(this,a)},Gb.prototype.next=function(a){return this.body_a==a?this.thread_a_next:this.thread_b_next};var Lb=0,Mb=function(a,b,c,d){this.p=a,this.n=b,this.dist=c,this.r1=this.r2=s,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=d,Lb++},Nb=[],Ob=function(a,b,c,d){var e=c+d,f=y(b,a),g=H(f);if(!(g>=e*e)){var h=Math.sqrt(g);return new Mb(x(a,A(f,.5+(c-.5*e)/(h?h:1/0))),h?A(f,1/h):new r(1,0),h-e,0)}},Pb=function(a,b){var c=Ob(a.tc,b.tc,a.r,b.r);return c?[c]:Nb},Qb=function(a,b){var c=b.ta,d=b.tb,e=a.tc,f=y(d,c),g=q(t(f,y(e,c))/H(f)),h=x(c,A(f,g)),i=Ob(e,h,a.r,b.r);if(i){var j=i.n;return 0===g&&0>t(j,b.a_tangent)||1===g&&0>t(j,b.b_tangent)?Nb:[i]}return Nb},Rb=0,Sb=function(a,b){var c=0,d=a.valueOnAxis(b[0].n,b[0].d);if(d>0)return-1;for(var e=1;b.length>e;e++){var f=a.valueOnAxis(b[e].n,b[e].d);if(f>0)return-1;f>d&&(d=f,c=e)}return Rb=d,c},Tb=function(a,b,c,d){for(var e=[],f=a.tVerts,g=0;f.length>g;g+=2){var i=f[g],j=f[g+1];b.containsVertPartial(i,j,z(c))&&e.push(new Mb(new r(i,j),c,d,h(a.hashid,g)))}for(var k=b.tVerts,g=0;k.length>g;g+=2){var i=k[g],j=k[g+1];a.containsVertPartial(i,j,c)&&e.push(new Mb(new r(i,j),c,d,h(b.hashid,g)))}return e},Ub=function(a,b,c,d){for(var e=[],f=a.tVerts,g=0;f.length>g;g+=2){var i=f[g],j=f[g+1];b.containsVert(i,j)&&e.push(new Mb(new r(i,j),c,d,h(a.hashid,g>>1)))}for(var k=b.tVerts,g=0;k.length>g;g+=2){var i=k[g],j=k[g+1];a.containsVert(i,j)&&e.push(new Mb(new r(i,j),c,d,h(b.hashid,g>>1)))}return e.length?e:Tb(a,b,c,d)},Vb=function(a,b){var c=Sb(b,a.tPlanes);if(-1==c)return Nb;var d=Rb,e=Sb(a,b.tPlanes);if(-1==e)return Nb;var f=Rb;return d>f?Ub(a,b,a.tPlanes[c].n,d):Ub(a,b,z(b.tPlanes[e].n),f)},Wb=function(a,c,d){var e=t(c,a.ta)-a.r,f=t(c,a.tb)-a.r;return b(e,f)-d},Xb=function(a,b,c,d,e){for(var f=B(b.tn,b.ta),g=B(b.tn,b.tb),i=A(b.tn,e),j=c.tVerts,k=0;j.length>k;k+=2){var l=j[k],m=j[k+1];if(u(l,m,i.x,i.y)<t(b.tn,b.ta)*e+b.r){var n=C(b.tn.x,b.tn.y,l,m);f>=n&&n>=g&&a.push(new Mb(new r(l,m),i,d,h(c.hashid,k)))}}},Yb=function(a,b){var c=[],d=b.tPlanes,e=d.length,f=t(a.tn,a.ta),g=b.valueOnAxis(a.tn,f)-a.r,i=b.valueOnAxis(z(a.tn),-f)-a.r;if(i>0||g>0)return Nb;var j=0,k=Wb(a,d[0].n,d[0].d);if(k>0)return Nb;for(var l=0;e>l;l++){var m=Wb(a,d[l].n,d[l].d);if(m>0)return Nb;m>k&&(k=m,j=l)}var n=z(d[j].n),o=x(a.ta,A(n,a.r)),p=x(a.tb,A(n,a.r));if(b.containsVert(o.x,o.y)&&c.push(new Mb(o,n,k,h(a.hashid,0))),b.containsVert(p.x,p.y)&&c.push(new Mb(p,n,k,h(a.hashid,1))),(g>=k||i>=k)&&(g>i?Xb(c,a,b,g,1):Xb(c,a,b,i,-1)),0===c.length){var q,s=2*j,u=b.tVerts,v=new r(u[s],u[s+1]);if(q=Ob(a.ta,v,a.r,0,c))return[q];if(q=Ob(a.tb,v,a.r,0,c))return[q];var w=2*e,y=new r(u[(s+2)%w],u[(s+3)%w]);if(q=Ob(a.ta,y,a.r,0,c))return[q];if(q=Ob(a.tb,y,a.r,0,c))return[q]}return c},Zb=function(a,b){for(var c=b.tPlanes,d=0,e=t(c[0].n,a.tc)-c[0].d-a.r,f=0;c.length>f;f++){var g=t(c[f].n,a.tc)-c[f].d-a.r;if(g>0)return Nb;g>e&&(e=g,d=f)}var h=c[d].n,i=b.tVerts,j=i.length,k=d<<1,l=i[k],m=i[k+1],n=i[(k+2)%j],o=i[(k+3)%j],p=C(h.x,h.y,l,m),q=C(h.x,h.y,n,o),s=B(h,a.tc);if(q>s){var u=Ob(a.tc,new r(n,o),a.r,0,u);return u?[u]:Nb}if(p>s)return[new Mb(y(a.tc,A(h,a.r+e/2)),z(h),e,0)];var u=Ob(a.tc,new r(l,m),a.r,0,u);return u?[u]:Nb};Z.prototype.collisionCode=0,_.prototype.collisionCode=1,bb.prototype.collisionCode=2,Z.prototype.collisionTable=[Pb,Qb,Zb],_.prototype.collisionTable=[null,function(){return Nb},Yb],bb.prototype.collisionTable=[null,null,Vb];var $b=a.collideShapes=function(a,b){return d(a.collisionCode<=b.collisionCode,"Collided shapes must be sorted by type"),a.collisionTable[b.collisionCode](a,b)},_b=new Fb,ac=a.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new kb(null),this.activeShapes=new kb(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=_b,this.postStepCallbacks=[],this.iterations=10,this.gravity=s,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=1/0,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new eb(1/0,1/0),this.staticBody.nodeIdleTime=1/0,this.collideShapes=this.makeCollideShapes()};ac.prototype.getCurrentTimeStep=function(){return this.curr_dt},ac.prototype.setIterations=function(a){this.iterations=a},ac.prototype.isLocked=function(){return this.locked};var bc=function(a){d(!a.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};ac.prototype.addCollisionHandler=function(a,b,c,d,e,f){bc(this),this.removeCollisionHandler(a,b);var g=new Fb;g.a=a,g.b=b,c&&(g.begin=c),d&&(g.preSolve=d),e&&(g.postSolve=e),f&&(g.separate=f),this.collisionHandlers[h(a,b)]=g},ac.prototype.removeCollisionHandler=function(a,b){bc(this),delete this.collisionHandlers[h(a,b)]},ac.prototype.setDefaultCollisionHandler=function(a,b,c,d){bc(this);var e=new Fb;a&&(e.begin=a),b&&(e.preSolve=b),c&&(e.postSolve=c),d&&(e.separate=d),this.defaultHandler=e},ac.prototype.lookupHandler=function(a,b){return this.collisionHandlers[h(a,b)]||this.defaultHandler},ac.prototype.addShape=function(a){var b=a.body;return b.isStatic()?this.addStaticShape(a):(d(!a.space,"This shape is already added to a space and cannot be added to another."),bc(this),b.activate(),b.addShape(a),a.update(b.p,b.rot),this.activeShapes.insert(a,a.hashid),a.space=this,a)},ac.prototype.addStaticShape=function(a){d(!a.space,"This shape is already added to a space and cannot be added to another."),bc(this);var b=a.body;return b.addShape(a),a.update(b.p,b.rot),this.staticShapes.insert(a,a.hashid),a.space=this,a},ac.prototype.addBody=function(a){return d(!a.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),d(!a.space,"This body is already added to a space and cannot be added to another."),bc(this),this.bodies.push(a),a.space=this,a},ac.prototype.addConstraint=function(a){d(!a.space,"This shape is already added to a space and cannot be added to another."),bc(this);var b=a.a,c=a.b;return b.activate(),c.activate(),this.constraints.push(a),a.next_a=b.constraintList,b.constraintList=a,a.next_b=c.constraintList,c.constraintList=a,a.space=this,a},ac.prototype.filterArbiters=function(a,b){for(var c in this.cachedArbiters){var d=this.cachedArbiters[c];(a===d.body_a&&(b===d.a||null===b)||a===d.body_b&&(b===d.b||null===b))&&(b&&"cached"!==d.state&&d.callSeparate(this),d.unthread(),i(this.arbiters,d),delete this.cachedArbiters[c])}},ac.prototype.removeShape=function(a){var b=a.body;b.isStatic()?this.removeStaticShape(a):(d(this.containsShape(a),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),bc(this),b.activate(),b.removeShape(a),this.filterArbiters(b,a),this.activeShapes.remove(a,a.hashid),a.space=null)},ac.prototype.removeStaticShape=function(a){d(this.containsShape(a),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),bc(this);var b=a.body;b.isStatic()&&b.activateStatic(a),b.removeShape(a),this.filterArbiters(b,a),this.staticShapes.remove(a,a.hashid),a.space=null},ac.prototype.removeBody=function(a){d(this.containsBody(a),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),bc(this),a.activate(),i(this.bodies,a),a.space=null},ac.prototype.removeConstraint=function(a){d(this.containsConstraint(a),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),bc(this),a.a.activate(),a.b.activate(),i(this.constraints,a),a.a.removeConstraint(a),a.b.removeConstraint(a),a.space=null},ac.prototype.containsShape=function(a){return a.space===this},ac.prototype.containsBody=function(a){return a.space==this},ac.prototype.containsConstraint=function(a){return a.space==this},ac.prototype.uncacheArbiter=function(a){delete this.cachedArbiters[h(a.a.hashid,a.b.hashid)],i(this.arbiters,a)},ac.prototype.eachBody=function(a){this.lock();for(var b=this.bodies,c=0;b.length>c;c++)a(b[c]);for(var d=this.sleepingComponents,c=0;d.length>c;c++)for(var e=d[c],f=e;f;){var g=f.nodeNext;a(f),f=g}this.unlock(!0)},ac.prototype.eachShape=function(a){this.lock(),this.activeShapes.each(a),this.staticShapes.each(a),this.unlock(!0)},ac.prototype.eachConstraint=function(a){this.lock();for(var b=this.constraints,c=0;b.length>c;c++)a(b[c]);this.unlock(!0)},ac.prototype.reindexStatic=function(){d(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(a){var b=a.body;a.update(b.p,b.rot)}),this.staticShapes.reindex()},ac.prototype.reindexShape=function(a){d(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var b=a.body;a.update(b.p,b.rot),this.activeShapes.reindexObject(a,a.hashid),this.staticShapes.reindexObject(a,a.hashid)},ac.prototype.reindexShapesForBody=function(a){for(var b=a.shapeList;b;b=b.next)this.reindexShape(b)},ac.prototype.useSpatialHash=function(){throw Error("Spatial Hash not implemented.")},ac.prototype.activateBody=function(a){if(d(!a.isRogue(),"Internal error: Attempting to activate a rogue body."),this.locked)-1===this.rousedBodies.indexOf(a)&&this.rousedBodies.push(a);else{this.bodies.push(a);for(var b=0;a.shapeList.length>b;b++){var c=a.shapeList[b];this.staticShapes.remove(c,c.hashid),this.activeShapes.insert(c,c.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;if(a===f||f.isStatic()){var g=e.a,i=e.b;this.cachedArbiters[h(g.hashid,i.hashid)]=e,e.stamp=this.stamp,e.handler=this.lookupHandler(g.collision_type,i.collision_type),this.arbiters.push(e)}}for(var j=a.constraintList;j;j=j.nodeNext){var f=j.a;(a===f||f.isStatic())&&this.constraints.push(j)}}},ac.prototype.deactivateBody=function(a){d(!a.isRogue(),"Internal error: Attempting to deactivate a rogue body."),i(this.bodies,a);for(var b=0;a.shapeList.length>b;b++){var c=a.shapeList[b];this.activeShapes.remove(c,c.hashid),this.staticShapes.insert(c,c.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;(a===f||f.isStatic())&&this.uncacheArbiter(e)}for(var g=a.constraintList;g;g=g.nodeNext){var f=g.a;(a===f||f.isStatic())&&i(this.constraints,g)}};var cc=function(a){return a?a.nodeRoot:null},dc=function(a){if(a&&a.isSleeping(a)){d(!a.isRogue(),"Internal Error: componentActivate() called on a rogue body.");for(var b=a.space,c=a;c;){var e=c.nodeNext;c.nodeIdleTime=0,c.nodeRoot=null,c.nodeNext=null,b.activateBody(c),c=e}i(b.sleepingComponents,a)}};eb.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,dc(cc(this)))},eb.prototype.activateStatic=function(a){d(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var b=this.arbiterList;b;b=b.next(this))a&&a!=b.a&&a!=b.b||(b.body_a==this?b.body_b:b.body_a).activate()},eb.prototype.pushArbiter=function(a){e(null===(a.body_a===this?a.thread_a_next:a.thread_b_next),"Internal Error: Dangling contact graph pointers detected. (A)"),e(null===(a.body_a===this?a.thread_a_prev:a.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (B)");var b=this.arbiterList;e(null===b||null===(b.body_a===this?b.thread_a_prev:b.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (C)"),a.body_a===this?a.thread_a_next=b:a.thread_b_next=b,b&&(b.body_a===this?b.thread_a_prev=a:b.thread_b_prev=a),this.arbiterList=a};var ec=function(a,b){b.nodeRoot=a,b!==a&&(b.nodeNext=a.nodeNext,a.nodeNext=b)},fc=function(a,b){if(!b.isRogue()){var c=cc(b);if(null==c){ec(a,b);for(var d=b.arbiterList;d;d=d.next(b))fc(a,b==d.body_a?d.body_b:d.body_a);for(var f=b.constraintList;f;f=f.next(b))fc(a,b==f.a?f.b:f.a)}else e(c===a,"Internal Error: Inconsistency detected in the contact graph.")}},gc=function(a,b){for(var c=a;c;c=c.nodeNext)if(b>c.nodeIdleTime)return!0;return!1};ac.prototype.processComponents=function(a){for(var b=1/0!==this.sleepTimeThreshold,c=this.bodies,d=0;c.length>d;d++){var f=c[d];e(null===f.nodeNext,"Internal Error: Dangling next pointer detected in contact graph."),e(null===f.nodeRoot,"Internal Error: Dangling root pointer detected in contact graph.")}if(b)for(var g=this.idleSpeedThreshold,h=g?g*g:H(this.gravity)*a*a,d=0;c.length>d;d++){var f=c[d],i=h?f.m*h:0;f.nodeIdleTime=f.kineticEnergy()>i?0:f.nodeIdleTime+a}for(var j=this.arbiters,d=0,k=j.length;k>d;d++){var l=j[d],m=l.body_a,n=l.body_b;b&&((n.isRogue()&&!n.isStatic()||m.isSleeping())&&m.activate(),(m.isRogue()&&!m.isStatic()||n.isSleeping())&&n.activate()),m.pushArbiter(l),n.pushArbiter(l)}if(b){for(var o=this.constraints,d=0;o.length>d;d++){var p=o[d],m=p.a,n=p.b;n.isRogue()&&!n.isStatic()&&m.activate(),m.isRogue()&&!m.isStatic()&&n.activate()}for(var d=0;c.length>d;){var f=c[d];if(null!==cc(f)||(fc(f,f),gc(f,this.sleepTimeThreshold)))d++,f.nodeRoot=null,f.nodeNext=null;else{this.sleepingComponents.push(f);for(var q=f;q;q=q.nodeNext)this.deactivateBody(q)}}}},eb.prototype.sleep=function(){this.sleepWithGroup(null)},eb.prototype.sleepWithGroup=function(a){d(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var b=this.space;if(d(b,"Cannot put a rogue body to sleep."),d(!b.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),d(null===a||a.isSleeping(),"Cannot use a non-sleeping body as a group identifier."),this.isSleeping())return void d(cc(this)===cc(a),"The body is already sleeping and it's group cannot be reassigned.");for(var c=0;this.shapeList.length>c;c++)this.shapeList[c].update(this.p,this.rot);if(b.deactivateBody(this),a){var e=cc(a);this.nodeRoot=e,this.nodeNext=e.nodeNext,this.nodeIdleTime=0,e.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,b.sleepingComponents.push(this);i(b.bodies,this)},ac.prototype.activateShapesTouchingShape=function(a){1/0!==this.sleepTimeThreshold&&this.shapeQuery(a,function(a){a.body.activate()})},ac.prototype.pointQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&e.pointQuery(a)&&d(e)},f=new R(a.x,a.y,a.x,a.y);this.lock(),this.activeShapes.query(f,e),this.staticShapes.query(f,e),this.unlock(!0)},ac.prototype.pointQueryFirst=function(a,b,c){var d=null;return this.pointQuery(a,b,c,function(a){a.sensor||(d=a)}),d},ac.prototype.nearestPointQuery=function(a,b,c,d,e){var f=function(f){if((!f.group||d!==f.group)&&c&f.layers){var g=f.nearestPointQuery(a);b>g.d&&e(f,g.d,g.p)}},g=S(a,b);this.lock(),this.activeShapes.query(g,f),this.staticShapes.query(g,f),this.unlock(!0)},ac.prototype.nearestPointQueryNearest=function(a,b,c,d){var e,f=function(f){if((!f.group||d!==f.group)&&c&f.layers&&!f.sensor){var g=f.nearestPointQuery(a);b>g.d&&(!e||g.d<e.d)&&(e=g)}},g=S(a,b);return this.activeShapes.query(g,f),this.staticShapes.query(g,f),e},ac.prototype.segmentQuery=function(a,b,c,d,e){var f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&(g=f.segmentQuery(a,b))&&e(f,g.t,g.n),1};this.lock(),this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,1,f),this.unlock(!0)},ac.prototype.segmentQueryFirst=function(a,b,c,d){var e=null,f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&!f.sensor&&(g=f.segmentQuery(a,b))&&(null===e||g.t<e.t)&&(e=g),e?e.t:1};return this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,e?e.t:1,f),e},ac.prototype.bbQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&T(a,e.bb_l,e.bb_b,e.bb_r,e.bb_t)&&d(e)};this.lock(),this.activeShapes.query(a,e),this.staticShapes.query(a,e),this.unlock(!0)},ac.prototype.shapeQuery=function(a,b){var c=a.body;c&&a.update(c.p,c.rot);var d=new R(a.bb_l,a.bb_b,a.bb_r,a.bb_t),e=!1,f=function(c){var d=a;if((!d.group||d.group!==c.group)&&d.layers&c.layers&&d!==c){var f;if(d.collisionCode<=c.collisionCode)f=$b(d,c);else{f=$b(c,d);for(var g=0;f.length>g;g++)f[g].n=z(f[g].n)}if(f.length&&(e=!(d.sensor||c.sensor),b)){for(var h=Array(f.length),g=0;f.length>g;g++)h[g]=new Hb(f[g].p,f[g].n,f[g].dist);b(c,h)}}};return this.lock(),this.activeShapes.query(d,f),this.staticShapes.query(d,f),this.unlock(!0),e},ac.prototype.addPostStepCallback=function(a){e(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(a)},ac.prototype.runPostStepCallbacks=function(){for(var a=0;this.postStepCallbacks.length>a;a++)this.postStepCallbacks[a]();this.postStepCallbacks=[]},ac.prototype.lock=function(){this.locked++},ac.prototype.unlock=function(a){if(this.locked--,d(this.locked>=0,"Internal Error: Space lock underflow."),0===this.locked&&a){for(var b=this.rousedBodies,c=0;b.length>c;c++)this.activateBody(b[c]);b.length=0,this.runPostStepCallbacks()}},ac.prototype.makeCollideShapes=function(){var a=this;return function(b,c){var d=a;if(b.bb_l<=c.bb_r&&c.bb_l<=b.bb_r&&b.bb_b<=c.bb_t&&c.bb_b<=b.bb_t&&b.body!==c.body&&(!b.group||b.group!==c.group)&&b.layers&c.layers){var e=d.lookupHandler(b.collision_type,c.collision_type),f=b.sensor||c.sensor;if(!f||e!==_b){if(b.collisionCode>c.collisionCode){var g=b;b=c,c=g}var i=$b(b,c);if(0!==i.length){var j=h(b.hashid,c.hashid),k=d.cachedArbiters[j];k||(k=d.cachedArbiters[j]=new Gb(b,c)),k.update(i,e,b,c),"first coll"!=k.state||e.begin(k,d)||k.ignore(),"ignore"!==k.state&&e.preSolve(k,d)&&!f?d.arbiters.push(k):(k.contacts=null,"ignore"!==k.state&&(k.state="normal")),k.stamp=d.stamp}}}}},ac.prototype.arbiterSetFilter=function(a){var b=this.stamp-a.stamp,c=a.body_a,d=a.body_b;return(c.isStatic()||c.isSleeping())&&(d.isStatic()||d.isSleeping())?!0:(b>=1&&"cached"!=a.state&&(a.callSeparate(this),a.state="cached"),b>=this.collisionPersistence?(a.contacts=null,!1):!0)};var hc=function(a){var b=a.body;a.update(b.p,b.rot)};ac.prototype.step=function(a){if(0!==a){d(0===s.x&&0===s.y,"vzero is invalid"),this.stamp++;var b=this.curr_dt;this.curr_dt=a;var c,e,f,g=this.bodies,h=this.constraints,i=this.arbiters;for(c=0;i.length>c;c++){var j=i[c];j.state="normal",j.body_a.isSleeping()||j.body_b.isSleeping()||j.unthread()}for(i.length=0,this.lock(),c=0;g.length>c;c++)g[c].position_func(a);this.activeShapes.each(hc),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(a),this.lock();for(f in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[f])||delete this.cachedArbiters[f];var k=this.collisionSlop,l=1-Math.pow(this.collisionBias,a);for(c=0;i.length>c;c++)i[c].preStep(a,k,l);for(c=0;h.length>c;c++){var m=h[c];m.preSolve(this),m.preStep(a)}var n=Math.pow(this.damping,a),o=this.gravity;for(c=0;g.length>c;c++)g[c].velocity_func(o,n,a);var p=0===b?0:a/b;for(c=0;i.length>c;c++)i[c].applyCachedImpulse(p);for(c=0;h.length>c;c++)h[c].applyCachedImpulse(p);for(c=0;this.iterations>c;c++){for(e=0;i.length>e;e++)i[e].applyImpulse();for(e=0;h.length>e;e++)h[e].applyImpulse()}for(c=0;h.length>c;c++)h[c].postSolve(this);for(c=0;i.length>c;c++)i[c].handler.postSolve(i[c],this);this.unlock(!0)}};var ic=function(a,b,c,d){var e=a.vx+-c.y*a.w,f=a.vy+c.x*a.w,g=b.vx+-d.y*b.w,h=b.vy+d.x*b.w;return new r(g-e,h-f)},jc=function(a,b,c,d,e){var f=a.vx+-c.y*a.w,g=a.vy+c.x*a.w,h=b.vx+-d.y*b.w,i=b.vy+d.x*b.w;return u(h-f,i-g,e.x,e.y)},kc=function(a,b,c,d){a.vx+=b*a.m_inv,a.vy+=c*a.m_inv,a.w+=a.i_inv*(d.x*c-d.y*b)},lc=function(a,b,c,d,e,f){kc(a,-e,-f,c),kc(b,e,f,d)},mc=function(a,b,c,d){a.v_biasx+=b*a.m_inv,a.v_biasy+=c*a.m_inv,a.w_bias+=a.i_inv*C(d.x,d.y,b,c)},nc=function(a,b,c){var d=B(b,c);return a.m_inv+a.i_inv*d*d},oc=function(a,b,c,d,f){var g=nc(a,c,f)+nc(b,d,f);return e(0!==g,"Unsolvable collision or constraint."),g},pc=function(a,b,c,d,f,g){var h,i,j,k,l=a.m_inv+b.m_inv;h=l,i=0,j=0,k=l;var m=a.i_inv,n=c.x*c.x*m,o=c.y*c.y*m,p=-c.x*c.y*m;h+=o,i+=p,j+=p,k+=n;var q=b.i_inv,r=d.x*d.x*q,s=d.y*d.y*q,t=-d.x*d.y*q;h+=s,i+=t,j+=t,k+=r;var u=h*k-i*j;e(0!==u,"Unsolvable constraint.");var v=1/u;f.x=k*v,f.y=-i*v,g.x=-j*v,g.y=h*v},qc=function(a,b,c){return new r(t(a,b),t(a,c))},rc=function(a,b){return 1-Math.pow(a,b)},sc=a.Constraint=function(a,b){this.a=a,this.b=b,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=1/0,this.errorBias=Math.pow(.9,60),this.maxBias=1/0};sc.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},sc.prototype.preStep=function(){},sc.prototype.applyCachedImpulse=function(){},sc.prototype.applyImpulse=function(){},sc.prototype.getImpulse=function(){return 0},sc.prototype.preSolve=function(){},sc.prototype.postSolve=function(){},sc.prototype.next=function(a){return this.a===a?this.next_a:this.next_b
};var tc=a.PinJoint=function(a,b,c,d){sc.call(this,a,b),this.anchr1=c,this.anchr2=d;var f=a?x(a.p,F(c,a.rot)):c,g=b?x(b.p,F(d,b.rot)):d;this.dist=v(y(g,f)),e(this.dist>0,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};tc.prototype=Object.create(sc.prototype),tc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=F(this.anchr1,b.rot),this.r2=F(this.anchr2,c.rot);var d=y(x(c.p,this.r2),x(b.p,this.r1)),e=v(d);this.n=A(d,1/(e?e:1/0)),this.nMass=1/oc(b,c,this.r1,this.r2,this.n);var f=this.maxBias;this.bias=p(-rc(this.errorBias,a)*(e-this.dist)/a,-f,f),this.jnMax=this.maxForce*a},tc.prototype.applyCachedImpulse=function(a){var b=A(this.n,this.jnAcc*a);lc(this.a,this.b,this.r1,this.r2,b.x,b.y)},tc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=jc(a,b,this.r1,this.r2,c),e=(this.bias-d)*this.nMass,f=this.jnAcc;this.jnAcc=p(f+e,-this.jnMax,this.jnMax),e=this.jnAcc-f,lc(a,b,this.r1,this.r2,c.x*e,c.y*e)},tc.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var uc=a.SlideJoint=function(a,b,c,d,e,f){sc.call(this,a,b),this.anchr1=c,this.anchr2=d,this.min=e,this.max=f,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};uc.prototype=Object.create(sc.prototype),uc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=F(this.anchr1,b.rot),this.r2=F(this.anchr2,c.rot);var d=y(x(c.p,this.r2),x(b.p,this.r1)),e=v(d),f=0;e>this.max?(f=e-this.max,this.n=L(d)):this.min>e?(f=this.min-e,this.n=z(L(d))):(this.n=s,this.jnAcc=0),this.nMass=1/oc(b,c,this.r1,this.r2,this.n);var g=this.maxBias;this.bias=p(-rc(this.errorBias,a)*f/a,-g,g),this.jnMax=this.maxForce*a},uc.prototype.applyCachedImpulse=function(a){var b=this.jnAcc*a;lc(this.a,this.b,this.r1,this.r2,this.n.x*b,this.n.y*b)},uc.prototype.applyImpulse=function(){if(0!==this.n.x||0!==this.n.y){var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=ic(a,b,d,e),g=t(f,c),h=(this.bias-g)*this.nMass,i=this.jnAcc;this.jnAcc=p(i+h,-this.jnMax,0),h=this.jnAcc-i,lc(a,b,this.r1,this.r2,c.x*h,c.y*h)}},uc.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var vc=a.PivotJoint=function(a,b,c,d){if(sc.call(this,a,b),void 0===d){var e=c;c=a?a.world2Local(e):e,d=b?b.world2Local(e):e}this.anchr1=c,this.anchr2=d,this.r1=this.r2=s,this.k1=new r(0,0),this.k2=new r(0,0),this.jAcc=s,this.jMaxLen=0,this.bias=s};vc.prototype=Object.create(sc.prototype),vc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=F(this.anchr1,b.rot),this.r2=F(this.anchr2,c.rot),pc(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var d=y(x(c.p,this.r2),x(b.p,this.r1));this.bias=M(A(d,-rc(this.errorBias,a)/a),this.maxBias)},vc.prototype.applyCachedImpulse=function(a){lc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},vc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=ic(a,b,c,d),f=qc(y(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=M(x(this.jAcc,f),this.jMaxLen),lc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},vc.prototype.getImpulse=function(){return v(this.jAcc)};var wc=a.GrooveJoint=function(a,b,c,d,e){sc.call(this,a,b),this.grv_a=c,this.grv_b=d,this.grv_n=D(K(y(d,c))),this.anchr2=e,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new r(0,0),this.k2=new r(0,0),this.jAcc=s,this.jMaxLen=0,this.bias=null};wc.prototype=Object.create(sc.prototype),wc.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.local2World(this.grv_a),e=b.local2World(this.grv_b),f=F(this.grv_n,b.rot),g=t(d,f);this.grv_tn=f,this.r2=F(this.anchr2,c.rot);var h=B(x(c.p,this.r2),f);B(d,f)>=h?(this.clamp=1,this.r1=y(d,b.p)):h>=B(e,f)?(this.clamp=-1,this.r1=y(e,b.p)):(this.clamp=0,this.r1=y(x(A(D(f),-h),A(f,g)),b.p)),pc(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var i=y(x(c.p,this.r2),x(b.p,this.r1));this.bias=M(A(i,-rc(this.errorBias,a)/a),this.maxBias)},wc.prototype.applyCachedImpulse=function(a){lc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},wc.prototype.grooveConstrain=function(a){var b=this.grv_tn,c=this.clamp*B(a,b)>0?a:E(a,b);return M(c,this.jMaxLen)},wc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=ic(a,b,c,d),f=qc(y(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=this.grooveConstrain(x(g,f)),lc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},wc.prototype.getImpulse=function(){return v(this.jAcc)},wc.prototype.setGrooveA=function(a){this.grv_a=a,this.grv_n=D(K(y(this.grv_b,a))),this.activateBodies()},wc.prototype.setGrooveB=function(a){this.grv_b=a,this.grv_n=D(K(y(a,this.grv_a))),this.activateBodies()};var xc=function(a,b){return(a.restLength-b)*a.stiffness},yc=a.DampedSpring=function(a,b,c,d,e,f,g){sc.call(this,a,b),this.anchr1=c,this.anchr2=d,this.restLength=e,this.stiffness=f,this.damping=g,this.springForceFunc=xc,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};yc.prototype=Object.create(sc.prototype),yc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=F(this.anchr1,b.rot),this.r2=F(this.anchr2,c.rot);var d=y(x(c.p,this.r2),x(b.p,this.r1)),f=v(d);this.n=A(d,1/(f?f:1/0));var g=oc(b,c,this.r1,this.r2,this.n);e(0!==g,"Unsolvable this."),this.nMass=1/g,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*a*g);var h=this.springForceFunc(this,f);lc(b,c,this.r1,this.r2,this.n.x*h*a,this.n.y*h*a)},yc.prototype.applyCachedImpulse=function(){},yc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=jc(a,b,d,e,c),g=(this.target_vrn-f)*this.v_coef;this.target_vrn=f+g,g*=this.nMass,lc(a,b,this.r1,this.r2,this.n.x*g,this.n.y*g)},yc.prototype.getImpulse=function(){return 0};var zc=function(a,b){return(b-a.restAngle)*a.stiffness},Ac=a.DampedRotarySpring=function(a,b,c,d,e){sc.call(this,a,b),this.restAngle=c,this.stiffness=d,this.damping=e,this.springTorqueFunc=zc,this.target_wrn=0,this.w_coef=0,this.iSum=0};Ac.prototype=Object.create(sc.prototype),Ac.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.i_inv+c.i_inv;e(0!==d,"Unsolvable spring."),this.iSum=1/d,this.w_coef=1-Math.exp(-this.damping*a*d),this.target_wrn=0;var f=this.springTorqueFunc(this,b.a-c.a)*a;b.w-=f*b.i_inv,c.w+=f*c.i_inv},Ac.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=a.w-b.w,d=(this.target_wrn-c)*this.w_coef;this.target_wrn=c+d;var e=d*this.iSum;a.w+=e*a.i_inv,b.w-=e*b.i_inv};var Bc=a.RotaryLimitJoint=function(a,b,c,d){sc.call(this,a,b),this.min=c,this.max=d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Bc.prototype=Object.create(sc.prototype),Bc.prototype.preStep=function(a){var b=this.a,c=this.b,d=c.a-b.a,e=0;d>this.max?e=this.max-d:this.min>d&&(e=this.min-d),this.iSum=1/(1/b.i+1/c.i);var f=this.maxBias;this.bias=p(-rc(this.errorBias,a)*e/a,-f,f),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},Bc.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},Bc.prototype.applyImpulse=function(){if(this.bias){var a=this.a,b=this.b,c=b.w-a.w,d=-(this.bias+c)*this.iSum,e=this.jAcc;this.jAcc=0>this.bias?p(e+d,0,this.jMax):p(e+d,-this.jMax,0),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv}},Bc.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var Cc=a.RatchetJoint=function(a,b,c,d){sc.call(this,a,b),this.angle=0,this.phase=c,this.ratchet=d,this.angle=(b?b.a:0)-(a?a.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};Cc.prototype=Object.create(sc.prototype),Cc.prototype.preStep=function(a){var b=this.a,c=this.b,d=this.angle,e=this.phase,f=this.ratchet,g=c.a-b.a,h=d-g,i=0;h*f>0?i=h:this.angle=Math.floor((g-e)/f)*f+e,this.iSum=1/(b.i_inv+c.i_inv);var j=this.maxBias;this.bias=p(-rc(this.errorBias,a)*i/a,-j,j),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},Cc.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},Cc.prototype.applyImpulse=function(){if(this.bias){var a=this.a,b=this.b,c=b.w-a.w,d=this.ratchet,e=-(this.bias+c)*this.iSum,f=this.jAcc;this.jAcc=p((f+e)*d,0,this.jMax*Math.abs(d))/d,e=this.jAcc-f,a.w-=e*a.i_inv,b.w+=e*b.i_inv}},Cc.prototype.getImpulse=function(a){return Math.abs(a.jAcc)};var Dc=a.GearJoint=function(a,b,c,d){sc.call(this,a,b),this.phase=c,this.ratio=d,this.ratio_inv=1/d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Dc.prototype=Object.create(sc.prototype),Dc.prototype.preStep=function(a){var b=this.a,c=this.b;this.iSum=1/(b.i_inv*this.ratio_inv+this.ratio*c.i_inv);var d=this.maxBias;this.bias=p(-rc(this.errorBias,a)*(c.a*this.ratio-b.a-this.phase)/a,-d,d),this.jMax=this.maxForce*a},Dc.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv*this.ratio_inv,c.w+=d*c.i_inv},Dc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w*this.ratio-a.w,d=(this.bias-c)*this.iSum,e=this.jAcc;this.jAcc=p(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv*this.ratio_inv,b.w+=d*b.i_inv},Dc.prototype.getImpulse=function(){return Math.abs(this.jAcc)},Dc.prototype.setRatio=function(a){this.ratio=a,this.ratio_inv=1/a,this.activateBodies()};var Ec=a.SimpleMotor=function(a,b,c){sc.call(this,a,b),this.rate=c,this.jAcc=0,this.iSum=this.jMax=0};Ec.prototype=Object.create(sc.prototype),Ec.prototype.preStep=function(a){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*a},Ec.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},Ec.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w-a.w+this.rate,d=-c*this.iSum,e=this.jAcc;this.jAcc=p(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv},Ec.prototype.getImpulse=function(){return Math.abs(this.jAcc)}}(),function(){var a=1e-6,b=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],c=function(a){return this.elements=new Float32Array(a||b),this};c.prototype.I=c.prototype.identity=function(){return this.elements=b,this},c.prototype.e=function(a,b){return this.elements[4*(a-1)+(b-1)]},c.prototype.row=function(a){var b=this.elements;return[b[a-1],b[3+a],b[7+a],b[11+a]]},c.prototype.col=function(a){var b=this.elements;return[b[4*a-4],b[4*a-3],b[4*a-2],b[4*a-1]]},c.prototype.dimensions=function(){return{rows:4,cols:4}},c.prototype.rows=function(){return 4},c.prototype.cols=function(){return 4},c.prototype.eql=function(b){var c=this.elements,d=b.elements;return Math.abs(c[0]-d[0])<a&&Math.abs(c[1]-d[1])<a&&Math.abs(c[2]-d[2])<a&&Math.abs(c[3]-d[3])<a&&Math.abs(c[4]-d[4])<a&&Math.abs(c[5]-d[5])<a&&Math.abs(c[6]-d[6])<a&&Math.abs(c[7]-d[7])<a&&Math.abs(c[8]-d[8])<a&&Math.abs(c[9]-d[9])<a&&Math.abs(c[10]-d[10])<a&&Math.abs(c[11]-d[11])<a&&Math.abs(c[12]-d[12])<a&&Math.abs(c[13]-d[13])<a&&Math.abs(c[14]-d[14])<a&&Math.abs(c[15]-d[15])<a},c.prototype.setElements=function(a){var b=this.elements;return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],this},c.prototype.dup=function(){return new c(this.elements)},c.prototype.map=function(a){var b=this.elements;return b[0]=a(b[0],0,0),b[1]=a(b[1],0,1),b[2]=a(b[2],0,2),b[3]=a(b[3],0,3),b[4]=a(b[4],1,0),b[5]=a(b[5],1,1),b[6]=a(b[6],1,2),b[7]=a(b[7],1,3),b[8]=a(b[8],2,0),b[9]=a(b[9],2,1),b[10]=a(b[10],2,2),b[11]=a(b[11],2,3),b[12]=a(b[12],3,0),b[13]=a(b[13],3,1),b[14]=a(b[14],3,2),b[15]=a(b[15],3,3),this},c.prototype.add=function(a){var b=this.elements,c=a.elements;return b[0]=b[0]+c[0],b[1]=b[1]+c[1],b[2]=b[2]+c[2],b[3]=b[3]+c[3],b[4]=b[4]+c[4],b[5]=b[5]+c[5],b[6]=b[6]+c[6],b[7]=b[7]+c[7],b[8]=b[8]+c[8],b[9]=b[9]+c[9],b[10]=b[10]+c[10],b[11]=b[11]+c[11],b[12]=b[12]+c[12],b[14]=b[13]+c[13],b[14]=b[14]+c[14],b[15]=b[15]+c[15],this},c.prototype.substract=function(a){var b=this.elements,c=a.elements;return b[0]=b[0]-c[0],b[1]=b[1]-c[1],b[2]=b[2]-c[2],b[3]=b[3]-c[3],b[4]=b[4]-c[4],b[5]=b[5]-c[5],b[6]=b[6]-c[6],b[7]=b[7]-c[7],b[8]=b[8]-c[8],b[9]=b[9]-c[9],b[10]=b[10]-c[10],b[11]=b[11]-c[11],b[12]=b[12]-c[12],b[14]=b[13]-c[13],b[14]=b[14]-c[14],b[15]=b[15]-c[15],this},c.prototype.multiply=c.prototype.x=function(a){var b=this.elements,c=a.elements||a,d=b[0],e=b[4],f=b[8],g=b[12],h=b[1],i=b[5],j=b[9],k=b[13],l=b[2],m=b[6],n=b[10],o=b[14],p=b[3],q=b[7],r=b[11],s=b[15],t=c[0],u=c[4],v=c[8],w=c[12],x=c[1],y=c[5],z=c[9],A=c[13],B=c[2],C=c[6],D=c[10],E=c[14],F=c[3],G=c[7],H=c[11],I=c[15];return b[0]=d*t+e*x+f*B+g*F,b[1]=h*t+i*x+j*B+k*F,b[2]=l*t+m*x+n*B+o*F,b[3]=p*t+q*x+r*B+s*F,b[4]=d*u+e*y+f*C+g*G,b[5]=h*u+i*y+j*C+k*G,b[6]=l*u+m*y+n*C+o*G,b[7]=p*u+q*y+r*C+s*G,b[8]=d*v+e*z+f*D+g*H,b[9]=h*v+i*z+j*D+k*H,b[10]=l*v+m*z+n*D+o*H,b[11]=p*v+q*z+r*D+s*H,b[12]=d*w+e*A+f*E+g*I,b[13]=h*w+i*A+j*E+k*I,b[14]=l*w+m*A+n*E+o*I,b[15]=p*w+q*A+r*E+s*I,this},c.prototype.translate=function(a){var b=this.elements,c=a.elements||a,d=b[0],e=b[4],f=b[8],g=b[12],h=b[1],i=b[5],j=b[9],k=b[13],l=b[2],m=b[6],n=b[10],o=b[14],p=b[3],q=b[7],r=b[11],s=b[15],t=c[0],u=c[1],v=c[2];return b[0]=d,b[1]=h,b[2]=l,b[3]=p,b[4]=e,b[5]=i,b[6]=m,b[7]=q,b[8]=f,b[9]=j,b[10]=n,b[11]=r,b[12]=d*t+e*u+f*v+g,b[13]=h*t+i*u+j*v+k,b[14]=l*t+m*u+n*v+o,b[15]=p*t+q*u+r*v+s,this},c.prototype.rotate=function(a,b){var c=b.elements?b.elements:b,d=this.elements,e=c[0],f=c[1],g=c[2],h=Math.sqrt(e*e+f*f+g*g),i=e/h,j=f/h,k=g/h,l=Math.sin(a),m=Math.cos(a),n=1-m,o=d[0],p=d[4],q=d[8],r=d[12],s=d[1],t=d[5],u=d[9],v=d[13],w=d[2],x=d[6],y=d[10],z=d[14],A=d[3],B=d[7],C=d[11],D=d[15],E=n*i*i+m,F=n*i*j-l*k,G=n*i*k+l*j,H=n*i*j+l*k,I=n*j*j+m,J=n*j*k-l*i,K=n*i*k-l*j,L=n*j*k+l*i,M=n*k*k+m;return d[0]=o*E+p*H+q*K,d[1]=s*E+t*H+u*K,d[2]=w*E+x*H+y*K,d[3]=A*E+B*H+C*K,d[4]=o*F+p*I+q*L,d[5]=s*F+t*I+u*L,d[6]=w*F+x*I+y*L,d[7]=A*F+B*I+C*L,d[8]=o*G+p*J+q*M,d[9]=s*G+t*J+u*M,d[10]=w*G+x*J+y*M,d[11]=A*G+B*J+C*M,d[12]=r,d[13]=v,d[14]=z,d[15]=D,this},c.prototype.scale=function(a){var b=a.elements?a.elements:a,c=this.elements,d=c[0],e=c[4],f=c[8],g=c[12],h=c[1],i=c[5],j=c[9],k=c[13],l=c[2],m=c[6],n=c[10],o=c[14],p=c[3],q=c[7],r=c[11],s=c[15],t=b[0],u=b[1],v=b[2];return c[0]=d*t,c[1]=h*t,c[2]=l*t,c[3]=p*t,c[4]=e*u,c[5]=i*u,c[6]=m*u,c[7]=q*u,c[8]=f*v,c[9]=j*v,c[10]=n*v,c[11]=r*v,c[12]=g,c[13]=k,c[14]=o,c[15]=s,this},c.prototype.transpose=function(){var a=this.elements,b=a[1];return a[1]=a[4],a[4]=b,b=a[2],a[2]=a[8],a[8]=b,b=a[3],a[3]=a[12],a[12]=b,b=a[6],a[6]=a[9],a[9]=b,b=a[7],a[7]=a[13],a[13]=b,b=a[11],a[11]=a[14],a[14]=b,this},c.prototype.max=function(){var a=this.elements,b=a[0],c=a[1];return c>b&&(b=c),c=a[2],c>b&&(b=c),c=a[3],c>b&&(b=c),c=a[4],c>b&&(b=c),c=a[5],c>b&&(b=c),c=a[6],c>b&&(b=c),c=a[7],c>b&&(b=c),c=a[8],c>b&&(b=c),c=a[9],c>b&&(b=c),c=a[10],c>b&&(b=c),c=a[12],c>b&&(b=c),c=a[13],c>b&&(b=c),c=a[14],c>b&&(b=c),c=a[15],c>b?c:b},c.prototype.min=function(){var a=this.elements,b=a[0],c=a[1];return b>c&&(b=c),c=a[2],b>c&&(b=c),c=a[3],b>c&&(b=c),c=a[4],b>c&&(b=c),c=a[5],b>c&&(b=c),c=a[6],b>c&&(b=c),c=a[7],b>c&&(b=c),c=a[8],b>c&&(b=c),c=a[9],c>b&&(b=c),c=a[10],b>c&&(b=c),c=a[12],b>c&&(b=c),c=a[13],b>c&&(b=c),c=a[14],b>c&&(b=c),c=a[15],b>c?c:b},c.prototype.indexOf=function(a){return e=this.elements,e[0]==a?new WebGLIntArray([0,0]):e[1]==a?new WebGLIntArray([0,1]):e[2]==a?new WebGLIntArray([0,2]):e[3]==a?new WebGLIntArray([0,3]):e[4]==a?new WebGLIntArray([1,0]):e[5]==a?new WebGLIntArray([1,1]):e[6]==a?new WebGLIntArray([1,2]):e[7]==a?new WebGLIntArray([1,3]):e[8]==a?new WebGLIntArray([2,0]):e[9]==a?new WebGLIntArray([2,1]):e[10]==a?new WebGLIntArray([2,2]):e[11]==a?new WebGLIntArray([2,3]):e[12]==a?new WebGLIntArray([3,0]):e[13]==a?new WebGLIntArray([3,1]):e[14]==a?new WebGLIntArray([3,2]):e[15]==a?new WebGLIntArray([3,3]):null},c.prototype.diagonal=function(){var a=this.elements;return[a[0],a[5],a[10],a[15]]},c.prototype.determinant=c.prototype.det=function(){var a=this.elements,b=a[0],c=a[4],d=a[8],e=a[12],f=a[1],g=a[5],h=a[9],i=a[13],j=a[2],k=a[6],l=a[10],m=a[14],n=a[3],o=a[7],p=a[11],q=a[15];return e*h*k*n-d*i*k*n-e*g*l*n+c*i*l*n+d*g*m*n-c*h*m*n-e*h*j*o+d*i*j*o+e*f*l*o-b*i*l*o-d*f*m*o+b*h*m*o+e*g*j*p-c*i*j*p-e*f*k*p+b*i*k*p+c*f*m*p-b*g*m*p-d*g*j*q+c*h*j*q+d*f*k*q-b*h*k*q-c*f*l*q+b*g*l*q},c.prototype.isSingular=function(){return 0===this.determinant()},c.prototype.trace=c.prototype.tr=function(){var a=this.elements;return a[0]+a[5]+a[10]+a[15]},c.prototype.inverse=function(){var a=this.elements,b=this.determinant(),c=a[0],d=a[4],e=a[8],f=a[12],g=a[1],h=a[5],i=a[9],j=a[13],k=a[2],l=a[6],m=a[10],n=a[14],o=a[3],p=a[7],q=a[11],r=a[15];return a[0]=(i*n*p-j*m*p+j*l*q-h*n*q-i*l*r+h*m*r)/b,a[1]=(j*m*o-i*n*o-j*k*q+g*n*q+i*k*r-g*m*r)/b,a[2]=(h*n*o-j*l*o+j*k*p-g*n*p-h*k*r+g*l*r)/b,a[3]=(i*l*o-h*m*o-i*k*p+g*m*p+h*k*q-g*l*q)/b,a[4]=(f*m*p-e*n*p-f*l*q+d*n*q+e*l*r-d*m*r)/b,a[5]=(e*n*o-f*m*o+f*k*q-c*n*q-e*k*r+c*m*r)/b,a[6]=(f*l*o-d*n*o-f*k*p+c*n*p+d*k*r-c*l*r)/b,a[7]=(d*m*o-e*l*o+e*k*p-c*m*p-d*k*q+c*l*q)/b,a[8]=(e*j*p-f*i*p+f*h*q-d*j*q-e*h*r+d*i*r)/b,a[9]=(f*i*o-e*j*o-f*g*q+c*j*q+e*g*r-c*i*r)/b,a[10]=(d*j*o-f*h*o+f*g*p-c*j*p-d*g*r+c*h*r)/b,a[11]=(e*h*o-d*i*o-e*g*p+c*i*p+d*g*q-c*h*q)/b,a[12]=(f*i*l-e*j*l-f*h*m+d*j*m+e*h*n-d*i*n)/b,a[13]=(e*j*k-f*i*k+f*g*m-c*j*m-e*g*n+c*i*n)/b,a[14]=(f*h*k-d*j*k-f*g*l+c*j*l+d*g*n-c*h*n)/b,a[15]=(d*i*k-e*h*k+e*g*l-c*i*l-d*g*m+c*h*m)/b,this},c.prototype.view=function(){var a=this.elements;return"[ "+a[0]+" , "+a[4]+" , "+a[8]+" , "+a[12]+" ] \n [ "+a[1]+" , "+a[5]+" , "+a[9]+" , "+a[13]+" ] \n [ "+a[2]+" , "+a[6]+" , "+a[10]+" , "+a[14]+" ] \n [ "+a[3]+" , "+a[7]+" , "+a[11]+" , "+a[15]+" ]"},c.prototype.rand=function(){var a=this.elements;return a[0]=1e3*Math.random(),a[1]=1e3*Math.random(),a[2]=1e3*Math.random(),a[3]=1e3*Math.random(),a[4]=1e3*Math.random(),a[5]=1e3*Math.random(),a[6]=1e3*Math.random(),a[7]=1e3*Math.random(),a[8]=1e3*Math.random(),a[9]=1e3*Math.random(),a[10]=1e3*Math.random(),a[11]=1e3*Math.random(),a[12]=1e3*Math.random(),a[13]=1e3*Math.random(),a[14]=1e3*Math.random(),a[15]=1e3*Math.random(),this},c.I=function(){return new c},c.set=c.$=function(){var a=arguments[15]?[arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7],arguments[8],arguments[9],arguments[10],arguments[11],arguments[12],arguments[13],arguments[14],arguments[15]]:arguments[0];return new c(a)},c.makeFrustum=function(a,b,d,e,f,g){return new c([2*f/(b-a),0,0,0,0,2*f/(e-d),0,0,(b+a)/(b-a),(e+d)/(e-d),-(g+f)/(g-f),-1,0,0,-2*g*f/(g-f),0])},c.makePerspective=function(a,b,d,e){var f=d*Math.tan(a*Math.PI/360),g=-f,h=g*b,i=f*b;return new c([2*d/(i-h),0,0,0,0,2*d/(f-g),0,0,(i+h)/(i-h),(f+g)/(f-g),-(e+d)/(e-d),-1,0,0,-2*e*d/(e-d),0])},c.makeOrtho=function(a,b,d,e,f,g){return new c([2/(b-a),0,0,0,0,2/(e-d),0,0,0,0,-2/(g-f),0,-(b+a)/(b-a),-(e+d)/(e-d),-(g+f)/(g-f),0])},c.makeRotate=function(a,b){var e=b.elements?b.normalize:d.set(b).normalize(),f=e[0],g=e[1],h=e[2],i=Math.cos(a),j=1-i,k=Math.sin(a);return new c([f*f*j+i,g*f*j+h*k,h*f*j-g*k,0,f*g*j-h*k,g*g*j+i,g*h*j+f*k,0,f*h*j+g*k,g*h*j-f*k,h*h*j+i,0,0,0,0,1])},c.makeScale=function(a){var b=a.elements?a.elements:a;return new c([b[0],0,0,0,0,b[1],0,0,0,0,b[2],0,0,0,0,1])},c.makeTranslate=function(a){var b=a.elements?a.elements:a;return new c([1,0,0,0,0,1,0,0,0,0,1,0,b[0],b[1],b[2],1])};var d=function(){return this.elements=new Float32Array(arguments[0]||[0,0,0]),this};d.prototype.setElements=function(a){return this.elements[0]=a[0],this.elements[1]=a[1],this.elements[2]=a[2],this},d.prototype.add=function(a){var b=this.elements,c=a.elements;return b[0]=b[0]+c[0],b[1]=b[1]+c[1],b[2]=b[2]+c[2],this},d.prototype.sub=function(a){var b=this.elements,c=a.elements;return b[0]=b[0]-c[0],b[1]=b[1]-c[1],b[2]=b[2]-c[2],this},d.prototype.mul=function(a){var b=this.elements,c=a.elements,d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2];return b[0]=e*i-f*h,b[1]=f*g-d*i,b[2]=d*h-e*g,this},d.prototype.length=function(){var a=this.elements;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},d.prototype.dot=function(a){var b=this.elements,c=a.elements;return b[0]*c[0]+b[1]*c[1]+b[2]*c[2]},d.prototype.normalize=function(){var a=this.elements,b=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return a[0]=a[0]*b,a[1]=a[1]*b,a[2]=a[2]*b,this},d.set=function(){var a=arguments[2]?[arguments[0],arguments[1],arguments[2]]:arguments[0];return new c(a)},window.v3=d,window.m4x4=c}(),Vector3=window.v3,Matrix4=window.m4x4,Matrix4.prototype.flatten=function(){return this.elements};var AREActorInterface,AREAnimationInterface,AREBezAnimation,ARECircleActor,AREColor3,AREEngine,AREEngineInterface,AREInterface,ARELog,AREPolygonActor,AREPsyxAnimation,ARERawActor,ARERectangleActor,ARERenderer,AREShader,AREUtilParam,AREVector2,AREVersion,AREVertAnimation,BazarShop,CBazar,Koon,KoonFlock,KoonNetworkMember,PhysicsManager,nextHighestPowerOfTwo,precision,precision_declaration,varying_precision,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};KoonNetworkMember=function(){function a(b){this._name=b||"GenericKoonNetworkMember",this._uuid=a.generateUUID(),this._subscribers=[]}return a.prototype._generateReceiver=function(a){return function(){return function(b,c){return a.receiveMessage(b,c)}}(this)},a.prototype.subscribe=function(a,b){return this._subscribers.push({namespace:b||"",receiver:this._generateReceiver(a)})},a.prototype.broadcast=function(a,b){var c,d;if(b=b||"",!this.hasSent(a)){for(a=this.tagAsSent(a),c=this._subscribers.length,d=[];c--;)d.push(this._subscribers[c].receiver(a,b));return d}},a.prototype.getId=function(){return this._uuid},a.prototype.getName=function(){return this._name},a.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b;return b=16*Math.random()|0,"x"===a?b.toString(16):(3&b|8).toString(16)})},a.prototype.tagAsSent=function(a){return a._senders?a._senders.push(this._name):a._senders=[this._name],a},a.prototype.hasSent=function(a){var b,c,d,e;if(a&&a._senders)for(e=a._senders,c=0,d=e.length;d>c;c++)if(b=e[c],b===this._name)return!0;return!1},a}(),Koon=function(a){function b(a){b.__super__.constructor.call(this,a||"GenericKoon")}return __extends(b,a),b.prototype.receiveMessage=function(a,b){return console.log("<"+a._sender+"> --> <"+this.getName()+">  ["+b+"] "+JSON.stringify(a))},b.prototype.broadcast=function(a,c){return"object"==typeof a?(a._sender=this._name,b.__super__.broadcast.call(this,a,c)):void 0},b}(KoonNetworkMember),KoonFlock=function(a){function b(a){b.__super__.constructor.call(this,a||"GenericKoonFlock")}return __extends(b,a),b.prototype.registerKoon=function(a,b){return this.subscribe(a,b),a.subscribe(this)},b.prototype.receiveMessage=function(a,b){return this.broadcast(a,b)},b.prototype._generateReceiver=function(a){return function(b,c){return a.hasSent(b)?void 0:a.receiveMessage(b,c)}},b}(KoonNetworkMember),CBazar=function(a){function b(){b.__super__.constructor.call(this,"Bazar")}return __extends(b,a),b}(KoonFlock),BazarShop=function(a){function b(a,c){b.__super__.constructor.call(this,a),async.map(c,function(a,b){return a.raw?b(null,a.raw):$.ajax({url:a.url,mimeType:"text",success:function(a){return b(null,a)}})},function(a){return function(b,c){return a._initFromSources(c),a._registerWithBazar()}}(this))}return __extends(b,a),b.prototype._initFromSources=function(a){var b;if(!this._worker)return b=new Blob([a.join("\n\n")],{type:"text/javascript"}),this._worker=new Worker((URL||window.webkitURL).createObjectURL(b)),this._connectWorkerListener(),this._worker.postMessage("")},b.prototype._connectWorkerListener=function(){return this._worker.onmessage=function(a){return function(b){var c,d,e,f,g;if(b.data instanceof Array){for(f=b.data,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(a.broadcast(c.message,c.namespace));return g}return a.broadcast(b.data.message,b.data.namespace)}}(this)},b.prototype._registerWithBazar=function(){return window.Bazar.registerKoon(this)},b.prototype.receiveMessage=function(a,b){return this._worker?this._worker.postMessage({message:a,namespace:b}):void 0},b}(Koon),window.Bazar||(window.Bazar=new CBazar),AREUtilParam=function(){function a(){}return a.required=function(a,b,c){var d,e,f,g;if(null===a&&c!==!0&&(a=void 0),void 0===a)throw new Error("Required argument missing!");if(b instanceof Array&&b.length>0){for(d=!1,f=0,g=b.length;g>f;f++)if(e=b[f],a===e){d=!0;break}if(!d)throw new Error("Required argument is not of a valid value!")}return a},a.optional=function(a,b,c,d){var e,f,g,h;if(null===a&&d!==!0&&(a=void 0),void 0===a&&(a=b),c instanceof Array&&c.length>0){for(e=!1,g=0,h=c.length;h>g;g++)if(f=c[g],a===f){e=!0;break}if(!e)throw new Error("Required argument is not of a valid value!")}return a},a}(),void 0===window.param&&(window.param=AREUtilParam),ARERawActor=function(a){function b(a,c){param.required(a),c=param.optional(c,null),this._initializeValues(),this._registerWithRenderer(),this.updateVertices(a,c),this.setColor(new AREColor3(255,255,255)),this.clearTexture(),b.__super__.constructor.call(this,"Actor_"+this._id),window.AREMessages.registerKoon(this,/^actor\..*/)}return __extends(b,a),b.defaultFriction=.3,b.defaultMass=10,b.defaultElasticity=.2,b.prototype._registerWithRenderer=function(){return this._id=ARERenderer.getNextId(),ARERenderer.addActor(this)},b.prototype._initializeValues=function(){if(ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL&&(this._gl=ARERenderer._gl,void 0===this._gl||null===this._gl))throw new Error("GL context is required for actor initialization!");return this._rotV=new Vector3([0,0,1]),this._transV=new Vector3([0,0,1]),this._modelM=new Matrix4,this._color=null,this._strokeColor=null,this._strokeWidth=1,this._colArray=null,this._opacity=1,this.lit=!1,this._visible=!0,this.layer=0,this._physicsLayer=-1,this._id=-1,this._position={x:0,y:0},this._rotation=0,this._size=new AREVector2(0,0),this._friction=null,this._mass=null,this._elasticity=null,this._vertices=[],this._psyxVertices=[],this._texVerts=[],this._origTexVerts=[],this._vertBuffer=null,this._vertBufferFloats=null,this._sh_handles={},this._renderMode=ARERenderer.RENDER_MODE_TRIANGLE_FAN,this._renderStyle=ARERenderer.RENDER_STYLE_FILL,this._texture=null,this._clipRect=[0,0,1,1],this._attachedTexture=null,this.attachedTextureAnchor={clipRect:[0,0,1,1],x:0,y:0,width:0,height:0,angle:0}},b.prototype.destroy=function(){return this.destroyPhysicsBody(),null},b.prototype.getMaterial=function(){return this._material},b.prototype.getLayer=function(){return this.layer},b.prototype.setLayer=function(a){return this.layer=param.required(a),ARERenderer.removeActor(this,!0),ARERenderer.addActor(this)},b.prototype.setTexture=function(a){if(param.required(a),!ARERenderer.hasTexture(a))throw new Error("No such texture loaded: "+a);return this._texture=ARERenderer.getTexture(a),this.setShader(ARERenderer.getMe().getTextureShader()),this._material=ARERenderer.MATERIAL_TEXTURE,this},b.prototype.clearTexture=function(){return this._texture=void 0,this._texRepeatX=1,this._texRepeatY=1,this.setShader(ARERenderer.getMe().getDefaultShader()),this._material=ARERenderer.MATERIAL_FLAT,this},b.prototype.getTexture=function(){return this._texture},b.prototype.getTextureRepeat=function(){return{x:this._texRepeatX,y:this._texRepeatY}},b.prototype.setShader=function(a){if(ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL){if(param.required(a),null===a.getProgram())throw new Error("Shader has to be built before it can be used!");return null===a.getHandles()&&a.generateHandles(),this._sh_handles=a.getHandles()}},b.prototype.hasPhysics=function(){return!!this._shape||!!this._body},b.prototype.createPhysicsBody=function(a,c,d){var e,f,g,h,i,j,k,l,m,n,o;if(this._mass=a,this._friction=c,this._elasticity=d,!this.hasPhysics()){for(this._friction||(this._friction=b.defaultFriction),this._elasticity||(this._elasticity=b.defaultElasticity),this._mass<0&&(this._mass=0),this._friction<0&&(this._friction=0),this._elasticity<0&&(this._elasticity=0),k=[],j=0,h=null,h=this._psyxVertices.length>6?this._psyxVertices:this._vertices,g=n=0,o=h.length-1;o>n;g=n+=2)k.push(h[g]),k.push(h[g+1]),0===this._mass&&(l=k[k.length-2],m=k[k.length-1],e=this._rotation,k[k.length-2]=l*Math.cos(e)-m*Math.sin(e),k[k.length-1]=l*Math.sin(e)+m*Math.cos(e));return f=null,i={id:this._id,type:"Polygon",vertices:k,"static":!1,position:this._position,friction:this._friction,elasticity:this._elasticity,layer:this._physicsLayer},0===this._mass?(i["static"]=!0,i.position=this._position):(f={id:this._id,position:this._position,angle:this._rotation,mass:this._mass,momentV:{x:0,y:0},vertices:k},i.position={x:0,y:0}),this.broadcast({},"physics.enable"),f&&this.broadcast({def:f},"physics.body.create"),i&&this.broadcast({def:i},"physics.shape.create"),this}},b.prototype.destroyPhysicsBody=function(){return this.broadcast({id:this._id},"physics.shape.remove"),this.broadcast({id:this._id},"physics.body.remove")},b.prototype.enablePhysics=function(){return this.hasPhysics()||this.createPhysicsBody(),this},b.prototype.disablePhysics=function(){return this.hasPhysics()&&this.destroyPhysicsBody,this},b.prototype.refreshPhysics=function(){return this.hasPhysics()?(this.destroyPhysicsBody(),this.createPhysicsBody(this._mass,this._friction,this._elasticity)):void 0},b.prototype.getMass=function(){return this._mass},b.prototype.getElasticity=function(){return this._elasticity},b.prototype.getFriction=function(){return this._friction},b.prototype.setMass=function(a){return this._mass=a,this.refreshPhysics(),this},b.prototype.setElasticity=function(a){return this._elasticity=a,this.refreshPhysics(),this},b.prototype.setFriction=function(a){return this._friction=a,this.refreshPhysics(),this},b.prototype.getPhysicsLayer=function(){return this._physicsLayer.toString(2).length-1},b.prototype.setPhysicsLayer=function(a){return this._physicsLayer=1<<param.required(a,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]),this.broadcast({id:this._id,layer:this._physicsLayer},"physics.shape.set.layer")},b.prototype.updateVertices=function(a,b){var c,d;if(d=param.optional(a,this._vertices),c=param.optional(b,this._texVerts),d.length<6)throw new Error("At least 3 vertices make up an actor");if(c!==this._texVerts)if(d!==this._vertices){if(d.length!==c.length)throw new Error("Vert and UV count must match!")}else if(this._vertices.length!==c.length)throw new Error("Vert and UV count must match!");return d!==this._vertices&&this.updateVertBuffer(d),c!==this._texVerts?this.updateUVBuffer(c):void 0},b.prototype.updateVertBuffer=function(a){var b,c,d,e,f,g,h;for(this._vertices=a,this._vertBufferFloats=new Float32Array(this._vertices),ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL&&(this._vertBuffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vertBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,this._vertBufferFloats,this._gl.STATIC_DRAW),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null)),c=0,d=0,e=0,f=0,b=g=1,h=this._vertices.length/2;h>=1?h>=g:g>=h;b=h>=1?++g:--g)this._vertices[2*b]<c&&(c=this._vertices[2*b]),e<this._vertices[2*b]&&(e=this._vertices[2*b]),this._vertices[2*b+1]<d&&(d=this._vertices[2*b+1]),f<this._vertices[2*b+1]&&(f=this._vertices[2*b+1]);return this._size.x=e-c,this._size.y=f-d},b.prototype.updateUVBuffer=function(a){return this._texVerts=a,ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL?(this._origTexVerts=this._texVerts,this._texVBufferFloats=new Float32Array(this._texVerts),this._texBuffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._texBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,this._texVBufferFloats,this._gl.STATIC_DRAW),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null)):void 0},b.prototype.setTextureRepeat=function(a,b){var c,d,e,f;for(a=param.optional(a,1),b=param.optional(b,1),d=[],c=e=0,f=this._origTexVerts.length;f>e;c=e+=2)d.push(this._origTexVerts[c]/this._texRepeatX*a),d.push(this._origTexVerts[c+1]/this._texRepeatY*b);return this._texRepeatX=a,this._texRepeatY=b,this.updateUVBuffer(d),this},b.prototype.setPhysicsVertices=function(a){return this._psyxVertices=param.required(a),this.destroyPhysicsBody(),this.createPhysicsBody(this._mass,this._friction,this._elasticity)
},b.prototype.attachTexture=function(a,b,c,d,e,f){if(param.required(a),param.required(b),param.required(c),this.attachedTextureAnchor.width=b,this.attachedTextureAnchor.height=c,this.attachedTextureAnchor.x=param.optional(d,0),this.attachedTextureAnchor.y=param.optional(e,0),this.attachedTextureAnchor.angle=param.optional(f,0),!ARERenderer.hasTexture(a))throw new Error("No such texture loaded: "+a);return this._attachedTexture&&this.removeAttachment(),this._attachedTexture=new ARERectangleActor(b,c),this._attachedTexture.setTexture(a),this._attachedTexture},b.prototype.removeAttachment=function(){return this._attachedTexture?(ARERenderer.removeActor(this._attachedTexture),this._attachedTexture=null,!0):!1},b.prototype.setAttachmentVisibility=function(a){return param.required(a),null===this._attachedTexture?!1:(this._attachedTexture._visible=a,!0)},b.prototype.hasAttachment=function(){return null!==this._attachedTexture},b.prototype.getAttachment=function(){return this._attachedTexture},b.prototype.updateAttachment=function(){var a,b,c;return this.hasAttachment()&&this.getAttachment()._visible?(b=this.getPosition(),c=this.getRotation(),b.x+=this.attachedTextureAnchor.x,b.y+=this.attachedTextureAnchor.y,c+=this.attachedTextureAnchor.angle,a=this.getAttachment(),a.setPosition(b),a.setRotation(c),a):this},b.prototype.wglBindTexture=function(a){return ARERenderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE&&(a.bindBuffer(a.ARRAY_BUFFER,this._texBuffer),a.vertexAttribPointer(this._sh_handles.aTexCoord,2,a.FLOAT,!1,0,0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this._texture.texture),a.uniform1i(this._sh_handles.uSampler,0)),this},b.prototype.wglDraw=function(a,b){var c,d;if(param.required(a),param.optional(b),this._visible){switch(this._modelM=new Matrix4,this._transV.elements[0]=this._position.x-ARERenderer.camPos.x,this._transV.elements[1]=ARERenderer.force_pos0_0?ARERenderer.getHeight()-this._position.y+ARERenderer.camPos.y:this._position.y-ARERenderer.camPos.y,this._modelM.translate(this._transV),this._modelM.rotate(-this._rotation,this._rotV),c=this._modelM.flatten(),b&&(d=this._sh_handles,this._sh_handles=b.getHandles()),a.bindBuffer(a.ARRAY_BUFFER,this._vertBuffer),a.vertexAttribPointer(this._sh_handles.aPosition,2,a.FLOAT,!1,0,0),a.uniformMatrix4fv(this._sh_handles.uModelView,!1,c),a.uniform4f(this._sh_handles.uColor,this._colArray[0],this._colArray[1],this._colArray[2],1),this._sh_handles.uClipRect&&a.uniform4fv(this._sh_handles.uClipRect,this._clipRect),a.uniform1f(this._sh_handles.uOpacity,this._opacity),this.wglBindTexture(a),this._renderMode){case ARERenderer.RENDER_MODE_LINE_LOOP:a.drawArrays(a.LINE_LOOP,0,this._vertices.length/2);break;case ARERenderer.RENDER_MODE_TRIANGLE_FAN:a.drawArrays(a.TRIANGLE_FAN,0,this._vertices.length/2);break;case ARERenderer.RENDER_MODE_TRIANGLE_STRIP:a.drawArrays(a.TRIANGLE_STRIP,0,this._vertices.length/2);break;default:throw new Error("Invalid render mode! "+this._renderMode)}return b&&(this._sh_handles=d),this}},b.prototype.cvSetupStyle=function(a){var b,c,d,e;return a.lineWidth=null!==this._strokeWidth?this._strokeWidth:1,this._strokeColor?(e=Number(this._strokeColor._r).toFixed(0),d=Number(this._strokeColor._g).toFixed(0),c=Number(this._strokeColor._b).toFixed(0),b=Number(this._opacity).toFixed(4),a.strokeStyle="rgba("+e+","+d+","+c+","+b+")"):a.strokeStyle="#FFF",ARERenderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE||(this._color?(e=Number(this._color._r).toFixed(0),d=Number(this._color._g).toFixed(0),c=Number(this._color._b).toFixed(0),b=Number(this._opacity).toFixed(4),a.fillStyle="rgba("+e+","+d+","+c+","+b+")"):a.fillStyle="#FFF"),this},b.prototype.cvDraw=function(a){var b,c,d,e,f;if(param.required(a),!this._visible)return!1;for(this._transV.elements[0]=this._position.x-ARERenderer.camPos.x,this._transV.elements[1]=this._position.y-ARERenderer.camPos.y,c=this._transV.elements[0],d=this._transV.elements[1],a.translate(c,d),a.beginPath(),a.rotate(this._rotation),a.moveTo(this._vertices[0],this._vertices[1]),b=e=1,f=this._vertices.length/2;f>=1?f>=e:e>=f;b=f>=1?++e:--e)a.lineTo(this._vertices[2*b],this._vertices[2*b+1]);switch(a.closePath(),this.cvSetupStyle(a),ARERenderer.force_pos0_0||a.scale(1,-1),this._renderMode){case ARERenderer.RENDER_MODE_LINE_LOOP:a.stroke();break;case ARERenderer.RENDER_MODE_TRIANGLE_STRIP:case ARERenderer.RENDER_MODE_TRIANGLE_FAN:(this._renderStyle&ARERenderer.RENDER_STYLE_STROKE)>0&&a.stroke(),(this._renderStyle&ARERenderer.RENDER_STYLE_FILL)>0&&(ARERenderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE?(a.clip(),a.drawImage(this._texture.texture,-this._size.x/2,-this._size.y/2,this._size.x,this._size.y)):a.fill());break;default:throw new Error("Invalid render mode! "+this._renderMode)}return this},b.prototype.nullDraw=function(a){return param.required(a),this._visible?this:!1},b.prototype.setRenderMode=function(a){return this._renderMode=param.required(a,ARERenderer.renderModes),this},b.prototype.setRenderStyle=function(a){return this._renderStyle=param.required(a,ARERenderer.renderStyles),this},b.prototype.setOpacity=function(a){return this._opacity=a,param.required(this._opacity),this},b.prototype.setPosition=function(a){return this._position=param.required(a),this.broadcast({id:this._id,position:a},"physics.body.set.position"),this},b.prototype.setRotation=function(a,b){return param.required(a),b=param.optional(b,!1),b||(a=.0174532925*Number(a)),this._rotation=a,this._mass>0?this.broadcast({id:this._id,rotation:this._rotation},"physics.body.set.rotation"):(this.destroyPhysicsBody(),this.createPhysicsBody(this._mass,this._friction,this._elasticity)),this},b.prototype.setStrokeWidth=function(a){return this._strokeWidth=Number(a),this},b.prototype.setColor_ext=function(a,b,c,d){return param.required(b),b instanceof AREColor3?(a.setR(b.getR()),a.setG(b.getG()),a.setB(b.getB())):(param.required(c),param.required(d),a.setR(Number(b)),a.setG(Number(c)),a.setB(Number(d))),this},b.prototype.setColor=function(a,b,c){return param.required(a),this._color||(this._color=new AREColor3),this.setColor_ext(this._color,a,b,c),this._colArray=[this._color.getR(!0),this._color.getG(!0),this._color.getB(!0)],this},b.prototype.setStrokeColor=function(a,b,c){return param.required(a),this._strokeColor||(this._strokeColor=new AREColor3),this.setColor_ext(this._strokeColor,a,b,c),this._strokeColorArray=[this._strokeColor.getR(!0),this._strokeColor.getG(!0),this._strokeColor.getB(!0)],this},b.prototype.setVisible=function(a){return this._visible=a,this},b.prototype.getOpacity=function(){return this._opacity},b.prototype.getPosition=function(){return this._position},b.prototype.getRotation=function(a){return a=param.optional(a,!1),a===!1?57.2957795*this._rotation:this._rotation},b.prototype.getVertices=function(){return this._vertices},b.prototype.getId=function(){return this._id},b.prototype.getColor=function(){return new AREColor3(this._color)},b.prototype.getVisible=function(){return this._visible},b.updateCount=0,b.lastTime=Date.now(),b.prototype.receiveMessage=function(a,c){var d;if(-1!==c.indexOf("actor.")&&a.id&&a.id===this._id)switch(d=c.split("."),d[1]){case"update":return b.updateCount++,Date.now()-b.lastTime>1e3&&(console.log("Got "+b.updateCount+" in the last second"),b.lastTime=Date.now(),b.updateCount=0),this._position=a.position,this._rotation=a.rotation}},b}(Koon),ARERectangleActor=function(a){function b(a,c){var d,e;if(this.width=a,this.height=c,param.required(a),param.required(c),0>=a)throw new Error("Invalid width: "+a);if(0>=c)throw new Error("Invalid height: "+c);e=this.generateVertices(),d=this.generateUVs(),b.__super__.constructor.call(this,e,d)}return __extends(b,a),b.prototype.generateVertices=function(){var a,b;return b=this.width/2,a=this.height/2,[-b,-a,-b,a,b,a,b,-a,-b,-a]},b.prototype.generateUVs=function(){return[0,1,0,0,1,0,1,1,0,1]},b.prototype.getWidth=function(){return this.width},b.prototype.getHeight=function(){return this.height},b.prototype.setWidth=function(a){return this.width=a,this.updateVertBuffer(this.generateVertices())},b.prototype.setHeight=function(a){return this.height=a,this.updateVertBuffer(this.generateVertices())},b}(ARERawActor),AREPolygonActor=function(a){function b(a,c){var d,e,f;if(this.radius=a,this.segments=c,param.required(a),this.radius instanceof Array)this._verts=this.radius,this.radius=null,e=this.generateUVs(this._verts),b.__super__.constructor.call(this,this._verts,e),this.setPhysicsVertices(this._verts);else{if(param.required(c),0>=a)throw new Error("Invalid radius: "+a);if(2>=c)throw new ERror("Invalid segment count: "+c);f=this.generateVertices(),d=this.generateVertices({mode:"physics"}),e=this.generateUVs(f),b.__super__.constructor.call(this,f,e),this.setPhysicsVertices(d)}this.setRenderMode(ARERenderer.RENDER_MODE_TRIANGLE_FAN)}return __extends(b,a),b.prototype.generateVertices=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(a=param.optional(a,{}),i=this.radius,j=0,e=6.2831852/this.segments,d=Math.tan(e),c=Math.cos(e),h=[],b=k=0,m=this.segments;m>=0?m>k:k>m;b=m>=0?++k:--k)h[2*b]=i,h[2*b+1]=j,f=-j,g=i,i+=f*d,j+=g*d,i*=c,j*=c;for(h.push(h[0]),h.push(h[1]),o=[],b=l=0,n=h.length;n>l;b=l+=2)o.push(h[h.length-2-b]),o.push(h[h.length-1-b]);return h=o,"physics"!==a.mode&&(h.push(0),h.push(0)),h},b.prototype.generateUVs=function(a){var b,c,d,e;for(param.required(a),b=[],d=0,e=a.length;e>d;d++)c=a[d],b.push(c/this.radius/2+.5);return b},b.prototype.fullVertRefresh=function(){var a,b,c;return c=this.generateVertices(),a=this.generateVertices({mode:"physics"}),b=this.generateUVs(c),this.updateVertices(c,b),this.setPhysicsVertices(a)},b.prototype.getRadius=function(){return this.radius},b.prototype.getSegments=function(){return this.segments},b.prototype.setRadius=function(a){if(this.radius=a,0>=a)throw new Error("Invalid radius: "+a);return this.fullVertRefresh()},b.prototype.setSegments=function(a){if(this.segments=a,2>=a)throw new ERror("Invalid segment count: "+a);return this.fullVertRefresh()},b}(ARERawActor),ARECircleActor=function(a){function b(a){this.radius=a,b.__super__.constructor.call(this,a,32),delete this.setSegments,delete this.getSegments}return __extends(b,a),b}(AREPolygonActor),AREColor3=function(){function a(b,c,d){b=param.optional(b,0),c=param.optional(c,0),d=param.optional(d,0),b instanceof a?(this._r=b.getR(),this._g=b.getG(),this._b=b.getB()):(this.setR(b),this.setG(c),this.setB(d))}return a.prototype.getR=function(a){return a!==!0?this._r:this._r/255},a.prototype.getG=function(a){return a!==!0?this._g:this._g/255},a.prototype.getB=function(a){return a!==!0?this._b:this._b/255},a.prototype.setR=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._r=a},a.prototype.setG=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._g=a},a.prototype.setB=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._b=a},a.prototype.toString=function(){return"("+this._r+", "+this._g+", "+this._b+")"},a}(),AREShader=function(){function a(a,b,c,d){var e;if(this._vertSrc=a,this._fragSrc=b,this._gl=c,param.required(this._vertSrc),param.required(this._fragSrc),param.required(this._gl),d=param.optional(d,!1),this.errors=[],this._prog=null,this._vertShader=null,this._fragShader=null,this._handles=null,d===!0&&(e=this.build(this._gl),e===!1))throw new Error("Failed to build shader! "+JSON.stringify(this.errors))}return a.prototype.build=function(a){var b;if(this._gl=a,param.required(this._gl),b=this._gl,this.errors=[],void 0===b||null===b)throw new Error("Need a valid gl object to build a shader!");return this._vertShader=b.createShader(b.VERTEX_SHADER),this._fragShader=b.createShader(b.FRAGMENT_SHADER),b.shaderSource(this._vertShader,this._vertSrc),b.shaderSource(this._fragShader,this._fragSrc),b.compileShader(this._vertShader),b.compileShader(this._fragShader),b.getShaderParameter(this._vertShader,b.COMPILE_STATUS)||this.errors.push(b.getShaderInfoLog(this._vertShader)),b.getShaderParameter(this._fragShader,b.COMPILE_STATUS)||this.errors.push(b.getShaderInfoLog(this._fragShader)),this._prog=b.createProgram(),b.attachShader(this._prog,this._vertShader),b.attachShader(this._prog,this._fragShader),b.linkProgram(this._prog),b.getProgramParameter(this._prog,b.LINK_STATUS)||this.errors.push("Failed to link!"),this.errors.length>0?!1:!0},a.prototype.generateHandles=function(){var a,b,c,d,e,f,g,h,i;if(null===this._prog)return AREEngine.getLog().error("Build program before generating handles"),!1;if(null!==this._handles)return AREEngine.getLog().warn("Refusing to re-generate handles!"),!1;for(this._handles={},h=function(a,b,c){var d,e;if(a=a.split(" "),d=a[a.length-1].replace(";",""),1===b){if(e={n:d,h:c._gl.getUniformLocation(c._prog,d)},"object"!=typeof e.h)throw new Error("Failed to get handle for uniform "+d+" ["+e.h+"]");return e}if(2===b)return e={n:d,h:c._gl.getAttribLocation(c._prog,d)};throw new Error("Type not 1 or 2, WTF, internal error")},i=[this._vertSrc,this._fragSrc],d=0,f=i.length;f>d;d++)for(c=i[d],c=c.split(";"),e=0,g=c.length;g>e&&(b=c[e],-1===b.indexOf("main()"));e++)-1!==b.indexOf("attribute")?(a=h(b,2,this),this._handles[a.n]=a.h):-1!==b.indexOf("uniform")&&(a=h(b,1,this),this._handles[a.n]=a.h);return!0},a.prototype.getHandles=function(){return this._handles},a.prototype.getProgram=function(){return this._prog},a}(),AREVector2=function(){function a(a,b){this.x=param.optional(a,0),this.y=param.optional(b,0)}return a.prototype.random=function(b){var c,d,e,f;return b=param.optional(b,{}),c=param.optional(b.bipolar,!1),d=param.optional(b.seed,65535*Math.random()),e=Math.random()*this.x,f=Math.random()*this.y,c&&(Math.random()<.5&&(e=-e),Math.random()<.5&&(f=-f)),new a(e,f)},a.prototype.add=function(b){return new a(this.x+b.x,this.y+b.y)},a.prototype.sub=function(b){return new a(this.x-b.x,this.y-b.y)},a.prototype.mul=function(b){return new a(this.x*b.x,this.y*b.y)},a.prototype.div=function(b){return new a(this.x/b.x,this.y/b.y)},a.prototype.floor=function(){return new a(Math.floor(this.x),Math.floor(this.y))},a.prototype.ceil=function(){return new a(Math.ceil(this.x),Math.ceil(this.y))},a.zero=function(){return new a(0,0)},a}(),AREShader.shaders={},AREShader.shaders.wire={},AREShader.shaders.solid={},AREShader.shaders.texture={},precision="mediump",varying_precision="highp",precision_declaration="precision "+precision+" float;",AREShader.shaders.wire.vertex=""+precision_declaration+"\n\nattribute vec2 aPosition;\n\nuniform mat4 uProjection;\nuniform mat4 uModelView;\n\nvoid main() {\n  gl_Position = uProjection * uModelView * vec4(aPosition, 1, 1);\n}",AREShader.shaders.wire.fragment=""+precision_declaration+"\n\nuniform vec4 uColor;\nuniform float uOpacity;\n\nvoid main() {\n  vec4 frag = uColor;\n  frag.a *= uOpacity;\n  gl_FragColor = frag;\n}",AREShader.shaders.solid.vertex=AREShader.shaders.wire.vertex,AREShader.shaders.solid.fragment=""+precision_declaration+"\n\nuniform vec4 uColor;\nuniform float uOpacity;\n\nvoid main() {\n  vec4 frag = uColor;\n  frag.a *= uOpacity;\n  gl_FragColor = frag;\n}",AREShader.shaders.texture.vertex=""+precision_declaration+"\n\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\n/* attribute vec2 aUVScale; */\n\nuniform mat4 uProjection;\nuniform mat4 uModelView;\n\nvarying "+varying_precision+" vec2 vTexCoord;\n/* varying "+varying_precision+" vec2 vUVScale; */\n\nvoid main() {\n  gl_Position = uProjection * uModelView * vec4(aPosition, 1, 1);\n  vTexCoord = aTexCoord;\n  /* vUVScale = aUVScale; */\n}",AREShader.shaders.texture.fragment=""+precision_declaration+"\n\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform float uOpacity;\n/* uniform "+varying_precision+" vec2 uUVScale; */\nuniform vec4 uClipRect;\n\nvarying "+varying_precision+" vec2 vTexCoord;\n/* varying "+varying_precision+" vec2 vUVScale; */\n\nvoid main() {\n  vec4 baseColor = texture2D(uSampler,\n                             uClipRect.xy +\n                             vTexCoord * uClipRect.zw);\n                             //vTexCoord * uClipRect.zw * uUVScale);\n  baseColor *= uColor;\n\n  if(baseColor.rgb == vec3(1.0, 0.0, 1.0))\n    discard;\n\n  baseColor.a *= uOpacity;\n  gl_FragColor = baseColor;\n}",ARERenderer=function(){function a(b,c,d){var e;if(this._width=c,this._height=d,b=param.optional(b,""),this._defaultShader=null,this._canvas=null,this._ctx=null,this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderSelectionRect=null,this._pickRenderCB=null,this.initError=void 0,0===b.length&&(b=void 0),null!==a.me)throw new Error("Only one instance of ARERenderer can be created!");if(a.me=this,this._width=param.optional(this._width,800),this._height=param.optional(this._height,600),this._width<=1||this._height<=1)throw new Error("Canvas must be at least 2x2 in size");if(e=function(b,c,d,e){var f;return f=a.me._canvas=document.createElement("canvas"),f.width=d,f.height=e,f.id="are_canvas","body"===b?document.getElementsByTagName(b)[0].appendChild(f):document.getElementById(b).appendChild(f)},void 0===b||null===b?(e("body","are_canvas",this._width,this._height),ARELog.info("Creating canvas #are_canvas ["+this._width+"x"+this._height+"]"),this._canvas=document.getElementById("are_canvas")):(this._canvas=document.getElementById(b),null===this._canvas?(e("body",b,this._width,this._height),ARELog.info("Creating canvas #"+b+" ["+this._width+"x"+this._height+"]"),this._canvas=document.getElementById(b)):"canvas"===this._canvas.nodeName.toLowerCase()?(ARELog.warn("Canvas exists, ignoring supplied dimensions"),this._width=this._canvas.width,this._height=this._canvas.height,ARELog.info("Using canvas #"+b+" ["+this._width+"x"+this._height+"]")):(e(b,"are_canvas",this._width,this._height),ARELog.info("Creating canvas #are_canvas ["+this._width+"x"+this._height+"]"))),null===this._canvas)return ARELog.error("Canvas does not exist!");switch(a.rendererMode){case a.RENDERER_MODE_NULL:this.initializeNullContext();break;case a.RENDERER_MODE_CANVAS:this.initializeCanvasContext();break;case a.RENDERER_MODE_WGL:this.initializeWGLContext(this._canvas)||(ARELog.info("Falling back on regular canvas renderer"),this.initializeCanvasContext());break;default:ARELog.error("Invalid Renderer "+a.rendererMode)}ARELog.info("Using the "+a.activeRendererMode+" renderer mode"),this.setClearColor(0,0,0),this.switchMaterial(a.MATERIAL_FLAT)}return a._nextID=0,a._gl=null,a.actors=[],a.actor_hash={},a.textures=[],a.me=null,a.camPos={x:0,y:0},a.RENDERER_MODE_NULL=0,a.RENDERER_MODE_CANVAS=1,a.RENDERER_MODE_WGL=2,a.rendererModes=[0,1,2],a.rendererMode=a.RENDERER_MODE_WGL,a.setRendererMode=function(a){return this.rendererMode=param.optional(a,null,this.rendererModes)},a.activeRendererMode=null,a.RENDER_MODE_LINE_LOOP=0,a.RENDER_MODE_TRIANGLE_FAN=1,a.RENDER_MODE_TRIANGLE_STRIP=2,a.renderModes=[0,1,2],a.RENDER_STYLE_STROKE=1,a.RENDER_STYLE_FILL=2,a.RENDER_STYLE_FILL_AND_STROKE=3,a.renderStyles=[0,1,2,3],a.MATERIAL_NONE="none",a.MATERIAL_FLAT="flat",a.MATERIAL_TEXTURE="texture",a._currentMaterial="none",a.force_pos0_0=!0,a.alwaysClearScreen=!0,a.prototype.initializeWGLContext=function(b){var c,d,e,f,g,h;return d={preserveDrawingBuffer:a.alwaysClearScreen,antialias:!0,alpha:!0,premultipliedAlpha:!0,depth:!0,stencil:!1},c=b.getContext("webgl",d),null===c&&(ARELog.warn("Continuing with experimental webgl support"),c=b.getContext("experimental-webgl")),null!==c?(a._gl=c,ARELog.info("Created WebGL context"),c.enable(c.DEPTH_TEST),c.enable(c.BLEND),c.depthFunc(c.LEQUAL),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),ARELog.info("Renderer initialized"),e=AREShader.shaders,h=e.wire,f=e.solid,g=e.texture,this._defaultShader=new AREShader(f.vertex,f.fragment,c,!0),this._defaultShader.generateHandles(),this._wireShader=new AREShader(h.vertex,h.fragment,c,!0),this._wireShader.generateHandles(),this._texShader=new AREShader(g.vertex,g.fragment,c,!0),this._texShader.generateHandles(),ARELog.info("Initialized shaders"),ARELog.info("ARE WGL initialized"),a.activeRendererMode=a.RENDERER_MODE_WGL,!0):void 0},a.prototype.initializeCanvasContext=function(){return this._ctx=this._canvas.getContext("2d"),ARELog.info("ARE CTX initialized"),a.activeRendererMode=a.RENDERER_MODE_CANVAS,!0},a.prototype.initializeNullContext=function(){return this._ctx=this._canvas.getContext("2d"),ARELog.info("ARE Null initialized"),a.activeRendererMode=a.RENDERER_MODE_NULL,!0},a.getMe=function(){return a.me},a.prototype.getDefaultShader=function(){return this._defaultShader},a.prototype.getWireShader=function(){return this._wireShader},a.prototype.getTextureShader=function(){return this._texShader},a.prototype.getCanvas=function(){return this._canvas},a.prototype.getContext=function(){return this._ctx},a.getGL=function(){return a._gl},a.prototype.getWidth=function(){return this._width},a.getWidth=function(){return this.me&&this.me.getWidth()||-1},a.prototype.getHeight=function(){return this._height},a.getHeight=function(){return this.me&&this.me.getHeight()||-1},a.prototype.getClearColor=function(){return this._clearColor},a.prototype.setClearColor=function(b,c,d){return void 0===this._clearColor&&(this._clearColor=new AREColor3),b instanceof AREColor3?this._clearColor=b:(this._clearColor.setR(b||0),this._clearColor.setG(c||0),this._clearColor.setB(d||0)),a.activeRendererMode===a.RENDERER_MODE_WGL?(b=this._clearColor.getR(!0),c=this._clearColor.getG(!0),d=this._clearColor.getB(!0),null!==a._gl&&void 0!==a._gl?a._gl.clearColor(b,c,d,1):ARELog.error("Can't set clear color, ARERenderer._gl not valid!")):void 0},a.prototype.requestPickingRenderWGL=function(a,b){return param.required(a),param.required(b),this._pickRenderRequested?void ARELog.warn("Pick render already requested! No request queue"):(this._pickRenderBuff=a,this._pickRenderSelectionRect=null,this._pickRenderCB=b,this._pickRenderRequested=!0)},a.prototype.requestPickingRenderCanvas=function(a,b){return param.required(a),param.required(b),this._pickRenderRequested?void ARELog.warn("Pick render already requested! No request queue"):(this._pickRenderBuff=null,this._pickRenderSelectionRect=a,this._pickRenderCB=b,this._pickRenderRequested=!0)},a.prototype.wglRender=function(){var b,c,d,e,f,g,h,i,j;if(c=a._gl,void 0!==c&&null!==c){for(this._pickRenderRequested&&c.bindFramebuffer(c.FRAMEBUFFER,this._pickRenderBuff),a.alwaysClearScreen&&c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),h=a.actors,d=0,g=h.length;g>d;d++)b=h[d],this._pickRenderRequested?(i=b.getColor(),j=b.getOpacity(),e=b.getId()-255*Math.floor(b.getId()/255),f=Math.floor(b.getId()/255),this.switchMaterial(a.MATERIAL_FLAT),b.setColor(e,f,248),b.setOpacity(1),b.wglDraw(c,this._defaultShader),b.setColor(i),b.setOpacity(j)):(b=b.updateAttachment(),b.getMaterial()!==a._currentMaterial&&this.switchMaterial(b.getMaterial()),b.wglDraw(c));return this._pickRenderRequested?(this._pickRenderCB(),this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderCB=null,c.bindFramebuffer(c.FRAMEBUFFER,null),this.render()):void 0}},a.prototype.cvRender=function(){var b,c,d,e,f,g,h,i,j,k,l;if(c=this._ctx,void 0!==c&&null!==c){for(this._clearColor?(c.fillStyle="rgb"+this._clearColor,c.fillRect(0,0,this._width,this._height)):c.clearRect(0,0,this._width,this._height),c.save(),a.force_pos0_0||(c.translate(0,this._height),c.scale(1,-1)),j=a.actors,f=0,i=j.length;i>f;f++)b=j[f],c.save(),this._pickRenderRequested?(k=b.getColor(),l=b.getOpacity(),g=b.getId()-255*Math.floor(b.getId()/255),h=Math.floor(b.getId()/255),this.switchMaterial(a.MATERIAL_FLAT),b.setColor(g,h,248),b.setOpacity(1),b.cvDraw(c),b.setColor(k),b.setOpacity(l)):(b=b.updateAttachment(),(d=b.getMaterial())!==a._currentMaterial&&this.switchMaterial(d),b.cvDraw(c)),c.restore();return c.restore(),this._pickRenderRequested?(e=this._pickRenderSelectionRect,this._pickRenderCB(c.getImageData(e.x,e.y,e.width,e.height)),this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderSelectionRect=null,this._pickRenderCB=null,this.render()):void 0}},a.prototype.nullRender=function(){var b,c,d,e,f,g;if(c=this._ctx,void 0!==c&&null!==c){for(this._clearColor?(c.fillStyle="rgb"+this._clearColor,c.fillRect(0,0,this._canvas.width,this._canvas.height)):c.clearRect(0,0,this._canvas.width,this._canvas.height),f=a.actors,g=[],d=0,e=f.length;e>d;d++)b=f[d],b=b.updateAttachment(),g.push(b.nullDraw(c));return g}},a.prototype.render=function(){switch(a.activeRendererMode){case a.RENDERER_MODE_NULL:return this.nullRender();case a.RENDERER_MODE_CANVAS:return this.cvRender();case a.RENDERER_MODE_WGL:return this.wglRender()}},a.prototype.getActiveRendererMode=function(){return a.activeRendererMode},a.prototype.isNullRendererActive=function(){return this.getActiveRendererMode()===a.RENDERER_MODE_NULL},a.prototype.isCanvasRendererActive=function(){return this.getActiveRendererMode()===a.RENDERER_MODE_CANVAS},a.prototype.isWGLRendererActive=function(){return this.getActiveRendererMode()===a.RENDERER_MODE_WGL},a.getNextId=function(){return a._nextID++},a.addActor=function(b,c){var d;return param.required(b),c=param.optional(c,b.layer),b.layer!==c&&(b.layer=c),d=_.sortedIndex(a.actors,b,"layer"),a.actors.splice(d,0,b),a.actor_hash[b.getId()]=b,b},a.removeActor=function(b,c){var d,e,f,g,h,i;for(param.required(b),c=param.optional(c,!1),e=b,e instanceof ARERawActor&&(e=e.getId()),i=a.actors,f=g=0,h=i.length;h>g;f=++g)if(d=i[f],d.getId()===e)return a.actors.splice(f,1),c||b.destroy(),!0;return!1},a.prototype.switchMaterial=function(b){var c,d,e;if(param.required(b),b===a._currentMaterial)return!1;if(this.isWGLRendererActive())switch(e=Matrix4.makeOrtho(0,this._width,0,this._height,-10,10).flatten(),e[15]=1,c=a._gl,b){case a.MATERIAL_FLAT:c.useProgram(this._defaultShader.getProgram()),d=this._defaultShader.getHandles(),c.uniformMatrix4fv(d.uProjection,!1,e),c.enableVertexAttribArray(d.aPosition);break;case a.MATERIAL_TEXTURE:c.useProgram(this._texShader.getProgram()),d=this._texShader.getHandles(),c.uniformMatrix4fv(d.uProjection,!1,e),c.enableVertexAttribArray(d.aPosition),c.enableVertexAttribArray(d.aTexCoord);break;default:throw new Error("Unknown material "+b)}return a._currentMaterial=b,ARELog.info("ARERenderer Switched material "+a._currentMaterial)},a.hasTexture=function(b){var c,d,e,f;for(f=a.textures,d=0,e=f.length;e>d;d++)if(c=f[d],c.name===b)return!0;return!1},a.getTexture=function(b){var c,d,e,f;for(param.required(b),f=a.textures,d=0,e=f.length;e>d;d++)if(c=f[d],c.name===b)return c;return null},a.getTextureSize=function(a){var b;return param.required(a),(b=this.getTexture(a))?{w:b.width*b.scaleX,h:b.height*b.scaleY}:null},a.addTexture=function(b){return param.required(b.name),param.required(b.texture),a.textures.push(b)},a}(),PhysicsManager=function(a){function b(){b.__super__.constructor.call(this,"PhysicsManager",[{raw:"cp = exports = {};"},{url:"/components/chipmunk/cp.js"},{url:"/lib/koon/koon.js"},{url:"/lib/physics/worker.js"}])}return __extends(b,a),b.prototype._connectWorkerListener=function(){var a,b,c,d,e,f;return a=0,b=1,c=2,e={},f={},d={},this._worker.onmessage=function(g){return function(h){var i,j;if(e=h.data,e.length){for(i=e.length-1,j=[];i--;)f=e[i],d=ARERenderer.actor_hash[f[a]],d._position=f[b],j.push(d._rotation=f[c]);return j}return g.broadcast(h.data.message,h.data.namespace)}}(this)},b}(BazarShop),ARELog=function(){function a(){}return a.tags=["","[Error]> ","[Warning]> ","[Debug]> ","[Info]> "],a.level=4,a.w=function(b,c){var d;return d=a,b>d.level||0===b||0===d.level?void 0:1===b&&void 0!==console.error?console.error?console.error(""+d.tags[b]+c):console.log(""+d.tags[b]+c):2===b&&void 0!==console.warn?console.warn?console.warn(""+d.tags[b]+c):console.log(""+d.tags[b]+c):3===b&&void 0!==console.debug?console.debug?console.debug(""+d.tags[b]+c):console.log(""+d.tags[b]+c):4===b&&void 0!==console.info?console.info?console.info(""+d.tags[b]+c):console.log(""+d.tags[b]+c):console.log(b>4&&void 0!==d.tags[b]?""+d.tags[b]+c:c)},a.error=function(a){return this.w(1,a)},a.warn=function(a){return this.w(2,a)},a.debug=function(a){return this.w(3,a)},a.info=function(a){return this.w(4,a)},a}(),AREBezAnimation=function(){function a(a,b,c){this.actor=a,c=param.optional(c,!1),this.options=param.required(b),this._duration=param.required(b.duration),param.required(b.endVal),this._property=param.required(b.property),b.controlPoints=param.optional(b.controlPoints,[]),this._fps=param.optional(b.fps,30),c?(param.optional(this.actor),param.required(b.startVal)):param.required(this.actor),this._animated=!1,this.bezOpt={},b.controlPoints.length>0?(this.bezOpt.degree=b.controlPoints.length,this.bezOpt.degree>0&&(param.required(b.controlPoints[0].x),param.required(b.controlPoints[0].y),2===this.bezOpt.degree&&(param.required(b.controlPoints[1].x),param.required(b.controlPoints[1].y))),this.bezOpt.ctrl=b.controlPoints):this.bezOpt.degree=0,this.bezOpt.endPos=param.required(b.endVal),this.tIncr=1/(this._duration*(this._fps/1e3)),c?this.bezOpt.startPos=b.startVal:("rotation"===this._property&&(this.bezOpt.startPos=this.actor.getRotation()),"position"===this._property[0]&&("x"===this._property[1]?this.bezOpt.startPos=this.actor.getPosition().x:"y"===this._property[1]&&(this.bezOpt.startPos=this.actor.getPosition().y)),"color"===this._property[0]&&("r"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getR():"g"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getG():"b"===this._property[1]&&(this.bezOpt.startPos=this.actor.getColor().getB())))}return a.prototype._update=function(a,b){var c,d,e,f,g,h;if(param.required(a),b=param.optional(b,!0),a>1||0>a)throw new Error("t out of bounds! "+a);if(0===this.bezOpt.degree)c=this.bezOpt.startPos+(this.bezOpt.endPos-this.bezOpt.startPos)*a;else if(1===this.bezOpt.degree)d=1-a,e=d*d,g=a*a,c=e*this.bezOpt.startPos+2*d*a*this.bezOpt.ctrl[0].y+g*this.bezOpt.endPos;else{if(2!==this.bezOpt.degree)throw new Error("Invalid degree, can't evaluate ("+this.bezOpt.degree+")");d=1-a,e=d*d,f=e*d,g=a*a,h=g*a,c=f*this.bezOpt.startPos+3*e*a*this.bezOpt.ctrl[0].y+3*d*g*this.bezOpt.ctrl[1].y+h*this.bezOpt.endPos}return b&&(this._applyValue(c),void 0!==this.options.cbStep&&this.options.cbStep(c)),c},a.prototype.preCalculate=function(){var a,b;for(b=0,a={stepTime:this._duration*this.tIncr},a.values=[];1>=b;){if(b+=this.tIncr,b>1&&b<1+this.tIncr)b=1;else if(b>1)break;a.values.push(this._update(b,!1))}return a},a.prototype._applyValue=function(a){var b,c,d,e;if("rotation"===this._property&&this.actor.setRotation(a),"position"===this._property[0]&&("x"===this._property[1]?(b=new cp.v(a,this.actor.getPosition().y),this.actor.setPosition(b)):"y"===this._property[1]&&(b=new cp.v(this.actor.getPosition().x,a),this.actor.setPosition(b))),"color"===this._property[0]){if("r"===this._property[1])return e=a,d=this.actor.getColor().getG(),c=this.actor.getColor().getB(),this.actor.setColor(e,d,c);if("g"===this._property[1])return e=this.actor.getColor().getR(),d=a,c=this.actor.getColor().getB(),this.actor.setColor(e,d,c);if("b"===this._property[1])return e=this.actor.getColor().getR(),d=this.actor.getColor().getG(),c=a,this.actor.setColor(e,d,c)}},a.prototype.animate=function(){var a;if(!this._animated)return this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),a=-this.tIncr,this._intervalID=setInterval(function(b){return function(){if(a+=b.tIncr,a>1){if(clearInterval(b._intervalID),void 0!==b.options.cbEnd)return b.options.cbEnd()}else if(b._update(a),void 0!==b.options.cbStep)return b.options.cbStep()}}(this),1e3/this._fps)},a}(),AREVertAnimation=function(){function a(a,b){return this.actor=a,this.options=b,param.required(this.actor),param.required(this.options),param.required(this.options.delays),param.required(this.options.deltas),this.options.delays.length!==this.options.deltas.length?(ARELog.warn("Vert animation delay count != delta set count! Bailing."),void(this._animated=!0)):void(this._animated=!1)}return a.prototype._setTimeout=function(a,b,c,d){return param.required(a),param.required(b),c=param.optional(c,null),setTimeout(function(b){return function(){return b._applyDeltas(a,c),d&&void 0!==b.options.cbEnd?b.options.cbEnd():void 0
}}(this),b)},a.prototype._applyDeltas=function(a,b){var c,d,e,f,g,h,i;for(param.required(a),void 0!==this.options.cbStep&&this.options.cbStep(b),d=this.actor.getVertices(),f=-1!==a.join("_").indexOf("...")?!0:!1,e=h=0,i=a.length;i>=0?i>h:h>i;e=i>=0?++h:--h){if(c=a[e],e>=d.length){if(f)break;g=void 0}else g=d[e];if("number"==typeof c)g=c;else{if("string"!=typeof c)return void ARELog.warn("Unknown delta type, can't apply deltas! "+c+" "+typeof c);if(void 0===g)return void ARELog.warn("Vertex does not exist, yet delta is relative!");if("|"===c.charAt(0))break;if("-"===c.charAt(0))g-=Number(c.slice(1));else if("+"===c.charAt(0))g+=Number(c.slice(1));else if("..."===c)e=0;else if("."!==c.charAt(0))return void ARELog.warn("Unknown delta action, "+c+", can't apply deltas.")}if(e>d.length)return void ARELog.warn("Vertex gap, can't push new vert! "+g+":"+c+":"+e);e===d.length?d.push(g):d[e]=g}return this.actor.updateVertices(d)},a.prototype.animate=function(){var a,b,c,d,e,f;if(!this._animated){for(this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),f=[],a=d=0,e=this.options.deltas.length;e>=0?e>d:d>e;a=e>=0?++d:--d)c=null,void 0!==this.options.udata&&(this.options.udata instanceof Array?a<this.options.udata.length&&(c=this.options.udata[a]):c=this.options.udata),b=a===this.options.deltas.length-1?!0:!1,f.push(this._setTimeout(this.options.deltas[a],this.options.delays[a],c,b));return f}},a}(),AREPsyxAnimation=function(){function a(a,b){this.actor=a,this.options=b,param.required(this.actor),param.required(this.options.mass),param.required(this.options.friction),param.required(this.options.elasticity),param.required(this.options.timeout),this._animated=!1}return a.prototype.animate=function(){return this._animated?void 0:(this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),setTimeout(function(a){return function(){return a.actor.createPhysicsBody(a.options.mass,a.options.friction,a.options.elasticity),void 0!==a.options.cbEnd?a.options.cbEnd():void 0}}(this),this.options.timeout))},a}(),AREActorInterface=function(){function a(){}return a.prototype._findActor=function(a){var b,c,d,e;for(param.required(a),e=ARERenderer.actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a)return b;return null},a.prototype.createRawActor=function(a){return param.required(a),new ARERawActor(JSON.parse(a)).getId()},a.prototype.createPolygonActor=function(a,b){return param.required(a),"string"==typeof a?this.createRawActor(a):(param.required(b),new AREPolygonActor(a,b).getId())},a.prototype.createRectangleActor=function(a,b){return param.required(a),param.required(b),new ARERectangleActor(a,b).getId()},a.prototype.createCircleActor=function(a){return param.required(a),new ARECircleActor(a).getId()},a.prototype.getActorLayer=function(a){var b;return(b=this._findActor(a))?b.getLayer():null},a.prototype.getActorPhysicsLayer=function(a){var b;return(b=this._findActor(a))?b.getPhysicsLayer():null},a.prototype.getRectangleActorWidth=function(a){var b,c,d,e;for(e=ARERenderer.actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a&&b instanceof ARERectangleActor)return b.getWidth();return null},a.prototype.getRectangleActorHeight=function(a){var b,c,d,e;for(e=ARERenderer.actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a&&b instanceof ARERectangleActor)return b.getHeight();return null},a.prototype.getCircleActorRadius=function(a){var b,c,d,e;for(e=ARERenderer.actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a&&b instanceof AREPolygonActor)return b.getRadius();return null},a.prototype.getActorOpacity=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?b.getOpacity():null},a.prototype.getActorVisible=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?b.getVisible():null},a.prototype.getActorPosition=function(a){var b,c;return param.required(a),null!==(b=this._findActor(a))?(c=b.getPosition(),JSON.stringify({x:c.x,y:c.y})):null},a.prototype.getActorRotation=function(a,b){var c;return param.required(a),b=param.optional(b,!1),null!==(c=this._findActor(a))?c.getRotation(b):1e-6},a.prototype.getActorColor=function(a){var b,c;return param.required(a),null!==(b=this._findActor(a))?(c=b.getColor(),JSON.stringify({r:c.getR(),g:c.getG(),b:c.getB()})):null},a.prototype.getActorTexture=function(a){var b,c;return null!==(b=this._findActor(a))?(c=b.getTexture(),c.name):null},a.prototype.getActorTextureRepeat=function(a){var b,c;return null!==(b=this._findActor(a))?(c=b.getTextureRepeat(),JSON.stringify(c)):null},a.prototype.setRectangleActorHeight=function(a,b){var c,d,e,f;for(f=ARERenderer.actors,d=0,e=f.length;e>d;d++)if(c=f[d],c.getId()===a&&c instanceof ARERectangleActor)return c.setHeight(b),!0;return!1},a.prototype.setRectangleActorWidth=function(a,b){var c,d,e,f;for(f=ARERenderer.actors,d=0,e=f.length;e>d;d++)if(c=f[d],c.getId()===a&&c instanceof ARERectangleActor)return c.setWidth(b),!0;return!1},a.prototype.setCircleActorRadius=function(a,b){var c,d,e,f;for(f=ARERenderer.actors,d=0,e=f.length;e>d;d++)if(c=f[d],c.getId()===a&&c instanceof AREPolygonActor)return c.setRadius(b),!0;return!1},a.prototype.attachTexture=function(a,b,c,d,e,f,g){var h;return param.required(g),param.required(a),param.required(b),param.required(c),d=param.optional(d,0),e=param.optional(e,0),f=param.optional(f,0),null!==(h=this._findActor(g))?(h.attachTexture(a,b,c,d,e,f),!0):!1},a.prototype.setActorLayer=function(a,b){var c;return param.required(b),param.required(a),null!==(c=this._findActor(b))?(c.setLayer(a),!0):!1},a.prototype.setActorPhysicsLayer=function(a,b){var c;return param.required(b),param.required(a),null!==(c=this._findActor(b))?(c.setPhysicsLayer(a),!0):!1},a.prototype.removeAttachment=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?(b.removeAttachment(),!0):!1},a.prototype.setAttachmentVisiblity=function(a,b){var c;return param.required(a),null!==(c=this._findActor(b))?c.setAttachmentVisibility(a):!1},a.prototype.updateVertices=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.updateVertices(JSON.parse(a)),!0):!1},a.prototype.getVertices=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?JSON.stringify(b.getVertices()):null},a.prototype.destroyActor=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?(b.destroyPhysicsBody(),ARERenderer.removeActor(b),!0):!1},a.prototype.setPhysicsVertices=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.setPhysicsVertices(JSON.parse(a)),!0):!1},a.prototype.setRenderMode=function(a,b){var c;return a=param.required(a,ARERenderer.renderModes),param.required(b),null!==(c=this._findActor(b))?(c.setRenderMode(a),!0):!1},a.prototype.setActorOpacity=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.setOpacity(a),!0):!1},a.prototype.setActorVisible=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.setVisible(a),!0):!1},a.prototype.setActorPosition=function(a,b,c){var d;return param.required(a),param.required(b),param.required(c),null!==(d=this._findActor(c))?(d.setPosition(new cp.v(a,b)),!0):!1},a.prototype.setActorRotation=function(a,b,c){var d;return param.required(a),param.required(b),c=param.optional(c,!1),null!==(d=this._findActor(b))?(d.setRotation(a,c),!0):!1},a.prototype.setActorColor=function(a,b,c,d){var e;return param.required(a),param.required(b),param.required(c),param.required(d),null!==(e=this._findActor(d))?(e.setColor(new AREColor3(a,b,c)),!0):!1},a.prototype.setActorTexture=function(a,b){var c;return param.required(a),param.required(b),null!==(c=this._findActor(b))?(c.setTexture(a),!0):!1},a.prototype.setActorTextureRepeat=function(a,b,c){var d;return param.required(a),param.required(c),b=param.optional(b,1),null!==(d=this._findActor(c))?(d.setTextureRepeat(a,b),!0):!1},a.prototype.enableActorPhysics=function(a,b,c,d){var e;return param.required(d),param.required(a),param.required(b),param.required(c),null!==(e=this._findActor(d))?(e.createPhysicsBody(a,b,c),!0):!1},a.prototype.destroyPhysicsBody=function(a){var b;return param.required(a),null!==(b=this._findActor(a))?(b.destroyPhysicsBody(),!0):!1},a}(),nextHighestPowerOfTwo=function(a){var b;for(--a,b=1;32>b;)a|=a>>b,b<<=1;return a+1},AREEngineInterface=function(){function a(){}return a.prototype.initialize=function(a,b,c,d,e){return param.required(c),param.required(a),param.required(b),d=param.optional(d,4),e=param.optional(e,""),ARERenderer.actors=[],ARERenderer.textures=[],ARERenderer._gl=null,ARERenderer.me=null,ARERenderer._currentMaterial="none",ARERenderer.camPos={x:0,y:0},this.wglFlipTextureY=!1,new AREEngine(a,b,function(a){return function(b){return a._engine=b,b.startRendering(),c(b)}}(this),d,e)},a.prototype.getRendererMode=function(){return ARERenderer.rendererMode},a.prototype.setRendererMode=function(a){return ARERenderer.setRendererMode(a)},a.prototype.setClearColor=function(a,b,c){return param.required(a),param.required(b),param.required(c),void 0!==this._engine?ARERenderer.me.setClearColor(a,b,c):void 0},a.prototype.getClearColor=function(){var a;return void 0===this._engine?null:(a=ARERenderer.me.getClearColor(),JSON.stringify({r:a.getR(),g:a.getG(),b:a.getB()}))},a.prototype.setLogLevel=function(a){return param.required(a,[0,1,2,3,4]),ARELog.level=a},a.prototype.setCameraPosition=function(a,b){return ARERenderer.camPos.x=param.optional(a,ARERenderer.camPos.x),ARERenderer.camPos.y=param.optional(b,ARERenderer.camPos.y)},a.prototype.getCameraPosition=function(){return JSON.stringify(ARERenderer.camPos)},a.prototype.getWidth=function(){return null===this._engine||void 0===this._engine?-1:this._engine.getWidth()},a.prototype.getHeight=function(){return null===this._engine||void 0===this._engine?-1:this._engine.getHeight()},a.prototype.setBenchmark=function(a){return this._engine.benchmark=a,window.AREMessages.broadcast({value:a},"physics.benchmark.set")},a.prototype.loadManifest=function(a,b){var c,d,e,f,g,h,i;if(param.required(a),e=JSON.parse(a),void 0!==e.textures&&(e=e.textures),_.isEmpty(e))return b();for(c=0,d=this.wglFlipTextureY,i=[],g=0,h=e.length;h>g;g++){if(f=e[g],void 0!==f.compression&&"none"!==f.compression)throw console.error(f.compression),new Error("Only un-compressed textures are supported!");if(void 0!==f.type&&"image"!==f.type)throw console.error(f.type),new Error("Only image textures are supported!");i.push(this.loadTexture(f.name,f.path,d,function(){return c++,c===e.length?b():void 0}))}return i},a.prototype.loadTexture=function(a,b,c,d){var e,f,g;return c=param.optional(c,this.wglFlipTextureY),ARELog.info("Loading texture: "+a+", "+b),f=new Image,f.crossOrigin="anonymous",e=ARERenderer._gl,g=null,ARERenderer.activeRendererMode===ARERenderer.RENDERER_MODE_WGL?(ARELog.info("Loading Gl Texture"),g=e.createTexture(),f.onload=function(){var b,h,i,j,k,l;return j=1,k=1,l=0!==(f.width&f.width-1),i=0!==(f.height&f.height-1),(l||i)&&(b=document.createElement("canvas"),b.width=nextHighestPowerOfTwo(f.width),b.height=nextHighestPowerOfTwo(f.height),j=f.width/b.width,k=f.height/b.height,h=b.getContext("2d"),h.drawImage(f,0,0,b.width,b.height),f=b),e.bindTexture(e.TEXTURE_2D,g),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,c),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,f),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,null),ARERenderer.addTexture({name:a,texture:g,width:f.width,height:f.height,scaleX:j,scaleY:k}),d?d():void 0}):(ARELog.info("Loading Canvas Image"),f.onload=function(){return ARERenderer.addTexture({name:a,texture:f,width:f.width,height:f.height}),d?d():void 0}),f.src=b},a.prototype.getTextureSize=function(a){return ARERenderer.getTextureSize(a)},a.prototype.setRemindMeButton=function(){},a}(),AREAnimationInterface=function(){function a(){}return a._animationMap={position:AREBezAnimation,color:AREBezAnimation,rotation:AREBezAnimation,mass:AREPsyxAnimation,friction:AREPsyxAnimation,elasticity:AREPsyxAnimation,physics:AREPsyxAnimation,vertices:AREVertAnimation},a.prototype.canAnimate=function(b){return void 0===a._animationMap[b]?!1:!0},a.prototype.getAnimationName=function(b){var c;return void 0===a._animationMap[b]?!1:(c=a._animationMap[b],c===AREBezAnimation?"bezier":c===AREPsyxAnimation?"psyx":c===AREVertAnimation?"vert":void 0)},a.prototype.animate=function(b,c,d){var e,f,g,h,i,j,k;for(param.required(b),c=JSON.parse(param.required(c)),d=JSON.parse(param.required(d)),d.start=param.optional(d.start,0),f=null,j=ARERenderer.actors,h=0,i=j.length;i>h;h++)if(e=j[h],e.getId()===b){f=e;break}if(null===f)throw new Error("Actor not found, can't animate! "+actorId);return g=c[0],void 0===d.property&&(d.property=c),k=function(b,c,d){return a._animationMap[b]===AREBezAnimation?new AREBezAnimation(c,d).animate():a._animationMap[b]===AREPsyxAnimation?new AREPsyxAnimation(c,d).animate():a._animationMap[b]===AREVertAnimation?new AREVertAnimation(c,d).animate():ARELog.warn("Unrecognized property: "+b)},d.start>0?setTimeout(function(){return k(g,f,d)},d.start):k(g,f,d)},a.prototype.preCalculateBez=function(a){var b;return a=JSON.parse(param.required(a)),param.required(a.startVal),param.required(a.endVal),param.required(a.duration),a.controlPoints=param.required(a.controlPoints,[]),a.fps=param.required(a.fps,30),b=new AREBezAnimation(null,a,!0).preCalculate(),JSON.stringify(b)},a}(),AREInterface=function(){function a(){this._Actors=new AREActorInterface,this._Engine=new AREEngineInterface,this._Animations=new AREAnimationInterface}return a.prototype.Actors=function(){return this._Actors},a.prototype.Engine=function(){return this._Engine},a.prototype.Animations=function(){return this._Animations},a}(),AREEngine=function(){function a(a,b,c,d,e){return param.required(a),param.required(b),param.required(c),ARELog.level=param.optional(d,4),e=param.optional(e,""),this._renderIntervalId=null,this.benchmark=!1,this.setFPS(60),null===window._||void 0===window._?ARELog.error("Underscore.js is not present!"):(window.AREMessages=new KoonFlock("AREMessages"),window.AREMessages.registerKoon(window.Bazar),this._physics=new PhysicsManager,this._renderer=new ARERenderer(e,a,b),this.startRendering(),void c(this))}return a.prototype.setFPS=function(a){return this._framerate=1/a,this},a.prototype.startRendering=function(){var a,b;if(null===this._renderIntervalId)return ARELog.info("Starting render loop"),a=0,b=0,this._renderIntervalId=setInterval(function(c){return function(){var d,e;return e=Date.now(),c._renderer.render(),c.benchmark&&(b++,a+=(Date.now()-e)/b,b%500===0)?(d=(1e3/a).toFixed(2),console.log("Render step time: "+a.toFixed(2)+"ms ("+d+" FPS)")):void 0}}(this),this._framerate)},a.prototype.stopRendering=function(){return null!==this._renderIntervalId?(ARELog.info("Halting render loop"),clearInterval(this._renderIntervalId),this._renderIntervalId=null):void 0},a.prototype.setClearColor=function(a,b,c){return a=param.optional(a,0),b=param.optional(b,0),c=param.optional(c,0),this._renderer instanceof ARERenderer&&this._renderer.setClearColor(a,b,c),this},a.prototype.getClearColor=function(){return this._renderer instanceof ARERenderer?this._renderer.getClearColor():null},a.prototype.getWidth=function(){return null===this._renderer||void 0===this._renderer?-1:this._renderer.getWidth()},a.prototype.getHeight=function(){return null===this._renderer||void 0===this._renderer?-1:this._renderer.getHeight()},a.prototype.requestPickingRenderWGL=function(a,b){return null===this._renderer||void 0===this._renderer?ARELog.warn("Can't request a pick render, renderer not instantiated!"):this._renderer.isWGLRendererActive()?this._renderer.requestPickingRenderWGL(a,b):ARELog.warn("Can't request a WGL pick render, not using WGL renderer")},a.prototype.requestPickingRenderCanvas=function(a,b){return null===this._renderer||void 0===this._renderer?ARELog.warn("Can't request a pick render, renderer not instantiated!"):this._renderer.isCanvasRendererActive()?this._renderer.requestPickingRenderCanvas(a,b):ARELog.warn("Can't request a canvas pick render, not using canvas renderer")},a.prototype.getGL=function(){return null===ARERenderer._gl&&ARELog.warn("Render not instantiated!"),ARERenderer._gl},a.prototype.getActiveRendererMode=function(){return ARERenderer.activeRendererMode},a}(),window.AdefyGLI=window.AdefyRE=new AREInterface,AREVersion={MAJOR:1,MINOR:0,PATCH:13,BUILD:null,STRING:"1.0.13"};