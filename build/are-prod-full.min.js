/* Copyright © 2013 Spectrum IT Solutions Gmbh - All Rights Reserved */
(function(){function a(a,b,c){c=(c||0)-1;for(var d=a?a.length:0;++c<d;)if(a[c]===b)return c;return-1}function b(b,c){var d=typeof c;if(b=b.l,"boolean"==d||null==c)return b[c]?0:-1;"number"!=d&&"string"!=d&&(d="object");var e="number"==d?c:r+c;return b=(b=b[d])&&b[e],"object"==d?b&&-1<a(b,c)?0:-1:b?0:-1}function c(a){var b=this.l,c=typeof a;if("boolean"==c||null==a)b[a]=!0;else{"number"!=c&&"string"!=c&&(c="object");var d="number"==c?a:r+a,b=b[c]||(b[c]={});"object"==c?(b[d]||(b[d]=[])).push(a):b[d]=!0}}function d(a){return a.charCodeAt(0)}function e(a,b){for(var c=a.m,d=b.m,e=-1,f=c.length;++e<f;){var g=c[e],h=d[e];if(g!==h){if(g>h||"undefined"==typeof g)return 1;if(h>g||"undefined"==typeof h)return-1}}return a.n-b.n}function f(a){var b=-1,d=a.length,e=a[0],f=a[d/2|0],g=a[d-1];if(e&&"object"==typeof e&&f&&"object"==typeof f&&g&&"object"==typeof g)return!1;for(e=i(),e["false"]=e["null"]=e["true"]=e.undefined=!1,f=i(),f.k=a,f.l=e,f.push=c;++b<d;)f.push(a[b]);return f}function g(a){return"\\"+U[a]}function h(){return o.pop()||[]}function i(){return p.pop()||{k:null,l:null,m:null,"false":!1,n:0,"null":!1,number:null,object:null,push:null,string:null,"true":!1,undefined:!1,o:null}}function j(a){a.length=0,o.length<t&&o.push(a)}function k(a){var b=a.l;b&&k(b),a.k=a.l=a.m=a.object=a.number=a.string=a.o=null,p.length<t&&p.push(a)}function l(a,b,c){b||(b=0),"undefined"==typeof c&&(c=a?a.length:0);var d=-1;c=c-b||0;for(var e=Array(0>c?0:c);++d<c;)e[d]=a[b+d];return e}function m(c){function o(a,b,c){if(!a||!T[typeof a])return a;b=b&&"undefined"==typeof c?b:bb(b,c,3);for(var d=-1,e=T[typeof a]&&Kc(a),f=e?e.length:0;++d<f&&(c=e[d],!1!==b(a[c],c,a)););return a}function p(a,b,c){var d;if(!a||!T[typeof a])return a;b=b&&"undefined"==typeof c?b:bb(b,c,3);for(d in a)if(!1===b(a[d],d,a))break;return a}function t(a,b,c){var d,e=a,f=e;if(!e)return f;for(var g=arguments,h=0,i="number"==typeof c?2:g.length;++h<i;)if((e=g[h])&&T[typeof e])for(var j=-1,k=T[typeof e]&&Kc(e),l=k?k.length:0;++j<l;)d=k[j],"undefined"==typeof f[d]&&(f[d]=e[d]);return f}function U(a,b,c){var d,e=a,f=e;if(!e)return f;var g=arguments,h=0,i="number"==typeof c?2:g.length;if(i>3&&"function"==typeof g[i-2])var j=bb(g[--i-1],g[i--],2);else i>2&&"function"==typeof g[i-1]&&(j=g[--i]);for(;++h<i;)if((e=g[h])&&T[typeof e])for(var k=-1,l=T[typeof e]&&Kc(e),m=l?l.length:0;++k<m;)d=l[k],f[d]=j?j(f[d],e[d]):e[d];return f}function W(a){var b,c=[];if(!a||!T[typeof a])return c;for(b in a)rc.call(a,b)&&c.push(b);return c}function X(a){return a&&"object"==typeof a&&!Jc(a)&&rc.call(a,"__wrapped__")?a:new Y(a)}function Y(a,b){this.__chain__=!!b,this.__wrapped__=a}function Z(a){function b(){if(d){var a=l(d);sc.apply(a,arguments)}if(this instanceof b){var f=ab(c.prototype),a=c.apply(f,a||arguments);return vb(a)?a:f}return c.apply(e,a||arguments)}var c=a[0],d=a[2],e=a[4];return Ic(b,a),b}function _(a,b,c,d,e){if(c){var f=c(a);if("undefined"!=typeof f)return f}if(!vb(a))return a;var g=kc.call(a);if(!Q[g])return a;var i=Gc[g];switch(g){case J:case K:return new i(+a);case M:case P:return new i(a);case O:return f=i(a.source,z.exec(a)),f.lastIndex=a.lastIndex,f}if(g=Jc(a),b){var k=!d;d||(d=h()),e||(e=h());for(var m=d.length;m--;)if(d[m]==a)return e[m];f=g?i(a.length):{}}else f=g?l(a):U({},a);return g&&(rc.call(a,"index")&&(f.index=a.index),rc.call(a,"input")&&(f.input=a.input)),b?(d.push(a),e.push(f),(g?Db:o)(a,function(a,g){f[g]=_(a,b,c,d,e)}),k&&(j(d),j(e)),f):f}function ab(a){return vb(a)?xc(a):{}}function bb(a,b,c){if("function"!=typeof a)return Ub;if("undefined"==typeof b||!("prototype"in a))return a;var d=a.__bindData__;if("undefined"==typeof d&&(Hc.funcNames&&(d=!a.name),d=d||!Hc.funcDecomp,!d)){var e=pc.call(a);Hc.funcNames||(d=!A.test(e)),d||(d=E.test(e),Ic(a,d))}if(!1===d||!0!==d&&1&d[1])return a;switch(c){case 1:return function(c){return a.call(b,c)};case 2:return function(c,d){return a.call(b,c,d)};case 3:return function(c,d,e){return a.call(b,c,d,e)};case 4:return function(c,d,e,f){return a.call(b,c,d,e,f)}}return Sb(a,b)}function cb(a){function b(){var a=i?g:this;if(e){var o=l(e);sc.apply(o,arguments)}return(f||k)&&(o||(o=l(arguments)),f&&sc.apply(o,f),k&&o.length<h)?(d|=16,cb([c,m?d:-4&d,o,null,g,h])):(o||(o=arguments),j&&(c=a[n]),this instanceof b?(a=ab(c.prototype),o=c.apply(a,o),vb(o)?o:a):c.apply(a,o))}var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=1&d,j=2&d,k=4&d,m=8&d,n=c;return Ic(b,a),b}function db(c,d){var e=-1,g=mb(),h=c?c.length:0,i=h>=s&&g===a,j=[];if(i){var l=f(d);l?(g=b,d=l):i=!1}for(;++e<h;)l=c[e],0>g(d,l)&&j.push(l);return i&&k(d),j}function eb(a,b,c,d){d=(d||0)-1;for(var e=a?a.length:0,f=[];++d<e;){var g=a[d];if(g&&"object"==typeof g&&"number"==typeof g.length&&(Jc(g)||qb(g))){b||(g=eb(g,b,c));var h=-1,i=g.length,j=f.length;for(f.length+=i;++h<i;)f[j++]=g[h]}else c||f.push(g)}return f}function fb(a,b,c,d,e,f){if(c){var g=c(a,b);if("undefined"!=typeof g)return!!g}if(a===b)return 0!==a||1/a==1/b;if(a===a&&!(a&&T[typeof a]||b&&T[typeof b]))return!1;if(null==a||null==b)return a===b;var i=kc.call(a),k=kc.call(b);if(i==H&&(i=N),k==H&&(k=N),i!=k)return!1;switch(i){case J:case K:return+a==+b;case M:return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case O:case P:return a==fc(b)}if(k=i==I,!k){var l=rc.call(a,"__wrapped__"),m=rc.call(b,"__wrapped__");if(l||m)return fb(l?a.__wrapped__:a,m?b.__wrapped__:b,c,d,e,f);if(i!=N)return!1;if(i=a.constructor,l=b.constructor,i!=l&&!(ub(i)&&i instanceof i&&ub(l)&&l instanceof l)&&"constructor"in a&&"constructor"in b)return!1}for(i=!e,e||(e=h()),f||(f=h()),l=e.length;l--;)if(e[l]==a)return f[l]==b;var n=0,g=!0;if(e.push(a),f.push(b),k){if(l=a.length,n=b.length,(g=n==l)||d)for(;n--;)if(k=l,m=b[n],d)for(;k--&&!(g=fb(a[k],m,c,d,e,f)););else if(!(g=fb(a[n],m,c,d,e,f)))break}else p(b,function(b,h,i){return rc.call(i,h)?(n++,g=rc.call(a,h)&&fb(a[h],b,c,d,e,f)):void 0}),g&&!d&&p(a,function(a,b,c){return rc.call(c,b)?g=-1<--n:void 0});return e.pop(),f.pop(),i&&(j(e),j(f)),g}function gb(a,b,c,d,e){(Jc(b)?Db:o)(b,function(b,f){var g,h,i=b,j=a[f];if(b&&((h=Jc(b))||Pc(b))){for(i=d.length;i--;)if(g=d[i]==b){j=e[i];break}if(!g){var k;c&&(i=c(j,b),k="undefined"!=typeof i)&&(j=i),k||(j=h?Jc(j)?j:[]:Pc(j)?j:{}),d.push(b),e.push(j),k||gb(j,b,c,d,e)}}else c&&(i=c(j,b),"undefined"==typeof i&&(i=b)),"undefined"!=typeof i&&(j=i);a[f]=j})}function hb(a,b){return a+oc(Fc()*(b-a+1))}function ib(c,d,e){var g=-1,i=mb(),l=c?c.length:0,m=[],n=!d&&l>=s&&i===a,o=e||n?h():m;for(n&&(o=f(o),i=b);++g<l;){var p=c[g],q=e?e(p,g,c):p;(d?!g||o[o.length-1]!==q:0>i(o,q))&&((e||n)&&o.push(q),m.push(p))}return n?(j(o.k),k(o)):e&&j(o),m}function jb(a){return function(b,c,d){var e={};c=X.createCallback(c,d,3),d=-1;var f=b?b.length:0;if("number"==typeof f)for(;++d<f;){var g=b[d];a(e,g,c(g,d,b),b)}else o(b,function(b,d,f){a(e,b,c(b,d,f),f)});return e}}function kb(a,b,c,d,e,f){var g=1&b,h=4&b,i=16&b,j=32&b;if(!(2&b||ub(a)))throw new gc;i&&!c.length&&(b&=-17,i=c=!1),j&&!d.length&&(b&=-33,j=d=!1);var k=a&&a.__bindData__;return k&&!0!==k?(k=l(k),k[2]&&(k[2]=l(k[2])),k[3]&&(k[3]=l(k[3])),!g||1&k[1]||(k[4]=e),!g&&1&k[1]&&(b|=8),!h||4&k[1]||(k[5]=f),i&&sc.apply(k[2]||(k[2]=[]),c),j&&vc.apply(k[3]||(k[3]=[]),d),k[1]|=b,kb.apply(null,k)):(1==b||17===b?Z:cb)([a,b,c,d,e,f])}function lb(a){return Lc[a]}function mb(){var b=(b=X.indexOf)===Mb?a:b;return b}function nb(a){return"function"==typeof a&&lc.test(a)}function ob(a){var b,c;return a&&kc.call(a)==N&&(b=a.constructor,!ub(b)||b instanceof b)?(p(a,function(a,b){c=b}),"undefined"==typeof c||rc.call(a,c)):!1}function pb(a){return Mc[a]}function qb(a){return a&&"object"==typeof a&&"number"==typeof a.length&&kc.call(a)==H||!1}function rb(a,b,c){var d=Kc(a),e=d.length;for(b=bb(b,c,3);e--&&(c=d[e],!1!==b(a[c],c,a)););return a}function sb(a){var b=[];return p(a,function(a,c){ub(a)&&b.push(c)}),b.sort()}function tb(a){for(var b=-1,c=Kc(a),d=c.length,e={};++b<d;){var f=c[b];e[a[f]]=f}return e}function ub(a){return"function"==typeof a}function vb(a){return!(!a||!T[typeof a])}function wb(a){return"number"==typeof a||a&&"object"==typeof a&&kc.call(a)==M||!1}function xb(a){return"string"==typeof a||a&&"object"==typeof a&&kc.call(a)==P||!1}function yb(a){for(var b=-1,c=Kc(a),d=c.length,e=Zb(d);++b<d;)e[b]=a[c[b]];return e}function zb(a,b,c){var d=-1,e=mb(),f=a?a.length:0,g=!1;return c=(0>c?Cc(0,f+c):c)||0,Jc(a)?g=-1<e(a,b,c):"number"==typeof f?g=-1<(xb(a)?a.indexOf(b,c):e(a,b,c)):o(a,function(a){return++d<c?void 0:!(g=a===b)}),g}function Ab(a,b,c){var d=!0;b=X.createCallback(b,c,3),c=-1;var e=a?a.length:0;if("number"==typeof e)for(;++c<e&&(d=!!b(a[c],c,a)););else o(a,function(a,c,e){return d=!!b(a,c,e)});return d}function Bb(a,b,c){var d=[];b=X.createCallback(b,c,3),c=-1;var e=a?a.length:0;if("number"==typeof e)for(;++c<e;){var f=a[c];b(f,c,a)&&d.push(f)}else o(a,function(a,c,e){b(a,c,e)&&d.push(a)});return d}function Cb(a,b,c){b=X.createCallback(b,c,3),c=-1;var d=a?a.length:0;if("number"!=typeof d){var e;return o(a,function(a,c,d){return b(a,c,d)?(e=a,!1):void 0}),e}for(;++c<d;){var f=a[c];if(b(f,c,a))return f}}function Db(a,b,c){var d=-1,e=a?a.length:0;if(b=b&&"undefined"==typeof c?b:bb(b,c,3),"number"==typeof e)for(;++d<e&&!1!==b(a[d],d,a););else o(a,b);return a}function Eb(a,b,c){var d=a?a.length:0;if(b=b&&"undefined"==typeof c?b:bb(b,c,3),"number"==typeof d)for(;d--&&!1!==b(a[d],d,a););else{var e=Kc(a),d=e.length;o(a,function(a,c,f){return c=e?e[--d]:--d,b(f[c],c,f)})}return a}function Fb(a,b,c){var d=-1,e=a?a.length:0;if(b=X.createCallback(b,c,3),"number"==typeof e)for(var f=Zb(e);++d<e;)f[d]=b(a[d],d,a);else f=[],o(a,function(a,c,e){f[++d]=b(a,c,e)});return f}function Gb(a,b,c){var e=-1/0,f=e;if("function"!=typeof b&&c&&c[b]===a&&(b=null),null==b&&Jc(a)){c=-1;for(var g=a.length;++c<g;){var h=a[c];h>f&&(f=h)}}else b=null==b&&xb(a)?d:X.createCallback(b,c,3),Db(a,function(a,c,d){c=b(a,c,d),c>e&&(e=c,f=a)});return f}function Hb(a,b,c,d){if(!a)return c;var e=3>arguments.length;b=X.createCallback(b,d,4);var f=-1,g=a.length;if("number"==typeof g)for(e&&(c=a[++f]);++f<g;)c=b(c,a[f],f,a);else o(a,function(a,d,f){c=e?(e=!1,a):b(c,a,d,f)});return c}function Ib(a,b,c,d){var e=3>arguments.length;return b=X.createCallback(b,d,4),Eb(a,function(a,d,f){c=e?(e=!1,a):b(c,a,d,f)}),c}function Jb(a){var b=-1,c=a?a.length:0,d=Zb("number"==typeof c?c:0);return Db(a,function(a){var c=hb(0,++b);d[b]=d[c],d[c]=a}),d}function Kb(a,b,c){var d;b=X.createCallback(b,c,3),c=-1;var e=a?a.length:0;if("number"==typeof e)for(;++c<e&&!(d=b(a[c],c,a)););else o(a,function(a,c,e){return!(d=b(a,c,e))});return!!d}function Lb(a,b,c){var d=0,e=a?a.length:0;if("number"!=typeof b&&null!=b){var f=-1;for(b=X.createCallback(b,c,3);++f<e&&b(a[f],f,a);)d++}else if(d=b,null==d||c)return a?a[0]:n;return l(a,0,Dc(Cc(0,d),e))}function Mb(b,c,d){if("number"==typeof d){var e=b?b.length:0;d=0>d?Cc(0,e+d):d||0}else if(d)return d=Ob(b,c),b[d]===c?d:-1;return a(b,c,d)}function Nb(a,b,c){if("number"!=typeof b&&null!=b){var d=0,e=-1,f=a?a.length:0;for(b=X.createCallback(b,c,3);++e<f&&b(a[e],e,a);)d++}else d=null==b||c?1:Cc(0,b);return l(a,d)}function Ob(a,b,c,d){var e=0,f=a?a.length:e;for(c=c?X.createCallback(c,d,1):Ub,b=c(b);f>e;)d=e+f>>>1,c(a[d])<b?e=d+1:f=d;return e}function Pb(a,b,c,d){return"boolean"!=typeof b&&null!=b&&(d=c,c="function"!=typeof b&&d&&d[b]===a?null:b,b=!1),null!=c&&(c=X.createCallback(c,d,3)),ib(a,b,c)}function Qb(){for(var a=1<arguments.length?arguments:arguments[0],b=-1,c=a?Gb(Tc(a,"length")):0,d=Zb(0>c?0:c);++b<c;)d[b]=Tc(a,b);return d}function Rb(a,b){var c=-1,d=a?a.length:0,e={};for(b||!d||Jc(a[0])||(b=[]);++c<d;){var f=a[c];b?e[f]=b[c]:f&&(e[f[0]]=f[1])}return e}function Sb(a,b){return 2<arguments.length?kb(a,17,l(arguments,2),null,b):kb(a,1,null,null,b)}function Tb(a,b,c){function d(){k&&nc(k),g=k=l=n,(p||o!==b)&&(m=Uc(),h=a.apply(j,f),k||g||(f=j=null))}function e(){var c=b-(Uc()-i);c>0?k=tc(e,c):(g&&nc(g),c=l,g=k=l=n,c&&(m=Uc(),h=a.apply(j,f),k||g||(f=j=null)))}var f,g,h,i,j,k,l,m=0,o=!1,p=!0;if(!ub(a))throw new gc;if(b=Cc(0,b)||0,!0===c)var q=!0,p=!1;else vb(c)&&(q=c.leading,o="maxWait"in c&&(Cc(b,c.maxWait)||0),p="trailing"in c?c.trailing:p);return function(){if(f=arguments,i=Uc(),j=this,l=p&&(k||!q),!1===o)var c=q&&!k;else{g||q||(m=i);var n=o-(i-m),r=0>=n;r?(g&&(g=nc(g)),m=i,h=a.apply(j,f)):g||(g=tc(d,n))}return r&&k?k=nc(k):k||b===o||(k=tc(e,b)),c&&(r=!0,h=a.apply(j,f)),!r||k||g||(f=j=null),h}}function Ub(a){return a}function Vb(a,b,c){var d=!0,e=b&&sb(b);b&&(c||e.length)||(null==c&&(c=b),f=Y,b=a,a=X,e=sb(b)),!1===c?d=!1:vb(c)&&"chain"in c&&(d=c.chain);var f=a,g=ub(f);Db(e,function(c){var e=a[c]=b[c];g&&(f.prototype[c]=function(){var b=this.__chain__,c=this.__wrapped__,g=[c];if(sc.apply(g,arguments),g=e.apply(a,g),d||b){if(c===g&&vb(g))return this;g=new f(g),g.__chain__=b}return g})})}function Wb(){}function Xb(a){return function(b){return b[a]}}function Yb(){return this.__wrapped__}c=c?$.defaults(V.Object(),c,$.pick(V,G)):V;var Zb=c.Array,$b=c.Boolean,_b=c.Date,ac=c.Function,bc=c.Math,cc=c.Number,dc=c.Object,ec=c.RegExp,fc=c.String,gc=c.TypeError,hc=[],ic=dc.prototype,jc=c._,kc=ic.toString,lc=ec("^"+fc(kc).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$"),mc=bc.ceil,nc=c.clearTimeout,oc=bc.floor,pc=ac.prototype.toString,qc=nb(qc=dc.getPrototypeOf)&&qc,rc=ic.hasOwnProperty,sc=hc.push,tc=c.setTimeout,uc=hc.splice,vc=hc.unshift,wc=function(){try{var a={},b=nb(b=dc.defineProperty)&&b,c=b(a,a,a)&&b}catch(d){}return c}(),xc=nb(xc=dc.create)&&xc,yc=nb(yc=Zb.isArray)&&yc,zc=c.isFinite,Ac=c.isNaN,Bc=nb(Bc=dc.keys)&&Bc,Cc=bc.max,Dc=bc.min,Ec=c.parseInt,Fc=bc.random,Gc={};Gc[I]=Zb,Gc[J]=$b,Gc[K]=_b,Gc[L]=ac,Gc[N]=dc,Gc[M]=cc,Gc[O]=ec,Gc[P]=fc,Y.prototype=X.prototype;var Hc=X.support={};Hc.funcDecomp=!nb(c.a)&&E.test(m),Hc.funcNames="string"==typeof ac.name,X.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:B,variable:"",imports:{_:X}},xc||(ab=function(){function a(){}return function(b){if(vb(b)){a.prototype=b;var d=new a;a.prototype=null}return d||c.Object()}}());var Ic=wc?function(a,b){S.value=b,wc(a,"__bindData__",S)}:Wb,Jc=yc||function(a){return a&&"object"==typeof a&&"number"==typeof a.length&&kc.call(a)==I||!1},Kc=Bc?function(a){return vb(a)?Bc(a):[]}:W,Lc={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Mc=tb(Lc),Nc=ec("("+Kc(Mc).join("|")+")","g"),Oc=ec("["+Kc(Lc).join("")+"]","g"),Pc=qc?function(a){if(!a||kc.call(a)!=N)return!1;var b=a.valueOf,c=nb(b)&&(c=qc(b))&&qc(c);return c?a==c||qc(a)==c:ob(a)}:ob,Qc=jb(function(a,b,c){rc.call(a,c)?a[c]++:a[c]=1}),Rc=jb(function(a,b,c){(rc.call(a,c)?a[c]:a[c]=[]).push(b)}),Sc=jb(function(a,b,c){a[c]=b}),Tc=Fb,Uc=nb(Uc=_b.now)&&Uc||function(){return(new _b).getTime()},Vc=8==Ec(u+"08")?Ec:function(a,b){return Ec(xb(a)?a.replace(C,""):a,b||0)};return X.after=function(a,b){if(!ub(b))throw new gc;return function(){return 1>--a?b.apply(this,arguments):void 0}},X.assign=U,X.at=function(a){for(var b=arguments,c=-1,d=eb(b,!0,!1,1),b=b[2]&&b[2][b[1]]===a?1:d.length,e=Zb(b);++c<b;)e[c]=a[d[c]];return e},X.bind=Sb,X.bindAll=function(a){for(var b=1<arguments.length?eb(arguments,!0,!1,1):sb(a),c=-1,d=b.length;++c<d;){var e=b[c];a[e]=kb(a[e],1,null,null,a)}return a},X.bindKey=function(a,b){return 2<arguments.length?kb(b,19,l(arguments,2),null,a):kb(b,3,null,null,a)},X.chain=function(a){return a=new Y(a),a.__chain__=!0,a},X.compact=function(a){for(var b=-1,c=a?a.length:0,d=[];++b<c;){var e=a[b];e&&d.push(e)}return d},X.compose=function(){for(var a=arguments,b=a.length;b--;)if(!ub(a[b]))throw new gc;return function(){for(var b=arguments,c=a.length;c--;)b=[a[c].apply(this,b)];return b[0]}},X.constant=function(a){return function(){return a}},X.countBy=Qc,X.create=function(a,b){var c=ab(a);return b?U(c,b):c},X.createCallback=function(a,b,c){var d=typeof a;if(null==a||"function"==d)return bb(a,b,c);if("object"!=d)return Xb(a);var e=Kc(a),f=e[0],g=a[f];return 1!=e.length||g!==g||vb(g)?function(b){for(var c=e.length,d=!1;c--&&(d=fb(b[e[c]],a[e[c]],null,!0)););return d}:function(a){return a=a[f],g===a&&(0!==g||1/g==1/a)}},X.curry=function(a,b){return b="number"==typeof b?b:+b||a.length,kb(a,4,null,null,null,b)},X.debounce=Tb,X.defaults=t,X.defer=function(a){if(!ub(a))throw new gc;var b=l(arguments,1);return tc(function(){a.apply(n,b)},1)},X.delay=function(a,b){if(!ub(a))throw new gc;var c=l(arguments,2);return tc(function(){a.apply(n,c)},b)},X.difference=function(a){return db(a,eb(arguments,!0,!0,1))},X.filter=Bb,X.flatten=function(a,b,c,d){return"boolean"!=typeof b&&null!=b&&(d=c,c="function"!=typeof b&&d&&d[b]===a?null:b,b=!1),null!=c&&(a=Fb(a,c,d)),eb(a,b)},X.forEach=Db,X.forEachRight=Eb,X.forIn=p,X.forInRight=function(a,b,c){var d=[];p(a,function(a,b){d.push(b,a)});var e=d.length;for(b=bb(b,c,3);e--&&!1!==b(d[e--],d[e],a););return a},X.forOwn=o,X.forOwnRight=rb,X.functions=sb,X.groupBy=Rc,X.indexBy=Sc,X.initial=function(a,b,c){var d=0,e=a?a.length:0;if("number"!=typeof b&&null!=b){var f=e;for(b=X.createCallback(b,c,3);f--&&b(a[f],f,a);)d++}else d=null==b||c?1:b||d;return l(a,0,Dc(Cc(0,e-d),e))},X.intersection=function(){for(var c=[],d=-1,e=arguments.length,g=h(),i=mb(),l=i===a,m=h();++d<e;){var n=arguments[d];(Jc(n)||qb(n))&&(c.push(n),g.push(l&&n.length>=s&&f(d?c[d]:m)))}var l=c[0],o=-1,p=l?l.length:0,q=[];a:for(;++o<p;){var r=g[0],n=l[o];if(0>(r?b(r,n):i(m,n))){for(d=e,(r||m).push(n);--d;)if(r=g[d],0>(r?b(r,n):i(c[d],n)))continue a;q.push(n)}}for(;e--;)(r=g[e])&&k(r);return j(g),j(m),q},X.invert=tb,X.invoke=function(a,b){var c=l(arguments,2),d=-1,e="function"==typeof b,f=a?a.length:0,g=Zb("number"==typeof f?f:0);return Db(a,function(a){g[++d]=(e?b:a[b]).apply(a,c)}),g},X.keys=Kc,X.map=Fb,X.mapValues=function(a,b,c){var d={};return b=X.createCallback(b,c,3),o(a,function(a,c,e){d[c]=b(a,c,e)}),d},X.max=Gb,X.memoize=function(a,b){function c(){var d=c.cache,e=b?b.apply(this,arguments):r+arguments[0];return rc.call(d,e)?d[e]:d[e]=a.apply(this,arguments)}if(!ub(a))throw new gc;return c.cache={},c},X.merge=function(a){var b=arguments,c=2;if(!vb(a))return a;if("number"!=typeof b[2]&&(c=b.length),c>3&&"function"==typeof b[c-2])var d=bb(b[--c-1],b[c--],2);else c>2&&"function"==typeof b[c-1]&&(d=b[--c]);for(var b=l(arguments,1,c),e=-1,f=h(),g=h();++e<c;)gb(a,b[e],d,f,g);return j(f),j(g),a},X.min=function(a,b,c){var e=1/0,f=e;if("function"!=typeof b&&c&&c[b]===a&&(b=null),null==b&&Jc(a)){c=-1;for(var g=a.length;++c<g;){var h=a[c];f>h&&(f=h)}}else b=null==b&&xb(a)?d:X.createCallback(b,c,3),Db(a,function(a,c,d){c=b(a,c,d),e>c&&(e=c,f=a)});return f},X.omit=function(a,b,c){var d={};if("function"!=typeof b){var e=[];p(a,function(a,b){e.push(b)});for(var e=db(e,eb(arguments,!0,!1,1)),f=-1,g=e.length;++f<g;){var h=e[f];d[h]=a[h]}}else b=X.createCallback(b,c,3),p(a,function(a,c,e){b(a,c,e)||(d[c]=a)});return d},X.once=function(a){var b,c;if(!ub(a))throw new gc;return function(){return b?c:(b=!0,c=a.apply(this,arguments),a=null,c)}},X.pairs=function(a){for(var b=-1,c=Kc(a),d=c.length,e=Zb(d);++b<d;){var f=c[b];e[b]=[f,a[f]]}return e},X.partial=function(a){return kb(a,16,l(arguments,1))},X.partialRight=function(a){return kb(a,32,null,l(arguments,1))},X.pick=function(a,b,c){var d={};if("function"!=typeof b)for(var e=-1,f=eb(arguments,!0,!1,1),g=vb(a)?f.length:0;++e<g;){var h=f[e];h in a&&(d[h]=a[h])}else b=X.createCallback(b,c,3),p(a,function(a,c,e){b(a,c,e)&&(d[c]=a)});return d},X.pluck=Tc,X.property=Xb,X.pull=function(a){for(var b=arguments,c=0,d=b.length,e=a?a.length:0;++c<d;)for(var f=-1,g=b[c];++f<e;)a[f]===g&&(uc.call(a,f--,1),e--);return a},X.range=function(a,b,c){a=+a||0,c="number"==typeof c?c:+c||1,null==b&&(b=a,a=0);var d=-1;b=Cc(0,mc((b-a)/(c||1)));for(var e=Zb(b);++d<b;)e[d]=a,a+=c;return e},X.reject=function(a,b,c){return b=X.createCallback(b,c,3),Bb(a,function(a,c,d){return!b(a,c,d)})},X.remove=function(a,b,c){var d=-1,e=a?a.length:0,f=[];for(b=X.createCallback(b,c,3);++d<e;)c=a[d],b(c,d,a)&&(f.push(c),uc.call(a,d--,1),e--);return f},X.rest=Nb,X.shuffle=Jb,X.sortBy=function(a,b,c){var d=-1,f=Jc(b),g=a?a.length:0,l=Zb("number"==typeof g?g:0);for(f||(b=X.createCallback(b,c,3)),Db(a,function(a,c,e){var g=l[++d]=i();f?g.m=Fb(b,function(b){return a[b]}):(g.m=h())[0]=b(a,c,e),g.n=d,g.o=a}),g=l.length,l.sort(e);g--;)a=l[g],l[g]=a.o,f||j(a.m),k(a);return l},X.tap=function(a,b){return b(a),a},X.throttle=function(a,b,c){var d=!0,e=!0;if(!ub(a))throw new gc;return!1===c?d=!1:vb(c)&&(d="leading"in c?c.leading:d,e="trailing"in c?c.trailing:e),R.leading=d,R.maxWait=b,R.trailing=e,Tb(a,b,R)},X.times=function(a,b,c){a=-1<(a=+a)?a:0;var d=-1,e=Zb(a);for(b=bb(b,c,1);++d<a;)e[d]=b(d);return e},X.toArray=function(a){return a&&"number"==typeof a.length?l(a):yb(a)},X.transform=function(a,b,c,d){var e=Jc(a);if(null==c)if(e)c=[];else{var f=a&&a.constructor;c=ab(f&&f.prototype)}return b&&(b=X.createCallback(b,d,4),(e?Db:o)(a,function(a,d,e){return b(c,a,d,e)})),c},X.union=function(){return ib(eb(arguments,!0,!0))},X.uniq=Pb,X.values=yb,X.where=Bb,X.without=function(a){return db(a,l(arguments,1))},X.wrap=function(a,b){return kb(b,16,[a])},X.xor=function(){for(var a=-1,b=arguments.length;++a<b;){var c=arguments[a];if(Jc(c)||qb(c))var d=d?ib(db(d,c).concat(db(c,d))):c}return d||[]},X.zip=Qb,X.zipObject=Rb,X.collect=Fb,X.drop=Nb,X.each=Db,X.eachRight=Eb,X.extend=U,X.methods=sb,X.object=Rb,X.select=Bb,X.tail=Nb,X.unique=Pb,X.unzip=Qb,Vb(X),X.clone=function(a,b,c,d){return"boolean"!=typeof b&&null!=b&&(d=c,c=b,b=!1),_(a,b,"function"==typeof c&&bb(c,d,1))},X.cloneDeep=function(a,b,c){return _(a,!0,"function"==typeof b&&bb(b,c,1))},X.contains=zb,X.escape=function(a){return null==a?"":fc(a).replace(Oc,lb)},X.every=Ab,X.find=Cb,X.findIndex=function(a,b,c){var d=-1,e=a?a.length:0;for(b=X.createCallback(b,c,3);++d<e;)if(b(a[d],d,a))return d;return-1},X.findKey=function(a,b,c){var d;return b=X.createCallback(b,c,3),o(a,function(a,c,e){return b(a,c,e)?(d=c,!1):void 0}),d},X.findLast=function(a,b,c){var d;return b=X.createCallback(b,c,3),Eb(a,function(a,c,e){return b(a,c,e)?(d=a,!1):void 0}),d},X.findLastIndex=function(a,b,c){var d=a?a.length:0;for(b=X.createCallback(b,c,3);d--;)if(b(a[d],d,a))return d;return-1},X.findLastKey=function(a,b,c){var d;return b=X.createCallback(b,c,3),rb(a,function(a,c,e){return b(a,c,e)?(d=c,!1):void 0}),d},X.has=function(a,b){return a?rc.call(a,b):!1},X.identity=Ub,X.indexOf=Mb,X.isArguments=qb,X.isArray=Jc,X.isBoolean=function(a){return!0===a||!1===a||a&&"object"==typeof a&&kc.call(a)==J||!1},X.isDate=function(a){return a&&"object"==typeof a&&kc.call(a)==K||!1},X.isElement=function(a){return a&&1===a.nodeType||!1},X.isEmpty=function(a){var b=!0;if(!a)return b;var c=kc.call(a),d=a.length;return c==I||c==P||c==H||c==N&&"number"==typeof d&&ub(a.splice)?!d:(o(a,function(){return b=!1}),b)},X.isEqual=function(a,b,c,d){return fb(a,b,"function"==typeof c&&bb(c,d,2))},X.isFinite=function(a){return zc(a)&&!Ac(parseFloat(a))},X.isFunction=ub,X.isNaN=function(a){return wb(a)&&a!=+a},X.isNull=function(a){return null===a},X.isNumber=wb,X.isObject=vb,X.isPlainObject=Pc,X.isRegExp=function(a){return a&&"object"==typeof a&&kc.call(a)==O||!1},X.isString=xb,X.isUndefined=function(a){return"undefined"==typeof a},X.lastIndexOf=function(a,b,c){var d=a?a.length:0;for("number"==typeof c&&(d=(0>c?Cc(0,d+c):Dc(c,d-1))+1);d--;)if(a[d]===b)return d;return-1},X.mixin=Vb,X.noConflict=function(){return c._=jc,this},X.noop=Wb,X.now=Uc,X.parseInt=Vc,X.random=function(a,b,c){var d=null==a,e=null==b;return null==c&&("boolean"==typeof a&&e?(c=a,a=1):e||"boolean"!=typeof b||(c=b,e=!0)),d&&e&&(b=1),a=+a||0,e?(b=a,a=0):b=+b||0,c||a%1||b%1?(c=Fc(),Dc(a+c*(b-a+parseFloat("1e-"+((c+"").length-1))),b)):hb(a,b)},X.reduce=Hb,X.reduceRight=Ib,X.result=function(a,b){if(a){var c=a[b];return ub(c)?a[b]():c}},X.runInContext=m,X.size=function(a){var b=a?a.length:0;return"number"==typeof b?b:Kc(a).length},X.some=Kb,X.sortedIndex=Ob,X.template=function(a,b,c){var d=X.templateSettings;a=fc(a||""),c=t({},c,d);var e,f=t({},c.imports,d.imports),d=Kc(f),f=yb(f),h=0,i=c.interpolate||D,j="__p+='",i=ec((c.escape||D).source+"|"+i.source+"|"+(i===B?y:D).source+"|"+(c.evaluate||D).source+"|$","g");a.replace(i,function(b,c,d,f,i,k){return d||(d=f),j+=a.slice(h,k).replace(F,g),c&&(j+="'+__e("+c+")+'"),i&&(e=!0,j+="';"+i+";\n__p+='"),d&&(j+="'+((__t=("+d+"))==null?'':__t)+'"),h=k+b.length,b}),j+="';",i=c=c.variable,i||(c="obj",j="with("+c+"){"+j+"}"),j=(e?j.replace(v,""):j).replace(w,"$1").replace(x,"$1;"),j="function("+c+"){"+(i?"":c+"||("+c+"={});")+"var __t,__p='',__e=_.escape"+(e?",__j=Array.prototype.join;function print(){__p+=__j.call(arguments,'')}":";")+j+"return __p}";try{var k=ac(d,"return "+j).apply(n,f)}catch(l){throw l.source=j,l}return b?k(b):(k.source=j,k)},X.unescape=function(a){return null==a?"":fc(a).replace(Nc,pb)},X.uniqueId=function(a){var b=++q;return fc(null==a?"":a)+b},X.all=Ab,X.any=Kb,X.detect=Cb,X.findWhere=Cb,X.foldl=Hb,X.foldr=Ib,X.include=zb,X.inject=Hb,Vb(function(){var a={};return o(X,function(b,c){X.prototype[c]||(a[c]=b)}),a}(),!1),X.first=Lb,X.last=function(a,b,c){var d=0,e=a?a.length:0;if("number"!=typeof b&&null!=b){var f=e;for(b=X.createCallback(b,c,3);f--&&b(a[f],f,a);)d++}else if(d=b,null==d||c)return a?a[e-1]:n;return l(a,Cc(0,e-d))},X.sample=function(a,b,c){return a&&"number"!=typeof a.length&&(a=yb(a)),null==b||c?a?a[hb(0,a.length-1)]:n:(a=Jb(a),a.length=Dc(Cc(0,b),a.length),a)},X.take=Lb,X.head=Lb,o(X,function(a,b){var c="sample"!==b;X.prototype[b]||(X.prototype[b]=function(b,d){var e=this.__chain__,f=a(this.__wrapped__,b,d);return e||null!=b&&(!d||c&&"function"==typeof b)?new Y(f,e):f})}),X.VERSION="2.4.1",X.prototype.chain=function(){return this.__chain__=!0,this},X.prototype.toString=function(){return fc(this.__wrapped__)},X.prototype.value=Yb,X.prototype.valueOf=Yb,Db(["join","pop","shift"],function(a){var b=hc[a];X.prototype[a]=function(){var a=this.__chain__,c=b.apply(this.__wrapped__,arguments);return a?new Y(c,a):c}}),Db(["push","reverse","sort","unshift"],function(a){var b=hc[a];X.prototype[a]=function(){return b.apply(this.__wrapped__,arguments),this}}),Db(["concat","slice","splice"],function(a){var b=hc[a];X.prototype[a]=function(){return new Y(b.apply(this.__wrapped__,arguments),this.__chain__)}}),X}var n,o=[],p=[],q=0,r=+new Date+"",s=75,t=40,u=" 	\f ﻿\n\r\u2028\u2029 ᠎             　",v=/\b__p\+='';/g,w=/\b(__p\+=)''\+/g,x=/(__e\(.*?\)|\b__t\))\+'';/g,y=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,z=/\w*$/,A=/^\s*function[ \n\r\t]+\w/,B=/<%=([\s\S]+?)%>/g,C=RegExp("^["+u+"]*0+(?=.$)"),D=/($^)/,E=/\bthis\b/,F=/['\n\r\t\u2028\u2029\\]/g,G="Array Boolean Date Function Math Number Object RegExp String _ attachEvent clearTimeout isFinite isNaN parseInt setTimeout".split(" "),H="[object Arguments]",I="[object Array]",J="[object Boolean]",K="[object Date]",L="[object Function]",M="[object Number]",N="[object Object]",O="[object RegExp]",P="[object String]",Q={};Q[L]=!1,Q[H]=Q[I]=Q[J]=Q[K]=Q[M]=Q[N]=Q[O]=Q[P]=!0;var R={leading:!1,maxWait:0,trailing:!1},S={configurable:!1,enumerable:!1,value:null,writable:!1},T={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},U={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"},V=T[typeof window]&&window||this,W=T[typeof exports]&&exports&&!exports.nodeType&&exports,X=T[typeof module]&&module&&!module.nodeType&&module,Y=X&&X.exports===W&&W,Z=T[typeof global]&&global;!Z||Z.global!==Z&&Z.window!==Z||(V=Z);var $=m();"function"==typeof define&&"object"==typeof define.amd&&define.amd?(V._=$,define(function(){return $})):W&&X?Y?(X.exports=$)._=$:W._=$:V._=$}).call(this),function(){Object.create=Object.create||function(a){function b(){}return b.prototype=a,new b};var a;"undefined"==typeof exports?(a={},"object"==typeof window&&(window.cp=a)):a=exports;var b,c,d=function(a,b){if(!a)throw Error("Assertion failed: "+b)},e=function(a,b){!a&&console&&console.warn&&(console.warn("ASSERTION FAILED: "+b),console.trace&&console.trace())},f=function(a,b){return b>a?a:b},g=function(a,b){return a>b?a:b};"object"==typeof window&&window.navigator.userAgent.indexOf("Firefox")>-1?(b=Math.min,c=Math.max):(b=f,c=g);var h=function(a,b){return b>a?a+" "+b:b+" "+a},i=function(a,b){for(var c=0;a.length>c;c++)if(a[c]===b)return a[c]=a[a.length-1],void a.length--},j=function(a,b,c){var d=y(b,c),e=q(t(d,y(a,c))/H(d));return x(c,A(d,e))},k=function(a,b,c,d,e,f){var g=c-e,h=d-f,i=q(u(g,h,a-e,b-f)/I(g,h));return new r(e+g*i,f+h*i)};a.momentForCircle=function(a,b,c,d){return a*(.5*(b*b+c*c)+H(d))},a.areaForCircle=function(a,b){return Math.PI*Math.abs(a*a-b*b)},a.momentForSegment=function(a,b,c){var d=A(x(b,c),.5);return a*(O(c,b)/12+H(d))},a.areaForSegment=function(a,b,c){return c*(Math.PI*c+2*N(a,b))},a.momentForPoly=function(a,b,c){for(var d=0,e=0,f=b.length,g=0;f>g;g+=2){var h=b[g]+c.x,i=b[g+1]+c.y,j=b[(g+2)%f]+c.x,k=b[(g+3)%f]+c.y,l=C(j,k,h,i),m=u(h,i,h,i)+u(h,i,j,k)+u(j,k,j,k);d+=l*m,e+=l}return a*d/(6*e)},a.areaForPoly=function(a){for(var b=0,c=0,d=a.length;d>c;c+=2)b+=B(new r(a[c],a[c+1]),new r(a[(c+2)%d],a[(c+3)%d]));return-b/2},a.centroidForPoly=function(a){for(var b=0,c=new r(0,0),d=0,e=a.length;e>d;d+=2){var f=new r(a[d],a[d+1]),g=new r(a[(d+2)%e],a[(d+3)%e]),h=B(f,g);b+=h,c=x(c,A(x(f,g),h))}return A(c,1/(3*b))},a.recenterPoly=function(b){for(var c=a.centroidForPoly(b),d=0;b.length>d;d+=2)b[d]-=c.x,b[d+1]-=c.y},a.momentForBox=function(a,b,c){return a*(b*b+c*c)/12},a.momentForBox2=function(b,c){var d=c.r-c.l,e=c.t-c.b,f=A([c.l+c.r,c.b+c.t],.5);return a.momentForBox(b,d,e)+b*H(f)};var l=a.loopIndexes=function(a){var b,c,d,e,f=0,g=0;b=d=a[0],c=e=a[1];for(var h=a.length>>1,i=1;h>i;i++){var j=a[2*i],k=a[2*i+1];b>j||j==b&&c>k?(b=j,c=k,f=i):(j>d||j==d&&k>e)&&(d=j,e=k,g=i)}return[f,g]},m=function(a,b,c){var d=a[2*b];a[2*b]=a[2*c],a[2*c]=d,d=a[2*b+1],a[2*b+1]=a[2*c+1],a[2*c+1]=d},n=function(a,b,c,d,e,f){if(0===c)return 0;for(var g=0,h=b,i=y(e,d),j=f*v(i),k=b,l=b+c-1;l>=k;){var n=new r(a[2*k],a[2*k+1]),o=B(i,y(n,d));o>j?(o>g&&(g=o,h=k),k++):(m(a,k,l),l--)}return h!=b&&m(a,b,h),k-b},o=function(a,b,c,d,e,f,g,h){if(0>d)return 0;if(0==d)return b[2*h]=f.x,b[2*h+1]=f.y,1;var i=n(b,c,d,e,f,a),j=new r(b[2*c],b[2*c+1]),k=o(a,b,c+1,i-1,e,j,f,h),l=h+k++;b[2*l]=f.x,b[2*l+1]=f.y;var m=n(b,c+i,d-i,f,g,a),p=new r(b[2*(c+i)],b[2*(c+i)+1]);return k+o(a,b,c+i+1,m-1,f,p,g,h+k)};a.convexHull=function(a,b,c){if(b)for(var d=0;a.length>d;d++)b[d]=a[d];else b=a;var f=l(a),g=f[0],h=f[1];if(g==h)return b.length=2,b;m(b,0,g),m(b,1,0==h?g:h);var i=new r(b[0],b[1]),j=new r(b[2],b[3]),k=a.length>>1,n=o(c,b,2,k-2,i,j,i,1)+1;return b.length=2*n,e(ab(b),"Internal error: cpConvexHull() and cpPolyValidate() did not agree.Please report this error with as much info as you can."),b};var p=function(a,d,e){return b(c(a,d),e)},q=function(a){return c(0,b(a,1))},r=a.Vect=function(a,b){this.x=a,this.y=b};a.v=function(a,b){return new r(a,b)};var s=a.vzero=new r(0,0),t=a.v.dot=function(a,b){return a.x*b.x+a.y*b.y},u=function(a,b,c,d){return a*c+b*d},v=a.v.len=function(a){return Math.sqrt(t(a,a))},w=a.v.len2=function(a,b){return Math.sqrt(a*a+b*b)};a.v.eql=function(a,b){return a.x===b.x&&a.y===b.y};var x=a.v.add=function(a,b){return new r(a.x+b.x,a.y+b.y)};r.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this};var y=a.v.sub=function(a,b){return new r(a.x-b.x,a.y-b.y)};r.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this};var z=a.v.neg=function(a){return new r(-a.x,-a.y)};r.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var A=a.v.mult=function(a,b){return new r(a.x*b,a.y*b)};r.prototype.mult=function(a){return this.x*=a,this.y*=a,this};var B=a.v.cross=function(a,b){return a.x*b.y-a.y*b.x},C=function(a,b,c,d){return a*d-b*c},D=a.v.perp=function(a){return new r(-a.y,a.x)};a.v.pvrperp=function(a){return new r(a.y,-a.x)};var E=a.v.project=function(a,b){return A(b,t(a,b)/H(b))};r.prototype.project=function(a){return this.mult(t(this,a)/H(a)),this};var F=a.v.rotate=function(a,b){return new r(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)};r.prototype.rotate=function(a){return this.x=this.x*a.x-this.y*a.y,this.y=this.x*a.y+this.y*a.x,this
};var G=a.v.unrotate=function(a,b){return new r(a.x*b.x+a.y*b.y,a.y*b.x-a.x*b.y)},H=a.v.lengthsq=function(a){return t(a,a)},I=a.v.lengthsq2=function(a,b){return a*a+b*b},J=a.v.lerp=function(a,b,c){return x(A(a,1-c),A(b,c))},K=a.v.normalize=function(a){return A(a,1/v(a))},L=a.v.normalize_safe=function(a){return 0===a.x&&0===a.y?s:K(a)},M=a.v.clamp=function(a,b){return t(a,a)>b*b?A(K(a),b):a};a.v.lerpconst=function(a,b,c){return x(a,M(y(b,a),c))};var N=a.v.dist=function(a,b){return v(y(a,b))},O=a.v.distsq=function(a,b){return H(y(a,b))};a.v.near=function(a,b,c){return c*c>O(a,b)};var P=a.v.slerp=function(a,b,c){var d=Math.acos(t(a,b));if(d){var e=1/Math.sin(d);return x(A(a,Math.sin((1-c)*d)*e),A(b,Math.sin(c*d)*e))}return a};a.v.slerpconst=function(a,c,d){var e=Math.acos(t(a,c));return P(a,c,b(d,e)/e)},a.v.forangle=function(a){return new r(Math.cos(a),Math.sin(a))},a.v.toangle=function(a){return Math.atan2(a.y,a.x)},a.v.str=function(a){return"("+a.x.toFixed(3)+", "+a.y.toFixed(3)+")"};var Q=0,R=a.BB=function(a,b,c,d){this.l=a,this.b=b,this.r=c,this.t=d,Q++};a.bb=function(a,b,c,d){return new R(a,b,c,d)};var S=function(a,b){return new R(a.x-b,a.y-b,a.x+b,a.y+b)},T=function(a,b,c,d,e){return d>=a.l&&a.r>=b&&e>=a.b&&a.t>=c},U=0;a.NO_GROUP=0;var V=a.ALL_LAYERS=-1;a.resetShapeIdCounter=function(){U=0};var W=a.Shape=function(a){this.body=a,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=U++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=s,this.collision_type=0,this.group=0,this.layers=V,this.space=null,this.collisionCode=this.collisionCode};W.prototype.setElasticity=function(a){this.e=a},W.prototype.setFriction=function(a){this.body.activate(),this.u=a},W.prototype.setLayers=function(a){this.body.activate(),this.layers=a},W.prototype.setSensor=function(a){this.body.activate(),this.sensor=a},W.prototype.setCollisionType=function(a){this.body.activate(),this.collision_type=a},W.prototype.getBody=function(){return this.body},W.prototype.active=function(){return this.body&&-1!==this.body.shapeList.indexOf(this)},W.prototype.setBody=function(a){d(!this.active(),"You cannot change the body on an active shape. You must remove the shape from the space before changing the body."),this.body=a},W.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},W.prototype.update=function(a,b){d(!isNaN(b.x),"Rotation is NaN"),d(!isNaN(a.x),"Position is NaN"),this.cacheData(a,b)},W.prototype.pointQuery=function(a){var b=this.nearestPointQuery(a);return 0>b.d?b:void 0},W.prototype.getBB=function(){return new R(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var X=function(a,b,c){this.shape=a,this.p=b,this.d=c},Y=function(a,b,c){this.shape=a,this.t=b,this.n=c};Y.prototype.hitPoint=function(a,b){return J(a,b,this.t)},Y.prototype.hitDist=function(a,b){return N(a,b)*this.t};var Z=a.CircleShape=function(a,b,c){this.c=this.tc=c,this.r=b,this.type="circle",W.call(this,a)};Z.prototype=Object.create(W.prototype),Z.prototype.cacheData=function(a,b){var c=this.tc=F(this.c,b).add(a),d=this.r;this.bb_l=c.x-d,this.bb_b=c.y-d,this.bb_r=c.x+d,this.bb_t=c.y+d},Z.prototype.nearestPointQuery=function(a){var b=a.x-this.tc.x,c=a.y-this.tc.y,d=w(b,c),e=this.r,f=new r(this.tc.x+b*e/d,this.tc.y+c*e/d);return new X(this,f,d-e)};var $=function(a,b,c,d,e){d=y(d,b),e=y(e,b);var f=t(d,d)-2*t(d,e)+t(e,e),g=-2*t(d,d)+2*t(d,e),h=t(d,d)-c*c,i=g*g-4*f*h;if(i>=0){var j=(-g-Math.sqrt(i))/(2*f);if(j>=0&&1>=j)return new Y(a,j,K(J(d,e,j)))}};Z.prototype.segmentQuery=function(a,b){return $(this,this.tc,this.r,a,b)};var _=a.SegmentShape=function(a,b,c,d){this.a=b,this.b=c,this.n=D(K(y(c,b))),this.ta=this.tb=this.tn=null,this.r=d,this.a_tangent=s,this.b_tangent=s,this.type="segment",W.call(this,a)};_.prototype=Object.create(W.prototype),_.prototype.cacheData=function(a,b){this.ta=x(a,F(this.a,b)),this.tb=x(a,F(this.b,b)),this.tn=F(this.n,b);var c,d,e,f;this.ta.x<this.tb.x?(c=this.ta.x,d=this.tb.x):(c=this.tb.x,d=this.ta.x),this.ta.y<this.tb.y?(e=this.ta.y,f=this.tb.y):(e=this.tb.y,f=this.ta.y);var g=this.r;this.bb_l=c-g,this.bb_b=e-g,this.bb_r=d+g,this.bb_t=f+g},_.prototype.nearestPointQuery=function(a){var b=j(a,this.ta,this.tb),c=a.x-b.x,d=a.y-b.y,e=w(c,d),f=this.r,g=e?x(b,A(new r(c,d),f/e)):b;return new X(this,g,e-f)},_.prototype.segmentQuery=function(a,b){var c=this.tn,d=t(y(this.ta,a),c),e=this.r,f=d>0?z(c):c,g=y(A(f,e),a),h=x(this.ta,g),i=x(this.tb,g),j=y(b,a);if(0>=B(j,h)*B(j,i)){var k=d+(d>0?-e:e),l=-k,m=t(j,c)-k;if(0>l*m)return new Y(this,l/(l-m),f)}else if(0!==e){var n=$(this,this.ta,this.r,a,b),o=$(this,this.tb,this.r,a,b);return n?o&&o.t<n.t?o:n:o}},_.prototype.setNeighbors=function(a,b){this.a_tangent=y(a,this.a),this.b_tangent=y(b,this.b)},_.prototype.setEndpoints=function(a,b){this.a=a,this.b=b,this.n=D(K(y(b,a)))};var ab=function(a){for(var b=a.length,c=0;b>c;c+=2){var d=a[c],e=a[c+1],f=a[(c+2)%b],g=a[(c+3)%b],h=a[(c+4)%b],i=a[(c+5)%b];if(C(f-d,g-e,h-f,i-g)>0)return!1}return!0},bb=a.PolyShape=function(a,b,c){this.setVerts(b,c),this.type="poly",W.call(this,a)};bb.prototype=Object.create(W.prototype);var cb=function(a,b){this.n=a,this.d=b};cb.prototype.compare=function(a){return t(this.n,a)-this.d},bb.prototype.setVerts=function(a,b){d(a.length>=4,"Polygons require some verts"),d("number"==typeof a[0],"Polygon verticies should be specified in a flattened list (eg [x1,y1,x2,y2,x3,y3,...])"),d(ab(a),"Polygon is concave or has a reversed winding. Consider using cpConvexHull()");var c=a.length,e=c>>1;this.verts=Array(c),this.tVerts=Array(c),this.planes=Array(e),this.tPlanes=Array(e);for(var f=0;c>f;f+=2){var g=a[f]+b.x,h=a[f+1]+b.y,i=a[(f+2)%c]+b.x,j=a[(f+3)%c]+b.y,k=K(D(new r(i-g,j-h)));this.verts[f]=g,this.verts[f+1]=h,this.planes[f>>1]=new cb(k,u(k.x,k.y,g,h)),this.tPlanes[f>>1]=new cb(new r(0,0),0)}},a.BoxShape=function(a,b,c){var d=b/2,e=c/2;return db(a,new R(-d,-e,d,e))};var db=a.BoxShape2=function(a,b){var c=[b.l,b.b,b.l,b.t,b.r,b.t,b.r,b.b];return new bb(a,c,s)};bb.prototype.transformVerts=function(a,d){for(var e=this.verts,f=this.tVerts,g=1/0,h=-1/0,i=1/0,j=-1/0,k=0;e.length>k;k+=2){var l=e[k],m=e[k+1],n=a.x+l*d.x-m*d.y,o=a.y+l*d.y+m*d.x;f[k]=n,f[k+1]=o,g=b(g,n),h=c(h,n),i=b(i,o),j=c(j,o)}this.bb_l=g,this.bb_b=i,this.bb_r=h,this.bb_t=j},bb.prototype.transformAxes=function(a,b){for(var c=this.planes,d=this.tPlanes,e=0;c.length>e;e++){var f=F(c[e].n,b);d[e].n=f,d[e].d=t(a,f)+c[e].d}},bb.prototype.cacheData=function(a,b){this.transformAxes(a,b),this.transformVerts(a,b)},bb.prototype.nearestPointQuery=function(a){for(var b=this.tPlanes,c=this.tVerts,d=c[c.length-2],e=c[c.length-1],f=1/0,g=s,h=!1,i=0;b.length>i;i++){b[i].compare(a)>0&&(h=!0);var j=c[2*i],l=c[2*i+1],m=k(a.x,a.y,d,e,j,l),n=N(a,m);f>n&&(f=n,g=m),d=j,e=l}return new X(this,g,h?f:-f)},bb.prototype.segmentQuery=function(a,b){for(var c=this.tPlanes,d=this.tVerts,e=c.length,f=2*e,g=0;e>g;g++){var h=c[g].n,i=t(a,h);if(!(c[g].d>i)){var j=t(b,h),k=(c[g].d-i)/(j-i);if(!(0>k||k>1)){var l=J(a,b,k),m=-B(h,l),n=-C(h.x,h.y,d[2*g],d[2*g+1]),o=-C(h.x,h.y,d[(2*g+2)%f],d[(2*g+3)%f]);if(m>=n&&o>=m)return new Y(this,k,h)}}}},bb.prototype.valueOnAxis=function(a,c){for(var d=this.tVerts,e=u(a.x,a.y,d[0],d[1]),f=2;d.length>f;f+=2)e=b(e,u(a.x,a.y,d[f],d[f+1]));return e-c},bb.prototype.containsVert=function(a,b){for(var c=this.tPlanes,d=0;c.length>d;d++){var e=c[d].n,f=u(e.x,e.y,a,b)-c[d].d;if(f>0)return!1}return!0},bb.prototype.containsVertPartial=function(a,b,c){for(var d=this.tPlanes,e=0;d.length>e;e++){var f=d[e].n;if(!(0>t(f,c))){var g=u(f.x,f.y,a,b)-d[e].d;if(g>0)return!1}}return!0},bb.prototype.getNumVerts=function(){return this.verts.length/2},bb.prototype.getVert=function(a){return new r(this.verts[2*a],this.verts[2*a+1])};var eb=a.Body=function(a,b){this.p=new r(0,0),this.vx=this.vy=0,this.f=new r(0,0),this.w=0,this.t=0,this.v_limit=1/0,this.w_limit=1/0,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(a),this.setMoment(b),this.rot=new r(0,0),this.setAngle(0)};if("undefined"!=typeof DEBUG&&DEBUG){var fb=function(a,b){d(a.x==a.x&&a.y==a.y,b)},gb=function(a,b){d(1/0!==Math.abs(a.x)&&1/0!==Math.abs(a.y),b)},hb=function(a,b){fb(a,b),gb(a,b)};eb.prototype.sanityCheck=function(){d(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),d(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),hb(this.p,"Body's position is invalid."),hb(this.f,"Body's force is invalid."),d(this.vx===this.vx&&1/0!==Math.abs(this.vx),"Body's velocity is invalid."),d(this.vy===this.vy&&1/0!==Math.abs(this.vy),"Body's velocity is invalid."),d(this.a===this.a&&1/0!==Math.abs(this.a),"Body's angle is invalid."),d(this.w===this.w&&1/0!==Math.abs(this.w),"Body's angular velocity is invalid."),d(this.t===this.t&&1/0!==Math.abs(this.t),"Body's torque is invalid."),hb(this.rot,"Body's rotation vector is invalid."),d(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),d(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else eb.prototype.sanityCheck=function(){};eb.prototype.getPos=function(){return this.p},eb.prototype.getVel=function(){return new r(this.vx,this.vy)},eb.prototype.getAngVel=function(){return this.w},eb.prototype.isSleeping=function(){return null!==this.nodeRoot},eb.prototype.isStatic=function(){return 1/0===this.nodeIdleTime},eb.prototype.isRogue=function(){return null===this.space},eb.prototype.setMass=function(a){d(a>0,"Mass must be positive and non-zero."),this.activate(),this.m=a,this.m_inv=1/a},eb.prototype.setMoment=function(a){d(a>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=a,this.i_inv=1/a},eb.prototype.addShape=function(a){this.shapeList.push(a)},eb.prototype.removeShape=function(a){i(this.shapeList,a)};var ib=function(a,b,c){return a===c?a.next(b):(a.a===b?a.next_a=ib(a.next_a,b,c):a.next_b=ib(a.next_b,b,c),a)};eb.prototype.removeConstraint=function(a){this.constraintList=ib(this.constraintList,this,a)},eb.prototype.setPos=function(b){this.activate(),this.sanityCheck(),b===s&&(b=a.v(0,0)),this.p=b},eb.prototype.setVel=function(a){this.activate(),this.vx=a.x,this.vy=a.y},eb.prototype.setAngVel=function(a){this.activate(),this.w=a},eb.prototype.setAngleInternal=function(a){d(!isNaN(a),"Internal Error: Attempting to set body's angle to NaN"),this.a=a,this.rot.x=Math.cos(a),this.rot.y=Math.sin(a)},eb.prototype.setAngle=function(a){this.activate(),this.sanityCheck(),this.setAngleInternal(a)},eb.prototype.velocity_func=function(a,b,c){var d=this.vx*b+(a.x+this.f.x*this.m_inv)*c,e=this.vy*b+(a.y+this.f.y*this.m_inv)*c,f=this.v_limit,g=d*d+e*e,h=g>f*f?f/Math.sqrt(g):1;this.vx=d*h,this.vy=e*h;var i=this.w_limit;this.w=p(this.w*b+this.t*this.i_inv*c,-i,i),this.sanityCheck()},eb.prototype.position_func=function(a){this.p.x+=(this.vx+this.v_biasx)*a,this.p.y+=(this.vy+this.v_biasy)*a,this.setAngleInternal(this.a+(this.w+this.w_bias)*a),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},eb.prototype.resetForces=function(){this.activate(),this.f=new r(0,0),this.t=0},eb.prototype.applyForce=function(a,b){this.activate(),this.f=x(this.f,a),this.t+=B(b,a)},eb.prototype.applyImpulse=function(a,b){this.activate(),kc(this,a.x,a.y,b)},eb.prototype.getVelAtPoint=function(a){return x(new r(this.vx,this.vy),A(D(a),this.w))},eb.prototype.getVelAtWorldPoint=function(a){return this.getVelAtPoint(y(a,this.p))},eb.prototype.getVelAtLocalPoint=function(a){return this.getVelAtPoint(F(a,this.rot))},eb.prototype.eachShape=function(a){for(var b=0,c=this.shapeList.length;c>b;b++)a(this.shapeList[b])},eb.prototype.eachConstraint=function(a){for(var b=this.constraintList;b;){var c=b.next(this);a(b),b=c}},eb.prototype.eachArbiter=function(a){for(var b=this.arbiterList;b;){var c=b.next(this);b.swappedColl=this===b.body_b,a(b),b=c}},eb.prototype.local2World=function(a){return x(this.p,F(a,this.rot))},eb.prototype.world2Local=function(a){return G(y(a,this.p),this.rot)},eb.prototype.kineticEnergy=function(){var a=this.vx*this.vx+this.vy*this.vy,b=this.w*this.w;return(a?a*this.m:0)+(b?b*this.i:0)};var jb=a.SpatialIndex=function(a){if(this.staticIndex=a,a){if(a.dynamicIndex)throw Error("This static index is already associated with a dynamic index.");a.dynamicIndex=this}};jb.prototype.collideStatic=function(a,b){if(a.count>0){var c=a.query;this.each(function(a){c(a,new R(a.bb_l,a.bb_b,a.bb_r,a.bb_t),b)})}};var kb=a.BBTree=function(a){jb.call(this,a),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.pooledNodes=null,this.pooledPairs=null,this.stamp=0};kb.prototype=Object.create(jb.prototype);var lb=0,mb=function(a,d,e){this.obj=null,this.bb_l=b(d.bb_l,e.bb_l),this.bb_b=b(d.bb_b,e.bb_b),this.bb_r=c(d.bb_r,e.bb_r),this.bb_t=c(d.bb_t,e.bb_t),this.parent=null,this.setA(d),this.setB(e)};kb.prototype.makeNode=function(a,b){var c=this.pooledNodes;return c?(this.pooledNodes=c.parent,c.constructor(this,a,b),c):(lb++,new mb(this,a,b))};var nb=0,ob=function(a,b){this.obj=b,a.getBB(b,this),this.parent=null,this.stamp=1,this.pairs=null,nb++};kb.prototype.getBB=function(a,d){var e=this.velocityFunc;if(e){var f=.1,g=(a.bb_r-a.bb_l)*f,h=(a.bb_t-a.bb_b)*f,i=A(e(a),.1);d.bb_l=a.bb_l+b(-g,i.x),d.bb_b=a.bb_b+b(-h,i.y),d.bb_r=a.bb_r+c(g,i.x),d.bb_t=a.bb_t+c(h,i.y)}else d.bb_l=a.bb_l,d.bb_b=a.bb_b,d.bb_r=a.bb_r,d.bb_t=a.bb_t},kb.prototype.getStamp=function(){var a=this.dynamicIndex;return a&&a.stamp?a.stamp:this.stamp},kb.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var pb=0,qb=function(a,b,c,d){this.prevA=null,this.leafA=a,this.nextA=b,this.prevB=null,this.leafB=c,this.nextB=d};kb.prototype.makePair=function(a,b,c,d){var e=this.pooledPairs;return e?(this.pooledPairs=e.prevA,e.prevA=null,e.leafA=a,e.nextA=b,e.prevB=null,e.leafB=c,e.nextB=d,e):(pb++,new qb(a,b,c,d))},qb.prototype.recycle=function(a){this.prevA=a.pooledPairs,a.pooledPairs=this};var rb=function(a,b,c){c&&(c.leafA===b?c.prevA=a:c.prevB=a),a?a.leafA===b?a.nextA=c:a.nextB=c:b.pairs=c};ob.prototype.clearPairs=function(a){var b,c=this.pairs;for(this.pairs=null;c;)c.leafA===this?(b=c.nextA,rb(c.prevB,c.leafB,c.nextB)):(b=c.nextB,rb(c.prevA,c.leafA,c.nextA)),c.recycle(a),c=b};var sb=function(a,b,c){var d=a.pairs,e=b.pairs,f=c.makePair(a,d,b,e);a.pairs=b.pairs=f,d&&(d.leafA===a?d.prevA=f:d.prevB=f),e&&(e.leafA===b?e.prevA=f:e.prevB=f)};mb.prototype.recycle=function(a){this.parent=a.pooledNodes,a.pooledNodes=this},ob.prototype.recycle=function(){},mb.prototype.setA=function(a){this.A=a,a.parent=this},mb.prototype.setB=function(a){this.B=a,a.parent=this},ob.prototype.isLeaf=!0,mb.prototype.isLeaf=!1,mb.prototype.otherChild=function(a){return this.A==a?this.B:this.A},mb.prototype.replaceChild=function(a,d,f){e(a==this.A||a==this.B,"Node is not a child of parent."),this.A==a?(this.A.recycle(f),this.setA(d)):(this.B.recycle(f),this.setB(d));for(var g=this;g;g=g.parent){var h=g.A,i=g.B;g.bb_l=b(h.bb_l,i.bb_l),g.bb_b=b(h.bb_b,i.bb_b),g.bb_r=c(h.bb_r,i.bb_r),g.bb_t=c(h.bb_t,i.bb_t)}},mb.prototype.bbArea=ob.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var tb=function(a,d){return(c(a.bb_r,d.bb_r)-b(a.bb_l,d.bb_l))*(c(a.bb_t,d.bb_t)-b(a.bb_b,d.bb_b))},ub=function(a,b){return Math.abs(a.bb_l+a.bb_r-b.bb_l-b.bb_r)+Math.abs(a.bb_b+a.bb_t-b.bb_b-b.bb_t)},vb=function(a,d,e){if(null==a)return d;if(a.isLeaf)return e.makeNode(d,a);var f=a.B.bbArea()+tb(a.A,d),g=a.A.bbArea()+tb(a.B,d);return f===g&&(f=ub(a.A,d),g=ub(a.B,d)),f>g?a.setB(vb(a.B,d,e)):a.setA(vb(a.A,d,e)),a.bb_l=b(a.bb_l,d.bb_l),a.bb_b=b(a.bb_b,d.bb_b),a.bb_r=c(a.bb_r,d.bb_r),a.bb_t=c(a.bb_t,d.bb_t),a};mb.prototype.intersectsBB=ob.prototype.intersectsBB=function(a){return this.bb_l<=a.r&&a.l<=this.bb_r&&this.bb_b<=a.t&&a.b<=this.bb_t};var wb=function(a,b,c){a.intersectsBB(b)&&(a.isLeaf?c(a.obj):(wb(a.A,b,c),wb(a.B,b,c)))},xb=function(a,d,e){var f=1/(e.x-d.x),g=a.bb_l==d.x?-1/0:(a.bb_l-d.x)*f,h=a.bb_r==d.x?1/0:(a.bb_r-d.x)*f,i=b(g,h),j=c(g,h),k=1/(e.y-d.y),l=a.bb_b==d.y?-1/0:(a.bb_b-d.y)*k,m=a.bb_t==d.y?1/0:(a.bb_t-d.y)*k,n=b(l,m),o=c(l,m);if(j>=n&&o>=i){var p=c(i,n),q=b(j,o);if(q>=0&&1>=p)return c(p,0)}return 1/0},yb=function(a,c,d,e,f){if(a.isLeaf)return f(a.obj);var g=xb(a.A,c,d),h=xb(a.B,c,d);return h>g?(e>g&&(e=b(e,yb(a.A,c,d,e,f))),e>h&&(e=b(e,yb(a.B,c,d,e,f)))):(e>h&&(e=b(e,yb(a.B,c,d,e,f))),e>g&&(e=b(e,yb(a.A,c,d,e,f)))),e};kb.prototype.subtreeRecycle=function(a){a.isLeaf&&(this.subtreeRecycle(a.A),this.subtreeRecycle(a.B),a.recycle(this))};var zb=function(a,b,c){if(b==a)return null;var d=b.parent;if(d==a){var e=a.otherChild(b);return e.parent=a.parent,a.recycle(c),e}return d.parent.replaceChild(d,d.otherChild(b),c),a},Ab=function(a,b){return a.bb_l<=b.bb_r&&b.bb_l<=a.bb_r&&a.bb_b<=b.bb_t&&b.bb_b<=a.bb_t};ob.prototype.markLeafQuery=function(a,b,c,d){Ab(a,this)&&(b?sb(a,this,c):(this.stamp<a.stamp&&sb(this,a,c),d&&d(a.obj,this.obj)))},mb.prototype.markLeafQuery=function(a,b,c,d){Ab(a,this)&&(this.A.markLeafQuery(a,b,c,d),this.B.markLeafQuery(a,b,c,d))},ob.prototype.markSubtree=function(a,b,c){if(this.stamp==a.getStamp()){b&&b.markLeafQuery(this,!1,a,c);for(var d=this;d.parent;d=d.parent)d==d.parent.A?d.parent.B.markLeafQuery(this,!0,a,c):d.parent.A.markLeafQuery(this,!1,a,c)}else for(var e=this.pairs;e;)this===e.leafB?(c&&c(e.leafA.obj,this.obj),e=e.nextB):e=e.nextA},mb.prototype.markSubtree=function(a,b,c){this.A.markSubtree(a,b,c),this.B.markSubtree(a,b,c)},ob.prototype.containsObj=function(a){return this.bb_l<=a.bb_l&&this.bb_r>=a.bb_r&&this.bb_b<=a.bb_b&&this.bb_t>=a.bb_t},ob.prototype.update=function(a){var b=a.root,c=this.obj;return this.containsObj(c)?!1:(a.getBB(this.obj,this),b=zb(b,this,a),a.root=vb(b,this,a),this.clearPairs(a),this.stamp=a.getStamp(),!0)},ob.prototype.addPairs=function(a){var b=a.dynamicIndex;if(b){var c=b.root;c&&c.markLeafQuery(this,!0,b,null)}else{var d=a.staticIndex.root;this.markSubtree(a,d,null)}},kb.prototype.insert=function(a,b){var c=new ob(this,a);this.leaves[b]=c,this.root=vb(this.root,c,this),this.count++,c.stamp=this.getStamp(),c.addPairs(this),this.incrementStamp()},kb.prototype.remove=function(a,b){var c=this.leaves[b];delete this.leaves[b],this.root=zb(this.root,c,this),this.count--,c.clearPairs(this),c.recycle(this)},kb.prototype.contains=function(a,b){return null!=this.leaves[b]};var Bb=function(){};kb.prototype.reindexQuery=function(a){if(this.root){var b,c=this.leaves;for(b in c)c[b].update(this);var d=this.staticIndex,e=d&&d.root;this.root.markSubtree(this,e,a),d&&!e&&this.collideStatic(this,d,a),this.incrementStamp()}},kb.prototype.reindex=function(){this.reindexQuery(Bb)},kb.prototype.reindexObject=function(a,b){var c=this.leaves[b];c&&(c.update(this)&&c.addPairs(this),this.incrementStamp())},kb.prototype.pointQuery=function(a,b){this.query(new R(a.x,a.y,a.x,a.y),b)},kb.prototype.segmentQuery=function(a,b,c,d){this.root&&yb(this.root,a,b,c,d)},kb.prototype.query=function(a,b){this.root&&wb(this.root,a,b)},kb.prototype.count=function(){return this.count},kb.prototype.each=function(a){var b;for(b in this.leaves)a(this.leaves[b].obj)};var Cb=function(a,d,e,f,g){return(c(a.bb_r,f)-b(a.bb_l,d))*(c(a.bb_t,g)-b(a.bb_b,e))},Db=function(a,d,e,f){if(1==f)return d[e];if(2==f)return a.makeNode(d[e],d[e+1]);for(var g=d[e],h=g.bb_l,i=g.bb_b,j=g.bb_r,k=g.bb_t,l=e+f,m=e+1;l>m;m++)g=d[m],h=b(h,g.bb_l),i=b(i,g.bb_b),j=c(j,g.bb_r),k=c(k,g.bb_t);var n=j-h>k-i,o=Array(2*f);if(n)for(var m=e;l>m;m++)o[2*m+0]=d[m].bb_l,o[2*m+1]=d[m].bb_r;else for(var m=e;l>m;m++)o[2*m+0]=d[m].bb_b,o[2*m+1]=d[m].bb_t;o.sort(function(a,b){return a-b});var p=.5*(o[f-1]+o[f]),q=h,r=i,s=j,t=k,u=h,v=i,w=j,x=k;n?s=u=p:t=v=p;for(var y=l,z=e;y>z;){var g=d[z];Cb(g,u,v,w,x)<Cb(g,q,r,s,t)?(y--,d[z]=d[y],d[y]=g):z++}if(y==f){for(var g=null,m=e;l>m;m++)g=vb(g,d[m],a);return g}return NodeNew(a,Db(a,d,e,y-e),Db(a,d,y,l-y))};kb.prototype.optimize=function(){var a=Array(this.count),b=0;for(var c in this.leaves)a[b++]=this.nodes[c];tree.subtreeRecycle(root),this.root=Db(tree,a,a.length)};var Eb=function(a,b){!a.isLeaf&&10>=b&&(Eb(a.A,b+1),Eb(a.B,b+1));for(var c="",d=0;b>d;d++)c+=" ";console.log(c+a.bb_b+" "+a.bb_t)};kb.prototype.log=function(){this.root&&Eb(this.root,0)};var Fb=a.CollisionHandler=function(){this.a=this.b=0};Fb.prototype.begin=function(){return!0},Fb.prototype.preSolve=function(){return!0},Fb.prototype.postSolve=function(){},Fb.prototype.separate=function(){};var Gb=function(a,b){this.e=0,this.u=0,this.surface_vr=s,this.a=a,this.body_a=a.body,this.b=b,this.body_b=b.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};Gb.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},Gb.prototype.totalImpulse=function(){for(var a=this.contacts,b=new r(0,0),c=0,d=a.length;d>c;c++){var e=a[c];b.add(A(e.n,e.jnAcc))}return this.swappedColl?b:b.neg()},Gb.prototype.totalImpulseWithFriction=function(){for(var a=this.contacts,b=new r(0,0),c=0,d=a.length;d>c;c++){var e=a[c];b.add(new r(e.jnAcc,e.jtAcc).rotate(e.n))}return this.swappedColl?b:b.neg()},Gb.prototype.totalKE=function(){for(var a=(1-this.e)/(1+this.e),b=0,c=this.contacts,d=0,e=c.length;e>d;d++){var f=c[d],g=f.jnAcc,h=f.jtAcc;b+=a*g*g/f.nMass+h*h/f.tMass}return b},Gb.prototype.ignore=function(){this.state="ignore"},Gb.prototype.getA=function(){return this.swappedColl?this.b:this.a},Gb.prototype.getB=function(){return this.swappedColl?this.a:this.b},Gb.prototype.isFirstContact=function(){return"first coll"===this.state};var Hb=function(a,b,c){this.point=a,this.normal=b,this.dist=c};Gb.prototype.getContactPointSet=function(){var a,b=Array(this.contacts.length);for(a=0;b.length>a;a++)b[a]=new Hb(this.contacts[a].p,this.contacts[a].n,this.contacts[a].dist);return b},Gb.prototype.getNormal=function(a){var b=this.contacts[a].n;return this.swappedColl?z(b):b},Gb.prototype.getPoint=function(a){return this.contacts[a].p},Gb.prototype.getDepth=function(a){return this.contacts[a].dist};var Ib=function(a,b,c,d){c?c.body_a===b?c.thread_a_next=d:c.thread_b_next=d:b.arbiterList=d,d&&(d.body_a===b?d.thread_a_prev=c:d.thread_b_prev=c)};Gb.prototype.unthread=function(){Ib(this,this.body_a,this.thread_a_prev,this.thread_a_next),Ib(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},Gb.prototype.update=function(a,b,c,d){if(this.contacts)for(var e=0;this.contacts.length>e;e++)for(var f=this.contacts[e],g=0;a.length>g;g++){var h=a[g];h.hash===f.hash&&(h.jnAcc=f.jnAcc,h.jtAcc=f.jtAcc)}this.contacts=a,this.handler=b,this.swappedColl=c.collision_type!==b.a,this.e=c.e*d.e,this.u=c.u*d.u,this.surface_vr=y(c.surface_v,d.surface_v),this.a=c,this.body_a=c.body,this.b=d,this.body_b=d.body,"cached"==this.state&&(this.state="first coll")},Gb.prototype.preStep=function(a,c,d){for(var e=this.body_a,f=this.body_b,g=0;this.contacts.length>g;g++){var h=this.contacts[g];h.r1=y(h.p,e.p),h.r2=y(h.p,f.p),h.nMass=1/oc(e,f,h.r1,h.r2,h.n),h.tMass=1/oc(e,f,h.r1,h.r2,D(h.n)),h.bias=-d*b(0,h.dist+c)/a,h.jBias=0,h.bounce=jc(e,f,h.r1,h.r2,h.n)*this.e}},Gb.prototype.applyCachedImpulse=function(a){if(!this.isFirstContact())for(var b=this.body_a,c=this.body_b,d=0;this.contacts.length>d;d++){var e=this.contacts[d],f=e.n.x,g=e.n.y,h=f*e.jnAcc-g*e.jtAcc,i=f*e.jtAcc+g*e.jnAcc;lc(b,c,e.r1,e.r2,h*a,i*a)}};var Jb=0,Kb=0;Gb.prototype.applyImpulse=function(){Jb++;for(var a=this.body_a,b=this.body_b,d=this.surface_vr,e=this.u,f=0;this.contacts.length>f;f++){Kb++;var g=this.contacts[f],h=g.nMass,i=g.n,j=g.r1,k=g.r2,l=b.vx-k.y*b.w-(a.vx-j.y*a.w),m=b.vy+k.x*b.w-(a.vy+j.x*a.w),n=i.x*(b.v_biasx-k.y*b.w_bias-a.v_biasx+j.y*a.w_bias)+i.y*(k.x*b.w_bias+b.v_biasy-j.x*a.w_bias-a.v_biasy),o=u(l,m,i.x,i.y),q=u(l+d.x,m+d.y,-i.y,i.x),r=(g.bias-n)*h,s=g.jBias;g.jBias=c(s+r,0);var t=-(g.bounce+o)*h,v=g.jnAcc;g.jnAcc=c(v+t,0);var w=e*g.jnAcc,x=-q*g.tMass,y=g.jtAcc;g.jtAcc=p(y+x,-w,w);var z=i.x*(g.jBias-s),A=i.y*(g.jBias-s);mc(a,-z,-A,j),mc(b,z,A,k);var B=g.jnAcc-v,C=g.jtAcc-y;lc(a,b,j,k,i.x*B-i.y*C,i.x*C+i.y*B)}},Gb.prototype.callSeparate=function(a){var b=a.lookupHandler(this.a.collision_type,this.b.collision_type);b.separate(this,a)},Gb.prototype.next=function(a){return this.body_a==a?this.thread_a_next:this.thread_b_next};var Lb=0,Mb=function(a,b,c,d){this.p=a,this.n=b,this.dist=c,this.r1=this.r2=s,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=d,Lb++},Nb=[],Ob=function(a,b,c,d){var e=c+d,f=y(b,a),g=H(f);if(!(g>=e*e)){var h=Math.sqrt(g);return new Mb(x(a,A(f,.5+(c-.5*e)/(h?h:1/0))),h?A(f,1/h):new r(1,0),h-e,0)}},Pb=function(a,b){var c=Ob(a.tc,b.tc,a.r,b.r);return c?[c]:Nb},Qb=function(a,b){var c=b.ta,d=b.tb,e=a.tc,f=y(d,c),g=q(t(f,y(e,c))/H(f)),h=x(c,A(f,g)),i=Ob(e,h,a.r,b.r);if(i){var j=i.n;return 0===g&&0>t(j,b.a_tangent)||1===g&&0>t(j,b.b_tangent)?Nb:[i]}return Nb},Rb=0,Sb=function(a,b){var c=0,d=a.valueOnAxis(b[0].n,b[0].d);if(d>0)return-1;for(var e=1;b.length>e;e++){var f=a.valueOnAxis(b[e].n,b[e].d);if(f>0)return-1;f>d&&(d=f,c=e)}return Rb=d,c},Tb=function(a,b,c,d){for(var e=[],f=a.tVerts,g=0;f.length>g;g+=2){var i=f[g],j=f[g+1];b.containsVertPartial(i,j,z(c))&&e.push(new Mb(new r(i,j),c,d,h(a.hashid,g)))}for(var k=b.tVerts,g=0;k.length>g;g+=2){var i=k[g],j=k[g+1];a.containsVertPartial(i,j,c)&&e.push(new Mb(new r(i,j),c,d,h(b.hashid,g)))}return e},Ub=function(a,b,c,d){for(var e=[],f=a.tVerts,g=0;f.length>g;g+=2){var i=f[g],j=f[g+1];b.containsVert(i,j)&&e.push(new Mb(new r(i,j),c,d,h(a.hashid,g>>1)))}for(var k=b.tVerts,g=0;k.length>g;g+=2){var i=k[g],j=k[g+1];a.containsVert(i,j)&&e.push(new Mb(new r(i,j),c,d,h(b.hashid,g>>1)))}return e.length?e:Tb(a,b,c,d)},Vb=function(a,b){var c=Sb(b,a.tPlanes);if(-1==c)return Nb;var d=Rb,e=Sb(a,b.tPlanes);if(-1==e)return Nb;var f=Rb;return d>f?Ub(a,b,a.tPlanes[c].n,d):Ub(a,b,z(b.tPlanes[e].n),f)},Wb=function(a,c,d){var e=t(c,a.ta)-a.r,f=t(c,a.tb)-a.r;return b(e,f)-d},Xb=function(a,b,c,d,e){for(var f=B(b.tn,b.ta),g=B(b.tn,b.tb),i=A(b.tn,e),j=c.tVerts,k=0;j.length>k;k+=2){var l=j[k],m=j[k+1];if(u(l,m,i.x,i.y)<t(b.tn,b.ta)*e+b.r){var n=C(b.tn.x,b.tn.y,l,m);f>=n&&n>=g&&a.push(new Mb(new r(l,m),i,d,h(c.hashid,k)))}}},Yb=function(a,b){var c=[],d=b.tPlanes,e=d.length,f=t(a.tn,a.ta),g=b.valueOnAxis(a.tn,f)-a.r,i=b.valueOnAxis(z(a.tn),-f)-a.r;if(i>0||g>0)return Nb;var j=0,k=Wb(a,d[0].n,d[0].d);if(k>0)return Nb;for(var l=0;e>l;l++){var m=Wb(a,d[l].n,d[l].d);if(m>0)return Nb;m>k&&(k=m,j=l)}var n=z(d[j].n),o=x(a.ta,A(n,a.r)),p=x(a.tb,A(n,a.r));if(b.containsVert(o.x,o.y)&&c.push(new Mb(o,n,k,h(a.hashid,0))),b.containsVert(p.x,p.y)&&c.push(new Mb(p,n,k,h(a.hashid,1))),(g>=k||i>=k)&&(g>i?Xb(c,a,b,g,1):Xb(c,a,b,i,-1)),0===c.length){var q,s=2*j,u=b.tVerts,v=new r(u[s],u[s+1]);if(q=Ob(a.ta,v,a.r,0,c))return[q];if(q=Ob(a.tb,v,a.r,0,c))return[q];var w=2*e,y=new r(u[(s+2)%w],u[(s+3)%w]);if(q=Ob(a.ta,y,a.r,0,c))return[q];if(q=Ob(a.tb,y,a.r,0,c))return[q]}return c},Zb=function(a,b){for(var c=b.tPlanes,d=0,e=t(c[0].n,a.tc)-c[0].d-a.r,f=0;c.length>f;f++){var g=t(c[f].n,a.tc)-c[f].d-a.r;if(g>0)return Nb;g>e&&(e=g,d=f)}var h=c[d].n,i=b.tVerts,j=i.length,k=d<<1,l=i[k],m=i[k+1],n=i[(k+2)%j],o=i[(k+3)%j],p=C(h.x,h.y,l,m),q=C(h.x,h.y,n,o),s=B(h,a.tc);if(q>s){var u=Ob(a.tc,new r(n,o),a.r,0,u);return u?[u]:Nb}if(p>s)return[new Mb(y(a.tc,A(h,a.r+e/2)),z(h),e,0)];var u=Ob(a.tc,new r(l,m),a.r,0,u);return u?[u]:Nb};Z.prototype.collisionCode=0,_.prototype.collisionCode=1,bb.prototype.collisionCode=2,Z.prototype.collisionTable=[Pb,Qb,Zb],_.prototype.collisionTable=[null,function(){return Nb},Yb],bb.prototype.collisionTable=[null,null,Vb];var $b=a.collideShapes=function(a,b){return d(a.collisionCode<=b.collisionCode,"Collided shapes must be sorted by type"),a.collisionTable[b.collisionCode](a,b)},_b=new Fb,ac=a.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new kb(null),this.activeShapes=new kb(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=_b,this.postStepCallbacks=[],this.iterations=10,this.gravity=s,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=1/0,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new eb(1/0,1/0),this.staticBody.nodeIdleTime=1/0,this.collideShapes=this.makeCollideShapes()};ac.prototype.getCurrentTimeStep=function(){return this.curr_dt},ac.prototype.setIterations=function(a){this.iterations=a},ac.prototype.isLocked=function(){return this.locked};var bc=function(a){d(!a.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};ac.prototype.addCollisionHandler=function(a,b,c,d,e,f){bc(this),this.removeCollisionHandler(a,b);var g=new Fb;g.a=a,g.b=b,c&&(g.begin=c),d&&(g.preSolve=d),e&&(g.postSolve=e),f&&(g.separate=f),this.collisionHandlers[h(a,b)]=g},ac.prototype.removeCollisionHandler=function(a,b){bc(this),delete this.collisionHandlers[h(a,b)]},ac.prototype.setDefaultCollisionHandler=function(a,b,c,d){bc(this);var e=new Fb;a&&(e.begin=a),b&&(e.preSolve=b),c&&(e.postSolve=c),d&&(e.separate=d),this.defaultHandler=e},ac.prototype.lookupHandler=function(a,b){return this.collisionHandlers[h(a,b)]||this.defaultHandler},ac.prototype.addShape=function(a){var b=a.body;return b.isStatic()?this.addStaticShape(a):(d(!a.space,"This shape is already added to a space and cannot be added to another."),bc(this),b.activate(),b.addShape(a),a.update(b.p,b.rot),this.activeShapes.insert(a,a.hashid),a.space=this,a)},ac.prototype.addStaticShape=function(a){d(!a.space,"This shape is already added to a space and cannot be added to another."),bc(this);var b=a.body;return b.addShape(a),a.update(b.p,b.rot),this.staticShapes.insert(a,a.hashid),a.space=this,a},ac.prototype.addBody=function(a){return d(!a.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),d(!a.space,"This body is already added to a space and cannot be added to another."),bc(this),this.bodies.push(a),a.space=this,a},ac.prototype.addConstraint=function(a){d(!a.space,"This shape is already added to a space and cannot be added to another."),bc(this);var b=a.a,c=a.b;return b.activate(),c.activate(),this.constraints.push(a),a.next_a=b.constraintList,b.constraintList=a,a.next_b=c.constraintList,c.constraintList=a,a.space=this,a},ac.prototype.filterArbiters=function(a,b){for(var c in this.cachedArbiters){var d=this.cachedArbiters[c];(a===d.body_a&&(b===d.a||null===b)||a===d.body_b&&(b===d.b||null===b))&&(b&&"cached"!==d.state&&d.callSeparate(this),d.unthread(),i(this.arbiters,d),delete this.cachedArbiters[c])}},ac.prototype.removeShape=function(a){var b=a.body;b.isStatic()?this.removeStaticShape(a):(d(this.containsShape(a),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),bc(this),b.activate(),b.removeShape(a),this.filterArbiters(b,a),this.activeShapes.remove(a,a.hashid),a.space=null)},ac.prototype.removeStaticShape=function(a){d(this.containsShape(a),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),bc(this);var b=a.body;b.isStatic()&&b.activateStatic(a),b.removeShape(a),this.filterArbiters(b,a),this.staticShapes.remove(a,a.hashid),a.space=null},ac.prototype.removeBody=function(a){d(this.containsBody(a),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),bc(this),a.activate(),i(this.bodies,a),a.space=null},ac.prototype.removeConstraint=function(a){d(this.containsConstraint(a),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),bc(this),a.a.activate(),a.b.activate(),i(this.constraints,a),a.a.removeConstraint(a),a.b.removeConstraint(a),a.space=null
},ac.prototype.containsShape=function(a){return a.space===this},ac.prototype.containsBody=function(a){return a.space==this},ac.prototype.containsConstraint=function(a){return a.space==this},ac.prototype.uncacheArbiter=function(a){delete this.cachedArbiters[h(a.a.hashid,a.b.hashid)],i(this.arbiters,a)},ac.prototype.eachBody=function(a){this.lock();for(var b=this.bodies,c=0;b.length>c;c++)a(b[c]);for(var d=this.sleepingComponents,c=0;d.length>c;c++)for(var e=d[c],f=e;f;){var g=f.nodeNext;a(f),f=g}this.unlock(!0)},ac.prototype.eachShape=function(a){this.lock(),this.activeShapes.each(a),this.staticShapes.each(a),this.unlock(!0)},ac.prototype.eachConstraint=function(a){this.lock();for(var b=this.constraints,c=0;b.length>c;c++)a(b[c]);this.unlock(!0)},ac.prototype.reindexStatic=function(){d(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(a){var b=a.body;a.update(b.p,b.rot)}),this.staticShapes.reindex()},ac.prototype.reindexShape=function(a){d(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var b=a.body;a.update(b.p,b.rot),this.activeShapes.reindexObject(a,a.hashid),this.staticShapes.reindexObject(a,a.hashid)},ac.prototype.reindexShapesForBody=function(a){for(var b=a.shapeList;b;b=b.next)this.reindexShape(b)},ac.prototype.useSpatialHash=function(){throw Error("Spatial Hash not implemented.")},ac.prototype.activateBody=function(a){if(d(!a.isRogue(),"Internal error: Attempting to activate a rogue body."),this.locked)-1===this.rousedBodies.indexOf(a)&&this.rousedBodies.push(a);else{this.bodies.push(a);for(var b=0;a.shapeList.length>b;b++){var c=a.shapeList[b];this.staticShapes.remove(c,c.hashid),this.activeShapes.insert(c,c.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;if(a===f||f.isStatic()){var g=e.a,i=e.b;this.cachedArbiters[h(g.hashid,i.hashid)]=e,e.stamp=this.stamp,e.handler=this.lookupHandler(g.collision_type,i.collision_type),this.arbiters.push(e)}}for(var j=a.constraintList;j;j=j.nodeNext){var f=j.a;(a===f||f.isStatic())&&this.constraints.push(j)}}},ac.prototype.deactivateBody=function(a){d(!a.isRogue(),"Internal error: Attempting to deactivate a rogue body."),i(this.bodies,a);for(var b=0;a.shapeList.length>b;b++){var c=a.shapeList[b];this.activeShapes.remove(c,c.hashid),this.staticShapes.insert(c,c.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;(a===f||f.isStatic())&&this.uncacheArbiter(e)}for(var g=a.constraintList;g;g=g.nodeNext){var f=g.a;(a===f||f.isStatic())&&i(this.constraints,g)}};var cc=function(a){return a?a.nodeRoot:null},dc=function(a){if(a&&a.isSleeping(a)){d(!a.isRogue(),"Internal Error: componentActivate() called on a rogue body.");for(var b=a.space,c=a;c;){var e=c.nodeNext;c.nodeIdleTime=0,c.nodeRoot=null,c.nodeNext=null,b.activateBody(c),c=e}i(b.sleepingComponents,a)}};eb.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,dc(cc(this)))},eb.prototype.activateStatic=function(a){d(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var b=this.arbiterList;b;b=b.next(this))a&&a!=b.a&&a!=b.b||(b.body_a==this?b.body_b:b.body_a).activate()},eb.prototype.pushArbiter=function(a){e(null===(a.body_a===this?a.thread_a_next:a.thread_b_next),"Internal Error: Dangling contact graph pointers detected. (A)"),e(null===(a.body_a===this?a.thread_a_prev:a.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (B)");var b=this.arbiterList;e(null===b||null===(b.body_a===this?b.thread_a_prev:b.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (C)"),a.body_a===this?a.thread_a_next=b:a.thread_b_next=b,b&&(b.body_a===this?b.thread_a_prev=a:b.thread_b_prev=a),this.arbiterList=a};var ec=function(a,b){b.nodeRoot=a,b!==a&&(b.nodeNext=a.nodeNext,a.nodeNext=b)},fc=function(a,b){if(!b.isRogue()){var c=cc(b);if(null==c){ec(a,b);for(var d=b.arbiterList;d;d=d.next(b))fc(a,b==d.body_a?d.body_b:d.body_a);for(var f=b.constraintList;f;f=f.next(b))fc(a,b==f.a?f.b:f.a)}else e(c===a,"Internal Error: Inconsistency detected in the contact graph.")}},gc=function(a,b){for(var c=a;c;c=c.nodeNext)if(b>c.nodeIdleTime)return!0;return!1};ac.prototype.processComponents=function(a){for(var b=1/0!==this.sleepTimeThreshold,c=this.bodies,d=0;c.length>d;d++){var f=c[d];e(null===f.nodeNext,"Internal Error: Dangling next pointer detected in contact graph."),e(null===f.nodeRoot,"Internal Error: Dangling root pointer detected in contact graph.")}if(b)for(var g=this.idleSpeedThreshold,h=g?g*g:H(this.gravity)*a*a,d=0;c.length>d;d++){var f=c[d],i=h?f.m*h:0;f.nodeIdleTime=f.kineticEnergy()>i?0:f.nodeIdleTime+a}for(var j=this.arbiters,d=0,k=j.length;k>d;d++){var l=j[d],m=l.body_a,n=l.body_b;b&&((n.isRogue()&&!n.isStatic()||m.isSleeping())&&m.activate(),(m.isRogue()&&!m.isStatic()||n.isSleeping())&&n.activate()),m.pushArbiter(l),n.pushArbiter(l)}if(b){for(var o=this.constraints,d=0;o.length>d;d++){var p=o[d],m=p.a,n=p.b;n.isRogue()&&!n.isStatic()&&m.activate(),m.isRogue()&&!m.isStatic()&&n.activate()}for(var d=0;c.length>d;){var f=c[d];if(null!==cc(f)||(fc(f,f),gc(f,this.sleepTimeThreshold)))d++,f.nodeRoot=null,f.nodeNext=null;else{this.sleepingComponents.push(f);for(var q=f;q;q=q.nodeNext)this.deactivateBody(q)}}}},eb.prototype.sleep=function(){this.sleepWithGroup(null)},eb.prototype.sleepWithGroup=function(a){d(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var b=this.space;if(d(b,"Cannot put a rogue body to sleep."),d(!b.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),d(null===a||a.isSleeping(),"Cannot use a non-sleeping body as a group identifier."),this.isSleeping())return void d(cc(this)===cc(a),"The body is already sleeping and it's group cannot be reassigned.");for(var c=0;this.shapeList.length>c;c++)this.shapeList[c].update(this.p,this.rot);if(b.deactivateBody(this),a){var e=cc(a);this.nodeRoot=e,this.nodeNext=e.nodeNext,this.nodeIdleTime=0,e.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,b.sleepingComponents.push(this);i(b.bodies,this)},ac.prototype.activateShapesTouchingShape=function(a){1/0!==this.sleepTimeThreshold&&this.shapeQuery(a,function(a){a.body.activate()})},ac.prototype.pointQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&e.pointQuery(a)&&d(e)},f=new R(a.x,a.y,a.x,a.y);this.lock(),this.activeShapes.query(f,e),this.staticShapes.query(f,e),this.unlock(!0)},ac.prototype.pointQueryFirst=function(a,b,c){var d=null;return this.pointQuery(a,b,c,function(a){a.sensor||(d=a)}),d},ac.prototype.nearestPointQuery=function(a,b,c,d,e){var f=function(f){if((!f.group||d!==f.group)&&c&f.layers){var g=f.nearestPointQuery(a);b>g.d&&e(f,g.d,g.p)}},g=S(a,b);this.lock(),this.activeShapes.query(g,f),this.staticShapes.query(g,f),this.unlock(!0)},ac.prototype.nearestPointQueryNearest=function(a,b,c,d){var e,f=function(f){if((!f.group||d!==f.group)&&c&f.layers&&!f.sensor){var g=f.nearestPointQuery(a);b>g.d&&(!e||g.d<e.d)&&(e=g)}},g=S(a,b);return this.activeShapes.query(g,f),this.staticShapes.query(g,f),e},ac.prototype.segmentQuery=function(a,b,c,d,e){var f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&(g=f.segmentQuery(a,b))&&e(f,g.t,g.n),1};this.lock(),this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,1,f),this.unlock(!0)},ac.prototype.segmentQueryFirst=function(a,b,c,d){var e=null,f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&!f.sensor&&(g=f.segmentQuery(a,b))&&(null===e||g.t<e.t)&&(e=g),e?e.t:1};return this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,e?e.t:1,f),e},ac.prototype.bbQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&T(a,e.bb_l,e.bb_b,e.bb_r,e.bb_t)&&d(e)};this.lock(),this.activeShapes.query(a,e),this.staticShapes.query(a,e),this.unlock(!0)},ac.prototype.shapeQuery=function(a,b){var c=a.body;c&&a.update(c.p,c.rot);var d=new R(a.bb_l,a.bb_b,a.bb_r,a.bb_t),e=!1,f=function(c){var d=a;if((!d.group||d.group!==c.group)&&d.layers&c.layers&&d!==c){var f;if(d.collisionCode<=c.collisionCode)f=$b(d,c);else{f=$b(c,d);for(var g=0;f.length>g;g++)f[g].n=z(f[g].n)}if(f.length&&(e=!(d.sensor||c.sensor),b)){for(var h=Array(f.length),g=0;f.length>g;g++)h[g]=new Hb(f[g].p,f[g].n,f[g].dist);b(c,h)}}};return this.lock(),this.activeShapes.query(d,f),this.staticShapes.query(d,f),this.unlock(!0),e},ac.prototype.addPostStepCallback=function(a){e(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(a)},ac.prototype.runPostStepCallbacks=function(){for(var a=0;this.postStepCallbacks.length>a;a++)this.postStepCallbacks[a]();this.postStepCallbacks=[]},ac.prototype.lock=function(){this.locked++},ac.prototype.unlock=function(a){if(this.locked--,d(this.locked>=0,"Internal Error: Space lock underflow."),0===this.locked&&a){for(var b=this.rousedBodies,c=0;b.length>c;c++)this.activateBody(b[c]);b.length=0,this.runPostStepCallbacks()}},ac.prototype.makeCollideShapes=function(){var a=this;return function(b,c){var d=a;if(b.bb_l<=c.bb_r&&c.bb_l<=b.bb_r&&b.bb_b<=c.bb_t&&c.bb_b<=b.bb_t&&b.body!==c.body&&(!b.group||b.group!==c.group)&&b.layers&c.layers){var e=d.lookupHandler(b.collision_type,c.collision_type),f=b.sensor||c.sensor;if(!f||e!==_b){if(b.collisionCode>c.collisionCode){var g=b;b=c,c=g}var i=$b(b,c);if(0!==i.length){var j=h(b.hashid,c.hashid),k=d.cachedArbiters[j];k||(k=d.cachedArbiters[j]=new Gb(b,c)),k.update(i,e,b,c),"first coll"!=k.state||e.begin(k,d)||k.ignore(),"ignore"!==k.state&&e.preSolve(k,d)&&!f?d.arbiters.push(k):(k.contacts=null,"ignore"!==k.state&&(k.state="normal")),k.stamp=d.stamp}}}}},ac.prototype.arbiterSetFilter=function(a){var b=this.stamp-a.stamp,c=a.body_a,d=a.body_b;return(c.isStatic()||c.isSleeping())&&(d.isStatic()||d.isSleeping())?!0:(b>=1&&"cached"!=a.state&&(a.callSeparate(this),a.state="cached"),b>=this.collisionPersistence?(a.contacts=null,!1):!0)};var hc=function(a){var b=a.body;a.update(b.p,b.rot)};ac.prototype.step=function(a){if(0!==a){d(0===s.x&&0===s.y,"vzero is invalid"),this.stamp++;var b=this.curr_dt;this.curr_dt=a;var c,e,f,g=this.bodies,h=this.constraints,i=this.arbiters;for(c=0;i.length>c;c++){var j=i[c];j.state="normal",j.body_a.isSleeping()||j.body_b.isSleeping()||j.unthread()}for(i.length=0,this.lock(),c=0;g.length>c;c++)g[c].position_func(a);this.activeShapes.each(hc),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(a),this.lock();for(f in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[f])||delete this.cachedArbiters[f];var k=this.collisionSlop,l=1-Math.pow(this.collisionBias,a);for(c=0;i.length>c;c++)i[c].preStep(a,k,l);for(c=0;h.length>c;c++){var m=h[c];m.preSolve(this),m.preStep(a)}var n=Math.pow(this.damping,a),o=this.gravity;for(c=0;g.length>c;c++)g[c].velocity_func(o,n,a);var p=0===b?0:a/b;for(c=0;i.length>c;c++)i[c].applyCachedImpulse(p);for(c=0;h.length>c;c++)h[c].applyCachedImpulse(p);for(c=0;this.iterations>c;c++){for(e=0;i.length>e;e++)i[e].applyImpulse();for(e=0;h.length>e;e++)h[e].applyImpulse()}for(c=0;h.length>c;c++)h[c].postSolve(this);for(c=0;i.length>c;c++)i[c].handler.postSolve(i[c],this);this.unlock(!0)}};var ic=function(a,b,c,d){var e=a.vx+-c.y*a.w,f=a.vy+c.x*a.w,g=b.vx+-d.y*b.w,h=b.vy+d.x*b.w;return new r(g-e,h-f)},jc=function(a,b,c,d,e){var f=a.vx+-c.y*a.w,g=a.vy+c.x*a.w,h=b.vx+-d.y*b.w,i=b.vy+d.x*b.w;return u(h-f,i-g,e.x,e.y)},kc=function(a,b,c,d){a.vx+=b*a.m_inv,a.vy+=c*a.m_inv,a.w+=a.i_inv*(d.x*c-d.y*b)},lc=function(a,b,c,d,e,f){kc(a,-e,-f,c),kc(b,e,f,d)},mc=function(a,b,c,d){a.v_biasx+=b*a.m_inv,a.v_biasy+=c*a.m_inv,a.w_bias+=a.i_inv*C(d.x,d.y,b,c)},nc=function(a,b,c){var d=B(b,c);return a.m_inv+a.i_inv*d*d},oc=function(a,b,c,d,f){var g=nc(a,c,f)+nc(b,d,f);return e(0!==g,"Unsolvable collision or constraint."),g},pc=function(a,b,c,d,f,g){var h,i,j,k,l=a.m_inv+b.m_inv;h=l,i=0,j=0,k=l;var m=a.i_inv,n=c.x*c.x*m,o=c.y*c.y*m,p=-c.x*c.y*m;h+=o,i+=p,j+=p,k+=n;var q=b.i_inv,r=d.x*d.x*q,s=d.y*d.y*q,t=-d.x*d.y*q;h+=s,i+=t,j+=t,k+=r;var u=h*k-i*j;e(0!==u,"Unsolvable constraint.");var v=1/u;f.x=k*v,f.y=-i*v,g.x=-j*v,g.y=h*v},qc=function(a,b,c){return new r(t(a,b),t(a,c))},rc=function(a,b){return 1-Math.pow(a,b)},sc=a.Constraint=function(a,b){this.a=a,this.b=b,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=1/0,this.errorBias=Math.pow(.9,60),this.maxBias=1/0};sc.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},sc.prototype.preStep=function(){},sc.prototype.applyCachedImpulse=function(){},sc.prototype.applyImpulse=function(){},sc.prototype.getImpulse=function(){return 0},sc.prototype.preSolve=function(){},sc.prototype.postSolve=function(){},sc.prototype.next=function(a){return this.a===a?this.next_a:this.next_b};var tc=a.PinJoint=function(a,b,c,d){sc.call(this,a,b),this.anchr1=c,this.anchr2=d;var f=a?x(a.p,F(c,a.rot)):c,g=b?x(b.p,F(d,b.rot)):d;this.dist=v(y(g,f)),e(this.dist>0,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};tc.prototype=Object.create(sc.prototype),tc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=F(this.anchr1,b.rot),this.r2=F(this.anchr2,c.rot);var d=y(x(c.p,this.r2),x(b.p,this.r1)),e=v(d);this.n=A(d,1/(e?e:1/0)),this.nMass=1/oc(b,c,this.r1,this.r2,this.n);var f=this.maxBias;this.bias=p(-rc(this.errorBias,a)*(e-this.dist)/a,-f,f),this.jnMax=this.maxForce*a},tc.prototype.applyCachedImpulse=function(a){var b=A(this.n,this.jnAcc*a);lc(this.a,this.b,this.r1,this.r2,b.x,b.y)},tc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=jc(a,b,this.r1,this.r2,c),e=(this.bias-d)*this.nMass,f=this.jnAcc;this.jnAcc=p(f+e,-this.jnMax,this.jnMax),e=this.jnAcc-f,lc(a,b,this.r1,this.r2,c.x*e,c.y*e)},tc.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var uc=a.SlideJoint=function(a,b,c,d,e,f){sc.call(this,a,b),this.anchr1=c,this.anchr2=d,this.min=e,this.max=f,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};uc.prototype=Object.create(sc.prototype),uc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=F(this.anchr1,b.rot),this.r2=F(this.anchr2,c.rot);var d=y(x(c.p,this.r2),x(b.p,this.r1)),e=v(d),f=0;e>this.max?(f=e-this.max,this.n=L(d)):this.min>e?(f=this.min-e,this.n=z(L(d))):(this.n=s,this.jnAcc=0),this.nMass=1/oc(b,c,this.r1,this.r2,this.n);var g=this.maxBias;this.bias=p(-rc(this.errorBias,a)*f/a,-g,g),this.jnMax=this.maxForce*a},uc.prototype.applyCachedImpulse=function(a){var b=this.jnAcc*a;lc(this.a,this.b,this.r1,this.r2,this.n.x*b,this.n.y*b)},uc.prototype.applyImpulse=function(){if(0!==this.n.x||0!==this.n.y){var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=ic(a,b,d,e),g=t(f,c),h=(this.bias-g)*this.nMass,i=this.jnAcc;this.jnAcc=p(i+h,-this.jnMax,0),h=this.jnAcc-i,lc(a,b,this.r1,this.r2,c.x*h,c.y*h)}},uc.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var vc=a.PivotJoint=function(a,b,c,d){if(sc.call(this,a,b),void 0===d){var e=c;c=a?a.world2Local(e):e,d=b?b.world2Local(e):e}this.anchr1=c,this.anchr2=d,this.r1=this.r2=s,this.k1=new r(0,0),this.k2=new r(0,0),this.jAcc=s,this.jMaxLen=0,this.bias=s};vc.prototype=Object.create(sc.prototype),vc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=F(this.anchr1,b.rot),this.r2=F(this.anchr2,c.rot),pc(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var d=y(x(c.p,this.r2),x(b.p,this.r1));this.bias=M(A(d,-rc(this.errorBias,a)/a),this.maxBias)},vc.prototype.applyCachedImpulse=function(a){lc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},vc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=ic(a,b,c,d),f=qc(y(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=M(x(this.jAcc,f),this.jMaxLen),lc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},vc.prototype.getImpulse=function(){return v(this.jAcc)};var wc=a.GrooveJoint=function(a,b,c,d,e){sc.call(this,a,b),this.grv_a=c,this.grv_b=d,this.grv_n=D(K(y(d,c))),this.anchr2=e,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new r(0,0),this.k2=new r(0,0),this.jAcc=s,this.jMaxLen=0,this.bias=null};wc.prototype=Object.create(sc.prototype),wc.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.local2World(this.grv_a),e=b.local2World(this.grv_b),f=F(this.grv_n,b.rot),g=t(d,f);this.grv_tn=f,this.r2=F(this.anchr2,c.rot);var h=B(x(c.p,this.r2),f);B(d,f)>=h?(this.clamp=1,this.r1=y(d,b.p)):h>=B(e,f)?(this.clamp=-1,this.r1=y(e,b.p)):(this.clamp=0,this.r1=y(x(A(D(f),-h),A(f,g)),b.p)),pc(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var i=y(x(c.p,this.r2),x(b.p,this.r1));this.bias=M(A(i,-rc(this.errorBias,a)/a),this.maxBias)},wc.prototype.applyCachedImpulse=function(a){lc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},wc.prototype.grooveConstrain=function(a){var b=this.grv_tn,c=this.clamp*B(a,b)>0?a:E(a,b);return M(c,this.jMaxLen)},wc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=ic(a,b,c,d),f=qc(y(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=this.grooveConstrain(x(g,f)),lc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},wc.prototype.getImpulse=function(){return v(this.jAcc)},wc.prototype.setGrooveA=function(a){this.grv_a=a,this.grv_n=D(K(y(this.grv_b,a))),this.activateBodies()},wc.prototype.setGrooveB=function(a){this.grv_b=a,this.grv_n=D(K(y(a,this.grv_a))),this.activateBodies()};var xc=function(a,b){return(a.restLength-b)*a.stiffness},yc=a.DampedSpring=function(a,b,c,d,e,f,g){sc.call(this,a,b),this.anchr1=c,this.anchr2=d,this.restLength=e,this.stiffness=f,this.damping=g,this.springForceFunc=xc,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};yc.prototype=Object.create(sc.prototype),yc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=F(this.anchr1,b.rot),this.r2=F(this.anchr2,c.rot);var d=y(x(c.p,this.r2),x(b.p,this.r1)),f=v(d);this.n=A(d,1/(f?f:1/0));var g=oc(b,c,this.r1,this.r2,this.n);e(0!==g,"Unsolvable this."),this.nMass=1/g,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*a*g);var h=this.springForceFunc(this,f);lc(b,c,this.r1,this.r2,this.n.x*h*a,this.n.y*h*a)},yc.prototype.applyCachedImpulse=function(){},yc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=jc(a,b,d,e,c),g=(this.target_vrn-f)*this.v_coef;this.target_vrn=f+g,g*=this.nMass,lc(a,b,this.r1,this.r2,this.n.x*g,this.n.y*g)},yc.prototype.getImpulse=function(){return 0};var zc=function(a,b){return(b-a.restAngle)*a.stiffness},Ac=a.DampedRotarySpring=function(a,b,c,d,e){sc.call(this,a,b),this.restAngle=c,this.stiffness=d,this.damping=e,this.springTorqueFunc=zc,this.target_wrn=0,this.w_coef=0,this.iSum=0};Ac.prototype=Object.create(sc.prototype),Ac.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.i_inv+c.i_inv;e(0!==d,"Unsolvable spring."),this.iSum=1/d,this.w_coef=1-Math.exp(-this.damping*a*d),this.target_wrn=0;var f=this.springTorqueFunc(this,b.a-c.a)*a;b.w-=f*b.i_inv,c.w+=f*c.i_inv},Ac.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=a.w-b.w,d=(this.target_wrn-c)*this.w_coef;this.target_wrn=c+d;var e=d*this.iSum;a.w+=e*a.i_inv,b.w-=e*b.i_inv};var Bc=a.RotaryLimitJoint=function(a,b,c,d){sc.call(this,a,b),this.min=c,this.max=d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Bc.prototype=Object.create(sc.prototype),Bc.prototype.preStep=function(a){var b=this.a,c=this.b,d=c.a-b.a,e=0;d>this.max?e=this.max-d:this.min>d&&(e=this.min-d),this.iSum=1/(1/b.i+1/c.i);var f=this.maxBias;this.bias=p(-rc(this.errorBias,a)*e/a,-f,f),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},Bc.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},Bc.prototype.applyImpulse=function(){if(this.bias){var a=this.a,b=this.b,c=b.w-a.w,d=-(this.bias+c)*this.iSum,e=this.jAcc;this.jAcc=0>this.bias?p(e+d,0,this.jMax):p(e+d,-this.jMax,0),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv}},Bc.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var Cc=a.RatchetJoint=function(a,b,c,d){sc.call(this,a,b),this.angle=0,this.phase=c,this.ratchet=d,this.angle=(b?b.a:0)-(a?a.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};Cc.prototype=Object.create(sc.prototype),Cc.prototype.preStep=function(a){var b=this.a,c=this.b,d=this.angle,e=this.phase,f=this.ratchet,g=c.a-b.a,h=d-g,i=0;h*f>0?i=h:this.angle=Math.floor((g-e)/f)*f+e,this.iSum=1/(b.i_inv+c.i_inv);var j=this.maxBias;this.bias=p(-rc(this.errorBias,a)*i/a,-j,j),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},Cc.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},Cc.prototype.applyImpulse=function(){if(this.bias){var a=this.a,b=this.b,c=b.w-a.w,d=this.ratchet,e=-(this.bias+c)*this.iSum,f=this.jAcc;this.jAcc=p((f+e)*d,0,this.jMax*Math.abs(d))/d,e=this.jAcc-f,a.w-=e*a.i_inv,b.w+=e*b.i_inv}},Cc.prototype.getImpulse=function(a){return Math.abs(a.jAcc)};var Dc=a.GearJoint=function(a,b,c,d){sc.call(this,a,b),this.phase=c,this.ratio=d,this.ratio_inv=1/d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Dc.prototype=Object.create(sc.prototype),Dc.prototype.preStep=function(a){var b=this.a,c=this.b;this.iSum=1/(b.i_inv*this.ratio_inv+this.ratio*c.i_inv);var d=this.maxBias;this.bias=p(-rc(this.errorBias,a)*(c.a*this.ratio-b.a-this.phase)/a,-d,d),this.jMax=this.maxForce*a},Dc.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv*this.ratio_inv,c.w+=d*c.i_inv},Dc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w*this.ratio-a.w,d=(this.bias-c)*this.iSum,e=this.jAcc;this.jAcc=p(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv*this.ratio_inv,b.w+=d*b.i_inv},Dc.prototype.getImpulse=function(){return Math.abs(this.jAcc)},Dc.prototype.setRatio=function(a){this.ratio=a,this.ratio_inv=1/a,this.activateBodies()};var Ec=a.SimpleMotor=function(a,b,c){sc.call(this,a,b),this.rate=c,this.jAcc=0,this.iSum=this.jMax=0};Ec.prototype=Object.create(sc.prototype),Ec.prototype.preStep=function(a){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*a},Ec.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},Ec.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w-a.w+this.rate,d=-c*this.iSum,e=this.jAcc;this.jAcc=p(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv},Ec.prototype.getImpulse=function(){return Math.abs(this.jAcc)}}(),function(){function a(a){var c=!1;return function(){if(c)throw new Error("Callback was already called.");c=!0,a.apply(b,arguments)}}var b,c,d={};b=this,null!=b&&(c=b.async),d.noConflict=function(){return b.async=c,d};var e=Object.prototype.toString,f=Array.isArray||function(a){return"[object Array]"===e.call(a)},g=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},h=function(a,b){if(a.map)return a.map(b);var c=[];return g(a,function(a,d,e){c.push(b(a,d,e))}),c},i=function(a,b,c){return a.reduce?a.reduce(b,c):(g(a,function(a,d,e){c=b(c,a,d,e)}),c)},j=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};"undefined"!=typeof process&&process.nextTick?(d.nextTick=process.nextTick,d.setImmediate="undefined"!=typeof setImmediate?function(a){setImmediate(a)}:d.nextTick):"function"==typeof setImmediate?(d.nextTick=function(a){setImmediate(a)},d.setImmediate=d.nextTick):(d.nextTick=function(a){setTimeout(a,0)},d.setImmediate=d.nextTick),d.each=function(b,c,d){function e(a){a?(d(a),d=function(){}):(f+=1,f>=b.length&&d())}if(d=d||function(){},!b.length)return d();var f=0;g(b,function(b){c(b,a(e))})},d.forEach=d.each,d.eachSeries=function(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():e())})};e()},d.forEachSeries=d.eachSeries,d.eachLimit=function(a,b,c,d){var e=k(b);e.apply(null,[a,c,d])},d.forEachLimit=d.eachLimit;var k=function(a){return function(b,c,d){if(d=d||function(){},!b.length||0>=a)return d();var e=0,f=0,g=0;!function h(){if(e>=b.length)return d();for(;a>g&&f<b.length;)f+=1,g+=1,c(b[f-1],function(a){a?(d(a),d=function(){}):(e+=1,g-=1,e>=b.length?d():h())})}()}},l=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[d.each].concat(b))}},m=function(a,b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[k(a)].concat(c))}},n=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[d.eachSeries].concat(b))}},o=function(a,b,c,d){if(b=h(b,function(a,b){return{index:b,value:a}}),d){var e=[];a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})}else a(b,function(a,b){c(a.value,function(a){b(a)})})};d.map=l(o),d.mapSeries=n(o),d.mapLimit=function(a,b,c,d){return p(b)(a,c,d)};var p=function(a){return m(a,o)};d.reduce=function(a,b,c,e){d.eachSeries(a,function(a,d){c(b,a,function(a,c){b=c,d(a)})},function(a){e(a,b)})},d.inject=d.reduce,d.foldl=d.reduce,d.reduceRight=function(a,b,c,e){var f=h(a,function(a){return a}).reverse();d.reduce(f,b,c,e)},d.foldr=d.reduceRight;var q=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&e.push(a),b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};d.filter=l(q),d.filterSeries=n(q),d.select=d.filter,d.selectSeries=d.filterSeries;var r=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||e.push(a),b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};d.reject=l(r),d.rejectSeries=n(r);var s=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(){d()})};d.detect=l(s),d.detectSeries=n(s),d.some=function(a,b,c){d.each(a,function(a,d){b(a,function(a){a&&(c(!0),c=function(){}),d()})},function(){c(!1)})},d.any=d.some,d.every=function(a,b,c){d.each(a,function(a,d){b(a,function(a){a||(c(!1),c=function(){}),d()})},function(){c(!0)})},d.all=d.every,d.sortBy=function(a,b,c){d.map(a,function(a,c){b(a,function(b,d){b?c(b):c(null,{value:a,criteria:d})})},function(a,b){if(a)return c(a);var d=function(a,b){var c=a.criteria,d=b.criteria;return d>c?-1:c>d?1:0};c(null,h(b.sort(d),function(a){return a.value}))})},d.auto=function(a,b){b=b||function(){};var c=j(a),e=c.length;if(!e)return b();var h={},k=[],l=function(a){k.unshift(a)},m=function(a){for(var b=0;b<k.length;b+=1)if(k[b]===a)return void k.splice(b,1)},n=function(){e--,g(k.slice(0),function(a){a()})};l(function(){if(!e){var a=b;b=function(){},a(null,h)}}),g(c,function(c){var e=f(a[c])?a[c]:[a[c]],k=function(a){var e=Array.prototype.slice.call(arguments,1);if(e.length<=1&&(e=e[0]),a){var f={};g(j(h),function(a){f[a]=h[a]}),f[c]=e,b(a,f),b=function(){}}else h[c]=e,d.setImmediate(n)},o=e.slice(0,Math.abs(e.length-1))||[],p=function(){return i(o,function(a,b){return a&&h.hasOwnProperty(b)},!0)&&!h.hasOwnProperty(c)};if(p())e[e.length-1](k,h);else{var q=function(){p()&&(m(q),e[e.length-1](k,h))};l(q)}})},d.retry=function(a,b,c){var e=5,f=[];"function"==typeof a&&(c=b,b=a,a=e),a=parseInt(a,10)||e;var g=function(e,g){for(var h=function(a,b){return function(c){a(function(a,d){c(!a||b,{err:a,result:d})},g)}};a;)f.push(h(b,!(a-=1)));d.series(f,function(a,b){b=b[b.length-1],(e||c)(b.err,b.result)})};return c?g():g},d.waterfall=function(a,b){if(b=b||function(){},!f(a)){var c=new Error("First argument to waterfall must be an array of functions");return b(c)}if(!a.length)return b();var e=function(a){return function(c){if(c)b.apply(null,arguments),b=function(){};else{var f=Array.prototype.slice.call(arguments,1),g=a.next();f.push(g?e(g):b),d.setImmediate(function(){a.apply(null,f)})}}};e(d.iterator(a))()};var t=function(a,b,c){if(c=c||function(){},f(b))a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(j(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};d.parallel=function(a,b){t({map:d.map,each:d.each},a,b)},d.parallelLimit=function(a,b,c){t({map:p(b),each:k(b)},a,c)},d.series=function(a,b){if(b=b||function(){},f(a))d.mapSeries(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};d.eachSeries(j(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}},d.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return c<a.length-1?b(c+1):null},d};return b(0)},d.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var u=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};d.concat=l(u),d.concatSeries=n(u),d.whilst=function(a,b,c){a()?b(function(e){return e?c(e):void d.whilst(a,b,c)}):c()},d.doWhilst=function(a,b,c){a(function(e){if(e)return c(e);var f=Array.prototype.slice.call(arguments,1);b.apply(null,f)?d.doWhilst(a,b,c):c()})},d.until=function(a,b,c){a()?c():b(function(e){return e?c(e):void d.until(a,b,c)})},d.doUntil=function(a,b,c){a(function(e){if(e)return c(e);var f=Array.prototype.slice.call(arguments,1);b.apply(null,f)?c():d.doUntil(a,b,c)})},d.queue=function(b,c){function e(a,b,c,e){return a.started||(a.started=!0),f(b)||(b=[b]),0==b.length?d.setImmediate(function(){a.drain&&a.drain()}):void g(b,function(b){var f={data:b,callback:"function"==typeof e?e:null};c?a.tasks.unshift(f):a.tasks.push(f),a.saturated&&a.tasks.length===a.concurrency&&a.saturated(),d.setImmediate(a.process)})}void 0===c&&(c=1);var h=0,i={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(a,b){e(i,a,!1,b)},kill:function(){i.drain=null,i.tasks=[]},unshift:function(a,b){e(i,a,!0,b)},process:function(){if(!i.paused&&h<i.concurrency&&i.tasks.length){var c=i.tasks.shift();i.empty&&0===i.tasks.length&&i.empty(),h+=1;var d=function(){h-=1,c.callback&&c.callback.apply(c,arguments),i.drain&&i.tasks.length+h===0&&i.drain(),i.process()},e=a(d);b(c.data,e)}},length:function(){return i.tasks.length},running:function(){return h},idle:function(){return i.tasks.length+h===0},pause:function(){i.paused!==!0&&(i.paused=!0,i.process())},resume:function(){i.paused!==!1&&(i.paused=!1,i.process())}};return i},d.cargo=function(a,b){var c=!1,e=[],i={tasks:e,payload:b,saturated:null,empty:null,drain:null,drained:!0,push:function(a,c){f(a)||(a=[a]),g(a,function(a){e.push({data:a,callback:"function"==typeof c?c:null}),i.drained=!1,i.saturated&&e.length===b&&i.saturated()}),d.setImmediate(i.process)},process:function j(){if(!c){if(0===e.length)return i.drain&&!i.drained&&i.drain(),void(i.drained=!0);var d="number"==typeof b?e.splice(0,b):e.splice(0,e.length),f=h(d,function(a){return a.data});i.empty&&i.empty(),c=!0,a(f,function(){c=!1;var a=arguments;g(d,function(b){b.callback&&b.callback.apply(null,a)}),j()})}},length:function(){return e.length},running:function(){return c}};return i};var v=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(b?console.error&&console.error(b):console[a]&&g(c,function(b){console[a](b)
}))}]))}};d.log=v("log"),d.dir=v("dir"),d.memoize=function(a,b){var c={},e={};b=b||function(a){return a};var f=function(){var f=Array.prototype.slice.call(arguments),g=f.pop(),h=b.apply(null,f);h in c?d.nextTick(function(){g.apply(null,c[h])}):h in e?e[h].push(g):(e[h]=[g],a.apply(null,f.concat([function(){c[h]=arguments;var a=e[h];delete e[h];for(var b=0,d=a.length;d>b;b++)a[b].apply(null,arguments)}])))};return f.memo=c,f.unmemoized=a,f},d.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}},d.times=function(a,b,c){for(var e=[],f=0;a>f;f++)e.push(f);return d.map(e,b,c)},d.timesSeries=function(a,b,c){for(var e=[],f=0;a>f;f++)e.push(f);return d.mapSeries(e,b,c)},d.seq=function(){var a=arguments;return function(){var b=this,c=Array.prototype.slice.call(arguments),e=c.pop();d.reduce(a,c,function(a,c,d){c.apply(b,a.concat([function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);d(a,b)}]))},function(a,c){e.apply(b,[a].concat(c))})}},d.compose=function(){return d.seq.apply(null,Array.prototype.reverse.call(arguments))};var w=function(a,b){var c=function(){var c=this,d=Array.prototype.slice.call(arguments),e=d.pop();return a(b,function(a,b){a.apply(c,d.concat([b]))},e)};if(arguments.length>2){var d=Array.prototype.slice.call(arguments,2);return c.apply(this,d)}return c};d.applyEach=l(w),d.applyEachSeries=n(w),d.forever=function(a,b){function c(d){if(d){if(b)return b(d);throw d}a(c)}c()},"undefined"!=typeof module&&module.exports?module.exports=d:"undefined"!=typeof define&&define.amd?define([],function(){return d}):b.async=d}();var ARE,AREActorInterface,AREAnimationInterface,AREBezAnimation,ARECircleActor,AREColor3,AREEngineInterface,AREInterface,ARELog,AREPolygonActor,AREPsyxAnimation,ARERawActor,ARERectangleActor,ARERenderer,AREShader,ARETriangleActor,AREVector2,AREVertAnimation,PhysicsManager,nextHighestPowerOfTwo,precision,precision_declaration,varying_precision,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};ARERawActor=function(){function a(a,b,c){this._renderer=a,this._initializeValues(),this._id=this._renderer.getNextId(),this._renderer.addActor(this),this._renderer.getGL()&&(this._indiceBuffer=this._renderer.getGL().createBuffer()),this._ownIndiceBuffer=this._indiceBuffer,this._hasOwnIndiceBuffer=!0,this._hostActorId=null,this._vertexData=null,this._vertStride=4*Float32Array.BYTES_PER_ELEMENT,this._uvOffset=2*Float32Array.BYTES_PER_ELEMENT,this.updateVertices(b,c),this.setColor(new AREColor3(255,255,255)),this.clearTexture()}return a.defaultFriction=.3,a.defaultMass=10,a.defaultElasticity=.2,a.prototype._initializeValues=function(){if(this._renderer.isWGLRendererActive()&&!(this._gl=this._renderer.getGL()))throw new Error("GL context is required for actor initialization!");return this._color=null,this._strokeColor=null,this._strokeWidth=1,this._colArray=null,this._opacity=1,this._needsDelete=!1,this._visible=!0,this.layer=0,this._physicsLayer=-1,this._id=-1,this._position={x:0,y:0},this._rotation=0,this._bounds={w:0,h:0},this._initializeModelMatrix(),this._updateModelMatrix(),this._physics=!1,this._friction=null,this._mass=null,this._elasticity=null,this._vertices=[],this._psyxVertices=[],this._texVerts=[],this._origTexVerts=[],this._vertBuffer=null,this._vertBufferFloats=null,this._sh_handles={},this._renderMode=ARERenderer.GL_MODE_TRIANGLE_FAN,this._renderStyle=ARERenderer.RENDER_STYLE_FILL,this._texture=null,this._clipRect=[0,0,1,1],this._attachedTexture=null,this.attachedTextureAnchor={clipRect:[0,0,1,1],x:0,y:0,width:0,height:0,angle:0}},a.prototype.getRenderer=function(){return this._renderer},a.prototype.flagForDelete=function(){return this._needsDelete=!0},a.prototype.flaggedForDeletion=function(){return this._needsDelete},a.prototype.destroy=function(){return this.flagForDelete()},a.prototype.rendererActorDelete=function(){var a,b,c,d;for(this.destroyPhysicsBody(),b=_.filter(this._renderer._actors,function(a){return!a.hasOwnIndiceBuffer()}),c=0,d=b.length;d>c;c++)a=b[c],a.getHostId()===this._id&&a.clearHostIndiceBuffer();return this._renderer.getGL().deleteBuffer(this._ownIndiceBuffer)},a.prototype.getIndiceBuffer=function(){return this._ownIndiceBuffer},a.prototype.getUsedIndiceBuffer=function(){return this._ownIndiceBuffer},a.prototype.setHostIndiceBuffer=function(a,b){return this._indiceBuffer=a,this._hostActorId=b,this._hasOwnIndiceBuffer=!1,this._renderer.requestVBORefresh()},a.prototype.getHostId=function(){return this._hostActorId},a.prototype.clearHostIndiceBuffer=function(){return this._indiceBuffer=this._ownIndiceBuffer,this._hasOwnIndiceBuffer=!0,this._hostActorId=null,this._renderer.requestVBORefresh()},a.prototype.hasOwnIndiceBuffer=function(){return this._hasOwnIndiceBuffer},a.prototype.getMaterial=function(){return this._material},a.prototype.getLayer=function(){return this.layer},a.prototype.setLayer=function(a){return this.layer=a,this._renderer.removeActor(this,!0),this._renderer.addActor(this,a)},a.prototype.hasTexture=function(){return!!this._texture},a.prototype.setTexture=function(a){if(!this._renderer.hasTexture(a))throw new Error("No such texture loaded: "+a);return this._texture=this._renderer.getTexture(a),this.setShader(this._renderer.getTextureShader()),this._material=ARERenderer.MATERIAL_TEXTURE,this},a.prototype.clearTexture=function(){return this._texture=void 0,this._texRepeatX=1,this._texRepeatY=1,this._renderer.getDefaultShader()&&this.setShader(this._renderer.getDefaultShader()),this._material=ARERenderer.MATERIAL_FLAT,this},a.prototype.getTexture=function(){return this._texture},a.prototype.getTextureRepeat=function(){return{x:this._texRepeatX,y:this._texRepeatY}},a.prototype.setShader=function(a){if(this._renderer.isWGLRendererActive()){if(!a.getProgram())throw new Error("Shader has to be built before it can be used!");return a.getHandles()||a.generateHandles(),this._sh_handles=a.getHandles()}},a.prototype.hasPhysics=function(){return this._physics},a.prototype.createPhysicsBody=function(b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q;if(this._mass=b,this._friction=c,this._elasticity=d,!this._physics&&!isNaN(this._mass)){for(e=!!e,this._friction||(this._friction=a.defaultFriction),this._elasticity||(this._elasticity=a.defaultElasticity),this._mass<0&&(this._mass=0),this._friction&&(this._friction=0),this._elasticity<0&&(this._elasticity=0),m=[],l=0,j=null,j=this._psyxVertices.length>6?this._psyxVertices:this._vertices,i=p=0,q=j.length-1;q>p;i=p+=2)m.push(j[i]),m.push(j[i+1]),0===this._mass&&(n=m[m.length-2],o=m[m.length-1],f=this._rotation,m[m.length-2]=n*Math.cos(f)-o*Math.sin(f),m[m.length-1]=n*Math.sin(f)+o*Math.cos(f));return g=null,k={id:this._id,type:"Polygon",vertices:m,"static":!1,position:this._position,friction:this._friction,elasticity:this._elasticity,layer:this._physicsLayer},0===this._mass?(k["static"]=!0,k.position=this._position):(g={id:this._id,position:this._position,angle:this._rotation,mass:this._mass,momentV:{x:0,y:0},vertices:m},k.position={x:0,y:0}),this._physics=!0,window.AREPhysicsManager.sendMessage({},"physics.enable"),g&&(h=e?"physics.body.refresh":"physics.body.create",window.AREPhysicsManager.sendMessage({def:g,id:this._id},h)),k&&(h=e?"physics.shape.refresh":"physics.shape.create",window.AREPhysicsManager.sendMessage({def:k,id:this._id},h)),this}},a.prototype.destroyPhysicsBody=function(){return this._physics?(window.AREPhysicsManager.sendMessage({id:this._id},"physics.shape.remove"),0!==this._mass&&window.AREPhysicsManager.sendMessage({id:this._id},"physics.body.remove"),this._physics=!1,this):void 0},a.prototype.enablePhysics=function(){return this.hasPhysics()||this.createPhysicsBody(),this},a.prototype.disablePhysics=function(){return this.hasPhysics()&&this.destroyPhysicsBody,this},a.prototype.refreshPhysics=function(){return this.hasPhysics()?this.createPhysicsBody(this._mass,this._friction,this._elasticity,!0):void 0},a.prototype.getMass=function(){return this._mass},a.prototype.getElasticity=function(){return this._elasticity},a.prototype.getFriction=function(){return this._friction},a.prototype.setMass=function(a){return this._mass=a,this.refreshPhysics(),this},a.prototype.setElasticity=function(a){return this._elasticity=a,this.refreshPhysics(),this},a.prototype.setFriction=function(a){return this._friction=a,this.refreshPhysics(),this},a.prototype.getMass=function(){return this._mass},a.prototype.getElasticity=function(){return this._elasticity},a.prototype.getFriction=function(){return this._friction},a.prototype.setMass=function(a){return this._mass=a,this.refreshPhysics(),this},a.prototype.setElasticity=function(a){return this._elasticity=a,this.refreshPhysics(),this},a.prototype.setFriction=function(a){return this._friction=a,this.refreshPhysics(),this},a.prototype.getPhysicsLayer=function(){return this._physicsLayer.toString(2).length-1},a.prototype.setPhysicsLayer=function(a){return this._physicsLayer=1<<a,window.AREPhysicsManager.sendMessage({id:this._id,layer:this._physicsLayer},"physics.shape.set.layer")},a.prototype.updateVertices=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;if(i=a||this._vertices,h=b||this._texVerts,i.length<6)throw new Error("At least 3 vertices make up an actor");if(h!==this._texVerts)if(i!==this._vertices){if(i.length!==h.length)throw new Error("Vert and UV count must match!")}else if(this._vertices.length!==h.length)throw new Error("Vert and UV count must match!");for(this._vertices=i,this._texVerts=h,this._origTexVerts=h,this._vertexData=[],c=j=0,l=this._vertices.length/2;l>=0?l>j:j>l;c=l>=0?++j:--j)this._vertexData.push(this._vertices[2*c]),this._vertexData.push(this._vertices[2*c+1]),this._vertexData.push(this._texVerts[2*c]),this._vertexData.push(this._texVerts[2*c+1]);for(this._vertCount=this._vertexData.length/4,d=0,e=0,f=0,g=0,c=k=1,m=this._vertices.length/2;m>=1?m>=k:k>=m;c=m>=1?++k:--k)d>this._vertices[2*c]&&(d=this._vertices[2*c]),f<this._vertices[2*c]&&(f=this._vertices[2*c]),e>this._vertices[2*c+1]&&(e=this._vertices[2*c+1]),g<this._vertices[2*c+1]&&(g=this._vertices[2*c+1]);return this._bounds={w:f-d,h:g-e},this._onSizeChange&&this._onSizeChange(this._bounds),this._renderer.requestVBORefresh()},a.prototype.updateIndices=function(a){var b;return b=new Uint16Array(a),this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._indiceBuffer),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,b,this._gl.STATIC_DRAW)},a.prototype.getRawVertexData=function(){return this._vertexData},a.prototype.setTextureRepeat=function(a,b){var c,d,e,f;for(a||(a=1),b||(b=1),d=[],c=e=0,f=this._origTexVerts.length;f>e;c=e+=2)d.push(this._origTexVerts[c]/this._texRepeatX*a),d.push(this._origTexVerts[c+1]/this._texRepeatY*b);return this._texRepeatX=a,this._texRepeatY=b,this.updateVertices(this._vertices,d),this},a.prototype.setPhysicsVertices=function(a){return this._psyxVertices=a,this.refreshPhysics()},a.prototype.attachTexture=function(a,b,c,d,e,f){if(this.attachedTextureAnchor.width=b,this.attachedTextureAnchor.height=c,this.attachedTextureAnchor.x=d||0,this.attachedTextureAnchor.y=e||0,this.attachedTextureAnchor.angle=f||0,!this._renderer.hasTexture(a))throw new Error("No such texture loaded: "+a);return this._attachedTexture&&this.removeAttachment(),this._attachedTexture=new ARERectangleActor(b,c),this._attachedTexture.setTexture(a),this._attachedTexture},a.prototype.removeAttachment=function(){return this._attachedTexture?(this._attachedTexture.destroy(),!0):!1},a.prototype.setAttachmentVisibility=function(a){return this._attachedTexture?(this._attachedTexture._visible=a,!0):!1},a.prototype.hasAttachment=function(){return null!==this._attachedTexture},a.prototype.getAttachment=function(){return this._attachedTexture},a.prototype.updateAttachment=function(){var a,b,c;return this.hasAttachment()&&this.getAttachment()._visible?(b=this.getPosition(),c=this.getRotation(),b.x+=this.attachedTextureAnchor.x,b.y+=this.attachedTextureAnchor.y,c+=this.attachedTextureAnchor.angle,a=this.getAttachment(),a.setPosition(b),a.setRotation(c),a):this},a.prototype.wglBindTexture=function(a){return this._renderer._currentTexture=this._texture.texture,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this._texture.texture),a.uniform1i(this._sh_handles.uSampler,0),this},a.prototype._updateModelMatrix=function(){var a,b,c,d;return c=this._position,b=this._renderer.getCameraPosition(),d=Math.sin(this._rotation),a=Math.cos(this._rotation),this._modelM[0]=a,this._modelM[1]=d,this._modelM[4]=-d,this._modelM[5]=a,this._modelM[12]=c.x-b.x,this._modelM[13]=c.y-b.y},a.prototype._initializeModelMatrix=function(){return this._modelM=[16],this._modelM[2]=0,this._modelM[3]=0,this._modelM[6]=0,this._modelM[7]=0,this._modelM[8]=0,this._modelM[9]=0,this._modelM[10]=1,this._modelM[11]=0,this._modelM[14]=1,this._modelM[15]=1},a.prototype.wglDraw=function(a,b){var c;if(this._visible){switch(this._updateModelMatrix(),b&&(c=this._sh_handles,this._sh_handles=b.getHandles()),a.uniformMatrix4fv(this._sh_handles.uModelView,!1,this._modelM),a.uniform4f(this._sh_handles.uColor,this._colArray[0],this._colArray[1],this._colArray[2],1),this._sh_handles.uClipRect&&a.uniform4fv(this._sh_handles.uClipRect,this._clipRect),a.uniform1f(this._sh_handles.uOpacity,this._opacity),a.enableVertexAttribArray(this._sh_handles.aPosition),a.vertexAttribPointer(this._sh_handles.aPosition,2,a.FLOAT,!1,this._vertStride,0),void 0!==this._sh_handles.aTexCoord&&(a.enableVertexAttribArray(this._sh_handles.aTexCoord),a.vertexAttribPointer(this._sh_handles.aTexCoord,2,a.FLOAT,!1,this._vertStride,this._uvOffset)),this._renderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE&&this._renderer._currentTexture!==this._texture.texture&&this.wglBindTexture(a),this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._indiceBuffer),this._renderMode){case ARERenderer.GL_MODE_LINE_LOOP:a.drawElements(a.LINE_LOOP,this._vertCount,a.UNSIGNED_SHORT,0);break;case ARERenderer.GL_MODE_TRIANGLE_FAN:a.drawElements(a.TRIANGLE_FAN,this._vertCount,a.UNSIGNED_SHORT,0);break;case ARERenderer.GL_MODE_TRIANGLE_STRIP:a.drawElements(a.TRIANGLE_STRIP,this._vertCount,a.UNSIGNED_SHORT,0);break;default:throw new Error("Invalid render mode! "+this._renderMode)}return b&&(this._sh_handles=c),this}},a.prototype.cvSetupStyle=function(a){var b,c,d,e;return a.lineWidth=null!==this._strokeWidth?this._strokeWidth:1,this._strokeColor?(e=Number(this._strokeColor._r).toFixed(0),d=Number(this._strokeColor._g).toFixed(0),c=Number(this._strokeColor._b).toFixed(0),b=Number(this._opacity).toFixed(4),a.strokeStyle="rgba("+e+","+d+","+c+","+b+")"):a.strokeStyle="#FFF",this._renderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE||(this._color?(e=Number(this._color._r).toFixed(0),d=Number(this._color._g).toFixed(0),c=Number(this._color._b).toFixed(0),b=Number(this._opacity).toFixed(4),a.fillStyle="rgba("+e+","+d+","+c+","+b+")"):a.fillStyle="#FFF"),this},a.prototype.cvDraw=function(a){var b,c,d;if(this._visible){for(this._updateModelMatrix(),a.translate(this._modelM[12],a.canvas.clientHeight-this._modelM[13]),a.beginPath(),a.rotate(this._rotation),a.moveTo(this._vertices[0],this._vertices[1]),b=c=1,d=this._vertices.length/2;d>=1?d>=c:c>=d;b=d>=1?++c:--c)a.lineTo(this._vertices[2*b],this._vertices[2*b+1]);switch(a.closePath(),this.cvSetupStyle(a),a.scale(1,-1),this._renderMode){case ARERenderer.GL_MODE_LINE_LOOP:a.stroke();break;case ARERenderer.GL_MODE_TRIANGLE_STRIP:case ARERenderer.GL_MODE_TRIANGLE_FAN:(this._renderStyle&ARERenderer.RENDER_STYLE_STROKE)>0&&a.stroke(),(this._renderStyle&ARERenderer.RENDER_STYLE_FILL)>0&&(this._renderer._currentMaterial===ARERenderer.MATERIAL_TEXTURE?(a.clip(),a.drawImage(this._texture.texture,-this._bounds.w/2,-this._bounds.h/2,this._bounds.w,this._bounds.h)):a.fill());break;default:throw new Error("Invalid render mode! "+this._renderMode)}return this}},a.prototype.nullDraw=function(){return this._visible?this:void 0},a.prototype.setRenderMode=function(a){return this._renderMode=a,this},a.prototype.setRenderStyle=function(a){return this._renderStyle=a,this},a.prototype.setOpacity=function(a){return this._opacity=a,this},a.prototype.setOnOrientationChange=function(a){return this._onOrientationChange=a},a.prototype.setOnSizeChange=function(a){return this._onSizeChange=a},a.prototype.setPosition=function(a){return this._position=a,this.hasPhysics()&&window.AREPhysicsManager.sendMessage({id:this._id,position:this._position},"physics.body.set.position"),this._onOrientationChange&&this._onOrientationChange({position:this._position}),this},a.prototype.setRotation=function(a,b){return b=!!b,b||(a=.0174532925*Number(a)),this._rotation!==a?(this._rotation=a,this.hasPhysics()&&(this._mass>0?window.AREPhysicsManager.sendMessage({id:this._id,rotation:this._rotation},"physics.body.set.rotation"):this.refreshPhysics()),this._onOrientationChange&&this._onOrientationChange({rotation:this._rotation}),this):void 0},a.prototype.setStrokeWidth=function(a){return this._strokeWidth=Number(a),this},a.prototype.setColor_ext=function(a,b,c,d){return b instanceof AREColor3?(a.setR(b.getR()),a.setG(b.getG()),a.setB(b.getB())):(isNaN(b.g)||isNaN(b.b)||(c=b.g,d=b.b,b=b.r),a.setR(Number(b)),a.setG(Number(c)),a.setB(Number(d))),this},a.prototype.setColor=function(a,b,c){return this._color||(this._color=new AREColor3),this.setColor_ext(this._color,a,b,c),this._colArray=[this._color.getR(!0),this._color.getG(!0),this._color.getB(!0)],this},a.prototype.setStrokeColor=function(a,b,c){return this._strokeColor||(this._strokeColor=new AREColor3),this.setColor_ext(this._strokeColor,a,b,c),this._strokeColorArray=[this._strokeColor.getR(!0),this._strokeColor.getG(!0),this._strokeColor.getB(!0)],this},a.prototype.setVisible=function(a){return this._visible=a,this},a.prototype.getOpacity=function(){return this._opacity},a.prototype.getPosition=function(){return this._position},a.prototype.getBounds=function(){return this._bounds},a.prototype.getRotation=function(a){return a?this._rotation:57.2957795*this._rotation},a.prototype.getVertices=function(){return this._vertices},a.prototype.getId=function(){return this._id},a.prototype.getColor=function(){return new AREColor3(this._color)},a.prototype.getVisible=function(){return this._visible},a.updateCount=0,a.lastTime=Date.now(),a.prototype.receiveMessage=function(a,b){var c;if(-1!==b.indexOf("actor.")&&a.id&&a.id===this._id)switch(c=b.split("."),c[1]){case"update":if(this._position=a.position,this._rotation=a.rotation,this._onOrientationChange)return this._onOrientationChange({position:this._position,rotation:this._rotation})}},a}(),ARERectangleActor=function(a){function b(a,c,d){var e,f;if(this.width=c,this.height=d,0>=c)throw new Error("Invalid width: "+c);if(0>=d)throw new Error("Invalid height: "+d);f=this.generateVertices(),e=this.generateUVs(),b.__super__.constructor.call(this,a,f,e)}return __extends(b,a),b.prototype.generateVertices=function(){var a,b;return b=this.width/2,a=this.height/2,[-b,-a,-b,a,b,a,b,-a,-b,-a]},b.prototype.generateUVs=function(){return[0,1,0,0,1,0,1,1,0,1]},b.prototype.getWidth=function(){return this.width},b.prototype.getHeight=function(){return this.height},b.prototype.setWidth=function(a){return this.width=a,this.updateVertices(this.generateVertices())},b.prototype.setHeight=function(a){return this.height=a,this.updateVertices(this.generateVertices())},b}(ARERawActor),AREPolygonActor=function(a){function b(a,c,d){var e,f,g;if(this.radius=c,this.segments=d,this.radius instanceof Array)this._verts=this.radius,this.radius=null,f=this.generateUVs(this._verts),b.__super__.constructor.call(this,a,this._verts,f),this.setPhysicsVertices(this._verts);else{if(0>=c)throw new Error("Invalid radius: "+c);if(2>=d)throw new Error("Invalid segment count: "+d);g=this.generateVertices(),e=this.generateVertices({mode:"physics"}),f=this.generateUVs(g),b.__super__.constructor.call(this,a,g,f),this.setPhysicsVertices(e)}this.setRenderMode(ARERenderer.GL_MODE_TRIANGLE_FAN),this.validateCacheEntry()}return __extends(b,a),b._INDICE_BUFFER_CACHE={},b._VERTEX_CACHE={},b._UV_CACHE={},b.prototype.generateVertices=function(a){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(a||(a={}),c=""+this.radius+"."+this.segments+"."+a.mode,d=b._VERTEX_CACHE[c])return d;for(l=this.radius,m=0,h=6.2831852/this.segments,g=Math.tan(h),f=Math.cos(h),k=[],e=n=0,p=this.segments;p>=0?p>n:n>p;e=p>=0?++n:--n)k[2*e]=l,k[2*e+1]=m,i=-m,j=l,l+=i*g,m+=j*g,l*=f,m*=f;for(k.push(k[0]),k.push(k[1]),r=[],e=o=0,q=k.length;q>o;e=o+=2)r.push(k[k.length-2-e]),r.push(k[k.length-1-e]);return k=r,"physics"!==a.mode&&(k.push(0),k.push(0)),b._VERTEX_CACHE[c]=k,k},b.prototype.generateUVs=function(a){var c,d;return c=""+this.radius+"."+this.segments,d=b._UV_CACHE[c],d?d:b._UV_CACHE[c]=_.map(a,function(a){return function(b){return b/a.radius/2+.5}}(this))},b.prototype.fullVertRefresh=function(){var a,b,c;return c=this.generateVertices(),a=this.generateVertices({mode:"physics"}),b=this.generateUVs(c),this.updateVertices(c,b),this.setPhysicsVertices(a)},b.prototype.validateCacheEntry=function(){var a,c;return a=""+this.radius+"."+this.segments,b._INDICE_BUFFER_CACHE[a]?(c=b._INDICE_BUFFER_CACHE[a],this.setHostIndiceBuffer(c.getIndiceBuffer(),c.getId())):(b._INDICE_BUFFER_CACHE[a]=this,this.clearHostIndiceBuffer())},b.prototype.destroy=function(){var a;return a=""+this.radius+"."+this.segments,b._INDICE_BUFFER_CACHE[a]===this&&(b._INDICE_BUFFER_CACHE[a]=null),b.__super__.destroy.call(this)},b.prototype.getRadius=function(){return this.radius},b.prototype.getSegments=function(){return this.segments},b.prototype.setRadius=function(a){if(this.radius=a,0>=a)throw new Error("Invalid radius: "+a);return this.fullVertRefresh(),this.validateCacheEntry()},b.prototype.setSegments=function(a){if(this.segments=a,2>=a)throw new Error("Invalid segment count: "+a);return this.fullVertRefresh(),this.validateCacheEntry()},b}(ARERawActor),ARECircleActor=function(a){function b(a,c){this.radius=c,b.__super__.constructor.call(this,a,c,32),delete this.setSegments,delete this.getSegments}return __extends(b,a),b}(AREPolygonActor),ARETriangleActor=function(a){function b(a,c,d){var e,f;if(this.base=c,this.height=d,0>=c)throw new Error("Invalid base: "+c);if(0>=d)throw new Error("Invalid height: "+d);f=this.generateVertices(),e=this.generateUVs(),b.__super__.constructor.call(this,a,f,e)}return __extends(b,a),b.prototype.generateVertices=function(){var a,b;return a=this.base/2,b=this.height/2,[-a,-b,0,b,a,-b,-a,-b]},b.prototype.generateUVs=function(){return[0,1,0,0,1,0,1,1]},b.prototype.getBase=function(){return this.base},b.prototype.getHeight=function(){return this.height},b.prototype.setBase=function(a){return this.base=a,this.updateVertices(this.generateVertices())},b.prototype.setHeight=function(a){return this.height=a,this.updateVertices(this.generateVertices())},b}(ARERawActor),AREColor3=function(){function a(b,c,d){b||(b=0),c||(c=0),d||(d=0),b instanceof a?(this._r=b.getR(),this._g=b.getG(),this._b=b.getB()):(this.setR(b),this.setG(c),this.setB(d))}return a.prototype.getR=function(a){return a!==!0?this._r:this._r/255},a.prototype.getG=function(a){return a!==!0?this._g:this._g/255},a.prototype.getB=function(a){return a!==!0?this._b:this._b/255},a.prototype.setR=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._r=a},a.prototype.setG=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._g=a},a.prototype.setB=function(a){return a=Number(a),0>a&&(a=0),a>255&&(a=255),this._b=a},a.prototype.toString=function(){return"("+this._r+", "+this._g+", "+this._b+")"},a}(),AREShader=function(){function a(a,b,c,d){var e;if(this._vertSrc=a,this._fragSrc=b,this._gl=c,d=!!d,this.errors=[],this._prog=null,this._vertShader=null,this._fragShader=null,this._handles=null,d===!0&&(e=this.build(this._gl),e===!1))throw new Error("Failed to build shader! "+JSON.stringify(this.errors))}return a.prototype.build=function(a){var b;if(this._gl=a,b=this._gl,this.errors=[],void 0===b||null===b)throw new Error("Need a valid gl object to build a shader!");return this._vertShader=b.createShader(b.VERTEX_SHADER),this._fragShader=b.createShader(b.FRAGMENT_SHADER),b.shaderSource(this._vertShader,this._vertSrc),b.shaderSource(this._fragShader,this._fragSrc),b.compileShader(this._vertShader),b.compileShader(this._fragShader),b.getShaderParameter(this._vertShader,b.COMPILE_STATUS)||this.errors.push(b.getShaderInfoLog(this._vertShader)),b.getShaderParameter(this._fragShader,b.COMPILE_STATUS)||this.errors.push(b.getShaderInfoLog(this._fragShader)),this._prog=b.createProgram(),b.attachShader(this._prog,this._vertShader),b.attachShader(this._prog,this._fragShader),b.linkProgram(this._prog),b.getProgramParameter(this._prog,b.LINK_STATUS)||this.errors.push("Failed to link!"),this.errors.length>0?!1:!0},a.prototype.generateHandles=function(){var a,b,c,d,e,f,g,h,i;if(null===this._prog)return AREEngine.getLog().error("Build program before generating handles"),!1;if(null!==this._handles)return AREEngine.getLog().warn("Refusing to re-generate handles!"),!1;for(this._handles={},h=function(a,b,c){var d,e;if(a=a.split(" "),d=a[a.length-1].replace(";",""),1===b){if(e={n:d,h:c._gl.getUniformLocation(c._prog,d)},"object"!=typeof e.h)throw new Error("Failed to get handle for uniform "+d+" ["+e.h+"]");return e}if(2===b)return e={n:d,h:c._gl.getAttribLocation(c._prog,d)};throw new Error("Type not 1 or 2, WTF, internal error")},i=[this._vertSrc,this._fragSrc],d=0,f=i.length;f>d;d++)for(c=i[d],c=c.split(";"),e=0,g=c.length;g>e&&(b=c[e],-1===b.indexOf("main()"));e++)-1!==b.indexOf("attribute")?(a=h(b,2,this),this._handles[a.n]=a.h):-1!==b.indexOf("uniform")&&(a=h(b,1,this),this._handles[a.n]=a.h);return!0},a.prototype.getHandles=function(){return this._handles},a.prototype.getProgram=function(){return this._prog},a}(),AREVector2=function(){function a(){this.x||(this.x=0),this.y||(this.y=0)}return a.prototype.random=function(b){var c,d,e,f;return b||(b={}),c=!!b.bipolar,d=b.seed||65535*Math.random(),e=Math.random()*this.x,f=Math.random()*this.y,c&&(Math.random()<.5&&(e=-e),Math.random()<.5&&(f=-f)),new a(e,f)},a.prototype.add=function(b){return new a(this.x+b.x,this.y+b.y)},a.prototype.sub=function(b){return new a(this.x-b.x,this.y-b.y)},a.prototype.mul=function(b){return new a(this.x*b.x,this.y*b.y)},a.prototype.div=function(b){return new a(this.x/b.x,this.y/b.y)},a.prototype.floor=function(){return new a(Math.floor(this.x),Math.floor(this.y))},a.prototype.ceil=function(){return new a(Math.ceil(this.x),Math.ceil(this.y))},a.zero=function(){return new a(0,0)},a}(),AREShader.shaders={},AREShader.shaders.wire={},AREShader.shaders.solid={},AREShader.shaders.texture={},precision="mediump",varying_precision="mediump",precision_declaration="precision "+precision+" float;",AREShader.shaders.wire.vertex=""+precision_declaration+"\n\nattribute vec2 aPosition;\n\nuniform mat4 uProjection;\nuniform mat4 uModelView;\n\nvoid main() {\n  gl_Position = uProjection * uModelView * vec4(aPosition, 1, 1);\n}",AREShader.shaders.wire.fragment=""+precision_declaration+"\n\nuniform vec4 uColor;\nuniform float uOpacity;\n\nvoid main() {\n  vec4 frag = uColor;\n  frag.a *= uOpacity;\n  gl_FragColor = frag;\n}",AREShader.shaders.solid.vertex=AREShader.shaders.wire.vertex,AREShader.shaders.solid.fragment=""+precision_declaration+"\n\nuniform vec4 uColor;\nuniform float uOpacity;\n\nvoid main() {\n  vec4 frag = uColor;\n  frag.a *= uOpacity;\n  gl_FragColor = frag;\n}",AREShader.shaders.texture.vertex=""+precision_declaration+"\n\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nuniform mat4 uProjection;\nuniform mat4 uModelView;\n\nvarying "+varying_precision+" vec2 vTexCoord;\n\nvoid main() {\n  gl_Position = uProjection * uModelView * vec4(aPosition, 1, 1);\n  vTexCoord = aTexCoord;\n}",AREShader.shaders.texture.fragment=""+precision_declaration+"\n\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform float uOpacity;\nuniform vec4 uClipRect;\n\nvarying "+varying_precision+" vec2 vTexCoord;\n\nvoid main() {\n  vec4 baseColor = texture2D(uSampler,\n                             uClipRect.xy +\n                             vTexCoord * uClipRect.zw);\n  // baseColor *= uColor;\n  baseColor.a *= uOpacity;\n\n  gl_FragColor = baseColor;\n}",ARERenderer=function(){function a(b){var c,d,e;if(this._width=b.width,this._height=b.height,c=b.canvasId||"",d=b.renderMode||a.RENDER_MODE_WGL,b.premultipliedAlpha||(b.premultipliedAlpha=!0),b.antialias||(b.antialias=!0),b.alpha||(b.alpha=!0),b.depth||(b.depth=!0),b.stencil||(b.stencil=!1),this._alwaysClearScreen=!!b.preserveDrawingBuffer,this._nextID=0,this._defaultShader=null,this._canvas=null,this._ctx=null,this._gl=null,this._actors=[],this._actor_hash={},this._textures=[],this._culling=!1,this._currentMaterial="none",this._activeRendererMode=null,this._cameraPosition={x:0,y:0},this._zoomFactor=1,this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderSelectionRect=null,this._pickRenderCB=null,this._clearColor=new AREColor3(255,255,255),e=function(a){return function(b,c){var d;return a._canvas=document.createElement("canvas"),a._canvas.width=a._width,a._canvas.height=a._height,a._canvas.id=c,d=document.querySelector(b),d||(d=document.getElementById(b)),d.appendChild(a._canvas),ARELog.info("Creating canvas #"+c+" ["+a._width+"x"+a._height+"] <"+b+">")}}(this),c?(this._canvas=document.getElementById(c),this._canvas?"canvas"===this._canvas.nodeName.toLowerCase()?(this._canvas.width=this._width,this._canvas.height=this._height):e(c,"are_canvas"):e("body",c)):e("body","are_anvas"),!this._canvas)throw new Error("Failed to create or find suitable canvas!");switch(d){case a.RENDER_MODE_NULL:this._initializeNullRendering();break;case a.RENDER_MODE_CANVAS:this._initializeCanvasRendering();break;case a.RENDER_MODE_WGL:this._initializeWebGLRendering(b)||(ARELog.info("Falling back on regular canvas renderer"),this._initializeCanvasRendering());break;default:throw new Error("Invalid Renderer "+rendererMode)}ARELog.info("Using the "+this._activeRendererMode+" renderer mode"),this.setClearColor(255,255,255),this.switchMaterial(a.MATERIAL_FLAT)}return a.RENDER_MODE_NULL=0,a.RENDER_MODE_CANVAS=1,a.RENDER_MODE_WGL=2,a.GL_MODE_LINE_LOOP=0,a.GL_MODE_TRIANGLE_FAN=1,a.GL_MODE_TRIANGLE_STRIP=2,a.RENDER_STYLE_STROKE=1,a.RENDER_STYLE_FILL=2,a.RENDER_STYLE_FILL_AND_STROKE=3,a.MATERIAL_NONE="none",a.MATERIAL_FLAT="flat",a.MATERIAL_TEXTURE="texture",a.prototype._initializeWebGLRendering=function(b){var c,d,e,f,g,h,i;return this._gl=this._canvas.getContext("webgl",b),this._gl||(ARELog.warn("Continuing with experimental webgl support"),this._gl=this._canvas.getContext("experimental-webgl",b)),this._gl?(ARELog.info("Obtained WebGL context"),this._gl.enable(this._gl.DEPTH_TEST),this._gl.enable(this._gl.BLEND),this._gl.depthFunc(this._gl.LEQUAL),this._gl.blendFunc(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),e=this._clearColor.getR(!0),d=this._clearColor.getG(!0),c=this._clearColor.getB(!0),this._gl.clearColor(e,d,c,1),f=AREShader.shaders,i=f.wire,g=f.solid,h=f.texture,this._defaultShader=new AREShader(g.vertex,g.fragment,this._gl,!0),this._defaultShader.generateHandles(),this._wireShader=new AREShader(i.vertex,i.fragment,this._gl,!0),this._wireShader.generateHandles(),this._texShader=new AREShader(h.vertex,h.fragment,this._gl,!0),this._texShader.generateHandles(),ARELog.info("Initialized shaders"),this._activeRendererMode=a.RENDER_MODE_WGL,this.render=this._wglRender,this._pendingVBORefresh=!1,this._vertexDataBuffer=this._gl.createBuffer(),this.requestVBORefresh(),ARELog.info("WebgL renderer initialized"),!0):(ARELog.warn("Failed to obtain WebGL context"),!1)},a.prototype._initializeCanvasRendering=function(){return this._ctx=this._canvas.getContext("2d"),this._activeRendererMode=a.RENDER_MODE_CANVAS,this.render=this._cvRender,ARELog.info("Canvas renderer initialized"),!0},a.prototype._initializeNullRendering=function(){return this._ctx=this._canvas.getContext("2d"),this._activeRendererMode=a.RENDER_MODE_NULL,this.render=this._nullRender,ARELog.info("Null renderer initialized"),!0
},a.prototype.render=function(){},a.prototype.enableCulling=function(){return this._culling=!0,this},a.prototype.disableCulling=function(){return this._culling=!1,this},a.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;for(i=_.remove(this._actors,function(a){return a.flaggedForDeletion()}),n=0,r=i.length;r>n;n++)b=i[n],b.rendererActorDelete();if(this._pendingVBORefresh&&this.isWGLRendererActive()){for(h=0,k=[],g=[],l=0,u=this._actors,o=0,s=u.length;s>o;o++)e=u[o],e.hasOwnIndiceBuffer()&&(l+=e.getRawVertexData().length);for(a=new Float32Array(l),v=this._actors,p=0,t=v.length;t>p;p++)if(e=v[p],e.hasOwnIndiceBuffer()){for(m=e.getRawVertexData(),k=[],j=q=0,w=m.length/4;w>=0?w>q:q>w;j=w>=0?++q:--q)f=h+j,k.push(f),c=4*f,d=4*j,a[c]=m[d],a[c+1]=m[d+1],a[c+2]=m[d+2],a[c+3]=m[d+3];h+=m.length/4,e.updateIndices(k)}return this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vertexDataBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,a,this._gl.STATIC_DRAW),this._pendingVBORefresh=!1}},a.prototype.requestVBORefresh=function(){return this._pendingVBORefresh=!0},a.prototype.getDefaultShader=function(){return this._defaultShader},a.prototype.getWireShader=function(){return this._wireShader},a.prototype.getTextureShader=function(){return this._texShader},a.prototype.getCanvas=function(){return this._canvas},a.prototype.getContext=function(){return this._ctx},a.prototype.getWidth=function(){return this._width},a.prototype.getHeight=function(){return this._height},a.prototype.setCameraPosition=function(a){this._cameraPosition=a},a.prototype.getCameraPosition=function(){return{x:this._cameraPosition.x,y:this._cameraPosition.y}},a.prototype.setCameraZoom=function(a){var b;return this._zoomFactor=a,(b=this.getShaderForMaterial(this._currentMaterial))?this.refreshViewport(b):void 0},a.prototype.getCameraZoom=function(){return this._zoomFactor},a.prototype.getClearColor=function(){return this._clearColor},a.prototype.setClearColor=function(b,c,d){var e;return this._clearColor||(this._clearColor=new AREColor3),b instanceof AREColor3?this._clearColor=b:(this._clearColor.setR(b||0),this._clearColor.setG(c||0),this._clearColor.setB(d||0)),this._activeRendererMode===a.RENDER_MODE_WGL&&(e=this._clearColor.getR(!0),c=this._clearColor.getG(!0),d=this._clearColor.getB(!0),this._gl&&this._gl.clearColor(e,c,d,1)),this},a.prototype.requestPickingRenderWGL=function(a,b){return this._pickRenderRequested?ARELog.warn("Pick render already requested! No request queue"):(this._pickRenderBuff=a,this._pickRenderSelectionRect=null,this._pickRenderCB=b,this._pickRenderRequested=!0,this)},a.prototype.requestPickingRenderCanvas=function(a,b){return this._pickRenderRequested?ARELog.warn("Pick render already requested! No request queue"):(this._pickRenderBuff=null,this._pickRenderSelectionRect=a,this._pickRenderCB=b,this._pickRenderRequested=!0,this)},a.prototype._wglRender=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;if(h=this._gl,this._pickRenderRequested&&h.bindFramebuffer(h.FRAMEBUFFER,this._pickRenderBuff),this._alwaysClearScreen&&h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT),d=this._actors.length,e=this._actors.length,this._pickRenderRequested){for(;e--;)b=this._actors[d-e-1],b._visible&&(c=b._id,p={r:b._color._r,g:b._color._g,b:b._color._b},q=b._opacity,n=c-255*Math.floor(c/255),o=Math.floor(c/255),this.switchMaterial(a.MATERIAL_FLAT),b.setColor(n,o,248),b.setOpacity(1),b.wglDraw(h,this._defaultShader),b.setColor(p.r,p.g,p.b),b.setOpacity(q));this._pickRenderCB(),this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderCB=null,h.bindFramebuffer(h.FRAMEBUFFER,null),this.render()}else for(m=window.innerWidth*this._zoomFactor*.5,l=window.innerHeight*this._zoomFactor*.5,i=j=k=f=!0,g=this._cameraPosition;e--;)b=this._actors[d-e-1],b._visible&&(i=b._position.x-g.x+b._bounds.w/2<-m,j=b._position.x-g.x-b._bounds.w/2>m,k=b._position.y-g.y+b._bounds.h/2<-l,f=b._position.y-g.y-b._bounds.h/2>l,this._culling&&(f||k||i||j)||(b._attachedTexture&&(b=b.updateAttachment()),b._material!==this._currentMaterial&&this.switchMaterial(b._material),b.wglDraw(h)));return this},a.prototype._cvRender=function(){var b,c,d,e,f,g,h,i,j,k,l;if(this._ctx){for(c=this._ctx,this._clearColor?(c.fillStyle="rgb"+this._clearColor,c.fillRect(0,0,this._width,this._height)):c.clearRect(0,0,this._width,this._height),c.save(),c.translate(0,this._height),c.scale(1,-1),j=this._actors,f=0,i=j.length;i>f;f++)b=j[f],c.save(),this._pickRenderRequested?(k=b._color,k={r:k._r,g:k._g,b:k._b},l=b._opacity,g=b.getId()-255*Math.floor(b.getId()/255),h=Math.floor(b.getId()/255),this.switchMaterial(a.MATERIAL_FLAT),b.setColor(g,h,248),b.setOpacity(1),b.cvDraw(c),b.setColor(k.r,k.g,k.b),b.setOpacity(l)):(b=b.updateAttachment(),(d=b.getMaterial())!==this._currentMaterial&&this.switchMaterial(d),b.cvDraw(c)),c.restore();return c.restore(),this._pickRenderRequested&&(e=this._pickRenderSelectionRect,this._pickRenderCB(c.getImageData(e.x,e.y,e.width,e.height)),this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderSelectionRect=null,this._pickRenderCB=null,this.render()),this}},a.prototype._nullRender=function(){var a,b,c,d,e;if(this._ctx){for(b=this._ctx,this._clearColor?(b.fillStyle="rgb"+this._clearColor,b.fillRect(0,0,this._canvas.width,this._canvas.height)):b.clearRect(0,0,this._canvas.width,this._canvas.height),e=this._actors,c=0,d=e.length;d>c;c++)a=e[c],a=a.updateAttachment(),a.nullDraw(b);return this}},a.prototype.clearScreen=function(){switch(this._activeRendererMode){case a.RENDER_MODE_CANVAS:this._clearColor?(this._ctx.fillStyle="rgb"+this._clearColor,this._ctx.fillRect(0,0,this._width,this._height)):this._ctx.clearRect(0,0,this._width,this._height);break;case a.RENDER_MODE_WGL:this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT)}return this},a.prototype.getActiveRendererMode=function(){return this._activeRendererMode},a.prototype.isNullRendererActive=function(){return this._activeRendererMode===a.RENDER_MODE_NULL},a.prototype.isCanvasRendererActive=function(){return this._activeRendererMode===a.RENDER_MODE_CANVAS},a.prototype.isWGLRendererActive=function(){return this._activeRendererMode===a.RENDER_MODE_WGL},a.prototype.getNextId=function(){return this._nextID++},a.prototype.getGL=function(){return this._gl},a.prototype.addActor=function(a,b){var c;return isNaN(b)||(a.layer=b),c=_.sortedIndex(this._actors,a,"layer"),this._actors.splice(c,0,a),this._actor_hash[a.getId()]=a,a},a.prototype.removeActor=function(a){var b;return a instanceof ARERawActor&&(a=a.getId()),b=_.remove(this._actors,function(b){return b.getId()===a})[0],!!b},a.prototype.makeOrthoMatrix=function(a,b,c,d,e,f){return new Float32Array([2/(b-a),0,0,0,0,2/(d-c),0,0,0,0,-2/(f-e),0,-(b+a)/(b-a),-(d+c)/(d-c),-(f+e)/(f-e),1])},a.prototype.refreshViewport=function(a){var b,c,d,e;return e=this._width*this._zoomFactor,c=this._height*this._zoomFactor,d=this.makeOrthoMatrix(-e/2,e/2,c/2,-c/2,-10,10),b=a.getHandles(),this._gl.uniformMatrix4fv(b.uProjection,!1,d)},a.prototype.getShaderForMaterial=function(b){switch(b){case a.MATERIAL_FLAT:return this._defaultShader;case a.MATERIAL_TEXTURE:return this._texShader;default:return null}},a.prototype.switchMaterial=function(a){var b;if(a===this._currentMaterial)return!1;if(this.isWGLRendererActive()){if(!(b=this.getShaderForMaterial(a)))throw new Error("Unknown material "+a);this._gl.useProgram(b.getProgram()),this.refreshViewport(b)}return this._currentMaterial=a,this},a.prototype.hasTexture=function(a){return!!_.find(this._textures,function(b){return b.name===a})},a.prototype.getTexture=function(a){return _.find(this._textures,function(b){return b.name===a})},a.prototype.getTextureSize=function(a){var b;return(b=this.getTexture(a))?{w:b.width*b.scaleX,h:b.height*b.scaleY}:null},a.prototype.addTexture=function(a){return this._textures.push(a),this},a}(),PhysicsManager=function(){function a(a,b,c){var d;this._renderer=a,this._backlog=[],d=[{raw:"cp = exports = {};"},{url:b.chipmunk},{url:b.physics_worker}],async.map(d,function(a,b){var c;return a.raw?b(null,a.raw):(c=new XMLHttpRequest,c.open("GET",a.url,!0),c.onerror=function(a){return b("Connection error: "+a,null)},c.onload=function(){return c.status>=200&&c.status<400?b(null,c.responseText):b("Request returned "+c.status,null)},c.send())},function(a){return function(b,d){return a._initFromSources(d),a._emptyBacklog(),c?c():void 0}}(this))}return a.prototype._initFromSources=function(a){var b;if(!this._worker)return b=new Blob([a.join("\n\n")],{type:"text/javascript"}),this._worker=new Worker((URL||window.webkitURL).createObjectURL(b)),this._worker.postMessage(""),this._connectWorkerListener()},a.prototype._emptyBacklog=function(){var a,b,c,d,e;if(this._worker){for(d=this._backlog,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.sendMessage(a.message,a.command));return e}},a.prototype.sendMessage=function(a,b){return this._worker?this._worker.postMessage({message:a,command:b}):this._backlog.push({message:a,command:b})},a.prototype._connectWorkerListener=function(){var a,b,c,d,e,f;return a=0,b=1,c=2,e={},f={},d={},this._worker.onmessage=function(g){return function(h){var i,j;if(e=h.data,e.length){for(i=e.length,j=[];i--;)f=e[i],d=g._renderer._actor_hash[f[a]],d._position=f[b],d._rotation=f[c],j.push(d._updateModelMatrix());return j}}}(this)},a}(),ARELog=function(){function a(){}return a.tags=["","[Error]> ","[Warning]> ","[Debug]> ","[Info]> "],a.level=4,a.w=function(b,c){var d;return d=a,b>d.level||0===b||0===d.level?void 0:1===b&&void 0!==console.error?console.error?console.error(""+d.tags[b]+c):console.log(""+d.tags[b]+c):2===b&&void 0!==console.warn?console.warn?console.warn(""+d.tags[b]+c):console.log(""+d.tags[b]+c):3===b&&void 0!==console.debug?console.debug?console.debug(""+d.tags[b]+c):console.log(""+d.tags[b]+c):4===b&&void 0!==console.info?console.info?console.info(""+d.tags[b]+c):console.log(""+d.tags[b]+c):console.log(b>4&&void 0!==d.tags[b]?""+d.tags[b]+c:c)},a.error=function(a){return this.w(1,a)},a.warn=function(a){return this.w(2,a)},a.debug=function(a){return this.w(3,a)},a.info=function(a){return this.w(4,a)},a}(),AREBezAnimation=function(){function a(a,b,c){this.actor=a,c=!!c,this._duration=b.duration,this._property=b.property,this._controlPoints=b.controlPoints||[],this._fps=b.fps||30,this._cbStep=b.cbStep||function(){},this._cbEnd=b.cbEnd||function(){},this._cbStart=b.cbStart||function(){},this._animated=!1,this.bezOpt={},this.bezOpt.degree=0,b.controlPoints.length>0&&(this.bezOpt.degree=b.controlPoints.length,this.bezOpt.ctrl=b.controlPoints),this.bezOpt.endPos=b.endVal,this.tIncr=1/(this._duration*(this._fps/1e3)),c?this.bezOpt.startPos=b.startVal:("rotation"===this._property[0]&&(this.bezOpt.startPos=this.actor.getRotation()),"position"===this._property[0]&&("x"===this._property[1]?this.bezOpt.startPos=this.actor.getPosition().x:"y"===this._property[1]&&(this.bezOpt.startPos=this.actor.getPosition().y)),"color"===this._property[0]&&("r"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getR():"g"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getG():"b"===this._property[1]&&(this.bezOpt.startPos=this.actor.getColor().getB())))}return a.prototype._update=function(a,b){var c,d,e,f,g,h;if(b||(b=!0),0>a&&(a=0),a>1&&(a=1),0===this.bezOpt.degree)c=this.bezOpt.startPos+(this.bezOpt.endPos-this.bezOpt.startPos)*a;else if(1===this.bezOpt.degree)d=1-a,e=d*d,g=a*a,c=e*this.bezOpt.startPos+2*d*a*this.bezOpt.ctrl[0].y+g*this.bezOpt.endPos;else{if(2!==this.bezOpt.degree)throw new Error("Invalid degree, can't evaluate ("+this.bezOpt.degree+")");d=1-a,e=d*d,f=e*d,g=a*a,h=g*a,c=f*this.bezOpt.startPos+3*e*a*this.bezOpt.ctrl[0].y+3*d*g*this.bezOpt.ctrl[1].y+h*this.bezOpt.endPos}return b&&(this._applyValue(c),this._cbStep(c)),c},a.prototype.preCalculate=function(){var a,b;for(b=0,a={stepTime:this._duration*this.tIncr},a.values=[];1>=b;){if(b+=this.tIncr,b>1&&b<1+this.tIncr)b=1;else if(b>1)break;a.values.push(this._update(b,!1))}return a},a.prototype._applyValue=function(a){var b,c,d;if("rotation"===this._property[0])return this.actor.setRotation(a);if("position"===this._property[0]){if("x"===this._property[1])return this.actor.setPosition({x:a,y:this.actor.getPosition().y});if("y"===this._property[1])return this.actor.setPosition({x:this.actor.getPosition().x,y:a})}else if("color"===this._property[0]){if("r"===this._property[1])return d=a,c=this.actor.getColor().getG(),b=this.actor.getColor().getB(),this.actor.setColor(d,c,b);if("g"===this._property[1])return d=this.actor.getColor().getR(),c=a,b=this.actor.getColor().getB(),this.actor.setColor(d,c,b);if("b"===this._property[1])return d=this.actor.getColor().getR(),c=this.actor.getColor().getG(),b=a,this.actor.setColor(d,c,b)}},a.prototype.animate=function(){var a;if(!this._animated)return this._animated=!0,this._cbStart(),a=-this.tIncr,this._intervalID=setInterval(function(b){return function(){return a+=b.tIncr,a>1&&(a=1),b._update(a),1===a?(clearInterval(b._intervalID),b._cbEnd()):b._cbStep()}}(this),1e3/this._fps)},a}(),AREVertAnimation=function(){function a(a,b){return this.actor=a,this._delays=b.delays,this._deltas=b.deltas,this._udata=b.udata,this._cbStep=b.cbStep||function(){},this._cbEnd=b.cbEnd||function(){},this._cbStart=b.cbStart||function(){},this._delays.length!==this._deltas.length?(ARELog.warn("Vert animation delay count != delta set count! Bailing."),void(this._animated=!0)):void(this._animated=!1)}return a.prototype._setTimeout=function(a,b,c,d){return setTimeout(function(b){return function(){return b._applyDeltas(a,c),d?b._cbEnd():void 0}}(this),b)},a.prototype._applyDeltas=function(a,b){var c,d,e,f,g,h,i;for(this._cbStep(b),d=this.actor.getVertices(),f=-1!==a.join("_").indexOf("..."),e=h=0,i=a.length;i>=0?i>h:h>i;e=i>=0?++h:--h){if(c=a[e],e>=d.length){if(f)break;g=void 0}else g=d[e];if("number"==typeof c)g=c;else{if("string"!=typeof c)return void ARELog.warn("Unknown delta type, can't apply deltas! "+c+" "+typeof c);if(!g)return void ARELog.warn("Vertex does not exist, yet delta is relative!");if("|"===c.charAt(0))break;if("-"===c.charAt(0))g-=Number(c.slice(1));else if("+"===c.charAt(0))g+=Number(c.slice(1));else if("..."===c)e=0;else if("."!==c.charAt(0))return void ARELog.warn("Unknown delta action, "+c+", can't apply deltas.")}if(e>d.length)return void ARELog.warn("Vertex gap, can't push new vert! "+g+":"+c+":"+e);e===d.length?d.push(g):d[e]=g}return this.actor.updateVertices(d)},a.prototype.animate=function(){var a,b,c,d,e,f;if(!this._animated){for(this._animated=!0,this._cbStart(),f=[],a=d=0,e=this._deltas.length;e>=0?e>d:d>e;a=e>=0?++d:--d)c=null,this._udata&&(this._udata instanceof Array?a<this._udata.length&&(c=this._udata[a]):c=this._udata),b=a===this._deltas.length-1,f.push(this._setTimeout(this._deltas[a],this._delays[a],c,b));return f}},a}(),AREPsyxAnimation=function(){function a(a,b){this.actor=a,this._mass=b.mass||0,this._friction=b.friction||0,this._elasticity=b.elasticity||0,this._timeout=b.timeout,this._cbStep=b.cbStep||function(){},this._cbEnd=b.cbEnd||function(){},this._cbStart=b.cbStart||function(){},this._animated=!1}return a.prototype.animate=function(){return this._animated?void 0:(this._animated=!0,this._cbStart(),setTimeout(function(a){return function(){return a.actor.createPhysicsBody(a._mass,a._friction,a._elasticity),a._cbEnd()}}(this),this._timeout))},a}(),AREActorInterface=function(){function a(){}return a.prototype.setEngine=function(a){return this._renderer=a.getRenderer()},a.prototype._findActor=function(a){var b,c,d,e;for(e=this._renderer._actors,c=0,d=e.length;d>c;c++)if(b=e[c],b.getId()===a)return b;return null},a.prototype.create2DRawPolygon=function(a){return new ARERawActor(this._renderer,a).getId()},a.prototype.create2DPolygon=function(a,b){return"string"==typeof a?this.createRawActor(a):new AREPolygonActor(this._renderer,a,b).getId()},a.prototype.create2DRectangle=function(a,b){return new ARERectangleActor(this._renderer,a,b).getId()},a.prototype.create2DCircle=function(a){return new ARECircleActor(this._renderer,a).getId()},a.prototype.getLayer=function(a){var b;return(b=this._findActor(a))?b.getLayer():null},a.prototype.getPhysicsLayer=function(a){var b;return(b=this._findActor(a))?b.getPhysicsLayer():null},a.prototype.getRectangleWidth=function(a){var b;return(b=this._findActor(a))&&b instanceof ARERectangleActor?b.getWidth():null},a.prototype.getRectangleHeight=function(a){var b;return(b=this._findActor(a))&&b instanceof ARERectangleActor?b.getHeight():null},a.prototype.getOpacity=function(a){var b;return(b=this._findActor(a))?b.getOpacity():null},a.prototype.isVisible=function(a){var b;return(b=this._findActor(a))?b.getVisible():null},a.prototype.getPosition=function(a){var b;return(b=this._findActor(a))?b.getPosition():null},a.prototype.getRotation=function(a,b){var c;return(c=this._findActor(a))?c.getRotation(!!b):null},a.prototype.getColor=function(a){var b,c;return(b=this._findActor(a))?(c=b.getColor(),{r:c.getR(),g:c.getG(),b:c.getB()}):null},a.prototype.getTexture=function(a){var b;return(b=this._findActor(a))?b.getTexture().name:null},a.prototype.getTextureRepeat=function(a){var b;return(b=this._findActor(a))?b.getTextureRepeat():null},a.prototype.setRectangleHeight=function(a,b){var c;return(c=this._findActor(a))&&c instanceof ARERectangleActor?(c.setHeight(b),!0):!1},a.prototype.setRectangleWidth=function(a,b){var c;return(c=this._findActor(a))&&c instanceof ARERectangleActor?(c.setWidth(b),!0):!1},a.prototype.setPolygonSegments=function(a,b){var c;return(c=this._findActor(a))&&c instanceof AREPolygonActor?(c.setSegments(b),!0):!1},a.prototype.setPolygonRadius=function(a,b){var c;return(c=this._findActor(a))&&c instanceof AREPolygonActor?(c.setRadius(b),!0):!1},a.prototype.getPolygonRadius=function(a){var b;return(b=this._findActor(a))&&b instanceof AREPolygonActor?b.getRadius():null},a.prototype.getPolygonSegments=function(a){var b;return(b=this._findActor(a))&&b instanceof AREPolygonActor?b.getSegments():null},a.prototype.attachTexture=function(a,b,c,d,e,f,g){var h;return e||(e=0),f||(f=0),g||(g=0),(h=this._findActor(a))?(h.attachTexture(b,c,d,e,f,g),!0):!1},a.prototype.setLayer=function(a,b){var c;return(c=this._findActor(a))?(c.setLayer(b),!0):!1},a.prototype.setPhysicsLayer=function(a,b){var c;return(c=this._findActor(a))?(c.setPhysicsLayer(b),!0):!1},a.prototype.removeAttachment=function(a){var b;return(b=this._findActor(a))?(b.removeAttachment(),!0):!1},a.prototype.setAttachmentVisiblity=function(a,b){var c;return(c=this._findActor(a))?c.setAttachmentVisibility(b):!1},a.prototype.setVertices=function(a,b){var c;return(c=this._findActor(a))?(c.updateVertices(b),!0):!1},a.prototype.getVertices=function(a){var b;return(b=this._findActor(a))?b.getVertices():null},a.prototype.destroyActor=function(a){var b;return(b=this._findActor(a))?(b.destroy(),!0):!1},a.prototype.setPhysicsVertices=function(a,b){var c;return(c=this._findActor(a))?(c.setPhysicsVertices(b),!0):!1},a.prototype.setRenderMode=function(a,b){var c;return(c=this._findActor(a))?(c.setRenderMode(b),!0):!1},a.prototype.setOpacity=function(a,b){var c;return isNaN(b)?!1:(b=Number(b),b>1&&(b=1),0>b&&(b=0),(c=this._findActor(a))?(c.setOpacity(b),!0):!1)},a.prototype.setVisible=function(a,b){var c;return(c=this._findActor(a))?(c.setVisible(b),!0):!1},a.prototype.setPosition=function(a,b){var c;return(c=this._findActor(a))?(c.setPosition(b),!0):!1},a.prototype.setRotation=function(a,b,c){var d;return(d=this._findActor(a))?(d.setRotation(b,!!c),!0):!1},a.prototype.setColor=function(a,b){var c;return(c=this._findActor(a))?(c.setColor(b),!0):!1},a.prototype.setTexture=function(a,b){var c;return(c=this._findActor(a))?(c.setTexture(b),!0):!1},a.prototype.setTextureRepeat=function(a,b){var c;return(c=this._findActor(a))?(c.setTextureRepeat(b.x,b.y),!0):!1},a.prototype.createPhysicsBody=function(a,b,c,d){var e;return(e=this._findActor(a))?(e.createPhysicsBody(b,c,d),!0):!1},a.prototype.destroyPhysicsBody=function(a){var b;return(b=this._findActor(a))?(b.destroyPhysicsBody(),!0):!1},a.prototype.enable2DMode=function(){return!1},a.prototype.disable2DMode=function(){return!1},a.prototype.is2DModeEnabled=function(){return!1},a.prototype.create3DActor=function(){return!1},a.prototype.beginActorBatch=function(){return!1},a.prototype.endActorBatch=function(){return!1},a.prototype.set2DRotation=function(){return!1},a.prototype.rotateInto2DPlane=function(){return!1},a.prototype.clearTexture=function(){return!1},a.prototype.set2DVertices=function(){return!1},a.prototype.setTextureCoords=function(){return!1},a.prototype.getTextureCoords=function(){return null},a.prototype.get2DRotation=function(){return null},a.prototype.getAABB=function(){return null},a.prototype.destroy=function(){return!1},a.prototype.setAttachment=function(){return!1},a.prototype.setAttachmentOffset=function(){return!1},a.prototype.setAttachmentRotation=function(){return!1},a.prototype.getAttachmentID=function(){return null},a.prototype.getAttachmentVisibility=function(){return null},a.prototype.getAttachmentOffset=function(){return null},a.prototype.getAttachmentRotation=function(){return null},a}(),nextHighestPowerOfTwo=function(a){var b;for(--a,b=1;32>b;)a|=a>>b,b<<=1;return a+1},AREEngineInterface=function(){function a(a){this._masterInterface=a}return a.prototype.initialize=function(a,b,c,d,e){return isNaN(d)&&(d=4),e||(e=""),this._engine?(ARELog.warn("Re-initialize attempt, ignoring and passing through"),c(this._engine)):(this.wglFlipTextureY=!0,this._engine=new ARE(a,b,function(a){return function(){return c(a._engine)}}(this),d,e),this._masterInterface.setEngine(this._engine),this._renderer=this._engine.getRenderer(),this._engine)},a.prototype.getRendererMode=function(){return this._renderer.getActiveRendererMode()},a.prototype.setClearColor=function(a){return this._renderer?this._renderer.setClearColor(a.r,a.g,a.b):void 0},a.prototype.getClearColor=function(){var a;if(this._renderer)return a=this._renderer.getClearColor(),{r:a.getR(),g:a.getG(),b:a.getB()}},a.prototype.setLogLevel=function(a){return a=Number(a),isNaN(a)?ARELog.warn("Log level is NaN"):(a=Math.round(a),0>a&&(a=0),a>4&&(a=4),ARELog.level=a)},a.prototype.getLogLevel=function(){return ARELog.level},a.prototype.setCameraPosition=function(a){var b;return b=this._renderer.getCameraPosition(),void 0!==a.x&&(b.x=a.x),void 0!==a.y&&(b.y=a.y),this._renderer.setCameraPosition(b)},a.prototype.getCameraPosition=function(){return this._renderer.getCameraPosition()},a.prototype.getWidth=function(){return this._renderer?this._renderer.getWidth():-1},a.prototype.getHeight=function(){return this._renderer?this._renderer.getHeight():-1},a.prototype.setBenchmark=function(a){return this._engine?(this._engine.benchmark=a,window.AREMessages.broadcast({value:a},"physics.benchmark.set")):void 0},a.prototype.getNRAIDVersion=function(){return"1.0.0,freestanding"},a.prototype.getMetaData=function(){return this._metaData},a.prototype.loadManifest=function(a,b){if(!a.version)throw new Error("No manifest version provided!");if(a.version.split(",")[0]>this.getNRAIDVersion().split(",")[0])throw new Error("Unsupported NRAID version");return this._metaData=a.meta,a.textures?async.each(a.textures,function(a){return function(b,c){return a.loadTexture(b,function(){return c()},a.wglFlipTextureY)}}(this),b):b()},a.prototype.loadTexture=function(a,b,c){var d,e,f;if("boolean"!=typeof c&&(c=this.wglFlipTextureY),a.atlas)throw new Error("This version of ARE does not support atlas loading!");return e=new Image,e.crossOrigin="anonymous",d=this._renderer.getGL(),f=null,this._renderer.isWGLRendererActive()?(f=d.createTexture(),e.onload=function(g){return function(){var h,i,j,k,l,m;return ARELog.info("Loading GL tex: "+a.name+", "+a.file),k=1,l=1,m=0!==(e.width&e.width-1),j=0!==(e.height&e.height-1),(m||j)&&(h=document.createElement("canvas"),h.width=nextHighestPowerOfTwo(e.width),h.height=nextHighestPowerOfTwo(e.height),k=e.width/h.width,l=e.height/h.height,i=h.getContext("2d"),i.drawImage(e,0,0,h.width,h.height),e=h),d.bindTexture(d.TEXTURE_2D,f),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,c),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,e),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.bindTexture(d.TEXTURE_2D,null),g._renderer.addTexture({name:a.name,texture:f,width:e.width,height:e.height,scaleX:k,scaleY:l}),b?b():void 0}}(this)):e.onload=function(c){return function(){return ARELog.info("Loading canvas tex: "+a.name+", "+a.file),c._renderer.addTexture({name:a.name,texture:e,width:e.width,height:e.height}),b?b():void 0}}(this),e.src=a.file},a.prototype.getTextureSize=function(a){return this._renderer.getTextureSize(a)},a}(),AREAnimationInterface=function(){function a(){}return a._animationMap={position:AREBezAnimation,color:AREBezAnimation,rotation:AREBezAnimation,mass:AREPsyxAnimation,friction:AREPsyxAnimation,elasticity:AREPsyxAnimation,physics:AREPsyxAnimation,vertices:AREVertAnimation},a.prototype.setEngine=function(a){return this._renderer=a.getRenderer()},a.prototype.canAnimate=function(b){return!!a._animationMap[b]},a.prototype.getAnimationName=function(b){if(!a._animationMap[b])return!1;switch(a._animationMap[b]){case AREBezAnimation:return"bezier";case AREPsyxAnimation:return"psyx";case AREVertAnimation:return"vert";default:return!1}},a.prototype.animate=function(b,c,d){var e,f,g,h,i,j,k;for(d.start||(d.start=0),f=null,j=this._renderer._actors,h=0,i=j.length;i>h;h++)if(e=j[h],e.getId()===b){f=e;break}if(null===f)throw new Error("Actor not found, can't animate! "+actorId);return g=c[0],void 0===d.property&&(d.property=c),k=function(b,c,d){return a._animationMap[b]===AREBezAnimation?new AREBezAnimation(c,d).animate():a._animationMap[b]===AREPsyxAnimation?new AREPsyxAnimation(c,d).animate():a._animationMap[b]===AREVertAnimation?new AREVertAnimation(c,d).animate():ARELog.warn("Unrecognized property: "+b)},d.start>0?setTimeout(function(){return k(g,f,d)},d.start):k(g,f,d)},a.prototype.preCalculateBez=function(a){return a.controlPoints||(a.controlPoints=0),a.fps||(a.fps=30),new AREBezAnimation(null,a,!0).preCalculate()},a}(),AREInterface=function(){function a(){this._Actors=new AREActorInterface(this),this._Engine=new AREEngineInterface(this),this._Animations=new AREAnimationInterface(this)}return a.prototype.Actors=function(){return this._Actors},a.prototype.Engine=function(){return this._Engine},a.prototype.Animations=function(){return this._Animations},a.prototype.setEngine=function(a){return this._Actors.setEngine(a),this._Animations.setEngine(a)},a}(),ARE=function(){function a(b,c,d,e,f){return isNaN(e)&&(e=4),ARELog.level=e,f||(f=""),this._renderIntervalId=null,this._currentlyRendering=!1,this.benchmark=!1,this.setFPS(60),null===window._||void 0===window._?ARELog.error("Underscore.js is not present!"):(this._renderer=new ARERenderer({canvasId:f,width:b,height:c}),void(a.config.physics?(this._physics=new PhysicsManager(this._renderer,a.config.deps.physics,function(a){return function(){return a.startRendering(),d(a)}}(this)),window.AREPhysicsManager=this._physics):(ARELog.info("Proceeding without physics..."),setTimeout(function(a){return function(){return a.startRendering(),d(a)}}(this)))))}return a.config={physics:!0,deps:{physics:{chipmunk:"/components/chipmunk/cp.js",physics_worker:"/lib/physics/worker.js"}}},a.Version={MAJOR:1,MINOR:5,PATCH:1,BUILD:null,STRING:"1.5.1"},a.prototype.getRenderer=function(){return this._renderer},a.prototype.setFPS=function(a){return this._framerate=1/a,this},a.prototype.startRendering=function(){var a,b;if(!this._currentlyRendering)return this._currentlyRendering=!0,ARELog.info("Starting render loop"),b=this._renderer,a=function(){return b.update(),b.render(),window.requestAnimationFrame(a)},window.requestAnimationFrame(a)},a.prototype.isRendering=function(){return this._currentlyRendering},a.prototype.setClearColor=function(a,b,c){return a||(a=0),b||(b=0),c||(c=0),this._renderer&&this._renderer.setClearColor(a,b,c),this},a.prototype.getClearColor=function(){return this._renderer?this._renderer.getClearColor():null},a.prototype.getWidth=function(){return this._renderer.getWidth()},a.prototype.getHeight=function(){return this._renderer.getHeight()},a.prototype.requestPickingRenderWGL=function(a,b){return this._renderer.isWGLRendererActive()?this._renderer.requestPickingRenderWGL(a,b):ARELog.warn("WebGL renderer available for WebGL pick!")},a.prototype.requestPickingRenderCanvas=function(a,b){return this._renderer.isCanvasRendererActive()?this._renderer.requestPickingRenderCanvas(a,b):ARELog.warn("Canvas renderer available for canvas pick!")},a}(),window.AdefyGLI=window.AdefyRE=new AREInterface;